---
title: "Fluconazole300623"
author: "Leo"
date: "2023-06-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### PTA fAUC200 of two optimized dosing 28 and 29

```{r read in PTA_overall dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
PTA_overall<-read.csv("PTA_overall.csv")

```

##### PTA over BW optimised dosing revised manuscript 300623

###### Efficacy

```{r for fAUC200}
# PTA_OPT200_DAY1
library(dplyr)
library(ggplot2)
PTA_OPT200_DAY1 <- PTA_overall %>%
  filter(DAY == 1, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(84, 100), breaks = seq(84, 100, by = 2), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 1") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT200_DAY1

# PTA_OPT200_DAY2
PTA_OPT200_DAY2 <- PTA_overall %>%
  filter(DAY == 2, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(84, 100), breaks = seq(84, 100, by = 2), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 2") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT200_DAY2

# PTA_OPT200_DAY7
PTA_OPT200_DAY7 <- PTA_overall %>%
  filter(DAY == 7, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(84, 100), breaks = seq(84, 100, by = 2), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 7") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT200_DAY7

# PTA_OPT200_DAY14
PTA_OPT200_DAY14 <- PTA_overall %>%
  filter(DAY == 14, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(84, 100), breaks = seq(84, 100, by = 2), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 14") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT200_DAY14

```

###### Toxicity

```{r for Cmin80}
library(dplyr)
library(ggplot2)
# PTA_OPT80_DAY1
PTA_OPT80_DAY1 <- PTA_overall %>%
  filter(DAY == 1, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1.5), breaks = seq(0, 1.5, by = 0.1), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 1") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) #+ 
  #geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT80_DAY1

# PTA_OPT80_DAY2
PTA_OPT80_DAY2 <- PTA_overall %>%
  filter(DAY == 2, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1.5), breaks = seq(0, 1.5, by = 0.1), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 2") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) #+ 
  #geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT80_DAY2

# PTA_OPT80_DAY7
PTA_OPT80_DAY7 <- PTA_overall %>%
  filter(DAY == 7, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1.5), breaks = seq(0, 1.5, by = 0.1), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 7") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) #+ 
  #geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
PTA_OPT80_DAY7

# PTA_OPT80_DAY14
PTA_OPT80_DAY14 <- PTA_overall %>%
  filter(DAY == 14, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1.5), breaks = seq(0, 1.5, by = 0.1), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 14") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  )
PTA_OPT80_DAY14#+
  #geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#+ theme(axis.title.x = element_blank(),axis.title.y = element_blank()) 

```
###### Combing plots

```{r combining fAUC200}

# Combine PTA_OPT200_DAY1, PTA_OPT200_DAY2, PTA_OPT200_DAY7, and PTA_OPT200_DAY14
library(gridExtra)
library(grid)
combined_PTA_OPT200 <- grid.arrange(
  PTA_OPT200_DAY1, PTA_OPT200_DAY2,
  PTA_OPT200_DAY7, PTA_OPT200_DAY14,
  nrow = 2, ncol = 2,
  top = textGrob("Probability of target Attainment of fAUC 200 mgxh/L", gp = gpar(fontsize = 12, fontface = "bold")),
  left = textGrob("(a)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 12)),
  bottom = get_legend(PTA_OPT200_day1)
)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("combined_PTA_OPT200_2706.png", combined_PTA_OPT200, dpi = 300, width = 29.7, height = 19, units = "cm", limitsize = FALSE)

```

```{r combining Cmin80, warning=FALSE}
# Loading the gridExtra package
library(gridExtra)
library(grid)

# Combine PTA_OPT80_DAY1, PTA_OPT80_DAY2, PTA_OPT80_DAY7, and PTA_OPT80_DAY14
combined_PTA_OPT80 <- grid.arrange(
  PTA_OPT80_DAY1, PTA_OPT80_DAY2,
  PTA_OPT80_DAY7, PTA_OPT80_DAY14,
  nrow = 2, ncol = 2,
  top = textGrob("Probability of reaching toxicity threshold of Cmin 80 mg/L", gp = gpar(fontsize = 12, fontface = "bold")),
  left = textGrob("(b)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 12)),
  bottom = get_legend(PTA_OPT200_day1)
)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("combined_PTA_OPT80_2706.png", combined_PTA_OPT80, dpi = 300, width = 29.7, height = 17.5, units = "cm", limitsize = FALSE)

```

#### Relax assumption of kidney function 130723

##### Within dosing-interval imputation

```{r read the dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")
View(FlucTotIV_clean)

```

```{r new variable CREAT_DOS_INT, warning=FALSE}
#CREAT_DOS_INT using within dosing-interval imputation
library(dplyr)

FlucTotIV_clean$CREAT_DOS_INT <- FlucTotIV_clean$CREAT

FlucTotIV_clean <- FlucTotIV_clean %>%
  group_by(ID, OCC) %>%
  mutate(unique_CREAT = sum(!is.na(CREAT)))

FlucTotIV_clean <- FlucTotIV_clean %>%
  group_by(ID, OCC) %>%
  mutate(
    CREAT_DOS_INT = ifelse(unique_CREAT == 1, CREAT[!is.na(CREAT)],
                           ifelse((is.na(CREAT_DOS_INT) & unique_CREAT > 1),mean(CREAT[!is.na(CREAT)], na.rm = TRUE),CREAT_DOS_INT)
  )
)

```

```{r convert data types,warning=FALSE}
FlucTotIV_clean$AGE <- as.numeric(FlucTotIV_clean$AGE)
FlucTotIV_clean$LENGTH <- as.numeric(FlucTotIV_clean$LENGTH)
FlucTotIV_clean$BW2 <- as.numeric(FlucTotIV_clean$BW2)
FlucTotIV_clean$DV <- as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$TIME <- as.numeric(FlucTotIV_clean$TIME)
FlucTotIV_clean$CREAT_DOS_INT <- as.numeric(FlucTotIV_clean$CREAT_DOS_INT)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
FlucTotIV_clean$EVID <- as.factor(FlucTotIV_clean$EVID)
FlucTotIV_clean$TAD <- as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean$RATE <- as.numeric(FlucTotIV_clean$RATE)

```

###### Creating CREAT3 variable that captures more CREAT that are within 3 hours than CREAT2

```{r adapt the CREAT2 generating code a bit}
FlucTotIV_clean <- FlucTotIV_clean %>%
  mutate(CREAT3 = CREAT) %>%
  group_by(ID) %>%
  mutate(CREAT3 = ifelse(is.na(CREAT3) & !is.na(lag(CREAT3)) & !is.na(lag(DV)) & (TIME - lag(TIME)) <= 3,
                         lag(CREAT3), 
                         ifelse(is.na(CREAT3) & !is.na(lead(CREAT3)) & !is.na(lead(DV)) & (lead(TIME) - TIME) <= 3,
                                lead(CREAT3),
                                CREAT3))) %>%
  ungroup()

# Count non-NA rows in CREAT3 column
sum(!is.na(FlucTotIV_clean$CREAT3)) #864 #Actually it is 850 - 310723

# Count non-NA rows in CREAT2 column
sum(!is.na(FlucTotIV_clean$CREAT2)) #846
# Miss 18 data points
# Miss 4 data points - 310723

```

```{r adding CRRT2 columns to the FlucTotIV_clean data}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean$CRRT2 <- ifelse(FlucTotIV_clean$ID %in% crrt_patients, 1, 0)

```

```{r investigate multiple imputed CREAT3 in the observed Scr dosing intervals with more than 1 observations}

# When using pmm method
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
Fluc_NONMEM_mul_impute1<- read.csv("Fluc_NONMEM_mul_impute1.csv")

# If use another method, convert Fluc_NONMEM_mul_impute into Fluc_NONMEM_mul_impute1 first
Fluc_NONMEM_mul_impute1<-Fluc_NONMEM_mul_impute

#CREAT3_observed new column
FlucTotIV_clean$CREAT3_observed <- ifelse(is.na(FlucTotIV_clean$CREAT3), 0, 1)

FlucTotIV_clean_investigate<-FlucTotIV_clean

# Adding CKDEPI01 to CKDEPI10 to FlucTotIV_clean_investigate dataset
FlucTotIV_clean_investigate <- cbind(FlucTotIV_clean_investigate, Fluc_NONMEM_mul_impute1[, c("CKDEPI01", "CKDEPI02", "CKDEPI03", "CKDEPI04", "CKDEPI05", "CKDEPI06", "CKDEPI07", "CKDEPI08", "CKDEPI09", "CKDEPI10")])

### Making the dataset for CREAT3

library(dplyr)
library(ggplot2)

filtered_data <- FlucTotIV_clean_investigate %>%
  group_by(ID, OCC) %>%
  filter(unique_CREAT > 1 & sum(CREAT3_observed == 0) > 0 & sum(CREAT3_observed == 1) > 0) %>%
  ungroup()

```

```{r use tidyr convert filtered_data from wide to long format}
library(tidyr)

# Eliminate former CKDEPI column
filtered_data$CKDEPI<-NULL

# This code is used to plot all the imputed values at once
filtered_data_long <- filtered_data  %>%
  pivot_longer(
    cols = starts_with("CKDEPI"),
    names_to = "Imputation",
    names_prefix = "CKDEPI",
    values_to = "CKDEPI",
    values_drop_na = TRUE
  )

```

```{r plot all the imputed CKDEPI at once}
library(ggplot2)
# CKDEPI plot
CKDEPI_plot <- ggplot(filtered_data_long, aes(x = TIME, y = CKDEPI, color = factor(CREAT3_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME",
       x = "Time (h)", y = "CKDEPI (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI_plot

# Export the plot to a high-quality image
# pmm method
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI_plot_pmm.png", plot = CKDEPI_plot, dpi = 300, width = 10, height = 8)

# Bayesian linear regression - norm method
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI_plot_norm.png", plot = CKDEPI_plot, dpi = 300, width = 10, height = 8)

```

#### Building a linear/non-linear (mixed) effect model for imputation 310723

##### Adding dosing interval as a predictor for the final imputation model in Fluconazole120423.Rmd file 180723

```{r creating dosing_interval column}
library(dplyr)

# Create the dosing_interval column
new_column <- FlucTotIV_clean %>% 
  filter(!is.na(AMT)) %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(dosing_interval = TIME - lag(TIME))

# Create the dosing_interval column 080823
new_column <- FlucTotIV_clean %>% 
  filter(AMT!=0) %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(dosing_interval = TIME - lag(TIME))

# Merge the new column with the original FlucTotIV_clean data
FlucTotIV_clean <- FlucTotIV_clean %>%
  left_join(new_column %>% select(ID, TIME, dosing_interval), by = c("ID", "TIME"))

# View the updated FlucTotIV_clean data
View(FlucTotIV_clean)

# Fill all the remaining missing dosing_interval with 0 #Scenario 1
FlucTotIV_clean$dosing_interval<-ifelse(is.na(FlucTotIV_clean$dosing_interval),0,FlucTotIV_clean$dosing_interval)

# Instead of doing scenario 1, I will try scenario 2 where only the values of rows having TIME=0 be assigned to 0 - 140823

FlucTotIV_clean$dosing_interval<-ifelse(FlucTotIV_clean$TIME==0,0,FlucTotIV_clean$dosing_interval)

```

###### Convert all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0

```{r convert NAs to 0}
FlucTotIV_clean$TAD[is.na(FlucTotIV_clean$TAD)] <- 0
FlucTotIV_clean$AMT[is.na(FlucTotIV_clean$AMT)] <- 0
FlucTotIV_clean$RATE[is.na(FlucTotIV_clean$RATE)] <- 0

```

```{r convert DV to 0 where TIME equals 0}
FlucTotIV_clean$DV[FlucTotIV_clean$TIME == 0] <- 0

```

```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))

```

```{r best imputation crrt dataset}
impute_CREAT3_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT3")]

impute_CREAT3_crrt_ID <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT3","ID")]

```

```{r best imputation nocrrt dataset}
impute_CREAT3_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT3")]

impute_CREAT3_nocrrt_ID <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT3","ID")]

```

##### Performing imputation

```{r for impute_CREAT3_crrt dataset norm method}
library(mice)
set.seed(123)
imputed_CREAT3_crrt<- mice(impute_CREAT3_crrt, m = 10,maxit=20,method="norm",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_crrt, action = i))$CREAT3
}

```

```{r for impute_CREAT3_crrt dataset norm.predict method}
# norm.predict - Linear regression, predicted values

library(mice)
set.seed(123)
imputed_CREAT3_crrt<- mice(impute_CREAT3_crrt, m = 10,maxit=20,method="norm.predict",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_crrt, action = i))$CREAT3
}

```

```{r for impute_CREAT3_nocrrt dataset norm method}
library(mice)
set.seed(123)
imputed_CREAT3_nocrrt<- mice(impute_CREAT3_nocrrt, m = 10,maxit=20,method="norm",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_nocrrt, action = i))$CREAT3
}

```

```{r for impute_CREAT3_nocrrt dataset norm.predict method}
library(mice)
set.seed(123)
imputed_CREAT3_nocrrt<- mice(impute_CREAT3_nocrrt, m = 10,maxit=20,method="norm.predict",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_nocrrt, action = i))$CREAT3
}

```

##### Combining two imputed dataset

```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Norm method surpasses pmm if the variable is close to normally distributed (cf. vanbuuren's book 6.3.1)

```{r check if CREAT3 is normally distributed}
hist(FlucTotIV_clean$CREAT3) #very skewed

FlucTotIV_clean$Log_CREAT3<-log(FlucTotIV_clean$CREAT3) #log-transform to be normally distributed

hist(FlucTotIV_clean$Log_CREAT3)

shapiro.test(FlucTotIV_clean$Log_CREAT3)

```

###### Generating multiple CKDEPI over dosing intervals plot 070823

```{r calculating CKDEPI based on new equations}
# 070823 code

FlucTotIV_clean$CKDEPI <- ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT < 0.9,(142) * ((FlucTotIV_clean$CREAT/0.9)^-0.302) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT >= 0.9,(142) * ((FlucTotIV_clean$CREAT/0.9)^-1.200) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 2 & FlucTotIV_clean$CREAT < 0.7, (142) * ((FlucTotIV_clean$CREAT/0.7)^-0.241) * (0.9938^FlucTotIV_clean$AGE)*1.012, (142) * ((FlucTotIV_clean$CREAT/0.7)^-1.200) * (0.9938^FlucTotIV_clean$AGE)*1.012)))

```

```{r multiple CREAT over dosing intervals plot}
library(dplyr)
multiple_CKDEPI_int <- FlucTotIV_clean %>% #multiple CKDEPI values per a dosing interval dataset
group_by(ID, OCC) %>%
filter(n_distinct(CREAT, na.rm = TRUE) > 1) %>%
filter(!is.na(CREAT))
View(multiple_CKDEPI_int)

# Plot CREAT over TIME for each ID and OCC pair
plot_mul_CREAT <- multiple_CKDEPI_int %>%
ggplot(aes(x = TIME, y = CREAT, group = ID, color = factor(ID))) +
geom_line() +
geom_point() +
facet_wrap(~ ID + OCC, scales = "free") +
labs(title = "CREAT over Time for ID and OCC pairs with multiple CREAT values",
x = "Time", y = "CREAT") +
theme_minimal()
plot_mul_CREAT

# Plot CKDEPI over TIME for each ID and OCC pair
plot_mul_CKDEPI<- multiple_CKDEPI_int %>%
ggplot(aes(x = TIME, y = CKDEPI, group = ID, color = factor(ID))) +
geom_line() +
geom_point() +
facet_wrap(~ ID + OCC, scales = "free") +
labs(title = "CKDEPI over Time for ID and OCC pairs with multiple CREAT values",
x = "Time", y = "CKDEPI") +
theme_minimal()
plot_mul_CKDEPI

# Save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("multiple_CKDEPI_int.png", plot = plot_mul_CKDEPI, dpi = 300, width = 10, height = 8)

```

###### Calculating delta_ckdepi within dosing intervals 070823

```{r delta CKDEPI of the maximum and minimum CKDEPI within a dosing interval}
library(dplyr)

# Creating a dataset
delta_CKDEPI <- multiple_CKDEPI_int %>%
  group_by(ID, OCC) %>%
  summarize(Delta_CKDEPI = max(CKDEPI, na.rm = TRUE) - min(CKDEPI, na.rm = TRUE))

# calculate within dosing intervals variability (WIV)
wiv<- mean(delta_CKDEPI$Delta_CKDEPI) #7.638913

# View the resulting dataset
View(delta_CKDEPI)

wiv

```

###### Calculating delta_ckdepi between dosing intervals 070823

```{r delta CKDEPI of the maximum and minimum CKDEPI between dosing interval per patient}

library(dplyr)

# between dosing interval variability in CKDEPI of a patient
bet_int_var <- FlucTotIV_clean %>%
  filter(unique_CREAT == 1) %>%
  group_by(ID) %>%
  summarize(delta_ckdepi = max(CKDEPI, na.rm = TRUE) - min(CKDEPI, na.rm = TRUE))

# View the resulting bet_int_var dataset
View(bet_int_var)

# between interval variability (biv)
biv<-mean(bet_int_var$delta_ckdepi[bet_int_var$delta_ckdepi!=0])
biv #22.21876

```

###### Calculating delta_ckdepi between dosing intervals of imputed values (pmm method) 070823

```{r read the first imputed dataset}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
Fluc_NONMEM_mul_impute_BW01 <- read.csv("Fluc_NONMEM_mul_impute_BW01.csv")

```

```{r creating unique_CREAT column for the 1st imputed dataset}
Fluc_NONMEM_mul_impute_BW01 <- Fluc_NONMEM_mul_impute_BW01 %>%
group_by(ID, OCC) %>%
mutate(unique_CREAT = sum(CREAT!=-99)
)

```

```{r delta CKDEPI of the maximum and minimum imputed CKDEPI between dosing intervals per patient}

library(dplyr)

# Creating bet_int_var_imputed dataset, calculating between dosing interval variation of the imputed CKDEPI values
bet_int_var_imputed <- Fluc_NONMEM_mul_impute_BW01 %>%
  filter(unique_CREAT == 0) %>%
  group_by(ID) %>%
  summarize(across(starts_with("CKDEPI"), ~ max(.) - min(.), na.rm = TRUE))

# View the resulting dataset
View(bet_int_var_imputed)

# between interval variability (biv) of CKDEPI01 to CKDEPI10 within a single patient

library(dplyr)

# Calculate the average of CKDEPI01 to CKDEPI10 values excluding cells with 0
average_excluding_zero <- bet_int_var_imputed %>%
  summarize(across(starts_with("CKDEPI"), ~ mean(.[. != 0], na.rm = TRUE)))

# View the resulting average
View(average_excluding_zero)

```

###### Calculating delta_ckdepi between dosing intervals of imputed values (norm method) 080823

```{r read the first imputed dataset}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
Fluc_NONMEM_mul_impute_BW01_norm <- read.csv("Fluc_NONMEM_mul_impute_BW01_norm.csv")

```

```{r creating unique_CREAT column for the 1st imputed dataset}
Fluc_NONMEM_mul_impute_BW01_norm <- Fluc_NONMEM_mul_impute_BW01_norm %>%
group_by(ID, OCC) %>%
mutate(unique_CREAT = sum(CREAT!=-99)
)

```

```{r delta CKDEPI of the maximum and minimum imputed CKDEPI between dosing intervals per patient}

library(dplyr)

# Creating bet_int_var_imputed dataset, calculating between dosing interval variation of the imputed CKDEPI values
bet_int_var_imputed <- Fluc_NONMEM_mul_impute_BW01_norm %>%
  filter(unique_CREAT == 0) %>%
  group_by(ID) %>%
  summarize(across(starts_with("CKDEPI"), ~ max(.) - min(.), na.rm = TRUE))

# View the resulting dataset
View(bet_int_var_imputed)

# between interval variability (biv) of CKDEPI01 to CKDEPI10 within a single patient

library(dplyr)

# Calculate the average of CKDEPI01 to CKDEPI10 values excluding cells with 0
average_excluding_zero <- bet_int_var_imputed %>%
  summarize(across(starts_with("CKDEPI"), ~ mean(.[. != 0], na.rm = TRUE)))

# View the resulting average
View(average_excluding_zero)

average_excluding_zero_norm<-average_excluding_zero

```

###### Imputation using FCS-LMM method - mice.impute.2 l.pan function

```{r Imputation of Missing Data in Chronic Hepatitis C Patient Utility Data - appendix}
imp0 <- mice(impute_CREAT3_crrt_ID  , maxit=0)

predmat <- imp0$predictorMatrix
predmat["CREAT3","ID"] <- -2

meth <- imp0$method
meth["CREAT3"] <- "2l.pan"

# use imputation to impute missing values
library(mice)
imputed_CREAT3_crrt <- mice::mice(data=impute_CREAT3_crrt_ID,method=meth,
                       predictorMatrix=predmat,
                       maxit=20,m=10,
                       printFlag=TRUE)

imp0 <- mice(impute_CREAT3_nocrrt_ID  , maxit=0)

predmat <- imp0$predictorMatrix
predmat["CREAT3","ID"] <- -2

meth <- imp0$method
meth["CREAT3"] <- "2l.pan"

# use imputation to impute missing values

imputed_CREAT3_nocrrt <- mice::mice(data=impute_CREAT3_nocrrt_ID,method=meth,
                       predictorMatrix=predmat,
                       maxit=20,m=10,
                       printFlag=TRUE)


```


###### Redundant code

```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT) + dosing_interval, data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)
# I will forget this for a moment and select norm method (bayesian normal imputation method) for imputing CREAT3

```

```{r explore the missing data pattern after imputing}
library(table1)
table1(~ CREAT + CREAT_DOS_INT | HOSPITAL, data=FlucTotIV_clean,
       render.continuous=c(.="Median [Q1-Q3]"))
# Missingness goes from 81.1 to 59.3%

```

```{r make the plot for CREAT2 }

# Filter the rows with unique_CREAT > 1
library(dplyr)

filtered_data <- FlucTotIV_clean_investigate %>%
  group_by(ID, OCC) %>%
  filter(unique_CREAT > 1 & sum(CREAT2_observed == 0) > 0 & sum(CREAT2_observed == 1) > 0) %>%
  ungroup()

```

```{r plot of multiple observed CREAT2 over dosing intervals}
filtered_data_observed <- FlucTotIV_clean %>%
group_by(ID, OCC) %>%
filter(n_distinct(CREAT2, na.rm = TRUE) > 1) %>%
filter(!is.na(CREAT2))
View(filtered_data_observed)

```

```{r adding new column CREAT2_observed}
FlucTotIV_clean$CREAT2_observed <- ifelse(is.na(FlucTotIV_clean$CREAT2), 0, 1)

```

```{r redundant code}
### Following this is a very long code

# Plot CKDEPI01 over TIME, differentiating by CREAT2_observed
CKDEPI01_plot<-ggplot(filtered_data, aes(x = TIME, y = CKDEPI01, color = factor(CREAT2_observed))) +  geom_point() +
  facet_wrap(~ ID + OCC, scales="free") +
  labs(title = "CKDEPI over TIME 01",
       x = "Time (h)", y = "CKDEPI01 (mL/min/1.73 m2") +
  scale_color_discrete(name = "Creatinin Observed", labels = c("No", "Yes")) +
  theme_minimal()

# Load necessary libraries
library(ggplot2)
library(ggsave)

# Create the plot 01
CKDEPI01_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI01, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 01",
       x = "Time (h)", y = "CKDEPI01 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI01_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI01_plot.png", plot = CKDEPI01_plot, dpi = 300, width = 10, height = 8)

# Load necessary libraries
library(ggplot2)
library(ggsave)

# Define the column names for CKDEPI02 to CKDEPI10
ckdepi_cols <- paste0("CKDEPI", sprintf("%02d", 2:10))

# Loop through the columns and create the plots
for (col in ckdepi_cols) {
  # Create the plot
  plot <- ggplot(filtered_data, aes(x = TIME, y = .data[[col]], color = factor(CREAT2_observed))) +
    geom_point() +
    facet_wrap(~ ID + OCC, scales = "free") +
    labs(title = paste("CKDEPI over TIME", substr(col, 7), sep = " "),
         x = "Time (h)", y = paste(col, "(mL/min/1.73 m²)", sep = " "),
         color = "Creatinin Observed") +
    scale_color_discrete(labels = c("No", "Yes")) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))

  # Print the plot
  print(plot)

  # Export the plot to a high-quality image
  ggsave(paste0("CKDEPI", substr(col, 7), "_plot.png"), plot = plot, dpi = 300, width = 10, height = 8)
}

# CKDEPI 02
CKDEPI02_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI02, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 02",
       x = "Time (h)", y = "CKDEPI02 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI02_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI02_plot.png", plot = CKDEPI02_plot, dpi = 300, width = 10, height = 8)

# CKDEPI 03
CKDEPI03_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI03, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 03",
       x = "Time (h)", y = "CKDEPI03 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI03_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI03_plot.png", plot = CKDEPI03_plot, dpi = 300, width = 10, height = 8)

# CKDEPI 04
CKDEPI04_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI04, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 04",
       x = "Time (h)", y = "CKDEPI04 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI04_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI04_plot.png", plot = CKDEPI04_plot, dpi = 300, width = 10, height = 8)

# CKDEPI 05
CKDEPI05_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI05, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 05",
       x = "Time (h)", y = "CKDEPI05 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI05_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI05_plot.png", plot = CKDEPI05_plot, dpi = 300, width = 10, height = 8)

CKDEPI06_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI06, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 06",
       x = "Time (h)", y = "CKDEPI06 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI06_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI06_plot.png", plot = CKDEPI06_plot, dpi = 300, width = 10, height = 8)

CKDEPI06_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI06, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 06",
       x = "Time (h)", y = "CKDEPI06 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI06_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI06_plot.png", plot = CKDEPI06_plot, dpi = 300, width = 10, height = 8)

#CKDEPI07
CKDEPI07_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI07, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 07",
       x = "Time (h)", y = "CKDEPI07 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI07_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI07_plot.png", plot = CKDEPI07_plot, dpi = 300, width = 10, height = 8)

# CKDEPI08
CKDEPI08_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI08, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 08",
       x = "Time (h)", y = "CKDEPI08 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI08_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI08_plot.png", plot = CKDEPI08_plot, dpi = 300, width = 10, height = 8)

# CKDEPI09
CKDEPI09_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI09, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 09",
       x = "Time (h)", y = "CKDEPI09 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI09_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI09_plot.png", plot = CKDEPI09_plot, dpi = 300, width = 10, height = 8)

# CKDEPI10
CKDEPI10_plot <- ggplot(filtered_data, aes(x = TIME, y = CKDEPI10, color = factor(CREAT2_observed))) + 
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CKDEPI over TIME 10",
       x = "Time (h)", y = "CKDEPI10 (mL/min/1.73 m²)",
       color = "Creatinin Observed") +  # Move color to the labs function
  scale_color_discrete(labels = c("No", "Yes")) +  # Move labels to scale_color_discrete
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

# Print the plot
CKDEPI10_plot

# Export the plot to a high-quality image
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
ggsave("CKDEPI10_plot.png", plot = CKDEPI10_plot, dpi = 300, width = 10, height = 8)

```

###### Plot CREAT over TIME for dos_int having more than 1 CREAT, disuss with Erwin 180723 

```{r how many dos_int has more than 1 CREAT, warning=FALSE}
#dosing intervals having more than 1 CREAT values
library(dplyr)

FlucTotIV_clean %>% filter(!is.na(AMT)) %>% filter (unique_CREAT>1) #24
24/1554 #1.5% of all dosing intervals containing more than 1 CREAT values

```

```{r CREAT over TIME per each ID&OCC}
library(dplyr)
library(ggplot2)

# Filter rows with unique_CREAT > 1
filtered_data <- FlucTotIV_clean %>%
  group_by(ID, OCC) %>%
  filter(n_distinct(CREAT, na.rm = TRUE) > 1) %>%
  ungroup()

# Plot CREAT over TIME for each ID and OCC pair
plot_data <- filtered_data %>%
  ggplot(aes(x = TIME, y = CREAT, group = ID, color = factor(ID))) +
  geom_line() +
  geom_point() +
  facet_wrap(~ ID + OCC, scales = "free") +
  labs(title = "CREAT over Time for ID and OCC pairs with unique_CREAT > 1",
       x = "Time", y = "CREAT") +
  theme_minimal()

# Display the plot
print(plot_data)

# CREAT fluctuates all over the place

```


###### Missingness drops from 81.1% to 59.3%, I will employ 70 impuptations (no, I have to impute at a between-dosing interval level)

###### Check missingness among all the dosing intervals 140723

```{r missingness among all dosing intervals}
library(dplyr)

CREAT_DOS_INT_subset <- FlucTotIV_clean %>%
  distinct(ID, OCC, CREAT_DOS_INT, .keep_all = TRUE) #extract all the rows with unique combination of ID, OCC, CREAT_DOS_INT

library(table1)
table1(~ CREAT + CREAT_DOS_INT | HOSPITAL, data=CREAT_DOS_INT_subset,
       render.continuous=c(.="Median [Q1-Q3]"))
# Missingness goes from 81.2 to 62.0%

```

#### Imputation step (adapted from Fluconazole120423.Rmd file) - 140723 - but for CREAT_DOS_INT_subset dataset

##### Firstly, I will create 2 datasets, crrt and no crrt datasets

```{r convert data types,warning=FALSE}
CREAT_DOS_INT_subset$AGE <- as.numeric(CREAT_DOS_INT_subset$AGE)
CREAT_DOS_INT_subset$LENGTH <- as.numeric(CREAT_DOS_INT_subset$LENGTH)
CREAT_DOS_INT_subset$BW2 <- as.numeric(CREAT_DOS_INT_subset$BW2)
CREAT_DOS_INT_subset$DV <- as.numeric(CREAT_DOS_INT_subset$DV)
CREAT_DOS_INT_subset$TIME <- as.numeric(CREAT_DOS_INT_subset$TIME)
CREAT_DOS_INT_subset$CREAT_DOS_INT <- as.numeric(CREAT_DOS_INT_subset$CREAT_DOS_INT)
CREAT_DOS_INT_subset$SEX <- as.factor(CREAT_DOS_INT_subset$SEX)
CREAT_DOS_INT_subset$HOSPITAL <- as.factor(CREAT_DOS_INT_subset$HOSPITAL)
CREAT_DOS_INT_subset$CRRT <- as.factor(CREAT_DOS_INT_subset$CRRT)
CREAT_DOS_INT_subset$OCC <- as.factor(CREAT_DOS_INT_subset$OCC)
CREAT_DOS_INT_subset$EVID <- as.factor(CREAT_DOS_INT_subset$EVID)
CREAT_DOS_INT_subset$TAD <- as.numeric(CREAT_DOS_INT_subset$TAD)
CREAT_DOS_INT_subset$AMT <- as.numeric(CREAT_DOS_INT_subset$AMT)
CREAT_DOS_INT_subset$RATE <- as.numeric(CREAT_DOS_INT_subset$RATE)

```

###### Convert all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0

```{r convert NAs to 0}
CREAT_DOS_INT_subset$TAD[is.na(CREAT_DOS_INT_subset$TAD)] <- 0
CREAT_DOS_INT_subset$AMT[is.na(CREAT_DOS_INT_subset$AMT)] <- 0
CREAT_DOS_INT_subset$RATE[is.na(CREAT_DOS_INT_subset$RATE)] <- 0

```

```{r convert DV to 0 where TIME equals 0}
CREAT_DOS_INT_subset$DV[CREAT_DOS_INT_subset$TIME == 0] <- 0

```

```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(CREAT_DOS_INT_subset[CREAT_DOS_INT_subset$CRRT == 1, "ID"])
CREAT_DOS_INT_subset_crrt<-CREAT_DOS_INT_subset%>%filter(ID%in%crrt_patients$ID)
CREAT_DOS_INT_subset_nocrrt<-CREAT_DOS_INT_subset%>%filter(!ID%in%(crrt_patients$ID))

```

##### Then I build the imputation model for crrt dataset

###### My first lm_crrt_1 model (which include all the possible predictors as above)

```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+TAD+CRRT+HOSPITAL, data = CREAT_DOS_INT_subset_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

```

###### Note, if I do imputation like this, there will be too few DV in the model (because essentially my CREAT_DOS_INT_subset_crrt dataset only involves dosing events). So I would do another strategy instead. It is imputing for the whole dataset, and take the average of the imputed CREAT_DOS_INT values per each dosing interval as the final value to be included in the popPK analysis

###### Important note 140723 15:12 (This is actually similar to what I did with BW and LENGTH)

#### Redo the imputation based on the aforementioned strategy (adapted from Fluconazole120423.Rmd file) - 140723 - FlucTotIV_clean dataset

##### Firstly, I will create 2 datasets, crrt and no crrt datasets

```{r convert data types,warning=FALSE}
FlucTotIV_clean$AGE <- as.numeric(FlucTotIV_clean$AGE)
FlucTotIV_clean$LENGTH <- as.numeric(FlucTotIV_clean$LENGTH)
FlucTotIV_clean$BW2 <- as.numeric(FlucTotIV_clean$BW2)
FlucTotIV_clean$DV <- as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$TIME <- as.numeric(FlucTotIV_clean$TIME)
FlucTotIV_clean$CREAT_DOS_INT <- as.numeric(FlucTotIV_clean$CREAT_DOS_INT)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
FlucTotIV_clean$EVID <- as.factor(FlucTotIV_clean$EVID)
FlucTotIV_clean$TAD <- as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean$RATE <- as.numeric(FlucTotIV_clean$RATE)

```

###### Convert all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0

```{r convert NAs to 0}
FlucTotIV_clean$TAD[is.na(FlucTotIV_clean$TAD)] <- 0
FlucTotIV_clean$AMT[is.na(FlucTotIV_clean$AMT)] <- 0
FlucTotIV_clean$RATE[is.na(FlucTotIV_clean$RATE)] <- 0

```

```{r convert DV to 0 where TIME equals 0}
FlucTotIV_clean$DV[FlucTotIV_clean$TIME == 0] <- 0

```

###### Creating crrt and non-crrt datasets

```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))

```

##### Then I build the imputation model for crrt dataset
##### These following codes are incorrect

###### My first lm_crrt_1 model (which include all the possible predictors as above)

```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+TAD+CRRT+HOSPITAL, data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

```


###### AIC of lm_crrt_1 model equals 605, adjusted R-squared is 0.18  This is not bad.

###### My second lm_crrt_2 model, which is lm_crrt_1 removing TAD

```{r lm_crrt_2 linear model}
lm_crrt_2 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+CRRT+HOSPITAL, data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)

## Model with dosing_interval as a predictor 140823

# Testing 2nd scenario (cf above)
lm_crrt_2_dos_int = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+CRRT+HOSPITAL+dosing_interval, data = FlucTotIV_clean_crrt)
summary(lm_crrt_2_dos_int)
AIC(lm_crrt_2_dos_int)

# Very poor model with NA - Had better go with 1st scenario like before

```

###### AIC of lm_crrt_2 model equals 604, adjusted R-squared is 0.18, which is better than lm_crrt_1

###### AIC of lm_crrt_2_dos_int model equals 606, adjusted R-squared is 0.18, which is slightly worse than lm_crrt_2 above - 140823

###### My third lm_crrt_3 model, which is lm_crrt_2 removing HOSPITAL

```{r lm_crrt_3 linear model}
lm_crrt_3 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+CRRT, data = FlucTotIV_clean_crrt)
summary(lm_crrt_3)
AIC(lm_crrt_3)

```

###### AIC of lm_crrt_3 model equals 607, adjusted R-squared is 0.16, which is worse than lm_crrt_2

```{r lm_crrt_2 model diagnostic}
qqnorm(residuals(lm_crrt_2), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt_2), col = "steelblue", lwd = 2)

```

###### It looks normal, normality assumption therefore holds.

###### Therefore, lm_crrt_2 will be my final imputation model for crrt dataset. The predictors for final imputation crrt dataset model are TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+CRRT+HOSPITAL

```{r best imputation crrt dataset}
impute_CREAT_DOS_INT_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","OCC","HOSPITAL","CREAT_DOS_INT")]

```

```{r best imputation crrt dataset with dosing_interval}
## Now I add dosing_interval as a predictor, and use pmm method 080823

impute_CREAT_DOS_INT_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","OCC","HOSPITAL","CREAT_DOS_INT","dosing_interval")]

```

##### After that, I build the imputation model for no-crrt dataset

###### My first lm_nocrrt_1 model (which include all the possible predictors as above, not including CRRT of course)

```{r lm_nocrrt_1 linear model}
lm_nocrrt_1 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_1)
AIC(lm_nocrrt_1)

```
###### AIC of lm_nocrrt_1 model equals 1160, adjusted R-squared is 0.305

###### My second lm_nocrrt_2 model, which is lm_nocrrt_1 removing TAD

```{r lm_nocrrt_2 linear model}
lm_nocrrt_2 = lm(CREAT_DOS_INT ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_2)
AIC(lm_nocrrt_2)

```

###### AIC of lm_nocrrt_2 model equals 1158, adjusted R-squared is 0.306, which is better than lm_nocrrt_1

```{r lm_nocrrt_2 model diagnostic}
qqnorm(residuals(lm_nocrrt_2), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt_2), col = "steelblue", lwd = 2)

```

###### It looks quite normal, normality assumption therefore holds.

###### Therefore, lm_nocrrt_2 will be my final imputation model for nocrrt dataset. The predictors for final imputation no-crrt dataset model are TIME + AMT + RATE + DV + AGE + BW2 + factor(SEX) + LENGTH + factor(OCC) + factor(HOSPITAL) 

###### Best imputation nocrrt dataset

```{r best imputation nocrrt dataset}
impute_CREAT_DOS_INT_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","OCC","HOSPITAL","CREAT_DOS_INT")]

```

```{r best imputation nocrrt dataset with dosing_interval}
## Now I add dosing_interval as a predictor, and use pmm method 080823 (similar to above)

impute_CREAT_DOS_INT_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","OCC","HOSPITAL","CREAT_DOS_INT","dosing_interval")]

```

##### Then imputing crrt and non-crrt models using pmm default method

```{r for impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r for imputed_CREAT_DOS_INT_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Then imputing crrt and non-crrt models using norm method (bayesian linear regression) - 080823

```{r for impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt,m = 10,maxit=20,method="norm",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r for imputed_CREAT_DOS_INT_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,method="norm",printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

#### Creat imputation datasets step 

##### Here I will set up a new working directory where I save all the imputed datasets using the aforementioned strategy. The minimum number of imputations is 70, so at least 7 datasets, 10 imputations each

#### First of all, my first imputed dataset (imputation 1st to 10th)

##### Firstly, for FlucTotIV_clean_crrt dataset

##### With this, I just need to continue from above by adding BW and LENGTH

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

# Change the maximum number of columns displayed, e.g. 1000
rstudioapi::writeRStudioPreference("data_viewer_max_columns", 1000L)
View(FlucTotIV_clean_imputed)

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Average CREAT per each ID and OCC, in rows that have CREAT_DOS_INT == NA
##### This is not something to worry about, I was worry for nothing!
##### I was wrong again! Average CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

# It looks correct, perfect! 150723 14:03

```


#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r median of observed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01[!is.na(Fluc_NONMEM_mul_impute$CREAT_DOS_INT)]) #89
# Why is it a bit different than before?

```


##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```
##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW01 dataset, warning=FALSE}

## When using pmm method
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW01.csv",quote=F,row.names = FALSE)

## When using norm method
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW01_norm.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW01.csv",quote=F,row.names = FALSE)

```

#### Second of all, my second imputed dataset (imputation 11th to 20th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(124)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(124)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```
##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
## Model without dosing_interval as a predictor
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW02.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW02.csv",quote=F,row.names = FALSE)

```

#### Third of all, my third imputed dataset (imputation 21st to 30th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(125)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(125)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW03.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW03.csv",quote=F,row.names = FALSE)

```

#### Fourth of all, my fourth imputed dataset (imputation 31st to 40th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(126)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(126)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
# Model without dosing_interval
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW04.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW04.csv",quote=F,row.names = FALSE)

```

#### Fifth of all, my fifth imputed dataset (imputation 41st to 50th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(127)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(127)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
## Model without dosing_interval
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW05.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW05.csv",quote=F,row.names = FALSE)

```

#### Sixth of all, my sixth imputed dataset (imputation 51st to 60th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(128)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(128)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
# Model without dosing_interval
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW06.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW06.csv",quote=F,row.names = FALSE)

```

#### Seventh of all, my seventh imputed dataset (imputation 61st to 70th)

```{r imputing impute_CREAT_DOS_INT_crrt dataset}
library(mice)
set.seed(129)
imputed_CREAT_DOS_INT_crrt<- mice(impute_CREAT_DOS_INT_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r imputing impute_CREAT_DOS_INT_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(129)
imputed_CREAT_DOS_INT_nocrrt<- mice(impute_CREAT_DOS_INT_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$LENGTH
}

```

```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$BW2
}

```

```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$LENGTH
}

```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

##### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing}
library(dplyr)

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))

```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

##### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

##### Exporting the dataset

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT")]

```

```{r Fluc_NONMEM_mul_impute_BW02 dataset, warning=FALSE}
# Model without dosing_interval
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW07.csv",quote=F,row.names = FALSE)

## Exporting NONMEM dataset for models with dosing_interval as a predictor - 140823
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW07.csv",quote=F,row.names = FALSE)

```

##### Within-day imputation 170723, try later

```{r read the dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")
View(FlucTotIV_clean)

```

```{r new variable CREAT_DOS_INT, warning=FALSE}
#CREAT_DOS_INT using within dosing-interval imputation
library(dplyr)

FlucTotIV_clean$CREAT_DOS_INT <- FlucTotIV_clean$CREAT

FlucTotIV_clean <- FlucTotIV_clean %>%
  group_by(ID, OCC) %>%
  mutate(unique_CREAT = sum(!is.na(CREAT)))

FlucTotIV_clean <- FlucTotIV_clean %>%
  group_by(ID, OCC) %>%
  mutate(
    CREAT_DOS_INT = ifelse(unique_CREAT == 1, CREAT[!is.na(CREAT)],
                           ifelse((is.na(CREAT_DOS_INT) & unique_CREAT > 1),mean(CREAT[!is.na(CREAT)], na.rm = TRUE),CREAT_DOS_INT)
  )
)

```

```{r explore the missing data pattern after imputing}
library(table1)
table1(~ CREAT + CREAT_DOS_INT | HOSPITAL, data=FlucTotIV_clean,
       render.continuous=c(.="Median [Q1-Q3]"))
# Missingness goes from 81.1 to 59.3%

```

###### I decided to build imputation models based on CRRT status (whether a patient has at least 1 CRRT session), and the predictors that I will be using will be restricted to "TIME", "AMT", "RATE", "DV", "AGE", "BW2", "SEX", "LENGTH", "HOSPITAL", "OCC", "TAD", "CRRT", "CREAT2" 

##### Firstly, I will create 2 datasets, crrt and no crrt datasets

```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))

```

##### Then I build the imputation model for crrt dataset
##### I will have the same imputation model for crrt dataset as above, which is lm_crrt_4 as below
###### My first lm_crrt_1 model (which include all the possible predictors as above)
```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL), data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+SEX+LENGTH+OCC+TAD+CRRT+HOSPITAL, data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)


```
###### AIC of lm_crrt_1 model equals 352, adjusted R-squared is -0.02
###### It is too bad!

###### My second lm_crrt_2 model, which is lm_crrt_1 removing HOSPITAL
```{r lm_crrt_2 linear model}
lm_crrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)
```

###### AIC of lm_crrt_2 model equals 347, adjusted R-squared is 0.014, which is better than lm_crrt_1

###### My third lm_crrt_3 model, which is lm_crrt_2 removing OCC
```{r lm_crrt_3 linear model}
lm_crrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_3)
AIC(lm_crrt_3)
```
###### AIC of lm_crrt_3 model equals 315.3, adjusted R-squared is 0.1405, which is better than lm_crrt_2

##### My fourth lm_crrt_4 model, which is lm_crrt_3 removing TAD
```{r lm_crrt_4 linear model}
lm_crrt_4 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_4)
AIC(lm_crrt_4)

```

```{r lm_crrt_4 linear model}
lm_crrt_4 = lm(CREAT3 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_4)
AIC(lm_crrt_4)

```

##### AIC of lm_crrt_4 model equals 313.3, adjusted R-squared is 0.150
##### AIC of lm_crrt_4 model equals 367.4, adjusted R-squared is 0.160

```{r lm_crrt_4 model diagnostic}
qqnorm(residuals(lm_crrt_4), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt_4), col = "steelblue", lwd = 2)

```

###### It looks normal, normality assumption therefore holds.
###### Therefore, lm_crrt_4 will be my final imputation model for crrt dataset. The predictors for final imputation crrt dataset model are TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT)

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]

```

```{r best imputation crrt dataset}
impute_CREAT3_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT3")]

```

###### Here I test lm_crrt_1 belows (the model with all the possible predictors)

```{r best imputation crrt dataset}
impute_CREAT3_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","OCC","TAD","HOSPITAL","CRRT","dosing_interval","CREAT3")]

```

##### After that, I build the imputation model for no-crrt dataset
###### My first lm_nocrrt_1 model (which include all the possible predictors as above, not including CRRT of course) 

```{r lm_nocrrt_1 linear model}
lm_nocrrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_1)
AIC(lm_nocrrt_1)

```

###### AIC of lm_nocrrt_1 model equals 704, adjusted R-squared is 0.160

###### My second lm_nocrrt_2 model, which is lm_nocrrt_1 removing OCC

```{r lm_nocrrt_2 linear model}
lm_nocrrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_2)
AIC(lm_nocrrt_2)

```

```{r lm_nocrrt_2 linear model}
lm_nocrrt_2 = lm(CREAT3 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_2)
AIC(lm_nocrrt_2)

```

###### AIC of lm_nocrrt_2 model equals 669.8, adjusted R-squared is 0.186, which is a lot better than lm_nocrrt_1

###### My third lm_nocrrt_3 model, which is lm_nocrrt_2 removing TAD

```{r lm_nocrrt_3 linear model}
lm_nocrrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_3)
AIC(lm_nocrrt_3)

```

```{r lm_nocrrt_3 linear model}
lm_nocrrt_3 = lm(CREAT3 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_3)
AIC(lm_nocrrt_3)

```

###### AIC of lm_nocrrt_3 model equals 669.3, adjusted R-squared is 0.185, which is a slightly worse than lm_nocrrt_2

```{r lm_nocrrt_2 model diagnostic}
qqnorm(residuals(lm_nocrrt_2), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt_2), col = "steelblue", lwd = 2)

```

###### It looks quite normal, normality assumption therefore holds.
###### Therefore, lm_nocrrt_2 will be my final imputation model for nocrrt dataset. The predictors for final imputation no-crrt dataset model are TIME + AMT + RATE + DV + AGE + BW2 + factor(SEX) + LENGTH + TAD + factor(HOSPITAL) 

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]

```

```{r best imputation nocrrt dataset}
impute_CREAT3_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT3")]

```

###### Here I test lm_nocrrt_1 belows (the model with all the possible predictors)

```{r best imputation crrt dataset}
impute_CREAT3_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","OCC","TAD","HOSPITAL","dosing_interval","CREAT3")]

```

##### Then imputing crrt and non-crrt models

```{r for impute_CREAT2_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}

```

```{r for impute_CREAT3_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT3_crrt<- mice(impute_CREAT3_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_crrt, action = i))$CREAT3
}

```

```{r for impute_CREAT2_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}

```

```{r for impute_CREAT3_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT3_nocrrt<- mice(impute_CREAT3_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT3_nocrrt, action = i))$CREAT3
}

```

###### The number of logged events is much lower than before (400 compared to 1400)

##### Then combining these two crrt and non-crrt imputed dataset
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

##### Then check the imputation performation via diagnostic plots
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
###### This plot also looks better than before
###### I also made CREAT vs TIME plots (from Fluconazole.Rmd file), they look alright

##### Repeat the initial 100 imputations with additional predictor: dosing_interval - 190723

###### Building imputation models based on CRRT status (whether a patient has at least 1 CRRT session), and the predictors that I will be using will be restricted to "TIME", "AMT", "RATE", "DV", "AGE", "BW2", "SEX", "LENGTH", "HOSPITAL", "OCC", "TAD", "CRRT", "CREAT3", "dosing_interval" 

###### Firstly, I will create 2 datasets, crrt and no crrt datasets

```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))

```

###### Then I build the imputation model for crrt dataset

###### My first lm_crrt_1 model 

```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL), data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

```

```{r lm_crrt_1 linear model CREAT3}
lm_crrt_1 = lm(CREAT3 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL) + dosing_interval, data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

```

###### AIC of lm_crrt_1 model equals 352, adjusted R-squared is -0.02
###### It is too bad!

###### AIC of lm_crrt_1 model equals 354, adjusted R-squared is -0.037
###### It is too bad!

###### I will choose this for imputing - 310723

###### My second lm_crrt_2 model, which is lm_crrt_1 removing HOSPITAL
```{r lm_crrt_2 linear model}
lm_crrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)

```

```{r lm_crrt_2 linear model CREAT3}
lm_crrt_2 = lm(CREAT3 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+dosing_interval, data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)

```

###### AIC of lm_crrt_2 model equals 347, adjusted R-squared is 0.014, which is better than lm_crrt_1

###### My third lm_crrt_3 model, which is lm_crrt_2 removing OCC
```{r lm_crrt_3 linear model}
lm_crrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_3)
AIC(lm_crrt_3)

```
###### AIC of lm_crrt_3 model equals 315.3, adjusted R-squared is 0.1405, which is better than lm_crrt_2

##### My fourth lm_crrt_4 model, which is lm_crrt_3 removing TAD
```{r lm_crrt_4 linear model}
lm_crrt_4 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT) + dosing_interval, data = FlucTotIV_clean_crrt)
summary(lm_crrt_4)
AIC(lm_crrt_4)

```
##### AIC of lm_crrt_4 model equals 313.3, adjusted R-squared is 0.150

```{r lm_crrt_4 model diagnostic}
qqnorm(residuals(lm_crrt_4), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt_4), col = "steelblue", lwd = 2)

```
###### It looks normal, normality assumption therefore holds.
###### Therefore, lm_crrt_4 will be my final imputation model for crrt dataset. The predictors for final imputation crrt dataset model are TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT)

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]

```

### Vignette 01 - Ad hoc methods and the MICE algorithm

##### Inspect the missing data pattern

```{r using md.pattern function}
require(mice)
require(lattice)
set.seed(123)
md.pattern(FlucTotIV_clean)
md.pattern(nhanes)

```

##### Impute the missing data in the nhanes dataset with mean imputation

```{r mean imputation nhanes}
imp <- mice(nhanes, method = "mean", m = 1, maxit = 1)
#imp is a convention in mice function

```

##### Explore the imputed data with the complete() function

```{r using complete function}
complete(imp)

# confirming the means of the variables
colMeans(nhanes, na.rm = TRUE)

# fitting a regression model where age is predicted from bmi

fit <- with(nhanes, lm(age ~ bmi))
summary(fit)

# inspecting the regression model with the imputed data

fit <- with(imp, lm(age ~ bmi))
summary(fit)

## nothing changed, but this is not surprising as variable bmi is somewhat normally distributed and we are just adding weight to the mean

densityplot(nhanes$bmi)

```

##### Impute the missing data in the nhanes dataset with regression imputation

```{r regression imputation - norm.predict}
imp <- mice(nhanes, method = "norm.predict", m = 1, maxit = 1)

## The argument method = "norm.predict" first fits a regression model for each observed value, based on the corresponding values in other variables and then imputes the missing values with the predicted values

# Again, inspect the completed data and investigate the imputed data regression model

complete(imp)

##  we extrapolated (part of) the regression model for the observed data to missing data in bmi. In other words; the relation (read: information) gets stronger and we’ve obtained more observations

```

##### Impute the missing data in the nhanes dataset with stochastic regression imputation.

```{r regression imputation - norm.nob}
imp <- mice(nhanes, method = "norm.nob", m = 1, maxit = 1)

##  This code imputes the missing values in the data set by the stochastic regression imputation method. The function does not incorporate the variability of the regression weights, so it is not ‘proper’ in the sense of Rubin (1987). For small samples, the variability of the imputed data will be underestimated.

# Again, inspect the completed data and investigate the imputed data regression model

complete(imp)

##  We have once more obtained a more natural looking set of imputations, where instead of filling in the same bmi for all ages, we now take age (as well as hyp and chl) into account when imputing bmi. We also add a random error to allow for our imputations to be off the regression line.

# Inspect the regression model with the imputed data

fit <- with(imp, lm(age ~ bmi))
summary(fit)

```

##### Re-run the stochastic imputation model with seed 123

```{r regression imputation - norm.nob with seed}
imp <- mice(nhanes, method = "norm.nob", m = 1, maxit = 1, seed = 123)
fit <- with(imp, lm(age ~ bmi))
summary(fit)

```

##### Impute the missing data in the nhanes dataset

```{r using mice default for imputation}
imp <- mice(nhanes)
imp

## The object imp contains a multiply imputed data set (of class mids). It encapsulates all information from imputing the nhanes dataset, such as the original data, the imputed values, the number of missing values, number of iterations, and so on.

#  Obtaining an overview of the information stored in the object imp, using the attributes() function

attributes(imp)

# for example, the original data are stored as

imp$data

# and the imputations are stored as

imp$imp

```

##### Extract the completed data

```{r getting the third imputed data set}
c3 <- complete(imp, 3) 
md.pattern(c3)

# The collection of the m imputed data sets can be exported by function complete() in long, broad and repeated formats

c.long <- complete(imp, "long")  
c.long

c.broad <- complete(imp, "broad")
c.broad

```

### Vignette 02 - Convergence and pooling (Algorithmic convergence and inference pooling)

```{r require()) the necessary packages}
require(mice)
require(lattice)
set.seed(123)

```

##### Vary the number of imputations.

```{r creating 3 imputations}
imp <- mice(nhanes, m = 3, print=F)

```

##### Change the predictor matrix

```{r predictor matrix}
# The predictor matrix is a square matrix that specifies the variables that are used to impute each incomplete variable. Let us have a look at the predictor matrix that was used

imp$pred

## Each variable in the data has a row and a column in the predictor matrix. A value 1 indicates that the column variable was used to impute the row variable. For example, the 1 at entry [bmi, age] indicates that variable age was used to impute the incomplete variable bmi.

# You can use mice() to give you the initial predictor matrix, and change it afterwards, without running the algorithm. This can be done by typing

ini <- mice(nhanes, maxit=0, print=F)
pred <- ini$pred
pred

## Altering the predictor matrix and returning it to the mice algorithm is very simple

# The following code removes the variable hyp from the set of predictors, but still leaves it to be predicted by the other variables

pred[ ,"hyp"] <- 0
pred

# Use the new predictor matrix in mice() as follows

imp <- mice(nhanes, pred=pred, print=F)

## There is a special function called quickpred() for a quick selection procedure of predictors which can be handy for datasets containing many variables. 

# Selecting predictors according to data relations with a minimum correlation of ρ=.30 can be done by

ini <- mice(nhanes, pred=quickpred(nhanes, mincor=.3), print=F)
ini$pred

## For large predictor matrices, it can be useful to export them to Microsoft Excel for easier configuration

```

##### Inspect the convergence of the algorithm

```{r inspecting the convergence}
## The mice() function implements an iterative Markov Chain Monte Carlo type of algorithm. Let us have a look at the trace lines generated by the algorithm to study convergence:

imp <- mice(nhanes, print=F)
plot(imp)

## The algorithm uses random sampling, and therefore, the results will be (perhaps slightly) different if we repeat the imputations with different seeds. In order to get exactly the same result, use the seed argument

imp <- mice(nhanes, seed=123, print=F)

```

##### Change the imputation method

```{r check imputation method}
# For each column, the algorithm requires a specification of the imputation method. To see which method was used by default

imp$meth

##  In reality, the data are better described a as mix of numerical and categorical data. 

# Let us take a look at the nhanes2 data frame

summary(nhanes2)

# The structure of the data frame

str(nhanes2)

# Methods used to impute nhanes2 dataset

imp <- mice(nhanes2, print=F)
imp$meth

## Notice that mice has set the imputation method for variable hyp to logreg, which implements multiple imputation by logistic regression.

# An up-to-date overview of the methods in mice can be found by

methods(mice)

# change the imputation method for bmi to Bayesian normal linear regression imputation

ini <- mice(nhanes2, maxit = 0)
meth <- ini$meth
meth

meth["bmi"] <- "norm"
meth

# and run the imputations again.

imp <- mice(nhanes2, meth = meth, print=F)

# plot trace lines to study convergence

plot(imp)

```

##### Extend the number of iterations

```{r the number of iterations}
## Though using just five iterations (the default) often works well in practice, we need to extend the number of iterations of the mice algorithm to confirm that there is ###---no trend and that the trace lines intermingle well---###

# Increase the number of iterations to 40 by running 35 additional iterations using the mice.mids() function

imp40 <- mice.mids(imp, maxit=35, print=F)
plot(imp40)

```

##### Further diagnostic checking. Use function stripplot()

```{r further diagnostic checking}
## Generally, one would prefer for the imputed data to be plausible values, i.e. values that could have been observed if they had not been missing. In order to form an idea about plausibility, one may check the imputations and compare them against the observed values.

## If we are willing to assume that the data are missing completely at random (MCAR), then the imputations should have the same distribution as the observed data.

## In general, distributions may be different because the missing data are MAR (or even MNAR). However, very large discrepancies need to be screened.

#  Let us plot the observed and imputed data of chl by

stripplot(imp, chl~.imp, pch=20, cex=2)

## The convention is to plot observed data in blue and the imputed data in red.

## Since the PMM method draws imputations from the observed data, imputed values have the same gaps as in the observed data, and are always within the range of the observed data. 

## The figure indicates that the distributions of the imputed and the observed values are similar.

## Under MCAR, univariate distributions of the observed and imputed data are expected to be identical. Under MAR, they can be different, both in location and spread, but their multivariate distribution is assumed to be identical.

# The following command creates a simpler version of the graph from the previous step and adds the plot for bmi.

stripplot(imp)
## Remember that bmi was imputed by Bayesian linear regression and (the range of) imputed values may therefore be different than observed values.

```

#####  Perform the following regression analysis on the multiply imputed data. Store the solution in object fit.

```{r regression analysis on the multiply imputed data}
## bmi=β0+β1chl+ϵ
fit <- with(imp, lm(bmi ~ chl))
fit

## The fit object contains the regression summaries for each data set. The new object fit is actually of class mira (multiply imputed repeated analyses).

class(fit)

# Use the ls() function to what out what is in the object.

ls(fit)

# Suppose we want to find the regression model fitted to the second imputed data set. It can be found as

summary(fit$analyses[[2]])

```

##### Pool the analyses from object fit.

```{r pooling the analyses}
## Pooling the repeated regression analyses
pool.fit <- pool(fit)
summary(pool.fit)

## which gives the relevant pooled regression coefficients and parameters, as well as the fraction of information about the coefficients missing due to nonresponse (fmi) and the proportion of the variation attributable to the missing data (lambda).

## The pooled fit object is of class mipo, which stands for "multiply imputed pooled object."

## mice is able to pool many analyses from a variety of packages for you, as long as the functions adhere to the coef method convention in R.

## For flexibility and in order to run custom pooling functions, mice also incorporates a function pool.scalar() which pools univariate estimates of m  repeated complete data analysis conform Rubin’s pooling rules (Rubin, 1987, paragraph 3.1)

```

### Pooling parameters model with within dosing interval imputation 070823

```{r set wd, warning=FALSE}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooling_Parameters_noadderr<-read.csv("Pooling_Parameters_noadderr_070823.csv")

```

```{r calculate variance Theta Within and Between Subject variability for all}
Pooling_Parameters_noadderr$Var<-(Pooling_Parameters_noadderr$RSE*Pooling_Parameters_noadderr$Estimates/100)^2

CKDEPI<-mean(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.4370929

W_CKDEPI<-mean(Pooling_Parameters_noadderr$Var[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.04594218 #within imputation variance

B_CKDEPI<-var(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.02165814 #between imputation variance

CKDEPI
W_CKDEPI
B_CKDEPI

```

```{r total variance for all}
m<-70
T_CKDEPI<-W_CKDEPI+(1+1/m)*B_CKDEPI #0.06790972
T_CKDEPI

```

```{r confidence interval - T distribution}
m<-70 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177
lambda_CKDEPI<-(B_CKDEPI+B_CKDEPI/m)/T_CKDEPI #proportion of variation attributable to the missing data
r_CKDEPI<-(lambda_CKDEPI)/(1-lambda_CKDEPI) #relative increase in variance due to nonresponse
v_old_CKDEPI<-(m-1)*(1+1/r_CKDEPI^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CKDEPI) in the hypothetically complete data
v_obs_CKDEPI=((v_com+1)/(v_com+3))*v_com*(1-lambda_CKDEPI) #observed data degrees of freedom that accounts for the missing information
v_CKDEPI<-(v_old_CKDEPI*v_obs_CKDEPI)/(v_old_CKDEPI+v_obs_CKDEPI) #equals 85
t_crit_CKDEPI <- qt(0.975, v_CKDEPI) #critical t-value with df 85 and alpha 0.05 (95%CI) #equals 1.988265
lower_bound_CKDEPI<-CKDEPI-t_crit_CKDEPI*sqrt(T_CKDEPI) #-0.08103884
upper_bound_CKDEPI<-CKDEPI+t_crit_CKDEPI*sqrt(T_CKDEPI) #0.9552246
lower_bound_CKDEPI
upper_bound_CKDEPI

```

#### Evaluate the adequacy of the number of imputations

```{r read my new dataframe, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noCKDEPI_noadderr_BW<-read.csv("Pooling_Parameters_noadderr_070823.csv")

```

```{r create a new variable}
Pooledmodel_noCKDEPI_noadderr_BW$Var<-(Pooledmodel_noCKDEPI_noadderr_BW$RSE*Pooledmodel_noCKDEPI_noadderr_BW$Estimates/100)^2

```

```{r calculate variance Theta Within and Between Subject variability for 70 imputations}
# Create empty vectors
m <- Theta <- W <- B <- Total_Var <- numeric(70)

# Assign values to vectors using for loop
for (i in 1:70) {
  m[i] <- i
  Theta[i] <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CKDEPI" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  W[i] <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CKDEPI" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  B[i] <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CKDEPI" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  Total_Var[i] <- W[i] + (1 + 1 / m[i]) * B[i]
}

# Combine vectors into a data frame
imputation_number <- data.frame(m, Theta, Total_Var)

```

```{r plot Theta over m, warning=FALSE}
library(ggplot2)
Theta_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Theta, color = "Parameter Estimate"), size = 1.0) +
  geom_point(aes(y = Theta, color = "Parameter Estimate"), size = 2.5) + # Add points for Parameter Estimate
  scale_color_manual(values = c("blue")) +
  scale_x_continuous(breaks = seq(1, 70, 10), limits = c(1, 70))  +
  labs(x = "Number of imputations", y = "CKDEPI effect Estimate", color = "Variables") +
  theme_bw() + theme(legend.position = "none")

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")

ggsave("theta_over_m_070823.png", plot = Theta_over_m, dpi = 300, width = 8.27, height = 10.3)

#scale_y_continuous(breaks = seq(0.95, 1.01, 0.005), limits = c(0.95, 1.01))

```

```{r plot variance over m, warning=FALSE}
var_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Total_Var, color = "Total Variance"), size = 1.0) +
  geom_point(aes(y = Total_Var, color = "Total Variance"), size = 2.5) + # Add points for Total Variance
  scale_color_manual(values = c("orange")) +
  scale_x_continuous(breaks = seq(2, 70, 10), limits = c(2, 70)) +
  labs(x = "Number of imputations", y = "Total variance of BW effect estimate", color = "Variables") +
  theme_bw() + theme(legend.position = "none")

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")

ggsave("var_over_m_070823.png", plot = var_over_m, dpi = 300, width = 8.27, height = 10.3)

        #scale_y_continuous(breaks = seq(0.035, 0.0405, 0.0005), limits = c(0.035, 0.0405))
```

### Pooling parameters model with within dosing interval imputation, dosing_interval as a predictor 150823

```{r set wd, warning=FALSE}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooling_Parameters_noadderr<-read.csv("Pooling_Parameters_noadderr_150823.csv")

```

```{r calculate variance Theta Within and Between Subject variability for all}
Pooling_Parameters_noadderr$Var<-(Pooling_Parameters_noadderr$RSE*Pooling_Parameters_noadderr$Estimates/100)^2

CKDEPI<-mean(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.4874571

W_CKDEPI<-mean(Pooling_Parameters_noadderr$Var[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.04430767 #within imputation variance

B_CKDEPI<-var(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.01876773 #between imputation variance

CKDEPI
W_CKDEPI
B_CKDEPI

```

```{r total variance for all}
m<-70
T_CKDEPI<-W_CKDEPI+(1+1/m)*B_CKDEPI #0.06334351
T_CKDEPI

```

```{r confidence interval - T distribution}
m<-70 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177
lambda_CKDEPI<-(B_CKDEPI+B_CKDEPI/m)/T_CKDEPI #proportion of variation attributable to the missing data
r_CKDEPI<-(lambda_CKDEPI)/(1-lambda_CKDEPI) #relative increase in variance due to nonresponse
v_old_CKDEPI<-(m-1)*(1+1/r_CKDEPI^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CKDEPI) in the hypothetically complete data
v_obs_CKDEPI=((v_com+1)/(v_com+3))*v_com*(1-lambda_CKDEPI) #observed data degrees of freedom that accounts for the missing information
v_CKDEPI<-(v_old_CKDEPI*v_obs_CKDEPI)/(v_old_CKDEPI+v_obs_CKDEPI) #equals 90.68601
t_crit_CKDEPI <- qt(0.975, v_CKDEPI) #critical t-value with df 85 and alpha 0.05 (95%CI) #equals 1.98647
lower_bound_CKDEPI<-CKDEPI-t_crit_CKDEPI*sqrt(T_CKDEPI) #-0.0125003
upper_bound_CKDEPI<-CKDEPI+t_crit_CKDEPI*sqrt(T_CKDEPI) #0.9874146
lower_bound_CKDEPI
upper_bound_CKDEPI

```

### Making diagnostic plot of CREAT over TIME observed vs imputed

#### Reading imputed dataset

```{r reading first imputed dataset}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int")
Fluc_NONMEM_mul_impute_BW01 <- read.csv("Fluc_NONMEM_mul_impute_BW01.csv")

```


```{r CREAT over TIME imputed vs non-imputed}
## Creat_Imputed variable indicating whether CREAT is missing or imputed
## Value of 1 means yes, and 0 means no

Fluc_NONMEM_mul_impute_BW01$Creat_Imputed<-ifelse(Fluc_NONMEM_mul_impute_BW01$CREAT==-99,1,0)

## Making 10 plots with trend lines

library(ggplot2)

# Create a list to store the plots
plot_list <- list()

# Loop through CKDEPI01 to CKDEPI10
for (i in 1:10) {
  # Create a plot for each CKDEPI variable
  plot <- ggplot(Fluc_NONMEM_mul_impute_BW01, aes(x = TIME, y = get(paste0("CKDEPI", sprintf("%02d", i))), color = factor(Creat_Imputed))) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +  # Add trend line
    labs(title = paste("CKDEPI", sprintf("%02d", i), "over Time"),
         x = "Time (h)", y = paste("eGFR (ml/min/1.73m2)"),
         color = "Creatinine Imputed") + 
    scale_color_discrete(labels = c("No", "Yes")) +
    theme_minimal() +
        scale_y_continuous(breaks = seq(0, 300, by = 20), limits = c(0, 300),expand = c(0,0)) +
        scale_x_continuous(breaks = seq(0, 1100, by = 50), limits = c(0, 1100),expand = c(0,0)) +
        theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 
  
  # Add the plot to the list
  plot_list[[i]] <- plot
}

# Print and export the plots
for (i in 1:10) {
  # Print the plot
  print(plot_list[[i]])
  
  # Export the plot to a high-quality image
  setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int/diagnostic_plots")  
  ggsave(paste("CKDEPI", sprintf("%02d", i), "_plot.png"), plot = plot_list[[i]], dpi = 300, width = 12, height = 8)
}

```


