---
title: "Fluconazole"
author: "Leo"
date: "2023-03-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## This is where I test my imputation model

### Here I use FlucTotIV_clean dataset

#### First of all, read in dataset

```{r read dataset}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean<-read.csv("FlucTotIV_clean.csv")
```

#### Then convert data type

```{r convert data types,warning=FALSE}
FlucTotIV_clean$AGE <- as.numeric(FlucTotIV_clean$AGE)
FlucTotIV_clean$LENGTH <- as.numeric(FlucTotIV_clean$LENGTH)
FlucTotIV_clean$BW2 <- as.numeric(FlucTotIV_clean$BW2)
FlucTotIV_clean$DV <- as.numeric(ifelse(FlucTotIV_clean$DV == ".", NA, FlucTotIV_clean$DV))
FlucTotIV_clean$TIME <- as.numeric(FlucTotIV_clean$TIME)
FlucTotIV_clean$CREAT2 <- as.numeric(FlucTotIV_clean$CREAT2)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
FlucTotIV_clean$EVID <- as.factor(FlucTotIV_clean$EVID)
FlucTotIV_clean$TAD <- as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean$RATE <- as.numeric(FlucTotIV_clean$RATE)
FlucTotIV_clean$APACHE <- as.factor(as.character(FlucTotIV_clean$APACHE))
FlucTotIV_clean$SOFA <- as.factor(as.character(FlucTotIV_clean$SOFA))
```

#### Convert all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0
```{r convert NAs to 0}
FlucTotIV_clean$TAD[is.na(FlucTotIV_clean$TAD)] <- 0
FlucTotIV_clean$AMT[is.na(FlucTotIV_clean$AMT)] <- 0
FlucTotIV_clean$RATE[is.na(FlucTotIV_clean$RATE)] <- 0
```
```{r convert DV to 0 where TIME equals 0}
FlucTotIV_clean$DV[FlucTotIV_clean$TIME == 0] <- 0
```

#### Create a new variable called CRRT2 to indicate whether a patient had CRRT or not
```{r creat CRRT2 variable}
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"]) #IDs of the patients who have CRRT
FlucTotIV_clean$CRRT2 <- ifelse(FlucTotIV_clean$ID %in% crrt_patients, 1, 0)
FlucTotIV_clean$CRRT2 <- as.factor(FlucTotIV_clean$CRRT2)
```

#### Here I try different imputation approach where I build 2 different imputation models for 2 different subsets, one with Dv and one without DV
#### First of all, creating two subsets (one with DV and one without DV)
```{r 2 sbusets with and without DV,include=FALSE}
library(dplyr)
FlucTotIV_clean_DV<-FlucTotIV_clean%>%filter(is.na(DV)==FALSE)
FlucTotIV_clean_noDV<-FlucTotIV_clean%>%filter(is.na(DV)==TRUE)
```

##### Check to see if the amount of missingness for CREAT2 is statistically different between the two datasets
```{r the amount of CREAT2 missing in each dataset}
library(table1)
table1(~ CREAT2 | HOSPITAL, data=FlucTotIV_clean_DV,
       render.continuous=c(.="Median [Q1-Q3]")) #75.2% missing overall
table1(~ CREAT2 | HOSPITAL, data=FlucTotIV_clean_noDV,
       render.continuous=c(.="Median [Q1-Q3]")) #70.9% missing over all - so less than DV dataset
```
```{r test the difference of CREAT2 between the two datasets using chisquare test}
# Get the number of missing and non-missing CREAT2 values in each dataset
dv_missing <- sum(is.na(FlucTotIV_clean_DV$CREAT2))
dv_non_missing <- sum(!is.na(FlucTotIV_clean_DV$CREAT2))
nodv_missing <- sum(is.na(FlucTotIV_clean_noDV$CREAT2))
nodv_non_missing <- sum(!is.na(FlucTotIV_clean_noDV$CREAT2))

# Create a table of the counts
count_table <- matrix(c(dv_missing, dv_non_missing, nodv_missing, nodv_non_missing), nrow = 2, byrow = TRUE)

# Perform the chi-square test
chisq.test(count_table)
```
##### The amount of CREAT2 missing between FlucTotIV_clean_DV and FlucTotIV_clean_noDV is statistically significantly different

### Some general notes for this whole imputation task
#### 1.I will apply the "first impute, then transfrom" strategy for imputing my 2 derived variables: FFM & CKDEPI
#### 2. Therefore, my minimum set of predictor variables in the final imputation model are: TIME, AMT, RATE, DV, AGE, SEX, BW2, LENGTH & CREAT2
##### 2.1. However, a probelm arises here, BW & LENGTH are also missing in some observations. As I use baseline values only, all observations within a single patient (a single ID) must have the same value for BW & LENGTH
##### So, I have two options here:
###### 1. not including ID in the imputation model, averaging BW & LENGTH per each patient after imputation and consider it as a baseline value
###### 2. Include ID in the final imputation model, and apply restriction per each ID when imputing

### I decide to try both of these options, and then see how it goes with regard to the performance of my imputation model

#### Select predictors for imputation models for both DV and non-DV datasets
##### First of all, not including ID as a predictor, take the average of BW and LENGTH as a baseline value for all observations within an ID
```{r select all potential predictors to build imputation models}
impute_CREAT2 <- FlucTotIV_clean[, c("AGE", "SEX", "BW2","DV", "TIME", "HOSPITAL", "CRRT", "CREAT2","OCC","LENGTH","TAD","AMT","RATE","CRRT2")] #14 variables in total
```

#### Then try different linear regression models to select the best set of predictors for 2 multiple imputation models
##### First of all, for the dataset that has DV, DV is definitely one of the predictor. The default predictors always contain: TIME, AMT, RATE, DV, AGE, SEX, BW2, LENGTH & CREAT2
##### My first lm_DV0 model
```{r lm_DV0 linear model}
lm_DV0 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD, data = FlucTotIV_clean_DV)
summary(lm_DV0)
AIC(lm_DV0)
```
##### AIC of lm_DV0 model equals 1086.5, adjusted R-squared is 0.155

```{r lm_DV0 model diagnostic}
qqnorm(residuals(lm_DV0), pch = 1, frame = FALSE)
qqline(residuals(lm_DV0), col = "steelblue", lwd = 2)
```
##### It looks quite normal. Normality assumption holds

##### My second lm_DV1 model, which is lm_DV0 removing TAD
```{r lm_DV1 linear model}
lm_DV1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC), data = FlucTotIV_clean_DV)
summary(lm_DV1)
AIC(lm_DV1)
```
##### AIC of lm_DV1 model equals 1086.2, adjusted R-squared is 0.1537 
##### This model is worse than lm_Dv0, therefore, lm_Dv0 is my final DV-included imputation model. The predictors for final imputation DV-dataset model are TIME+AMT+RATE+DV+AGE+factor(SEX)+BW2+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD

```{r best imputation DV dataset}
impute_CREAT2_DV <- FlucTotIV_clean_DV[, c("DV","TIME","RATE","AMT","AGE","LENGTH","BW2","SEX","HOSPITAL", "CRRT","CRRT2","OCC","TAD","CREAT2")]
```

##### Second of all, for the dataset that has no-DV, DV will not be one of the predictors. The default predictors always contain: TIME, AMT, RATE, AGE, SEX, BW2, LENGTH & CREAT2. There will be no TAD, because they all equal to 0.

##### My first lm_noDV0 model
```{r lm_noDV0 linear model}
lm_noDV0 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC), data = FlucTotIV_clean_noDV)
summary(lm_noDV0)
AIC(lm_noDV0)
```
##### AIC of lm_noDV0 model equals 750.8, adjusted R-squared is 0.201

```{r lm_noDV0 model diagnostic}
qqnorm(residuals(lm_noDV0), pch = 1, frame = FALSE)
qqline(residuals(lm_noDV0), col = "steelblue", lwd = 2)
```
##### The QQ-plot is much worse than the model with DV. However, we can still consider it normal!

##### My second lm_noDV1 model, which is lm_noDV0 removing OCC
```{r lm_noDV1 linear model}
lm_noDV1 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2), data = FlucTotIV_clean_noDV)
summary(lm_noDV1)
AIC(lm_noDV1)
```
##### AIC of lm_noDV1 model equals 704.2, adjusted R-squared is 0.229

```{r lm_noDV1 model diagnostic}
qqnorm(residuals(lm_noDV1), pch = 1, frame = FALSE)
qqline(residuals(lm_noDV1), col = "steelblue", lwd = 2)
```
##### It looks quite off from nomality, however we will still consider it normal.
##### Therefore, lm_noDV1 will be my final imputation model for no-DV-dataset. The predictors for final imputation no-DV-dataset model are TIME+AMT+RATE+AGE+factor(SEX)+BW2+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)

```{r best imputation noDV dataset}
impute_CREAT2_noDV <- FlucTotIV_clean_noDV[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CRRT","CRRT2", "CREAT2")]
```

#### I will also impute based on CRRT because of the unrealistic values from the model that include CRRT and CRRT2 as predictors
##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
set.seed(123)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(123)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(123)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(123)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```

### This following does not work very well, therefore I tried the above instead
#### Imputing using my final impute_CREAT2_DV & impute_CREAT2_noDV models
```{r final impute_CREAT2_DV model,include=FALSE,echo=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_DV <- mice(impute_CREAT2_DV, m = 10,maxit=20,printFlag=FALSE) #maxit = 20 is generally enough
```
```{r check the linear regression model again}
lm_DV_impute1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD, data = complete(imputed_CREAT2_DV,1))
summary(lm_DV_impute1)
AIC(lm_DV_impute1)
```
```{r lm_DV_impute1 model diagnostic}
qqnorm(residuals(lm_DV_impute1), pch = 1, frame = FALSE)
qqline(residuals(lm_DV_impute1), col = "steelblue", lwd = 2)
```
```{r final impute_CREAT2_noDV model,include=FALSE,echo=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_noDV <- mice(impute_CREAT2_noDV, m = 10,maxit=20,printFlag=FALSE) #maxit equals 20 is generally enough
```
```{r check the linear regression model again}
lm_noDV_impute1 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2), complete(imputed_CREAT2_noDV,1))
summary(lm_noDV_impute1)
AIC(lm_noDV_impute1)
```
```{r lm_noDV_impute1 model diagnostic}
qqnorm(residuals(lm_noDV_impute1), pch = 1, frame = FALSE)
qqline(residuals(lm_noDV_impute1), col = "steelblue", lwd = 2)
```
##### A bad diagnostic plot to be honest

#### Integrate imputed CREAT2 to FlucTotIV_clean_DV and FlucTotIV_clean_noDV dataset
```{r impute creatinine,include=FALSE,echo=FALSE}
for (i in 1:10) {
        FlucTotIV_clean_DV[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV, action = i))$CREAT2
}
for (i in 1:10) {
        FlucTotIV_clean_noDV[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV, action = i))$CREAT2
}
```
#### The end of the suboptimal approach

#### Here I try combining FlucTotIV_clean_DV and FlucTotIV_clean_noDV datasets into one so according to ID and HOSPITAL, and that TIME will be in an ascending order
```{r combine FlucTotIV_clean_DV & FlucTotIV_clean_noDV}
FlucTotIV_clean2 <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean2 <- FlucTotIV_clean2[order(FlucTotIV_clean2$ID, FlucTotIV_clean2$HOSPITAL, FlucTotIV_clean2$TIME), ]
```

#### Save dataset for future use - FlucTotIV_clean_DV, FlucTotIV_clean_noDV and FlucTotIV_clean2
```{r save 3 datasets}
write.csv(FlucTotIV_clean_DV,"FlucTotIV_clean_DV.csv",quote=F,row.names=FALSE)
write.csv(FlucTotIV_clean_noDV,"FlucTotIV_clean_noDV.csv",quote=F,row.names=FALSE)
write.csv(FlucTotIV_clean2,"FlucTotIV_clean2.csv",quote=F,row.names=FALSE)
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### Export to FlucTotIV_clean_imputed dataset
```{r Export FlucTotIV_clean_imputed dataset}
FlucTotIV_clean_imputed<-read.csv("FlucTotIV_clean_imputed.csv")
#write.csv(FlucTotIV_clean_imputed,"FlucTotIV_clean_imputed.csv",quote=F,row.names=FALSE)
```

### Imputation diagnostic

#### Check the distribution of imputed CKDEPI01 to 10 compared to observed CREAT2
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
#### This looks much better!!!

#### DV over CREAT
```{r index column whether CREAT is imputed or not}
FlucTotIV_clean_imputed$CREAT_IMPUTE <- ifelse(is.na(FlucTotIV_clean_imputed$CREAT2), 1, 0)
FlucTotIV_clean_imputed$CREAT_IMPUTE<-as.factor(FlucTotIV_clean_imputed$CREAT_IMPUTE)
```
```{r DV vs CREAT01}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT01, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 01") +
  labs(caption = NULL)
```
```{r DV vs CREAT02}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT02, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 02") +
  labs(caption = NULL)
```
```{r DV vs CREAT03}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT03, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 03") +
  labs(caption = NULL)
```
```{r DV vs CREAT04}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT04, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 04") +
  labs(caption = NULL)
```
```{r DV vs CREAT05}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT05, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 05") +
  labs(caption = NULL)
```
```{r DV vs CREAT06}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT06, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 06") +
  labs(caption = NULL)

```
```{r DV vs CREAT07}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT07, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 07") +
  labs(caption = NULL)
```
```{r DV vs CREAT08}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT08, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 08") +
  labs(caption = NULL)
```
```{r DV vs CREAT09}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT09, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 09") +
  labs(caption = NULL)
```
```{r DV vs CREAT10}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT10, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 10") +
  labs(caption = NULL)
```

### Check the distribution of imputed CREAT vs TIME

```{r CREAT per individual in each of 10 imputed CREAT}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 01 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT01, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT01, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 02
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 02 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT02, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT02, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 03
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 03 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT03, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT03, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}


# Impute 04
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 04 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT04, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT04, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 05
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 05 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT05, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT05, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 06
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 06 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT06, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT06, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 07
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 07 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16 
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT07, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT07, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 08
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 08 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT08, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT08, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 09
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 09 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT09, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT09, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

# Impute 10
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/CREAT impute 10 dataset2")
library(dplyr)
FlucTotIV_clean_imputed2 <- FlucTotIV_clean_imputed2 %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 1 & !FlucTotIV_clean_imputed2$ID %in% FlucTotIV_clean_imputed2$ID[FlucTotIV_clean_imputed2$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV_clean_imputed2 %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean_imputed2 %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV_clean_imputed2$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV_clean_imputed2 %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV_clean_imputed2 %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT10, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT10, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

```
##### The predicted CREAT is quite unrealistic (based on individual CREAT plots), therefore I will impute seperately for CRRT & non-CRRT patients

### Here I test imputation when not including DV (For Erwin)
#### I will impute based on CRRT because of the unrealistic values from the model that include CRRT and CRRT2 as predictors
##### First of all, creating crrt and non-crrt datasets
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients))
```

##### In this case, DV will not be one of the predictors. The default predictors always contain: TIME, AMT, RATE, AGE, SEX, BW2, LENGTH & CREAT2. CRRT2 will not be a predictor anymore and for non-crrt dataset, CRRT is also not a predictor

##### My first lm_crrt0 model
```{r lm_crrt0 linear model}
lm_crrt0 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+TAD, data = FlucTotIV_clean_crrt)
summary(lm_crrt0)
AIC(lm_crrt0)
```
##### AIC of lm_crrt0 model equals 564.1, adjusted R-squared is 0.197

```{r lm_crrt0 model diagnostic}
qqnorm(residuals(lm_crrt0), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt0), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks quite normal, ergo the normality assumption holds!

##### My second lm_crrt1 model, which is lm_crrt0 removing TAD
```{r lm_crrt1 linear model}
lm_crrt1 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(OCC), data = FlucTotIV_clean_crrt)
summary(lm_crrt1)
AIC(lm_crrt1)
```
##### AIC of lm_crrt1 model equals 562.4, adjusted R-squared is 0.201

```{r lm_crrt1 model diagnostic}
qqnorm(residuals(lm_crrt1), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt1), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks quite normal, ergo the normality assumption holds!

##### My third lm_crrt2 model, which is lm_crrt1 removing HOSPITAL
```{r lm_crrt2 linear model}
lm_crrt2 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT)+factor(OCC), data = FlucTotIV_clean_crrt)
summary(lm_crrt2)
AIC(lm_crrt2)
```
##### AIC of lm_crrt2 model equals 564.13, adjusted R-squared is 0.185

```{r lm_crrt2 model diagnostic}
qqnorm(residuals(lm_crrt2), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt2), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks quite normal, ergo the normality assumption holds!

##### Therefore, lm_crrt1 will be my final imputation model for crrt-dataset. The predictors for final imputation crrt-dataset model are TIME+AMT+RATE+AGE+factor(SEX)+BW2+LENGTH+factor(HOSPITAL)+factor(CRRT)+factor(OCC)

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CRRT","OCC", "CREAT2")]
```

##### Similarly, my first lm_nocrrt0 model
```{r lm_nocrrt0 linear model}
lm_nocrrt0 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(OCC)+TAD, data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt0)
AIC(lm_nocrrt0)
```
##### AIC of lm_nocrrt0 model equals 1258.2, adjusted R-squared is 0.1075

```{r lm_nocrrt0 model diagnostic}
qqnorm(residuals(lm_nocrrt0), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt0), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks much worse yet still quite normal, ergo the normality assumption holds!

##### My second lm_nocrrt1 model, which is lm_nocrrt0 removing TAD
```{r lm_crrt1 linear model}
lm_nocrrt1 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL)+factor(OCC), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt1)
AIC(lm_nocrrt1)
```
##### AIC of lm_nocrrt1 model equals 1256.2, adjusted R-squared is 0.109

```{r lm_nocrrt1 model diagnostic}
qqnorm(residuals(lm_nocrrt1), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt1), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks much worse yet still quite normal, ergo the normality assumption holds!

##### My third lm_nocrrt2 model, which is lm_nocrrt1 removing OCC
```{r lm_nocrrt2 linear model}
lm_nocrrt2 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt2)
AIC(lm_nocrrt2)
```
##### AIC of lm_nocrrt2 model equals 1197.9, adjusted R-squared is 0.14

```{r lm_nocrrt2 model diagnostic}
qqnorm(residuals(lm_nocrrt2), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt2), col = "steelblue", lwd = 2)
```
##### The QQ-plot looks much worse yet still quite normal, ergo the normality assumption holds!

##### Therefore, lm_nocrrt2 will be my final imputation model for nocrrt-dataset. The predictors for final imputation nocrrt-dataset model are TIME+AMT+RATE+AGE+factor(SEX)+BW2+LENGTH+factor(HOSPITAL)

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL","CREAT2")]
```

#### Then, I do imputation for crrt & non crrt dataset (without DV as a predictor)
##### For FlucTotIV_clean_crrt 
```{r impute FlucTotIV_clean_crrt dataset,warning=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

##### For FlucTotIV_clean_nocrrt 
```{r impute FlucTotIV_clean_nocrrt dataset,warning=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Combine the two datasets
```{r bind 2 datasets}
FlucTotIV_clean <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean <- FlucTotIV_clean[order(FlucTotIV_clean$ID, FlucTotIV_clean$HOSPITAL, FlucTotIV_clean$TIME), ]
FlucTotIV_clean_imputed<-FlucTotIV_clean
```

#### Imputation diagnostic

##### Check the distribution of imputed CKDEPI01 to 10 compared to observed CREAT2
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```

#### Then, chehck DV over CREAT plots
```{r index column whether CREAT is imputed or not}
FlucTotIV_clean_imputed$CREAT_IMPUTE <- ifelse(is.na(FlucTotIV_clean_imputed$CREAT2), 1, 0)
FlucTotIV_clean_imputed$CREAT_IMPUTE<-as.factor(FlucTotIV_clean_imputed$CREAT_IMPUTE)
```
```{r DV vs CREAT01}
library(ggplot2)
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT01, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 01") +
  labs(caption = NULL)
```
```{r DV vs CREAT02}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT02, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 02") +
  labs(caption = NULL)
```
```{r DV vs CREAT03}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT03, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 03") +
  labs(caption = NULL)
```
```{r DV vs CREAT04}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT04, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 04") +
  labs(caption = NULL)
```
```{r DV vs CREAT05}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT05, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 05") +
  labs(caption = NULL)
```
```{r DV vs CREAT06}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT06, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 06") +
  labs(caption = NULL)

```
```{r DV vs CREAT07}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT07, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 07") +
  labs(caption = NULL)
```
```{r DV vs CREAT08}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT08, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 08") +
  labs(caption = NULL)
```
```{r DV vs CREAT09}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT09, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 09") +
  labs(caption = NULL)
```
```{r DV vs CREAT10}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT10, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 10") +
  labs(caption = NULL)
```
### When not including DV as a predictor, the diagnostic plots are slightly worse than when doing so

### I will perform 10 more imputations to check the variability of the pooled parameter estimates
##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
set.seed(234)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(234)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_noDV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(234)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_noDV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(234)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```

#### Here I try combining FlucTotIV_clean_DV and FlucTotIV_clean_noDV datasets into one so according to ID and HOSPITAL, and that TIME will be in an ascending order
```{r combine FlucTotIV_clean_DV & FlucTotIV_clean_noDV}
FlucTotIV_clean2 <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean2 <- FlucTotIV_clean2[order(FlucTotIV_clean2$ID, FlucTotIV_clean2$HOSPITAL, FlucTotIV_clean2$TIME), ]
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### Export to FlucTotIV_clean_imputed2 dataset
```{r Export FlucTotIV_clean_imputed dataset}
#FlucTotIV_clean_imputed<-read.csv("FlucTotIV_clean_imputed.csv")
write.csv(FlucTotIV_clean_imputed,"FlucTotIV_clean_imputed2.csv",quote=F,row.names=FALSE)
```

### Imputation diagnostic

#### Check the distribution of imputed CKDEPI01 to 10 compared to observed CREAT2
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
#### This looks much better!!!

#### DV over CREAT
```{r index column whether CREAT is imputed or not}
FlucTotIV_clean_imputed$CREAT_IMPUTE <- ifelse(is.na(FlucTotIV_clean_imputed$CREAT2), 1, 0)
FlucTotIV_clean_imputed$CREAT_IMPUTE<-as.factor(FlucTotIV_clean_imputed$CREAT_IMPUTE)
```
```{r DV vs CREAT01}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT01, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 01") +
  labs(caption = NULL)
```
```{r DV vs CREAT02}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT02, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 02") +
  labs(caption = NULL)
```
```{r DV vs CREAT03}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT03, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 03") +
  labs(caption = NULL)
```
```{r DV vs CREAT04}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT04, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 04") +
  labs(caption = NULL)
```
```{r DV vs CREAT05}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT05, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 05") +
  labs(caption = NULL)
```
```{r DV vs CREAT06}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT06, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 06") +
  labs(caption = NULL)

```
```{r DV vs CREAT07}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT07, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 07") +
  labs(caption = NULL)
```
```{r DV vs CREAT08}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT08, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 08") +
  labs(caption = NULL)
```
```{r DV vs CREAT09}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT09, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 09") +
  labs(caption = NULL)
```
```{r DV vs CREAT10}
ggplot(FlucTotIV_clean_imputed[!is.na(FlucTotIV_clean_imputed$DV),], aes(x=CREAT10, y=DV, color=factor(CREAT_IMPUTE))) + 
  geom_point(alpha=0.5, size=2) +
  geom_smooth(method="lm", se=FALSE, formula=y~x) +
  geom_smooth(method="lm", se=FALSE, color="black", aes(group=1)) +
  labs(x = "CREAT", y = "DV", color = "Creatinine Imputed") +
  scale_color_manual(values=c("#F8766D", "#00BA38", "black"), name = "Creatinine Imputed", labels = c("No", "Yes", "Overall")) +
  theme_classic() +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin=margin(t=0,b=-0.2)) +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), plot.margin=unit(c(1,1,0,0), "cm")) +
  theme(plot.title = element_text(size=16, face="bold", hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  ggtitle("DV vs CREAT 10") +
  labs(caption = NULL)
```


#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Creat CREATMAX, CREATMIN, CREATMED columns

```{r CREATMAX}
Fluc_NONMEM_mul_impute$CREATMAX <- ifelse(Fluc_NONMEM_mul_impute$CREAT2 != -99,        Fluc_NONMEM_mul_impute$CREAT2,max(Fluc_NONMEM_mul_impute$CREAT2[Fluc_NONMEM_mul_impute$CREAT2 != -99], na.rm = TRUE))
```

```{r CREATMIN}
Fluc_NONMEM_mul_impute$CREATMIN <- ifelse(Fluc_NONMEM_mul_impute$CREAT2 != -99,        Fluc_NONMEM_mul_impute$CREAT2,min(Fluc_NONMEM_mul_impute$CREAT2[Fluc_NONMEM_mul_impute$CREAT2 != -99], na.rm = TRUE))
```

```{r CREATMED}
Fluc_NONMEM_mul_impute$CREATMED <- ifelse(Fluc_NONMEM_mul_impute$CREAT2 != -99,        Fluc_NONMEM_mul_impute$CREAT2,median(Fluc_NONMEM_mul_impute$CREAT2[Fluc_NONMEM_mul_impute$CREAT2 != -99], na.rm = TRUE))
```

##### Creat BWMAX, BWMIN, BWMED columns

```{r BWMAX}
Fluc_NONMEM_mul_impute$BWMAX <- ifelse(Fluc_NONMEM_mul_impute$BW2 != -99, 
                                          Fluc_NONMEM_mul_impute$BW2, 
                                          max(Fluc_NONMEM_mul_impute$BW2[Fluc_NONMEM_mul_impute$BW2 != -99], na.rm = TRUE))
```

```{r BWMIN}
Fluc_NONMEM_mul_impute$BWMIN <- ifelse(Fluc_NONMEM_mul_impute$BW2 != -99, 
                                          Fluc_NONMEM_mul_impute$BW2, 
                                          min(Fluc_NONMEM_mul_impute$BW2[Fluc_NONMEM_mul_impute$BW2 != -99], na.rm = TRUE))
```

```{r BWMED}
Fluc_NONMEM_mul_impute$BWMED <- ifelse(Fluc_NONMEM_mul_impute$BW2 != -99, 
                                          Fluc_NONMEM_mul_impute$BW2, 
                                          median(Fluc_NONMEM_mul_impute$BW2[Fluc_NONMEM_mul_impute$BW2 != -99], na.rm = TRUE))
```

##### Creat LENGTHMAX, LENGTHMIN, LENGTHMED columns

```{r LENGTHMAX}
Fluc_NONMEM_mul_impute$LENGTHMAX <- ifelse(Fluc_NONMEM_mul_impute$LENGTH != -99, 
                                       Fluc_NONMEM_mul_impute$LENGTH, 
                                       max(Fluc_NONMEM_mul_impute$LENGTH[Fluc_NONMEM_mul_impute$LENGTH != -99], na.rm = TRUE))
```

```{r LENGTHMIN}
Fluc_NONMEM_mul_impute$LENGTHMIN <- ifelse(Fluc_NONMEM_mul_impute$LENGTH != -99, 
                                       Fluc_NONMEM_mul_impute$LENGTH, 
                                       min(Fluc_NONMEM_mul_impute$LENGTH[Fluc_NONMEM_mul_impute$LENGTH != -99], na.rm = TRUE))
```

```{r LENGTHMED}
Fluc_NONMEM_mul_impute$LENGTHMED <- ifelse(Fluc_NONMEM_mul_impute$LENGTH != -99, 
                                       Fluc_NONMEM_mul_impute$LENGTH, 
                                       median(Fluc_NONMEM_mul_impute$LENGTH[Fluc_NONMEM_mul_impute$LENGTH != -99], na.rm = TRUE))
```

##### Creat CKDEPIMAX, CKDEPIMIN, CKDEPIMED columns

```{r CKDEPIMAX}
Fluc_NONMEM_mul_impute$CKDEPIMAX <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMIN < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMIN/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMIN >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMIN/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREATMIN < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREATMIN/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREATMIN/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPIMIN}
Fluc_NONMEM_mul_impute$CKDEPIMIN <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMAX < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMAX/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMAX >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMAX/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREATMAX < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREATMAX/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREATMAX/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPIMED}
Fluc_NONMEM_mul_impute$CKDEPIMED <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMED < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMED/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREATMED >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREATMED/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREATMED < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREATMED/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREATMED/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Creat FFMMAX, FFMMIN, FFMMED columns

```{r FFMMAX}
for (i in 1:length(Fluc_NONMEM_mul_impute$SEX)) {
        if (Fluc_NONMEM_mul_impute$SEX[i]==1) {
                Fluc_NONMEM_mul_impute$FFMMAX[i] <- 0.407*Fluc_NONMEM_mul_impute$BWMAX[i]+0.267*Fluc_NONMEM_mul_impute$LENGTHMAX[i]*100-19.2
        } else {
                Fluc_NONMEM_mul_impute$FFMMAX[i] <- 0.252*Fluc_NONMEM_mul_impute$BWMAX[i]+0.473*Fluc_NONMEM_mul_impute$LENGTHMAX[i]*100-48.3
        } 
}
```

```{r FFMMIN}
for (i in 1:length(Fluc_NONMEM_mul_impute$SEX)) {
        if (Fluc_NONMEM_mul_impute$SEX[i]==1) {
                Fluc_NONMEM_mul_impute$FFMMIN[i] <- 0.407*Fluc_NONMEM_mul_impute$BWMIN[i]+0.267*Fluc_NONMEM_mul_impute$LENGTHMIN[i]*100-19.2
        } else {
                Fluc_NONMEM_mul_impute$FFMMIN[i] <- 0.252*Fluc_NONMEM_mul_impute$BWMIN[i]+0.473*Fluc_NONMEM_mul_impute$LENGTHMIN[i]*100-48.3
        } 
}
```

```{r FFMMED}
for (i in 1:length(Fluc_NONMEM_mul_impute$SEX)) {
        if (Fluc_NONMEM_mul_impute$SEX[i]==1) {
                Fluc_NONMEM_mul_impute$FFMMED[i] <- 0.407*Fluc_NONMEM_mul_impute$BWMED[i]+0.267*Fluc_NONMEM_mul_impute$LENGTHMED[i]*100-19.2
        } else {
                Fluc_NONMEM_mul_impute$FFMMED[i] <- 0.252*Fluc_NONMEM_mul_impute$BWMED[i]+0.473*Fluc_NONMEM_mul_impute$LENGTHMED[i]*100-48.3
        } 
}
```

##### Creat observed CKDEPI2 column

```{r CKDEPI2}
Fluc_NONMEM_mul_impute$CKDEPI2 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT2 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT2/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT2 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT2/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT2 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT2/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT2/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Relocate CKDEPI2 column to right after CREAT2 column

```{r relocate CKDEPI2}
library(dplyr)
Fluc_NONMEM_mul_impute<-Fluc_NONMEM_mul_impute %>% relocate(CKDEPI2, .after=CREAT2)
```
##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute.csv",quote=F,row.names = FALSE)
```

##### Export two datasets (the next 10 imputations)

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed2.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute2.csv",quote=F,row.names = FALSE)
```

##### Check the distributions of different FFMs

```{r FFMs distribution}
hist(Fluc_NONMEM_mul_impute_2$FFM01)
hist(Fluc_NONMEM_mul_impute_2$FFM02)
hist(Fluc_NONMEM_mul_impute_2$FFM03)
```

##### It seems CREAT08 is a bit off, check it 
```{r CREAT08 vs CREAT2,warning=FALSE}
library(ggplot2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT08)) + 
        geom_density(aes(fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT08" = "gray","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of CREAT08 vs the original creatinin")
```
##### Compare 10 imputed CREAT only
```{r compare 10 imputed CREAT}
library(ggplot2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin")
```
##### Median of imputed CKDEPI
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 83.30
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 80.42
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 73.12
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 86.36
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 80.99
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 76.96
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 86.26
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 79.12
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 85.25
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 80.27
median(Fluc_NONMEM_mul_impute$CKDEPIMAX) #198.06
median(Fluc_NONMEM_mul_impute$CKDEPIMIN) #5.29
median(Fluc_NONMEM_mul_impute$CKDEPIMED) #83.46
```

##### Median of imputed CKDEPI (the next 10 imputations)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute_2$CKDEPI01) #equals 79.19
median(Fluc_NONMEM_mul_impute_2$CKDEPI02) #equals 82.28
median(Fluc_NONMEM_mul_impute_2$CKDEPI03) #equals 82.37
median(Fluc_NONMEM_mul_impute_2$CKDEPI04) #equals 77.55
median(Fluc_NONMEM_mul_impute_2$CKDEPI05) #equals 84.00
median(Fluc_NONMEM_mul_impute_2$CKDEPI06) #equals 79.18
median(Fluc_NONMEM_mul_impute_2$CKDEPI07) #equals 78.09
median(Fluc_NONMEM_mul_impute_2$CKDEPI08) #equals 83.78
median(Fluc_NONMEM_mul_impute_2$CKDEPI09) #equals 82.23
median(Fluc_NONMEM_mul_impute_2$CKDEPI10) #equals 82.95
median(Fluc_NONMEM_mul_impute_2$CKDEPIMAX) #198.06
median(Fluc_NONMEM_mul_impute_2$CKDEPIMIN) #5.29
median(Fluc_NONMEM_mul_impute_2$CKDEPIMED) #83.46
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.02
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFMMAX) #equals 58.76
median(Fluc_NONMEM_mul_impute$FFMMIN) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFMMED) #equals 58.15
```

##### Median of imputed FFM (the next 10 imputations)
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute_2$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM06) #equals 57.68
median(Fluc_NONMEM_mul_impute_2$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute_2$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute_2$FFM09) #equals 57.68
median(Fluc_NONMEM_mul_impute_2$FFM10) #equals 57.68
median(Fluc_NONMEM_mul_impute_2$FFMMAX) #equals 58.76
median(Fluc_NONMEM_mul_impute_2$FFMMIN) #equals 57.68
median(Fluc_NONMEM_mul_impute_2$FFMMED) #equals 58.15
```

### From here, I will create multiple imputed datasets, where each dataset contains 10 imputations for CKDEPI and FFM. The target is 100-200 imputations in total.
#### The third multiply imputed dataset (imputation 21th to 30th)

##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
library(mice)
set.seed(124)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(124)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_noDV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(124)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_noDV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(124)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```

#### Here I try combining FlucTotIV_clean_DV and FlucTotIV_clean_noDV datasets into one so according to ID and HOSPITAL, and that TIME will be in an ascending order
```{r combine FlucTotIV_clean_DV & FlucTotIV_clean_noDV}
FlucTotIV_clean2 <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean2 <- FlucTotIV_clean2[order(FlucTotIV_clean2$ID, FlucTotIV_clean2$HOSPITAL, FlucTotIV_clean2$TIME), ]
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### Export to FlucTotIV_clean_imputed3 dataset
```{r Export FlucTotIV_clean_imputed dataset}
#FlucTotIV_clean_imputed<-read.csv("FlucTotIV_clean_imputed.csv")
write.csv(FlucTotIV_clean_imputed,"FlucTotIV_clean_imputed3.csv",quote=F,row.names=FALSE)
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed3.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute3.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 21th to 30th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 76.84
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 77.00
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 76.95
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 75.97
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 82.49
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 82.28
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 81.09
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 81.64
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 79.54
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 83.21
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 57.68
```

#### The fourth multiply imputed dataset (imputation 31st to 40th)

##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
library(mice)
set.seed(125)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(125)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_noDV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(125)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_noDV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(125)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```
```{r bind 2 dataset}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```
```{r}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Replace values of 20 columns with mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    if(is.numeric(subset[[bw_col]])){
      bw_mean <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
      FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID == i, bw_col] <- bw_mean
    }
    if(is.numeric(subset[[length_col]])){
      length_mean <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
      FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID == i, length_col] <- length_mean
    }
  }
}

```


#### Export to FlucTotIV_clean_imputed4 dataset
```{r Export FlucTotIV_clean_imputed dataset}
#FlucTotIV_clean_imputed<-read.csv("FlucTotIV_clean_imputed.csv")
write.csv(FlucTotIV_clean_imputed,"FlucTotIV_clean_imputed4.csv",quote=F,row.names=FALSE)
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed4.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute4.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 31st to 40th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 74.67
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 81.06
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 74.66
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 82.22
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 78.99
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 76.26
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 78.30
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 83.37
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 83.42
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 75.34
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 57.88
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM10) #equals 57.68
```

#### The fifth multiply imputed dataset (imputation 41st to 50th)

##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
library(mice)
set.seed(126)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(126)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_noDV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(126)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_noDV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(126)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed5.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute5.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 41st to 50th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 78.07
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 80.58
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 79.15
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 77.05
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 79.88
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 77.63
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 81.92
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 80.94
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 82.94
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 85.03
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### The sixth multiply imputed dataset (imputation 51st to 60th)

##### First of all, for FlucTotIV_clean_DV dataset
```{r DV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_DV_crrt<-FlucTotIV_clean_DV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_DV_nocrrt<-FlucTotIV_clean_DV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2" as predictors in the imputation model for FlucTotIV_clean_DV_crrt dataset 
```{r impute FlucTotIV_clean_DV_crrt dataset,warning=FALSE}
impute_CREAT2_DV_crrt <- FlucTotIV_clean_DV_crrt[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","CRRT","CREAT2")]
library(mice)
set.seed(127)
imputed_CREAT2_DV_crrt<- mice(impute_CREAT2_DV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","TAD" as predictors in the imputation model for FlucTotIV_clean_DV_nocrrt dataset 
```{r impute FlucTotIV_clean_DV_nocrrt dataset,warning=FALSE}
impute_CREAT2_DV_nocrrt <- FlucTotIV_clean_DV_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","HOSPITAL", "TAD", "CREAT2")]
set.seed(127)
imputed_CREAT2_DV_nocrrt<- mice(impute_CREAT2_DV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$CREAT2
}
```

##### Second of all, for FlucTotIV_clean_noDV dataset
```{r noDV crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_noDV_crrt<-FlucTotIV_clean_noDV%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_noDV_nocrrt<-FlucTotIV_clean_noDV%>%filter(!ID%in%(crrt_patients))
```

###### By conducting the same procedure, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","CRRT","CREAT2","HOSPITAL","OCC" as predictors in the imputation model for FlucTotIV_clean_noDV_crrt dataset 
```{r impute FlucTotIV_clean_noDV_crrt dataset,warning=FALSE}
impute_CREAT2_noDV_crrt <- FlucTotIV_clean_noDV_crrt[, c("TIME","AMT","RATE", "AGE","BW2","SEX","LENGTH","CRRT","HOSPITAL","OCC","CREAT2")]
set.seed(127)
imputed_CREAT2_noDV_crrt<- mice(impute_CREAT2_noDV_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$CREAT2
}
```

###### Similarly, I selected "TIME","AMT","RATE","AGE","BW2","SEX","LENGTH","HOSPITAL" as predictors in the imputation model for FlucTotIV_clean_noDV_nocrrt dataset 
```{r impute FlucTotIV_clean_noDV_nocrrt dataset,warning=FALSE}
impute_CREAT2_noDV_nocrrt <- FlucTotIV_clean_noDV_nocrrt[, c("TIME","RATE","AMT","AGE","SEX","BW2","LENGTH","HOSPITAL", "CREAT2")]
set.seed(127)
imputed_CREAT2_noDV_nocrrt<- mice(impute_CREAT2_noDV_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$CREAT2
}
```

#### Then imputing BW & LENGTH based on the previous imputation model, where I average all the values within a single patient and consider it as his/her baseline value
##### Adding BW and LENGTH per each dataset
```{r adding BW to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_DV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_DV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_DV_nocrrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_noDV_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_noDV_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_noDV_nocrrt, action = i))$LENGTH
}
```

##### Then combine 4 datasets into 1 FlucTotIV_clean_imputed dataset
```{r combine FlucTotIV_clean_DV}
FlucTotIV_clean_DV <- rbind(FlucTotIV_clean_DV_crrt, FlucTotIV_clean_DV_nocrrt)
```
```{r combine FlucTotIV_clean_noDV}
FlucTotIV_clean_noDV <- rbind(FlucTotIV_clean_noDV_crrt, FlucTotIV_clean_noDV_nocrrt)
```
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_DV, FlucTotIV_clean_noDV)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

#### Now average BW and LENGTH per each ID 
```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", j))
    length_col <- paste0("LENGTH", sprintf("%02d", j))
    bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
    subset[subset$ID == i, bw_mean_col] <- mean(subset[subset$ID == i, bw_col], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col] <- mean(subset[subset$ID == i, length_col], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets}
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed6.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute6.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 51st to 60th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 80.69
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 80.28
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 82.18
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 81.03
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 77.03
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 84.00
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 78.11
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 83.31
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 78.32
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 76.64
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 57.85
median(Fluc_NONMEM_mul_impute$FFM04) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM05) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM06) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM07) #equals 57.93
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

### Lab meeting 05042023

#### This is the graphical exploration of the among of missing data by variable

```{r read dataset}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")
```

```{r missing data plot,echo=FALSE}
suppressPackageStartupMessages(library(VIM))
aggr_plot <- aggr(FlucTotIV_clean, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE,
labels=names(FlucTotIV_clean), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```

#### Apply Little's MCAR test

```{r MCAR test}
library(naniar)
mcar_test(FlucTotIV_clean)
```

### This following part can be eliminated

#### The following is redundant now
```{r imputation for BW - SEX HOSPITAL and LENGTH}
impute_BW01<-impute_BW1[,!names(impute_BW1) %in% c("AGE","CREAT2","CRRT2","AMT","RATE")]
```
```{r impute BW,include=FALSE}
set.seed(123)
library(mice)
imputed_BW01 <- mice(impute_BW01, m = 10,maxit=50)
for (i in 1:10) {
        impute_BW01[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_BW01, action = i))$BW
}
```
```{r imputation for LENGTH - AGE SEX CREAT2 HOSPITAL BW AMT RATE and CREAT2}
impute_LENGTH01<-impute_BW1
```
```{r impute LENGTH,include=FALSE}
set.seed(123)
library(mice)
imputed_LENGTH01 <- mice(impute_LENGTH01, m = 10,maxit=50)
for (i in 1:10) {
        impute_LENGTH01[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_LENGTH01, action = i))$LENGTH
}
```

##### Add ID column back after imputing
```{r add ID column and eliminate redundant columns BW dataset}
impute_BW01$ID<-impute_BW$ID
impute_BW01 <- impute_BW01[, !names(impute_BW01) %in% c("BW","LENGTH","SEX")]
```
```{r add ID column and eliminate redundant columns LENGTH dataset}
impute_LENGTH01$ID<-impute_BW$ID
impute_LENGTH01 <- impute_LENGTH01[, !names(impute_LENGTH01) %in% c("AGE","CREAT2","BW","LENGTH","SEX","AMT","RATE","CRRT2")]
```
```{r merge into original dataset}
FlucTotIV_clean_first <- FlucTotIV_clean[!duplicated(FlucTotIV_clean$ID), ]
imputed_first_BW <- merge(FlucTotIV_clean_first[, "ID", drop = FALSE], impute_BW01, by = "ID", all.x = TRUE)
imputed_first_LENGTH <- merge(FlucTotIV_clean_first[, "ID", drop = FALSE], impute_LENGTH01, by = "ID", all.x = TRUE)
FlucTotIV_clean_imputed <- merge(FlucTotIV_clean, imputed_first_BW, by = c("ID", "HOSPITAL"), all.x = TRUE)
FlucTotIV_clean_imputed <- merge(FlucTotIV_clean_imputed, imputed_first_LENGTH, by = c("ID", "HOSPITAL"), all.x = TRUE)
```

#### Here I try different linear regression models to select the best set of predictors for multiple imputation model
#### First of all, model with AMT + RATE + TAD but no DV
```{r lm_fit0 linear model}
lm_fit0 = glm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+LENGTH+AMT+RATE+factor(OCC)+TAD, data = impute_CREAT2)
summary(lm_fit0)
```
##### AIC of the first model equals 1805
```{r check R squared lm_fit0}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+LENGTH+AMT+RATE+factor(OCC)+TAD, data = impute_CREAT2))
```
##### Adjusted R-squared of this model equals 0.1571 - This can be my final no-DV imputation model
```{r model diagnostic}
qqnorm(residuals(lm_fit0), pch = 1, frame = FALSE)
qqline(residuals(lm_fit0), col = "steelblue", lwd = 2)
```
##### It looks quite normal
#### Second of all, I try model with DV, TAD but no AMT, RATE
```{r lm_fit1 linear model}
lm_fit1 = glm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH+TAD, data = impute_CREAT2)
summary(lm_fit1)
```
##### TAD doesn't seem to be an important predictor anymore
```{r lm_fit1 check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH+TAD, data = impute_CREAT2))
```
##### It brings down R-squared quite a lot actually, equals 0.1072
```{r model diagnostic}
qqnorm(residuals(lm_fit1), pch = 1, frame = FALSE)
qqline(residuals(lm_fit1), col = "steelblue", lwd = 2)
```
##### This plot looks quite normal 
#### Then (thirdly), I try removing TAD from the previous model
```{r lm_fit2 linear model}
lm_fit2 = glm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH, data = impute_CREAT2)
summary(lm_fit2)
```
```{r lm_fit2 check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH, data = impute_CREAT2))
```
##### Adjusted R-squared is 0.1089, is not significantly different from the first model, however AIC is much smaller
##### lm_fit2 is the best model until now (smallest AIC, largest adjusted R-squared)
#### After that (fourthly), I try removing factor (OCC) from lm_fit2
```{r lm_fit3 linear model}
lm_fit3 = glm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+LENGTH, data = impute_CREAT2)
summary(lm_fit3)
```
```{r lm_fit3 check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+LENGTH, data = impute_CREAT2))
```
##### lm_fit3 has a slightly lower AIC, however much lower adjusted R-squared, therefore keep lm_fit2
#### This following model seems to perform the best 
```{r best model with DV}
lm_fit4 = glm(CREAT2 ~ AGE + DV + factor(HOSPITAL)+factor(CRRT)+factor(OCC), data = impute_CREAT2)
summary(lm_fit4)
summary(lm(CREAT2 ~ AGE + DV + factor(HOSPITAL)+factor(CRRT)+factor(OCC), data = impute_CREAT2))
qqnorm(residuals(lm_fit4), pch = 1, frame = FALSE)
qqline(residuals(lm_fit4), col = "steelblue", lwd = 2)
```
##### Adjusted R-squared 0.1138, AIC 1100, normality assumption holds
```{r best imputation dataset}
impute_CREAT2_01 <- FlucTotIV_clean[, c("AGE","DV","HOSPITAL", "CRRT", "CREAT2","OCC")]
```

#### And I fitune from lm_fit0 
```{r lm_fit0 with no TAD}
lm_fit5 = glm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+LENGTH+AMT+RATE+factor(OCC), data = impute_CREAT2)
summary(lm_fit5)
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+LENGTH+AMT+RATE+factor(OCC), data = impute_CREAT2))
qqnorm(residuals(lm_fit5), pch = 1, frame = FALSE)
qqline(residuals(lm_fit5), col = "steelblue", lwd = 2)
```
##### Adjusted R-squared 0.1582, AIC 1848, normality assumption holds
#### Then fituning from lm_fit5
```{r lm_fit5 with no LENGTH}
lm_fit6 = glm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+AMT+RATE+factor(OCC), data = impute_CREAT2)
summary(lm_fit6)
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+AMT+RATE+factor(OCC), data = impute_CREAT2))
qqnorm(residuals(lm_fit6), pch = 1, frame = FALSE)
qqline(residuals(lm_fit6), col = "steelblue", lwd = 2)
```
##### Adjusted R-squared 0.1588, AIC 1846, normality assumption holds
#### Then fituning from lm_fit6
```{r lm_fit6 with no BW and TIME}
lm_fit7 = glm(CREAT2 ~ AGE + factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+AMT+RATE+factor(OCC), data = impute_CREAT2)
summary(lm_fit7)
summary(lm(CREAT2 ~ AGE + factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+AMT+RATE+factor(OCC), data = impute_CREAT2))
qqnorm(residuals(lm_fit7), pch = 1, frame = FALSE)
qqline(residuals(lm_fit7), col = "steelblue", lwd = 2)
```
##### Adjusted R-squared 0.1579, AIC 1845, normality assumption holds

#### My non-DV best model will contain AGE + SEX+HOSPITAL+CRRT+CRRT2+AMT+RATE+OCC as predictors
```{r non-DV best imputation dataset}
impute_CREAT2_02 <- FlucTotIV_clean[, c("AGE","SEX","HOSPITAL", "CRRT","CRRT2", "CREAT2","OCC","AMT","RATE")]
```

#### Imputing using my final lm_fit7 model
```{r final lm_fit7 model,include=FALSE,echo=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_02 <- mice(impute_CREAT2_02, m = 10,maxit=50,printFlag=FALSE)
```
```{r check the linear regression model again}
summary(lm(CREAT2 ~ AGE+ factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+AMT+RATE,data=complete(imputed_CREAT2_02,1)))
summary(lm(CREAT2 ~ AGE +factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+AMT+RATE,data=complete(imputed_CREAT2_02,2)))
```
```{r lm_fit8 linear model}
lm_fit8 = glm(CREAT2 ~ AGE+ factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+AMT+RATE,data=complete(imputed_CREAT2_02,1))
summary(lm_fit8)
```
```{r lm_fit8 model diagnostic}
qqnorm(residuals(lm_fit8), pch = 1, frame = FALSE)
qqline(residuals(lm_fit8), col = "steelblue", lwd = 2)
```
```{r lm_fit9 linear model}
lm_fit9 = glm(CREAT2 ~ AGE+ factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+AMT+RATE,data=complete(imputed_CREAT2_02,2))
summary(lm_fit9)
```
```{r lm_fit9 model diagnostic}
qqnorm(residuals(lm_fit9), pch = 1, frame = FALSE)
qqline(residuals(lm_fit9), col = "steelblue", lwd = 2)
```
##### imputed_CREAT2_02 is a better model to proceed with since it demonstrates better AIC, adjusted R-squared in imputed datasets, the degree of missing is much less compared to imputed_CREAT2_01 (number of logged events is only 500) 

#### Integrate imputed CREAT2 to FlucTotIV_clean dataset
```{r impute creatinine,include=FALSE,echo=FALSE}
for (i in 1:10) {
        FlucTotIV_clean[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_02, action = i))$CREAT2
}
```

#### Then I try removing DV
```{r lm model removing DV}
lm_fit2 = glm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH, data = impute_CREAT2)
summary(lm_fit2)
```

##### *This gives a much worse model*

```{r lm_fit2 check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH, data = impute_CREAT2))
```

```{r model no DV diagnostic}
qqnorm(residuals(lm_fit2), pch = 1, frame = FALSE)
qqline(residuals(lm_fit2), col = "steelblue", lwd = 2)
```

##### Does it really needed to include outcome as a predictor?

#### Then I try adding TAD
```{r linear model}
lm_fit3 = glm(CREAT2 ~ AGE + BW2 + factor(SEX) + DV +TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH+TAD, data = impute_CREAT2)
summary(lm_fit3)
```
```{r lm_fit3 check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+DV+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH+TAD, data = impute_CREAT2))
```
```{r lm_fit3 model diagnostic}
qqnorm(residuals(lm_fit3), pch = 1, frame = FALSE)
qqline(residuals(lm_fit3), col = "steelblue", lwd = 2)
```
#### The model with the fullest data available
```{r lm_fit4 linear model}
lm_fit4 = glm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+LENGTH+factor(EVID), data = impute_CREAT2)
summary(lm_fit4)
```
```{r check the model R squared}
summary(lm(CREAT2 ~ AGE + BW2 + factor(SEX)+TIME+factor(HOSPITAL)+factor(CRRT)+factor(OCC)+LENGTH+factor(EVID), data = impute_CREAT2))
```

### Check the performance of different imputation model
#### First check the model with TAD
```{r model with TAD,include=FALSE,echo=FALSE}
library(mice)
set.seed(123)
imputed_CREAT2_01 <- mice(impute_CREAT2_01, m = 10,maxit=50,printFlag=FALSE)
```
```{r check the linear regression model again}
summary(lm(CREAT2 ~ AGE + DV+factor(HOSPITAL)+factor(CRRT)+factor(OCC),data=complete(imputed_CREAT2_01,1)))
summary(lm(CREAT2 ~ AGE + DV+factor(HOSPITAL)+factor(CRRT)+factor(OCC),data=complete(imputed_CREAT2_01,2)))
```
```{r lm_fit6 linear model}
lm_fit6 = glm(CREAT2 ~ AGE + DV+factor(HOSPITAL)+factor(CRRT)+factor(OCC),data=complete(imputed_CREAT2_01,1))
summary(lm_fit6)
```
```{r lm_fit6 model diagnostic}
qqnorm(residuals(lm_fit6), pch = 1, frame = FALSE)
qqline(residuals(lm_fit6), col = "steelblue", lwd = 2)
```
```{r lm_fit7 linear model}
lm_fit7 = glm(CREAT2 ~ AGE + DV+factor(HOSPITAL)+factor(CRRT)+factor(OCC),data=complete(imputed_CREAT2_01,2))
summary(lm_fit7)
```
```{r lm_fit7 model diagnostic}
qqnorm(residuals(lm_fit7), pch = 1, frame = FALSE)
qqline(residuals(lm_fit7), col = "steelblue", lwd = 2)
```
##### Check imputed DV to see if it makes sense
```{r impute DV,include=FALSE,echo=FALSE}
for (i in 1:10) {
        FlucTotIV_clean[[paste0("DV", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_01, action = i))$DV
}
```

### This following can be skipped

### Here I will do differently, use automated process
#### Build an optimal model for imputing CREAT2
```{r select a set of predictors}
impute_CREAT2 <- FlucTotIV_clean[, c("AGE", "SEX", "BW2", "TIME", "HOSPITAL", "CRRT", "CREAT2","CRRT2","OCC","LENGTH","TAD","AMT","RATE")]
```
```{r select an optimal linear regression model based on adjusted R-squared}
library(leaps)

# Fit a model using forward stepwise selection based on adjusted R-squared
regfit <- regsubsets(CREAT2 ~ ., data = impute_CREAT2, method = "forward", nvmax = ncol(impute_CREAT2), really.big = TRUE)
summary(regfit)

# Identify the best model based on adjusted R-squared
best_model <- which.max(summary(regfit)$adjr2)
coef(regfit, best_model)
```
##### Now it seems the model with AGE, SEX, HOSPITAL, CRRT2 and OCC is the best one
```{r check the best model}
summary(lm(CREAT2~AGE+SEX+HOSPITAL+OCC+CRRT2,data=impute_CREAT2))
summary(glm(CREAT2~AGE+SEX+HOSPITAL+OCC+CRRT2,data=impute_CREAT2))
```
```{r select an optimal linear regression model based on AIC}
library(glmulti)

# Define the formula for the linear regression model
formula <- "CREAT2 ~ AGE + SEX + BW2 + TIME + HOSPITAL + CRRT + CRRT2 + OCC + LENGTH + TAD + AMT + RATE"

# Use glmulti to select the best model based on AIC
glmulti_output <- glmulti(formula, data = impute_CREAT2, level = 2, crit = "aic")

# Print the results
summary(glmulti_output)
```
##### This above code is too computationally demanding!!! So, don't use it!

#### Start to impute based on the best model according to adjusted R-squared criteria
```{r impute model without TAD,include=FALSE,echo=FALSE}
library(mice)
set.seed(123)
creat2_impute<-FlucTotIV_clean[, c("AGE", "SEX", "HOSPITAL", "CRRT2", "CREAT2","OCC")]
creat2_imputed <- mice(creat2_impute, m = 10,maxit=50,printFlag=FALSE)
```
```{r check imputed dataset}
creat2_imputed_1<-complete(creat2_imputed,1)
```

### Can skip this as well
```{r compare two imputed dataset}
FlucTotIV_clean_imputed<-read.csv("FlucTotIV_clean_imputed.csv")
FlucTotIV_clean
FlucTotIV_clean_imputed
```

```{r compare median of creat01}
hist(FlucTotIV_clean$CREAT01)
hist(FlucTotIV_clean_imputed$CREAT01)
median(FlucTotIV_clean$CREAT01)
median(FlucTotIV_clean_imputed$CREAT01)
```

```{r compare median of creat02}
hist(FlucTotIV_clean$CREAT02)
hist(FlucTotIV_clean_imputed$CREAT02)
median(FlucTotIV_clean$CREAT02)
median(FlucTotIV_clean_imputed$CREAT02)
```
#### Here I compare two imputations when I don't converge it to the right datatype

```{r incorrect datatype imputuation,echo=FALSE,include=FALSE}
FlucTotIV_clean01<-read.csv("FlucTotIV_clean.csv")
impute_CREAT02 <- FlucTotIV_clean01[, c("AGE", "SEX", "BW2", "DV", "TIME", "HOSPITAL", "CRRT", "CREAT2","OCC","LENGTH")]
library(mice)
set.seed(123)
imputed_CREAT02 <- mice(impute_CREAT02, m = 10,maxit=50)
for (i in 1:10) {
        FlucTotIV_clean01[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT02, action = i))$CREAT2
}
```

```{r compare the medians of CREAT01}
median(FlucTotIV_clean01$CREAT01)
median(FlucTotIV_clean_imputed$CREAT01)
```

##### This clearly proves that I made a mistake in the imputation step
#### Here I proceed with FlucTotIV_clean dataset

#### This part can be skipped too
##### My third lm_noDV2 model, which is lm_noDV1 removing BW2
```{r lm_noDV2 linear model}
lm_noDV2 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC), data = FlucTotIV_clean_noDV)
summary(lm_noDV2)
AIC(lm_noDV2)
```
##### AIC of lm_noDV2 model equals 746.8, adjusted R-squared is 0.205

```{r lm_noDV2 model diagnostic}
qqnorm(residuals(lm_noDV2), pch = 1, frame = FALSE)
qqline(residuals(lm_noDV2), col = "steelblue", lwd = 2)
```
##### It looks quite off from nomality, however we will still consider it normal.

##### My third lm_noDV3 model, which is lm_noDV2 removing OCC
```{r lm_noDV3 linear model}
lm_noDV3 = lm(CREAT2 ~ TIME+AMT+RATE+AGE+factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2), data = FlucTotIV_clean_noDV)
summary(lm_noDV3)
AIC(lm_noDV3)
```
##### AIC of lm_noDV3 model equals 700.2, adjusted R-squared is 0.233
##### Therefore, lm_noDV3 will be my final imputation model for no-DV-dataset. The predictors for final imputation no-DV-dataset model are TIME+AMT+RATE+AGE+factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)

```{r lm_noDV3 model diagnostic}
qqnorm(residuals(lm_noDV3), pch = 1, frame = FALSE)
qqline(residuals(lm_noDV3), col = "steelblue", lwd = 2)
```
##### It looks quite off from nomality, however we will still consider it normal.

#### Impute BW & LENGTH
```{r convert data type}
FlucTotIV_clean$ID <- as.factor(FlucTotIV_clean$ID)
FlucTotIV_clean$BW <- as.numeric(FlucTotIV_clean$BW)
FlucTotIV_clean$LENGTH <- as.numeric(FlucTotIV_clean$LENGTH)
FlucTotIV_clean$AGE <- as.numeric(FlucTotIV_clean$AGE)
FlucTotIV_clean$BW2 <- as.numeric(FlucTotIV_clean$BW2)
FlucTotIV_clean$DV <- as.numeric(ifelse(FlucTotIV_clean$DV == ".", NA, FlucTotIV_clean$DV))
FlucTotIV_clean$TIME <- as.numeric(FlucTotIV_clean$TIME)
FlucTotIV_clean$CREAT2 <- as.numeric(FlucTotIV_clean$CREAT2)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
```

##### I choose the best model based on adjusted R-squared
```{r extract data for BW & LENGTH imputation,include=FALSE}
library(dplyr)
impute_BW <- FlucTotIV_clean %>% 
        group_by(ID) %>% 
        slice(1) %>% 
        select(ID,AGE, SEX,CREAT2, BW, HOSPITAL, LENGTH,AMT,RATE,CRRT2)
```
```{r exclude ID out of imputation model}
impute_BW1<-impute_BW[,!names(impute_BW) %in% c("ID")]
```
```{r fit a model for imputing BW}
summary(lm(BW~AGE+SEX+CREAT2+HOSPITAL+LENGTH+AMT+RATE+CRRT2,data=impute_BW1))
```
```{r finetune the BW model - excluding non-significant predictors}
summary(lm(BW~LENGTH+AMT,data=impute_BW1))
summary(glm(BW~LENGTH+AMT,data=impute_BW1))
```
```{r excluding AMT from the previous model}
summary(lm(BW~LENGTH,data=impute_BW1))
summary(glm(BW~LENGTH,data=impute_BW1))
```
```{r if we include AGE}
summary(lm(BW~LENGTH+AMT+SEX,data=impute_BW1))
summary(glm(BW~LENGTH+AMT+SEX,data=impute_BW1))
```
```{r if we include SEX}
summary(lm(BW~LENGTH+AMT+SEX,data=impute_BW1))
summary(glm(BW~LENGTH+AMT+SEX,data=impute_BW1))
```
##### Best predictors for BW is SEX, HOSPITAL and LENGTH
```{r check best model for BW}
summary(lm(BW~HOSPITAL+SEX+LENGTH,data=impute_BW))
```
#### Do similarly for LENGTH
```{r fit a model for imputing BW}
summary(lm(LENGTH~AGE+SEX+CREAT2+HOSPITAL+BW+AMT+RATE+CRRT2,data=impute_BW1))
```
```{r fitune LENGTH model - excluding CREAT2}
summary(lm(LENGTH~AGE+SEX+HOSPITAL+BW+AMT+RATE+CRRT2,data=impute_BW1))
```
##### Best predictors for LENGTH is AGE,SEX,CREAT2,HOSPITAL,BW,AMT,RATE and CRRT2

```{r lm_DV1 model diagnostic}
qqnorm(residuals(lm_DV1), pch = 1, frame = FALSE)
qqline(residuals(lm_DV1), col = "steelblue", lwd = 2)
```
##### It looks quite normal. Normality assumption holds

##### My third lm_DV2 model, which is lm_DV1 removing BW2
```{r lm_DV2 linear model}
lm_DV2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD, data = FlucTotIV_clean_DV)
summary(lm_DV2)
AIC(lm_DV2)
```
##### AIC of lm_DV2 model equals 1083.4, adjusted R-squared is 0.1572

```{r lm_DV2 model diagnostic}
qqnorm(residuals(lm_DV2), pch = 1, frame = FALSE)
qqline(residuals(lm_DV2), col = "steelblue", lwd = 2)
```
##### It looks quite normal. Normality assumption holds

##### My third lm_DV3 model, which is lm_DV2 removing SEX
```{r lm_DV2 linear model}
lm_DV3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD, data = FlucTotIV_clean_DV)
summary(lm_DV3)
AIC(lm_DV3)
```
##### AIC of lm_DV3 model equals 1083, adjusted R-squared is 0.1563
##### Therefore, lm_DV2 will be my final imputation model for DV-dataset. The predictors for final imputation DV-dataset model are TIME+AMT+RATE+DV+AGE+factor(SEX)+factor(HOSPITAL)+factor(CRRT)+factor(CRRT2)+factor(OCC)+TAD
### The end of the excluded part. An automated step does not seem to work