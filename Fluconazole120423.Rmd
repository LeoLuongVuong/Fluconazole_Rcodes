---
title: "Fluconazole after discussion with Steven"
author: "Leo"
date: "2023-04-12"
output: pdf_document
---

### Some take home message from the Q&A session on the 12th April 2023
#### 1. If I do stratified imputation based on DV, I will lose precision and it is not recommended! -> Therefore I should keep it
#### 2. The unrealistic DV values resulting from that model is not something to worry about given that I only care about the covariates
#### 3. If stratifying based on CRRT gives a more realistic CREAT2 value, then it is better to do so.
#### 4. Logged events is something to worry about, should better check it
#### 5. Log-transform my variance, then use Delta method for calculating the variance tranformed term based on the one of the untransformed
#### 6. Missing values in the predictors is not an excuse of not including it in the imputation model. We should include as many variables as we can, as long as its inclusion improves the imputation model

### Here are my final decisions regarding the multiple-imputation model
#### 1. Include as many variables as I can from my dataset.
##### All the possible variables that I can include from my dataset are: "TIME","AMT","RATE","DV","AGE","BW2","SEX","LENGTH","HOSPITAL","OCC","TAD","CRRT","CREAT2", "CRRT2" (probably),"GGT","AFT","AST","ALT","BILI","SOFA","FLUID",CL24", "APACHE" and "ALB" 

### However, first of all, I need to eliminate all the (potential) duplicates in the (potential) predictors of my FlucTotIV_clean dataset
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
```

```{r read in the original source dataset,warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean<-read.csv("FlucTotIV_clean.csv")
```

```{r convert data types,warning=FALSE}
FlucTotIV_clean$AGE <- as.numeric(FlucTotIV_clean$AGE)
FlucTotIV_clean$LENGTH <- as.numeric(FlucTotIV_clean$LENGTH)
FlucTotIV_clean$BW2 <- as.numeric(FlucTotIV_clean$BW2)
FlucTotIV_clean$DV <- as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$TIME <- as.numeric(FlucTotIV_clean$TIME)
FlucTotIV_clean$CREAT2 <- as.numeric(FlucTotIV_clean$CREAT2)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
FlucTotIV_clean$EVID <- as.factor(FlucTotIV_clean$EVID)
FlucTotIV_clean$TAD <- as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean$RATE <- as.numeric(FlucTotIV_clean$RATE)
FlucTotIV_clean$CL24 <- as.numeric(FlucTotIV_clean$CL24)
FlucTotIV_clean$GGT <- as.numeric(FlucTotIV_clean$GGT)
FlucTotIV_clean$AFT <- as.numeric(FlucTotIV_clean$AFT)
FlucTotIV_clean$AST <- as.numeric(FlucTotIV_clean$AST)
FlucTotIV_clean$ALT <- as.numeric(FlucTotIV_clean$ALT)
FlucTotIV_clean$BILI <- as.numeric(FlucTotIV_clean$BILI)
FlucTotIV_clean$ALB <- as.numeric(FlucTotIV_clean$ALB)
FlucTotIV_clean$FLUID <- as.numeric(FlucTotIV_clean$FLUID)
FlucTotIV_clean$APACHE <- ifelse(is.na(FlucTotIV_clean$APACHE), NA, as.factor(FlucTotIV_clean$APACHE))
FlucTotIV_clean$SOFA <- ifelse(is.na(FlucTotIV_clean$SOFA), NA, as.factor(FlucTotIV_clean$SOFA))
FlucTotIV_clean$ID<-as.numeric(FlucTotIV_clean$ID)
```

#### Remove all the duplicates in "CL24", "GGT", "AFT", "AST", "ALT", "BILI", "ALB", "SOFA", "FLUID","APACHE"
```{r create a cleaner dataset, include=FALSE}
library(dplyr)

cols_to_process <- c("CL24", "GGT", "AFT", "AST", "ALT", "BILI", "ALB", "SOFA", "FLUID","APACHE")

FlucTotIV_clean <- FlucTotIV_clean %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(across(all_of(cols_to_process), ~ ifelse(duplicated(.), NA, .))) %>%
  ungroup()
```

#### Then check the percentage of missingness of the aforementioned variables after eliminating duplicates
```{r percentage of missingness}
# Create a vector of variable names to process
vars_to_process <- c("CL24", "GGT", "AFT", "AST", "ALT", "BILI", "ALB", "SOFA", "FLUID","APACHE")

# Calculate the percentage of missing data for each variable
missing_percents <- colMeans(is.na(FlucTotIV_clean[, vars_to_process])) * 100

# Print the results
missing_percents

```
##### quite a lot actually
##### CL24, APACHE and ALB should be least prioritized since they are missing too much

#### Convert all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0
```{r convert NAs to 0}
FlucTotIV_clean$TAD[is.na(FlucTotIV_clean$TAD)] <- 0
FlucTotIV_clean$AMT[is.na(FlucTotIV_clean$AMT)] <- 0
FlucTotIV_clean$RATE[is.na(FlucTotIV_clean$RATE)] <- 0
```
```{r convert DV to 0 where TIME equals 0}
FlucTotIV_clean$DV[FlucTotIV_clean$TIME == 0] <- 0
```

#### Create a new variable called CRRT2 to indicate whether a patient had CRRT or not

```{r creat CRRT2 variable}
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"]) #IDs of the patients who have CRRT
FlucTotIV_clean$CRRT2 <- ifelse(FlucTotIV_clean$ID %in% crrt_patients, 1, 0)
FlucTotIV_clean$CRRT2 <- as.factor(FlucTotIV_clean$CRRT2)
```

#### Convert APACHE from 214 to NA
```{r APACHE from 214 to NA}
FlucTotIV_clean$APACHE[FlucTotIV_clean$APACHE == 214] <- NA
```


### Building model for imputation step
#### First of all, I will try not stratifying based on CRRT, and use CRRT2 as a predictor
##### My first lm_unstra_1 model (which include all the possible predictors comprising of the 3 very-missing variables)
##### Turns out FLUID can't be included for some reason, so does SOFA, APACHE, CL24 and ALB
```{r lm_unstra_1 linear model}
lm_unstra_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL)+factor(CRRT2)+GGT+AFT+AST+ALT+BILI, data = FlucTotIV_clean)
summary(lm_unstra_1)
AIC(lm_unstra_1)
```
##### AIC of lm_unstra_1 model equals 297, adjusted R-squared is 0.4538

```{r lm_unstra_1 model diagnostic}
qqnorm(residuals(lm_unstra_1), pch = 1, frame = FALSE)
qqline(residuals(lm_unstra_1), col = "steelblue", lwd = 2)
```
##### It looks quite normal. Normality assumption holds

##### My second lm_unstra_2 model, which is lm_unstra_1 removing CRRT
```{r lm_unstra_2 linear model}
lm_unstra_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL)+factor(CRRT2)+GGT+AFT+AST+ALT+BILI, data = FlucTotIV_clean)
summary(lm_unstra_2)
AIC(lm_unstra_2)
```

##### AIC of lm_unstra_2 model equals 295, adjusted R-squared is 0.4575, which is better than lm_unstra_1

```{r lm_unstra_2 model diagnostic}
qqnorm(residuals(lm_unstra_2), pch = 1, frame = FALSE)
qqline(residuals(lm_unstra_2), col = "steelblue", lwd = 2)
```
##### It looks quite normal. Normality assumption holds

##### My third lm_unstra_3 model, which is lm_unstra_2 removing BILI
```{r lm_unstra_3 linear model}
lm_unstra_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL)+factor(CRRT2)+GGT+AFT+AST+ALT, data = FlucTotIV_clean)
summary(lm_unstra_3)
AIC(lm_unstra_3)
```

##### AIC of lm_unstra_3 model equals 316, adjusted R-squared is 0.4477, which is worse than lm_unstra_2
##### therefore, lm_unstra_2 is my final DV-included imputation model. The predictors for final imputation DV-dataset model are TIME+AMT+RATE+DV+AGE+factor(SEX)+BW2+LENGTH+factor(HOSPITAL)+factor(OCC)+factor(CRRT2)+TAD+GGT+AFT+AST+ALT+BILI

#### Imputing based on the non-CRRT stratified imputation model and check imputation model diagnostic
```{r impute impute_unstra_crrt dataset}
impute_unstra_crrt <- FlucTotIV_clean[, c("TIME","AMT","RATE", "DV","AGE","BW2","SEX","LENGTH","HOSPITAL","OCC","CRRT2","TAD","GGT","AFT","AST","ALT","BILI","CREAT2")]
set.seed(123)
imputed_unstra_crrt<- mice(impute_unstra_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_unstra_crrt, action = i))$CREAT2
}
```
```{r check the logged events}
summary(imputed_unstra_crrt)
```
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean$CREAT2 <- ifelse(FlucTotIV_clean$CREAT2 == -99, NA, FlucTotIV_clean$CREAT2)
ggplot(FlucTotIV_clean, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
###### The performance of the imputation so poor, interms of the density plots and logged events
###### This is definitely much poorer than my previous imputation model

#### Second of all, I will try stratifying based on CRRT, and use CRRT2 as a predictor for the CRRT patients
##### Firstly, I will create 2 datasets, crrt and no crrt datasets
```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I build the imputation model for crrt dataset
###### My first lm_crrt_1 model (which include all the possible predictors as above, and obviously CRRT2 will not be a predictor); GGT, AFT,AST, ALT, BILI can't be included either
```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL), data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)
```
###### AIC of lm_crrt_1 model equals 352, adjusted R-squared is -0.02
###### It is too bad!

###### My second lm_crrt_2 model, which is lm_crrt_1 removing HOSPITAL
```{r lm_crrt_2 linear model}
lm_crrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)
```

###### AIC of lm_crrt_2 model equals 347, adjusted R-squared is 0.014, which is better than lm_crrt_1

###### My third lm_crrt_3 model, which is lm_crrt_2 removing OCC
```{r lm_crrt_3 linear model}
lm_crrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_3)
AIC(lm_crrt_3)
```
###### AIC of lm_crrt_3 model equals 315.3, adjusted R-squared is 0.1405, which is better than lm_crrt_2

##### My fourth lm_crrt_4 model, which is lm_crrt_3 removing TAD
```{r lm_crrt_4 linear model}
lm_crrt_4 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_4)
AIC(lm_crrt_4)
```
##### AIC of lm_crrt_4 model equals 313.3, adjusted R-squared is 0.150

```{r lm_crrt_4 model diagnostic}
qqnorm(residuals(lm_crrt_4), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt_4), col = "steelblue", lwd = 2)
```
###### It looks normal, normality assumption therefore holds.
###### Therefore, lm_crrt_4 will be my final imputation model for crrt dataset. The predictors for final imputation crrt dataset model are TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT)

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

##### After that, I build the imputation model for no-crrt dataset
###### My first lm_nocrrt_1 model (which include all the possible predictors as above, and obviously CRRT2 and CRRT will not be a predictor); GGT, AFT,AST, ALT, BILI can't be included either
```{r lm_nocrrt_1 linear model}
lm_nocrrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL)+GGT+AFT+AST+ALT+BILI, data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_1)
AIC(lm_nocrrt_1)
```
###### AIC of lm_nocrrt_1 model equals 226, adjusted R-squared is 0.2878
###### This is really good!

###### My second lm_nocrrt_2 model, which is lm_nocrrt_1 removing BILI
```{r lm_nocrrt_2 linear model}
lm_nocrrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL)+GGT+AFT+AST+ALT, data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_2)
AIC(lm_nocrrt_2)
```

###### AIC of lm_nocrrt_2 model equals 245, adjusted R-squared is 0.282, which is worse than lm_nocrrt_1

```{r lm_nocrrt_1 model diagnostic}
qqnorm(residuals(lm_nocrrt_1), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt_1), col = "steelblue", lwd = 2)
```
###### It looks normal, normality assumption therefore holds.
###### Therefore, lm_nocrrt_1 will be my final imputation model for nocrrt dataset. The predictors for final imputation no-crrt dataset model are TIME + AMT + RATE + DV + AGE + BW2 + factor(SEX) + LENGTH + factor(OCC) + TAD + factor(HOSPITAL) + GGT + AFT + AST + ALT + BILI

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","OCC","TAD","HOSPITAL","GGT","AFT","AST","ALT","BILI","CREAT2")]
```

##### Then imputing crrt and non-crrt models
```{r for impute_CREAT2_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r for impute_CREAT2_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```
###### Since the number of logged events is high (1400), I check the after imputation model as following
```{r lm_nocrrt_3 after imputation linear model}
lm_nocrrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL)+GGT+AFT+AST+ALT+BILI, data = complete(imputed_CREAT2_nocrrt,1))
summary(lm_nocrrt_3)
AIC(lm_nocrrt_3)
```
##### Then combining these two crrt and non-crrt imputed dataset
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Then check the imputation performation via diagnostic plots
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
###### This plot also looks very bad, therefore I'd better stick with the variables that I tried at the very beginning, excluding all those variables that have more than 90% missingness

#### I decided to build imputation models based on CRRT status (whether a patient has at least 1 CRRT session), and the predictors that I will be using will be restricted to "TIME", "AMT", "RATE", "DV", "AGE", "BW2", "SEX", "LENGTH", "HOSPITAL", "OCC", "TAD", "CRRT", "CREAT2" 

##### Firstly, I will create 2 datasets, crrt and no crrt datasets
```{r crrt & non-crrt dataset, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))

```

##### Then I build the imputation model for crrt dataset
##### I will have the same imputation model for crrt dataset as above, which is lm_crrt_4 as below
###### My first lm_crrt_1 model (which include all the possible predictors as above)
```{r lm_crrt_1 linear model}
lm_crrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT)+factor(HOSPITAL), data = FlucTotIV_clean_crrt)
summary(lm_crrt_1)
AIC(lm_crrt_1)

# Check the code
library(dplyr)

subset_non_na <- FlucTotIV_clean_crrt %>%
  filter(!is.na(CREAT2) & !is.na(TIME) & !is.na(AMT) & !is.na(RATE) & !is.na(DV) &
         !is.na(AGE) & !is.na(BW2) & !is.na(SEX) & !is.na(LENGTH) & !is.na(OCC) &
         !is.na(TAD) & !is.na(CRRT) & !is.na(HOSPITAL) & !is.na(dosing_interval))

# View the subset data
View(subset_non_na)


```
###### AIC of lm_crrt_1 model equals 352, adjusted R-squared is -0.02
###### It is too bad!

###### My second lm_crrt_2 model, which is lm_crrt_1 removing HOSPITAL
```{r lm_crrt_2 linear model}
lm_crrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_2)
AIC(lm_crrt_2)
```

###### AIC of lm_crrt_2 model equals 347, adjusted R-squared is 0.014, which is better than lm_crrt_1

###### My third lm_crrt_3 model, which is lm_crrt_2 removing OCC
```{r lm_crrt_3 linear model}
lm_crrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_3)
AIC(lm_crrt_3)
```
###### AIC of lm_crrt_3 model equals 315.3, adjusted R-squared is 0.1405, which is better than lm_crrt_2

##### My fourth lm_crrt_4 model, which is lm_crrt_3 removing TAD
```{r lm_crrt_4 linear model}
lm_crrt_4 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT), data = FlucTotIV_clean_crrt)
summary(lm_crrt_4)
AIC(lm_crrt_4)
```
##### AIC of lm_crrt_4 model equals 313.3, adjusted R-squared is 0.150

```{r lm_crrt_4 model diagnostic}
qqnorm(residuals(lm_crrt_4), pch = 1, frame = FALSE)
qqline(residuals(lm_crrt_4), col = "steelblue", lwd = 2)
```
###### It looks normal, normality assumption therefore holds.
###### Therefore, lm_crrt_4 will be my final imputation model for crrt dataset. The predictors for final imputation crrt dataset model are TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(CRRT)

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

##### After that, I build the imputation model for no-crrt dataset
###### My first lm_nocrrt_1 model (which include all the possible predictors as above, not including CRRT of course) 
```{r lm_nocrrt_1 linear model}
lm_nocrrt_1 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(OCC)+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_1)
AIC(lm_nocrrt_1)
```
###### AIC of lm_nocrrt_1 model equals 704, adjusted R-squared is 0.160

###### My second lm_nocrrt_2 model, which is lm_nocrrt_1 removing OCC
```{r lm_nocrrt_2 linear model}
lm_nocrrt_2 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+TAD+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_2)
AIC(lm_nocrrt_2)
```

###### AIC of lm_nocrrt_2 model equals 669.8, adjusted R-squared is 0.186, which is a lot better than lm_nocrrt_1

###### My third lm_nocrrt_3 model, which is lm_nocrrt_2 removing TAD
```{r lm_nocrrt_3 linear model}
lm_nocrrt_3 = lm(CREAT2 ~ TIME+AMT+RATE+DV+AGE+BW2+factor(SEX)+LENGTH+factor(HOSPITAL), data = FlucTotIV_clean_nocrrt)
summary(lm_nocrrt_3)
AIC(lm_nocrrt_3)
```

###### AIC of lm_nocrrt_3 model equals 669.3, adjusted R-squared is 0.185, which is a slightly worse than lm_nocrrt_2

```{r lm_nocrrt_2 model diagnostic}
qqnorm(residuals(lm_nocrrt_2), pch = 1, frame = FALSE)
qqline(residuals(lm_nocrrt_2), col = "steelblue", lwd = 2)
```

###### It looks quite normal, normality assumption therefore holds.
###### Therefore, lm_nocrrt_2 will be my final imputation model for nocrrt dataset. The predictors for final imputation no-crrt dataset model are TIME + AMT + RATE + DV + AGE + BW2 + factor(SEX) + LENGTH + TAD + factor(HOSPITAL) 

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

##### Then imputing crrt and non-crrt models
```{r for impute_CREAT2_crrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r for impute_CREAT2_nocrrt dataset}
library(mice)
set.seed(123)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```
###### The number of logged events is much lower than before (400 compared to 1400)

##### Then combining these two crrt and non-crrt imputed dataset
```{r combine FlucTotIV_clean}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Then check the imputation performation via diagnostic plots
```{r distribution of CREAT01 to 10 compared to CREAT2,warning=FALSE}
library(ggplot2)
FlucTotIV_clean_imputed$CREAT2 <- ifelse(FlucTotIV_clean_imputed$CREAT2 == -99, NA, FlucTotIV_clean_imputed$CREAT2)
ggplot(FlucTotIV_clean_imputed, aes(x = CREAT01)) + 
        geom_density(aes(fill = "CREAT01"), alpha = 0.5) + 
        geom_density(aes(x = CREAT02, fill = "CREAT02"), alpha = 0.5) + 
        geom_density(aes(x = CREAT03, fill = "CREAT03"), alpha = 0.5) + 
        geom_density(aes(x = CREAT04, fill = "CREAT04"), alpha = 0.5) + 
        geom_density(aes(x = CREAT05, fill = "CREAT05"), alpha = 0.5) + 
        geom_density(aes(x = CREAT06, fill = "CREAT06"), alpha = 0.5) + 
        geom_density(aes(x = CREAT07, fill = "CREAT07"), alpha = 0.5) + 
        geom_density(aes(x = CREAT08, fill = "CREAT08"), alpha = 0.5) + 
        geom_density(aes(x = CREAT09, fill = "CREAT09"), alpha = 0.5) + 
        geom_density(aes(x = CREAT10, fill = "CREAT10"), alpha = 0.5) +
        geom_density(aes(x = CREAT2, fill = "CREAT2"), alpha = 0.5) +
        scale_fill_manual(name = "Variable", values = c("CREAT01" = "blue", "CREAT02" = "lightblue", "CREAT03" = "green",
                                                        "CREAT04" = "orange", "CREAT05" = "purple", "CREAT06" = "pink",
                                                        "CREAT07" = "brown", "CREAT08" = "gray", "CREAT09" = "black",
                                                        "CREAT10" = "yellow","CREAT2" = "red")) +
        xlab("Creatinine Levels") +
        ylab("Density") +
        ggtitle("Density Plot of 10 imputed creatinin vs the original creatinin")
```
###### This plot also looks better than before
###### I also made CREAT vs TIME plots (from Fluconazole.Rmd file), they look alright 

### Creat imputation datasets step 
#### Here I will set up a new working directory where I save all the imputed datasets using the aforementioned strategy. The minimum number of imputations is 100, so at least 10 datasets, 10 imputations each

```{r set new working directory}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
```

#### First of all, my first imputed dataset (imputation 1st to 10th)

##### Firstly, for FlucTotIV_clean_crrt dataset
##### With this, I just need to continue from above by adding BW and LENGTH
##### Adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed1.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute1.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 1st to 10th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 88.25
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 85.79
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 83.39
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 85.34
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 84.02
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 89.51
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 87.40
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 85.40
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 85.38
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 85.58
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 57.97
```


#### Second of all, my second imputed dataset (imputation 11th to 20th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset}
library(mice)
set.seed(124)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(124)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 02, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed2.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute2.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 11st to 20th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 85.88
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 83.51
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 88.25
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 91.59
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 90.49
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 84.95
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 87.16
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 81.74
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 82.43
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 90.96
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Third of all, my third imputed dataset (imputation 21st to 30th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset}
library(mice)
set.seed(125)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(125)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 03, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed3.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute3.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 21st to 30th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 86.69
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 84.78
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 85.61
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 85.10
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 91.23
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 85.58
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 85.82
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 91.95
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 87.17
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 87.72
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Fourth of all, my fourth imputed dataset (imputation 31st to 40th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset}
library(mice)
set.seed(126)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(126)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 04, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed4.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute4.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 31st to 40th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 89.32
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 89.33
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 84.95
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 89.36
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 86.74
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 88.78
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 91.23
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 87.25
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 89.42
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 85.79
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Fifth of all, my fifth imputed dataset (imputation 41st to 50th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset}
library(mice)
set.seed(127)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(127)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 05, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed5.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute5.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 41st to 50th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 85.56
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 90.09
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 86.12
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 85.03
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 88.13
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 82.76
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 87.97
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 84.52
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 86.75
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 90.69
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.01
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.80
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 57.68
```

#### Sixth of all, my sixth imputed dataset (imputation 51st to 60th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset, warning = FALSE}
library(mice)
set.seed(128)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(128)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 06, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed6.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute6.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 51st to 60th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 87.17
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 88.28
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 90.45
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 83.11
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 90.54
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 84.20
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 87.83
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 89.36
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 83.51
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 91.62
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Seventh of all, my seventh imputed dataset (imputation 61st to 70th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset, warning = FALSE}
library(mice)
set.seed(129)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(129)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 07, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed7.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute7.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 61st to 70th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 88.87
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 86.79
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 88.98
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 89.20
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 87.95
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 87.95
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 88.11
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 83.98
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 85.04
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 87.27
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM06) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM07) #equals 57.93
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 57.68
```

#### Eighth of all, my eighth imputed dataset (imputation 71st to 80th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset, warning = FALSE}
library(mice)
set.seed(130)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(130)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 08, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed8.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute8.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 71st to 80th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 87.18
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 90.24
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 87.15
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 85.81
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 81.80
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 91.42
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 90.54
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 90.80
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 85.04
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 84.50
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.11
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Ninth of all, my ninth imputed dataset (imputation 81st to 90th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset, warning = FALSE}
library(mice)
set.seed(131)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(131)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 09, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed9.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute9.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 81st to 90th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 86.15
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 89.40
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 82.67
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 87.94
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 85.41
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 90.09
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 90.75
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 86.69
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 84.33
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 87.44
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM04) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM09) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

#### Tenth of all, my tenth imputed dataset (imputation 91st to 100th)

##### Firstly, I create crrt and non-crrt datasets

```{r crrt & non-crrt datasets, warning=FALSE}
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients$ID)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients$ID))
```

##### Then I impute CREAT2 for both datasets

```{r best imputation crrt dataset}
impute_CREAT2_crrt <- FlucTotIV_clean_crrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH", "CRRT","CREAT2")]
```

```{r best imputation nocrrt dataset}
impute_CREAT2_nocrrt <- FlucTotIV_clean_nocrrt[, c("TIME","RATE","AMT","DV","AGE","SEX","BW2","LENGTH","TAD","HOSPITAL","CREAT2")]
```

```{r imputing impute_CREAT2_crrt dataset, warning = FALSE}
library(mice)
set.seed(132)
imputed_CREAT2_crrt<- mice(impute_CREAT2_crrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$CREAT2
}
```

```{r imputing impute_CREAT2_nocrrt dataset, warning = FALSE}
library(mice)
set.seed(132)
imputed_CREAT2_nocrrt<- mice(impute_CREAT2_nocrrt, m = 10,maxit=20,printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$CREAT2
}
```

##### Next, adding BW and LENGTH to crrt and non-crrt datasets

```{r adding BW to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_crrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_crrt, action = i))$LENGTH
}
```
```{r adding BW to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("BW", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$BW2
}
```
```{r adding LENGTH to the FlucTotIV_clean_nocrrt dataset}
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("LENGTH", sprintf("%02d", i))]] <- (complete(imputed_CREAT2_nocrrt, action = i))$LENGTH
}
```

##### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}
FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]
```

##### Now average BW and LENGTH per each ID 

```{r Integrating mean values to the original dataset}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]
```
```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))
```

#### CKDEPI Equation to use
##### In men:
###### cre < 0.9 mg/dL: CKD-EPI = 142 x (cre/0.9)^-0.302 x 0.9938^age 
###### cre >= 0.9 mg/dL:CKD-EPI = 142 x (cre/0.9)^-1.200 x 0.9938^age
##### In women:
###### cre < 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-0.241 x 0.9938^age * 1.012
###### cre >= 0.7 mg/dL: CKD-EPI = 142 x (cre/0.7)^-1.200 x 0.9938^age * 1.012

##### Calculate CKDEPI 01 to 10

```{r CKDEPI 01}
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed
Fluc_NONMEM_mul_impute$CKDEPI01 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT01 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT01 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT01/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 02}
Fluc_NONMEM_mul_impute$CKDEPI02 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT02 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT02 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT02/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 03}
Fluc_NONMEM_mul_impute$CKDEPI03 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT03 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT03 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT03/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 04}
Fluc_NONMEM_mul_impute$CKDEPI04 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT04 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT04 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT04/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 05}
Fluc_NONMEM_mul_impute$CKDEPI05 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT05 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT05 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT05/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 06}
Fluc_NONMEM_mul_impute$CKDEPI06 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT06 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT06 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT06/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 07}
Fluc_NONMEM_mul_impute$CKDEPI07 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT07 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT07 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT07/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 08}
Fluc_NONMEM_mul_impute$CKDEPI08 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT08 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT08 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT08/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 09}
Fluc_NONMEM_mul_impute$CKDEPI09 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT09 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT09 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT09/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

```{r CKDEPI 10}
Fluc_NONMEM_mul_impute$CKDEPI10 <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 < 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-0.302) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 1 & Fluc_NONMEM_mul_impute$CREAT10 >= 0.9,(142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.9)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE), ifelse(Fluc_NONMEM_mul_impute$SEX == 2 & Fluc_NONMEM_mul_impute$CREAT10 < 0.7, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-0.241) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012, (142) * ((Fluc_NONMEM_mul_impute$CREAT10/0.7)^-1.200) * (0.9938^Fluc_NONMEM_mul_impute$AGE)*1.012)))
```

##### Calculate FFM 01 to 10

```{r add 10 new FFM columns}
for (i in 1:10) {
        BW_col <- paste0("BW", sprintf("%02d", i))
        LENGTH_col <- paste0("LENGTH", sprintf("%02d", i))
        FFM_col <- paste0("FFM", sprintf("%02d", i))
        Fluc_NONMEM_mul_impute[, FFM_col] <- ifelse(Fluc_NONMEM_mul_impute$SEX == 1, 0.407 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.267 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 19.2,0.252 * Fluc_NONMEM_mul_impute[[BW_col]] + 0.473 * Fluc_NONMEM_mul_impute[[LENGTH_col]] * 100 - 48.3)
}
```

##### Convert all NAs to -99

```{r NAs to -99}
Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99
```

##### Convert back to NONMEM format
```{r DV from 0 & -99 to "."}
Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)
```
```{r AMT TAD and RATE from 0 to "."}
Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)
```
##### Export two datasets

```{r select appropriate datasets}
FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID")]
Fluc_NONMEM_mul_impute_2 <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%                                    c("LENGTHMAX","LENGTHMIN","LENGTHMED","CREATMAX","CREATMIN","CREATMED",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
```

```{r two datasets 010, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Imputed datasets")
write.csv(FlucTotIV_clean_imputed, "FlucTotIV_clean_imputed10.csv",quote=F,row.names = FALSE)
write.csv(Fluc_NONMEM_mul_impute_2, "Fluc_NONMEM_mul_impute10.csv",quote=F,row.names = FALSE)
```

##### Median of imputed CKDEPI (imputation from 91st to 100th)
```{r Median of imputed CKDEPI}
median(Fluc_NONMEM_mul_impute$CKDEPI01) #equals 87.84
median(Fluc_NONMEM_mul_impute$CKDEPI02) #equals 88.21
median(Fluc_NONMEM_mul_impute$CKDEPI03) #equals 85.56
median(Fluc_NONMEM_mul_impute$CKDEPI04) #equals 88.46
median(Fluc_NONMEM_mul_impute$CKDEPI05) #equals 89.52
median(Fluc_NONMEM_mul_impute$CKDEPI06) #equals 85.49
median(Fluc_NONMEM_mul_impute$CKDEPI07) #equals 91.14
median(Fluc_NONMEM_mul_impute$CKDEPI08) #equals 88.81
median(Fluc_NONMEM_mul_impute$CKDEPI09) #equals 88.61
median(Fluc_NONMEM_mul_impute$CKDEPI10) #equals 91.04
```

##### Median of imputed FFM
```{r Median of imputed FFM}
median(Fluc_NONMEM_mul_impute$FFM01) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM02) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM03) #equals 58.01
median(Fluc_NONMEM_mul_impute$FFM04) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM05) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM06) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM07) #equals 58.15
median(Fluc_NONMEM_mul_impute$FFM08) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM09) #equals 57.68
median(Fluc_NONMEM_mul_impute$FFM10) #equals 58.15
```

### I am gonna use the median CKDEPI of 83.46 and median FFM of 58.15 across all my 100 imputed datasets!!!

### Pooling parameters model with add_err and FFM

```{r set wd}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
```
```{r read xlsx file}
library(readxl)
Pooling_Parameters<-read_excel("Pooling_Parameters.xlsx")
```
```{r calculate variance Theta Within and Between Subject variability for all}
Pooling_Parameters$Var<-(Pooling_Parameters$RSE*Pooling_Parameters$Estimates/100)^2
Theta<-mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI"]) #0.276297
W<-mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI"]) #0.02315402 #within imputation variance
B<-var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI"]) #0.01727679 #between imputation variance
```

```{r here I calculate lower and upper bound of the 95% CI}
Pooling_Parameters$lower_bound<-Pooling_Parameters$Estimates-1.96*Pooling_Parameters$RSE*Pooling_Parameters$Estimates/100
Pooling_Parameters$upper_bound<-Pooling_Parameters$Estimates+1.96*Pooling_Parameters$RSE*Pooling_Parameters$Estimates/100
library(dplyr)
CKDEPI_effect<-Pooling_Parameters%>% filter(Parameters == "CKDEPI")
```


```{r total variance for all}
T<-W+(1+1/100)*B #.04060
```
```{r confidence interval - T distribution}
lambda<-(B+B/100)/T
r=(lambda)/(1-lambda)
v_old<-(100-1)*(1+1/r^2)
v_com=177-12
v_obs=(v_com+1)/(v_com+3)*v_com*(1-lambda) #(sample size of 177, with 12 parameters)
t_crit <- qt(0.975, 93) #critical t-value with df 93 and alpha 0.05 (95%CI)
lower_bound<-Theta-t_crit*sqrt(T) #-0.12
upper_bound<-Theta+t_crit*sqrt(T) #0.676
```

#### Here I pool the parameter of the first 10, 20, 30, ... till 100 imputations to see what is the optimal number of imputations

##### For the first 10 imputations
```{r calculate variance Theta Within and Between Subject variability for first 10 imputations}
m1<-10
Theta1 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 10]) #0.270
W1 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 10]) #0.01967 
B1 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 10]) #0.01516
T1<-W1+(1+1/m1)*B1 #.03635
```

##### For the first 20 imputations
```{r calculate variance Theta Within and Between Subject variability for first 20 imputations}
m2<-20
Theta2 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 20]) #0.292
W2 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 20]) #0.02154 
B2 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 20]) #0.01265
T2<-W2+(1+1/m2)*B2 #.03482
```

##### For the first 30 imputations
```{r calculate variance Theta Within and Between Subject variability for first 30 imputations}
m3<-30
Theta3 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 30]) #0.267
W3 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 30]) #0.02220 
B3 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 30]) #0.01363
T3<-W3+(1+1/m3)*B3 #.03629
```

##### For the first 40 imputations
```{r calculate variance Theta Within and Between Subject variability for first 40 imputations}
m4<-40
Theta4 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 40]) #0.261
W4 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 40]) #0.02325 
B4 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 40]) #0.01436
T4<-W4+(1+1/m4)*B4 #.03797
```

##### For the first 50 imputations
```{r calculate variance Theta Within and Between Subject variability for first 50 imputations}
m5<-50
Theta5 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 50]) #0.255
W5 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 50]) #0.02250 
B5 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 50]) #0.01360
T5<-W5+(1+1/m5)*B5 #.03636
```

##### For the first 60 imputations
```{r calculate variance Theta Within and Between Subject variability for first 60 imputations}
m6<-60
Theta6 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 60]) #0.272
W6 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 60]) #0.02306 
B6 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 60]) #0.01521
T6<-W6+(1+1/m6)*B6 #.03852
```

##### For the first 70 imputations
```{r calculate variance Theta Within and Between Subject variability for first 70 imputations}
m7<-70
Theta7 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 70]) #0.271
W7 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 70]) #0.02340 
B7 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 70]) #0.01557
T7<-W7+(1+1/m7)*B7 #.03852
```

##### For the first 80 imputations
```{r calculate variance Theta Within and Between Subject variability for first 80 imputations}
m8<-80
Theta8 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 80]) #0.274
W8 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 80]) #0.02308 
B8 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 80]) #0.01689
T8<-W8+(1+1/m8)*B8 #.04018
```

##### For the first 90 imputations
```{r calculate variance Theta Within and Between Subject variability for first 90 imputations}
m9<-90
Theta9 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 90]) #0.278
W9 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 90]) #0.02317 
B9 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 90]) #0.01753
T9<-W9+(1+1/m9)*B9 #.04090
```

##### For the first 100 imputations
```{r calculate variance Theta Within and Between Subject variability for first 100 imputations}
m10<-100
Theta10 <- mean(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 100]) #0.278
W10 <- mean(Pooling_Parameters$Var[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 100]) #0.02315 
B10 <- var(Pooling_Parameters$Estimates[Pooling_Parameters$Parameters == "CKDEPI" & Pooling_Parameters$Model <= 100]) #0.01728
T10<-W10+(1+1/m10)*B10 #.04060
```

##### Creat imputation_number dataframe to evaluate the optimal number of imputations in my dataset
```{r creat imputation_number dataframe}
m <- c(m1,m2,m3,m4,m5,m6,m7,m8,m9,m10)
Theta <- c(Theta1, Theta2, Theta3, Theta4, Theta5, Theta6, Theta7, Theta8, Theta9, Theta10)
Total_Var <- c(T1, T2, T3, T4, T5, T6, T7, T8, T9, T10)
imputation_number <- data.frame(m, Theta, Total_Var)
```
```{r plot Theta over m, warning=FALSE}
Theta_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Theta, color = "Parameter Estimate"), size = 1.0) +
  geom_point(aes(y = Theta, color = "Parameter Estimate"), size = 2.5) + # Add points for Parameter Estimate
  scale_color_manual(values = c("blue")) +
  scale_x_continuous(breaks = seq(10, 100, 10), limits = c(10, 100)) +
  labs(x = "Number of imputations", y = "Parameter Estimate", color = "Variables") +
  theme_bw()
ggsave("theta_over_m.png", plot = Theta_over_m, dpi = 300, width = 10, height = 4)
```
```{r plot variance over m, warning=FALSE}
var_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Total_Var, color = "Total Variance"), size = 1.0) +
  geom_point(aes(y = Total_Var, color = "Total Variance"), size = 2.5) + # Add points for Total Variance
  scale_color_manual(values = c("Green")) +
  scale_x_continuous(breaks = seq(10, 100, 10), limits = c(10, 100)) +
  labs(x = "Number of imputations", y = "Total Variance", color = "Variables") +
  theme_bw()
ggsave("var_over_m.png", plot = var_over_m, dpi = 300, width = 10, height = 4)
```

### Pooling parameters model with FFM but without add_err 160523

```{r set wd, warning=FALSE}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooling_Parameters_noadderr<-read.csv("Pooling_Parameters_noadderr.csv")
```

```{r calculate variance Theta Within and Between Subject variability for all}
Pooling_Parameters_noadderr$Var<-(Pooling_Parameters_noadderr$RSE*Pooling_Parameters_noadderr$Estimates/100)^2
Theta<-mean(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.274864
W<-mean(Pooling_Parameters_noadderr$Var[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.02482632 #within imputation variance
B<-var(Pooling_Parameters_noadderr$Estimates[Pooling_Parameters_noadderr$Parameters == "CKDEPI"]) #0.01743984 #between imputation variance
Theta
W
B
```

```{r total variance for all}
T<-W+(1+1/100)*B #0.04244056
T
```

```{r confidence interval - T distribution}
lambda<-(B+B/100)/T
r=(lambda)/(1-lambda)
v_old<-(100-1)*(1+1/r^2)
v_com=177-12
v_obs=(v_com+1)/(v_com+3)*v_com*(1-lambda) #(sample size of 177, with 12 parameters)
t_crit <- qt(0.975, 95) #critical t-value with df 93 and alpha 0.05 (95%CI)
lower_bound<-Theta-t_crit*sqrt(T) #-0.1341197
upper_bound<-Theta+t_crit*sqrt(T) #0.6838477
v_obs
lower_bound
upper_bound
```

#### Theta (95% CI) of CKDEPI effect in model without add_err but with FFM is 0.274864 (-0.1341197 - 0.6838477)

### Missing data plot - presentation 17042023

```{r for BW2, LENGTH and CREAT2}
library(ggplot2)

# Calculate missing data percentages for each variable
missing_pct <- round(colSums(is.na(FlucTotIV_clean[, c("BW2", "CREAT2", "LENGTH")])) / nrow(FlucTotIV_clean) * 100, 2)

# Create a data frame for plotting
missing_data_df <- data.frame(variable = c("Body Weight", "CREATININE", "HEIGHT"),
                              missing_pct = missing_pct)

# Create the plot
missing_data_plot <- ggplot(missing_data_df, aes(x = variable, y = missing_pct)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  
  labs(x = "Variables", y = "Percentage") +
  ylim(0, 100) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  geom_text(aes(label = paste0(missing_pct, "%"), y = missing_pct + 5), size = 6, fontface = "bold") +
  theme_bw() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.text = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold"))

# Display the plot
missing_data_plot
ggsave("missingcovariates.png", plot = missing_data_plot, dpi = 300, width = 10, height = 4)

```

### Assessing the optimal number of imputation for my final model without CKDEPI

```{r read my new dataframe}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noCKDEPI_noadderr<-read.csv("Pooling_Parameters_noCKDEPI_noadderr.csv")
```

```{r create a new variable}
Pooledmodel_noCKDEPI_noadderr$Var<-(Pooledmodel_noCKDEPI_noadderr$RSE*Pooledmodel_noCKDEPI_noadderr$Estimates/100)^2
```


```{r calculate variance Theta Within and Between Subject variability for first 10 imputations}
# Create empty vectors
m <- Theta <- W <- B <- Total_Var <- numeric(10)

# Assign values to vectors using for loop
for (i in 1:10) {
  m[i] <- i
  Theta[i] <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM" & Pooledmodel_noCKDEPI_noadderr$Model <= i])
  W[i] <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM" & Pooledmodel_noCKDEPI_noadderr$Model <= i])
  B[i] <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM" & Pooledmodel_noCKDEPI_noadderr$Model <= i])
  Total_Var[i] <- W[i] + (1 + 1 / m[i]) * B[i]
}

# Combine vectors into a data frame
imputation_number <- data.frame(m, Theta, Total_Var)
```
```{r plot Theta over m, warning=FALSE}
library(ggplot2)
Theta_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Theta, color = "Parameter Estimate"), size = 1.0) +
  geom_point(aes(y = Theta, color = "Parameter Estimate"), size = 2.5) + # Add points for Parameter Estimate
  scale_color_manual(values = c("blue")) +
  scale_x_continuous(breaks = seq(1, 10, 1), limits = c(1, 10)) +
  labs(x = "Number of imputations", y = "Parameter Estimate", color = "Variables") +
  theme_bw()
ggsave("theta_over_m_noCKDEPI.png", plot = Theta_over_m, dpi = 300, width = 10, height = 4)
```
```{r plot variance over m, warning=FALSE}
var_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Total_Var, color = "Total Variance"), size = 1.0) +
  geom_point(aes(y = Total_Var, color = "Total Variance"), size = 2.5) + # Add points for Total Variance
  scale_color_manual(values = c("Green")) +
  scale_x_continuous(breaks = seq(1, 10, 1), limits = c(1, 10)) +
  labs(x = "Number of imputations", y = "Total Variance", color = "Variables") +
  theme_bw()
ggsave("var_over_m_noCKDEPI.png", plot = var_over_m, dpi = 300, width = 10, height = 4)
```

### Here I pool parameters of my 10 imputations in the final model without add.err and CKDEPI
#### First of all, read in dataset

```{r read Pooledmodel_noCKDEPI_noadderr dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noCKDEPI_noadderr<-read.csv("Pooling_Parameters_noCKDEPI_noadderr.csv")
```

```{r create a new variable}
Pooledmodel_noCKDEPI_noadderr$Var<-(Pooledmodel_noCKDEPI_noadderr$RSE*Pooledmodel_noCKDEPI_noadderr$Estimates/100)^2
```

#### Second of all, pooling CLcrrt
```{r pooling CLcrrt}
CLcrrt <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLcrrt"]) #1.684
W_CLcrrt <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLcrrt"])
B_CLcrrt <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLcrrt"]) 
T_CLcrrt<-W_CLcrrt+(1+1/10)*B_CLcrrt #.0203 #m always equals 10
SE_CLcrrt<-sqrt(T_CLcrrt) 
RSE_CLcrrt<-SE_CLcrrt/CLcrrt*100 #8.46
CLcrrt
RSE_CLcrrt

```
##### For CLcrrt, the parameter estimate is 1.684 (8.46%)

```{r confidence interval CLcrrt - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLcrrt<-(B_CLcrrt+B_CLcrrt/m)/T_CLcrrt #proportion of variation attributable to the missing data
r_CLcrrt<-(lambda_CLcrrt)/(1-lambda_CLcrrt) #relative increase in variance due to nonresponse
v_old_CLcrrt<-(m-1)*(1+1/r_CLcrrt^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CLcrrt) in the hypothetically complete data
v_obs_CLcrrt=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLcrrt) #observed data degrees of freedom that accounts for the missing information
v_CLcrrt<-(v_old_CLcrrt*v_obs_CLcrrt)/(v_old_CLcrrt+v_obs_CLcrrt) #equals 164
t_crit_CLcrrt <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLcrrt<-CLcrrt-t_crit_CLcrrt*sqrt(T_CLcrrt) #1.40
upper_bound_CLcrrt<-CLcrrt+t_crit_CLcrrt*sqrt(T_CLcrrt) #1.97
lower_bound_CLcrrt
upper_bound_CLcrrt

```

#### Third of all, pooling CLr
```{r pooling CLr}
CLr <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLr"]) #0.634
W_CLr <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLr"])
B_CLr <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "CLr"]) 
T_CLr<-W_CLr+(1+1/10)*B_CLr #.00114 #m always equals 10
SE_CLr<-sqrt(T_CLr) 
RSE_CLr<-SE_CLr/CLr*100 #5.33
CLr
T_CLr
RSE_CLr
```
##### For CLr, the parameter estimate is 0.634 (5.33%)

```{r confidence interval CLr - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLr<-(B_CLr+B_CLr/m)/T_CLr #proportion of variation attributable to the missing data
r_CLr<-(lambda_CLr)/(1-lambda_CLr) #relative increase in variance due to nonresponse
v_old_CLr<-(m-1)*(1+1/r_CLr^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CLr) in the hypothetically complete data
v_obs_CLr=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLr) #observed data degrees of freedom that accounts for the missing information
v_CLr<-(v_old_CLr*v_obs_CLr)/(v_old_CLr+v_obs_CLr) #equals 164
t_crit_CLr <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLr<-CLr-t_crit_CLr*sqrt(T_CLr) #0.567
upper_bound_CLr<-CLr+t_crit_CLr*sqrt(T_CLr) #0.701
lower_bound_CLr
upper_bound_CLr
```

#### Fourth of all, pooling V1
```{r pooling V1}
V1 <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "V1"]) #39.59
W_V1 <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "V1"])
B_V1 <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "V1"]) 
T_V1<-W_V1+(1+1/10)*B_V1 #12.00 #m always equals 10
SE_V1<-sqrt(T_V1) 
RSE_V1<-SE_V1/V1*100 #8.75
V1
T_V1
RSE_V1
```
##### For V1, the parameter estimate is 39.59 (8.75%)

```{r confidence interval V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V1<-(B_V1+B_V1/m)/T_V1 #proportion of variation attributable to the missing data
r_V1<-(lambda_V1)/(1-lambda_V1) #relative increase in variance due to nonresponse
v_old_V1<-(m-1)*(1+1/r_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V1) in the hypothetically complete data
v_obs_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_V1) #observed data degrees of freedom that accounts for the missing information
v_V1<-(v_old_V1*v_obs_V1)/(v_old_V1+v_obs_V1) #equals 164
t_crit_V1 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V1<-V1-t_crit_V1*sqrt(T_V1) #32.7
upper_bound_V1<-V1+t_crit_V1*sqrt(T_V1) #46.4
lower_bound_V1
upper_bound_V1
```

#### Fourth of all, pooling Q
```{r pooling Q}
Q <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "Q"]) #14.05
W_Q <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "Q"])
B_Q <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "Q"]) 
T_Q<-W_Q+(1+1/10)*B_Q #26.51 #m always equals 10
SE_Q<-sqrt(T_Q) 
RSE_Q<-SE_Q/Q*100 #36.64
Q
T_Q
RSE_Q
```
##### For Q, the parameter estimate is 14.05 (36.64%)

```{r confidence interval Q - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Q<-(B_Q+B_Q/m)/T_Q #proportion of variation attributable to the missing data
r_Q<-(lambda_Q)/(1-lambda_Q) #relative increase in variance due to nonresponse
v_old_Q<-(m-1)*(1+1/r_Q^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Q) in the hypothetically complete data
v_obs_Q=((v_com+1)/(v_com+3))*v_com*(1-lambda_Q) #observed data degrees of freedom that accounts for the missing information
v_Q<-(v_old_Q*v_obs_Q)/(v_old_Q+v_obs_Q) #equals 164
t_crit_Q <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Q<-Q-t_crit_Q*sqrt(T_Q) #3.9
upper_bound_Q<-Q+t_crit_Q*sqrt(T_Q) #24.2
lower_bound_Q
upper_bound_Q
```

#### Fifth of all, pooling V2
```{r pooling V2}
V2 <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "V2"]) #8.80
W_V2 <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "V2"])
B_V2 <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "V2"]) 
T_V2<-W_V2+(1+1/10)*B_V2 #9.73 #m always equals 10
SE_V2<-sqrt(T_V2) 
RSE_V2<-SE_V2/V2*100 #35.44
V2
T_V2
RSE_V2
```
##### For V2, the parameter estimate is 8.80 (35.44%)

```{r confidence interval V2 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V2<-(B_V2+B_V2/m)/T_V2 #proportion of variation attributable to the missing data
r_V2<-(lambda_V2)/(1-lambda_V2) #relative increase in variance due to nonresponse
v_old_V2<-(m-1)*(1+1/r_V2^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V2) in the hypothetically complete data
v_obs_V2=((v_com+1)/(v_com+3))*v_com*(1-lambda_V2) #observed data degrees of freedom that accounts for the missing information
v_V2<-(v_old_V2*v_obs_V2)/(v_old_V2+v_obs_V2) #equals 164
t_crit_V2 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V2<-V2-t_crit_V2*sqrt(T_V2) #2.64
upper_bound_V2<-V2+t_crit_V2*sqrt(T_V2) #14.96
lower_bound_V2
upper_bound_V2
```

#### Sixth of all, pooling FFM
```{r pooling FFM}
FFM <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM"]) #1.37
W_FFM <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM"])
B_FFM <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "FFM"]) 
T_FFM<-W_FFM+(1+1/10)*B_FFM #0.0597 #m always equals 10
SE_FFM<-sqrt(T_FFM) 
RSE_FFM<-SE_FFM/FFM*100 #17.86
FFM
T_FFM
RSE_FFM
```
##### For FFM, the parameter estimate is 1.37 (17.86%)

```{r confidence interval FFM - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_FFM<-(B_FFM+B_FFM/m)/T_FFM #proportion of variation attributable to the missing data
r_FFM<-(lambda_FFM)/(1-lambda_FFM) #relative increase in variance due to nonresponse
v_old_FFM<-(m-1)*(1+1/r_FFM^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (FFM) in the hypothetically complete data
v_obs_FFM=((v_com+1)/(v_com+3))*v_com*(1-lambda_FFM) #observed data degrees of freedom that accounts for the missing information
v_FFM<-(v_old_FFM*v_obs_FFM)/(v_old_FFM+v_obs_FFM) #equals 164
t_crit_FFM <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_FFM<-FFM-t_crit_FFM*sqrt(T_FFM) #0.89
upper_bound_FFM<-FFM+t_crit_FFM*sqrt(T_FFM) #1.85
lower_bound_FFM
upper_bound_FFM
```

#### Seventh of all, pooling Cov_CLr_V1
```{r pooling Cov_CLr_V1}
Cov_CLr_V1 <- mean(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "Cov_CLr_V1"]) #0.09074
W_Cov_CLr_V1 <- mean(Pooledmodel_noCKDEPI_noadderr$Var[Pooledmodel_noCKDEPI_noadderr$Parameters == "Cov_CLr_V1"])
B_Cov_CLr_V1 <- var(Pooledmodel_noCKDEPI_noadderr$Estimates[Pooledmodel_noCKDEPI_noadderr$Parameters == "Cov_CLr_V1"]) 
T_Cov_CLr_V1<-W_Cov_CLr_V1+(1+1/10)*B_Cov_CLr_V1 #0.001967543 #m always equals 10
SE_Cov_CLr_V1<-sqrt(T_Cov_CLr_V1) 
RSE_Cov_CLr_V1<-SE_Cov_CLr_V1/Cov_CLr_V1*100 #48.88362
Cov_CLr_V1
T_Cov_CLr_V1
RSE_Cov_CLr_V1
```
##### For Cov_CLr_V1, the parameter estimate is 0.09074 (48.884%)

```{r confidence interval Cov_CLr_V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Cov_CLr_V1<-(B_Cov_CLr_V1+B_Cov_CLr_V1/m)/T_Cov_CLr_V1 #proportion of variation attributable to the missing data
r_Cov_CLr_V1<-(lambda_Cov_CLr_V1)/(1-lambda_Cov_CLr_V1) #relative increase in variance due to nonresponse
v_old_Cov_CLr_V1<-(m-1)*(1+1/r_Cov_CLr_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Cov_CLr_V1) in the hypothetically complete data
v_obs_Cov_CLr_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_Cov_CLr_V1) #observed data degrees of freedom that accounts for the missing information
v_Cov_CLr_V1<-(v_old_Cov_CLr_V1*v_obs_Cov_CLr_V1)/(v_old_Cov_CLr_V1+v_obs_Cov_CLr_V1) #equals 164
t_crit_Cov_CLr_V1 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Cov_CLr_V1<-Cov_CLr_V1-t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.003155569
upper_bound_Cov_CLr_V1<-Cov_CLr_V1+t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.1783244
lower_bound_Cov_CLr_V1
upper_bound_Cov_CLr_V1
```

#### Thereafter, with IIVs and Prop.Err, they are variance terms, so I will log-transform them first, then use Rubin's Rule to pool the parameter estimates, then back-transform to get the actual esmates 

##### First of all, create a new column called Log (the log-tranformed parameter estimates)
```{r create a log-transformed Log column}
Pooledmodel_noCKDEPI_noadderr$Log<-log(Pooledmodel_noCKDEPI_noadderr$Estimates)
```

##### Then create a Var_Log variable, which is the variance of the log-transformed variable
```{r create a Var_Log variable}
Pooledmodel_noCKDEPI_noadderr$Var_Log<-(1/(Pooledmodel_noCKDEPI_noadderr$Estimates))^2*Pooledmodel_noCKDEPI_noadderr$Var #Var(log(x))=[1/(mean(x))]^2*var(x) (log(x) in R is actually ln(x))
# Use for calculating Table S2 - 050623
```

##### Then pooling the log-transformed estimates, firstly, IIV_CLcrrt_log
```{r pooloing log-transformed IIV_CLcrrt_log }
IIV_CLcrrt_log <- mean(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLcrrt"]) #-1.7215
W_IIV_CLcrrt_log <- mean(Pooledmodel_noCKDEPI_noadderr$Var_Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLcrrt"])
B_IIV_CLcrrt_log <- var(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLcrrt"]) 
T_IIV_CLcrrt_log<-W_IIV_CLcrrt_log+(1+1/10)*B_IIV_CLcrrt_log #0.12 #m always equals 10
SE_IIV_CLcrrt_log<-sqrt(T_IIV_CLcrrt_log)  
RSE_IIV_CLcrrt_log<-SE_IIV_CLcrrt_log/IIV_CLcrrt_log*100 #20%
IIV_CLcrrt_log
T_IIV_CLcrrt_log
RSE_IIV_CLcrrt_log
```
```{r confidence interval IIV_CLcrrt_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLcrrt_log<-(B_IIV_CLcrrt_log+B_IIV_CLcrrt_log/m)/T_IIV_CLcrrt_log #proportion of variation attributable to the missing data
r_IIV_CLcrrt_log<-(lambda_IIV_CLcrrt_log)/(1-lambda_IIV_CLcrrt_log) #relative increase in variance due to nonresponse
v_old_IIV_CLcrrt_log<-(m-1)*(1+1/r_IIV_CLcrrt_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLcrrt_log) in the hypothetically complete data
v_obs_IIV_CLcrrt_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLcrrt_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLcrrt_log<-(v_old_IIV_CLcrrt_log*v_obs_IIV_CLcrrt_log)/(v_old_IIV_CLcrrt_log+v_obs_IIV_CLcrrt_log) #equals 164
t_crit_IIV_CLcrrt_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log-t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-2.406
upper_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log+t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-1.037
```

##### Then back transform to the original scale, IIV_CLcrrt
```{r back transform IIV_CLcrrt_log to IIV_CLcrrt}
IIV_CLcrrt<-exp(IIV_CLcrrt_log) #.1788
lower_bound_IIV_CLcrrt<-exp(lower_bound_IIV_CLcrrt_log) #.0902
upper_bound_IIV_CLcrrt<-exp(upper_bound_IIV_CLcrrt_log) #.3546
```

##### Next step, pooling the log-transformed estimates for IIV_CLr_log
```{r pooloing log-transformed IIV_CLr_log }
IIV_CLr_log <- mean(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLr"]) #-1.255618
W_IIV_CLr_log <- mean(Pooledmodel_noCKDEPI_noadderr$Var_Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLr"])
B_IIV_CLr_log <- var(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_CLr"]) 
T_IIV_CLr_log<-W_IIV_CLr_log+(1+1/10)*B_IIV_CLr_log #0.02722636 #m always equals 10
SE_IIV_CLr_log<-sqrt(T_IIV_CLr_log)  
RSE_IIV_CLr_log<-SE_IIV_CLr_log/IIV_CLr_log*100 #13.14%
IIV_CLr_log
T_IIV_CLr_log
RSE_IIV_CLr_log
```
```{r confidence interval IIV_CLr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLr_log<-(B_IIV_CLr_log+B_IIV_CLr_log/m)/T_IIV_CLr_log #proportion of variation attributable to the missing data
r_IIV_CLr_log<-(lambda_IIV_CLr_log)/(1-lambda_IIV_CLr_log) #relative increase in variance due to nonresponse
v_old_IIV_CLr_log<-(m-1)*(1+1/r_IIV_CLr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLr_log) in the hypothetically complete data
v_obs_IIV_CLr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLr_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLr_log<-(v_old_IIV_CLr_log*v_obs_IIV_CLr_log)/(v_old_IIV_CLr_log+v_obs_IIV_CLr_log) #equals 164
t_crit_IIV_CLr_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLr_log<-IIV_CLr_log-t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-1.581
upper_bound_IIV_CLr_log<-IIV_CLr_log+t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-0.930
```

##### Then back transform to the original scale, IIV_CLr
```{r back transform IIV_CLr_log to IIV_CLr}
IIV_CLr<-exp(IIV_CLr_log) #.2849
lower_bound_IIV_CLr<-exp(lower_bound_IIV_CLr_log) #.2057
upper_bound_IIV_CLr<-exp(upper_bound_IIV_CLr_log) #.3946
```

##### After that, pooling the log-transformed estimates for IIV_V1_log
```{r pooloing log-transformed IIV_V1_log }
IIV_V1_log <- mean(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_V1"]) #-1.165402
W_IIV_V1_log <- mean(Pooledmodel_noCKDEPI_noadderr$Var_Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_V1"])
B_IIV_V1_log <- var(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "IIV_V1"]) 
T_IIV_V1_log<-W_IIV_V1_log+(1+1/10)*B_IIV_V1_log #0.02316932 #m always equals 10
SE_IIV_V1_log<-sqrt(T_IIV_V1_log)  
RSE_IIV_V1_log<-SE_IIV_V1_log/IIV_V1_log*100 #13.06%
IIV_V1_log
T_IIV_V1_log
RSE_IIV_V1_log
```
```{r confidence interval IIV_V1_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_V1_log<-(B_IIV_V1_log+B_IIV_V1_log/m)/T_IIV_V1_log #proportion of variation attributable to the missing data
r_IIV_V1_log<-(lambda_IIV_V1_log)/(1-lambda_IIV_V1_log) #relative increase in variance due to nonresponse
v_old_IIV_V1_log<-(m-1)*(1+1/r_IIV_V1_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_V1_log) in the hypothetically complete data
v_obs_IIV_V1_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_V1_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_V1_log<-(v_old_IIV_V1_log*v_obs_IIV_V1_log)/(v_old_IIV_V1_log+v_obs_IIV_V1_log) #equals 164
t_crit_IIV_V1_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_V1_log<-IIV_V1_log-t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-1.465956
upper_bound_IIV_V1_log<-IIV_V1_log+t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-0.8648492
v_IIV_V1_log
lower_bound_IIV_V1_log
upper_bound_IIV_V1_log
```

##### Then back transform to the original scale, IIV_V1
```{r back transform IIV_V1_log to IIV_V1}
IIV_V1<-exp(IIV_V1_log) #.3118
lower_bound_IIV_V1<-exp(lower_bound_IIV_V1_log) #.2309
upper_bound_IIV_V1<-exp(upper_bound_IIV_V1_log) #.4211
IIV_V1
lower_bound_IIV_V1
upper_bound_IIV_V1
```

##### Finally, pooling the log-transformed estimates for PropErr_log
```{r pooloing log-transformed PropErr_log}
PropErr_log <- mean(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "PropErr"]) #-3.588493
W_PropErr_log <- mean(Pooledmodel_noCKDEPI_noadderr$Var_Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "PropErr"])
B_PropErr_log <- var(Pooledmodel_noCKDEPI_noadderr$Log[Pooledmodel_noCKDEPI_noadderr$Parameters == "PropErr"]) 
T_PropErr_log<-W_PropErr_log+(1+1/10)*B_PropErr_log #0.01692994 #m always equals 10
SE_PropErr_log<-sqrt(T_PropErr_log)  
RSE_PropErr_log<-SE_PropErr_log/PropErr_log*100 #3.625898%
PropErr_log
T_PropErr_log
RSE_PropErr_log
```
```{r confidence interval PropErr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_PropErr_log<-(B_PropErr_log+B_PropErr_log/m)/T_PropErr_log #proportion of variation attributable to the missing data
r_PropErr_log<-(lambda_PropErr_log)/(1-lambda_PropErr_log) #relative increase in variance due to nonresponse
v_old_PropErr_log<-(m-1)*(1+1/r_PropErr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (PropErr_log) in the hypothetically complete data
v_obs_PropErr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_PropErr_log) #observed data degrees of freedom that accounts for the missing information
v_PropErr_log<-(v_old_PropErr_log*v_obs_PropErr_log)/(v_old_PropErr_log+v_obs_PropErr_log) #equals 164
t_crit_PropErr_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_PropErr_log<-PropErr_log-t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.84541
upper_bound_PropErr_log<-PropErr_log+t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.331576
v_PropErr_log
lower_bound_PropErr_log
upper_bound_PropErr_log
```

##### Then back transform to the original scale, PropErr
```{r back transform PropErr_log to PropErr}
PropErr<-exp(PropErr_log) #0.02763996
lower_bound_PropErr<-exp(lower_bound_PropErr_log) #0.02137764
upper_bound_PropErr<-exp(upper_bound_PropErr_log) #0.03573674
PropErr
lower_bound_PropErr
upper_bound_PropErr
```

### Here I pool parameters of my 10 imputations in my final model without add.err and CKDEPI, with only BW as a covariate (instead of FFM)
### This is done after the meeting with Isabel on 120523
#### First of all, read in dataset

```{r read Pooledmodel_noCKDEPI_noadderr dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noCKDEPI_noadderr_BW<-read.csv("Pooling_Parameters_noCKDEPI_noadderr_BW.csv")
```

```{r create a new variable}
Pooledmodel_noCKDEPI_noadderr_BW$Var<-(Pooledmodel_noCKDEPI_noadderr_BW$RSE*Pooledmodel_noCKDEPI_noadderr_BW$Estimates/100)^2
```

#### Second of all, pooling CLcrrt
```{r pooling CLcrrt}
CLcrrt <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLcrrt"]) #1.69
W_CLcrrt <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLcrrt"])
B_CLcrrt <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLcrrt"]) 
T_CLcrrt<-W_CLcrrt+(1+1/10)*B_CLcrrt #.01823 #m always equals 10
SE_CLcrrt<-sqrt(T_CLcrrt) 
RSE_CLcrrt<-SE_CLcrrt/CLcrrt*100 #8
CLcrrt
RSE_CLcrrt
```
##### For CLcrrt, the parameter estimate is 1.69 (8%)

```{r confidence interval CLcrrt - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLcrrt<-(B_CLcrrt+B_CLcrrt/m)/T_CLcrrt #proportion of variation attributable to the missing data #0
r_CLcrrt<-(lambda_CLcrrt)/(1-lambda_CLcrrt) #relative increase in variance due to nonresponse #0
v_old_CLcrrt<-(m-1)*(1+1/r_CLcrrt^2) #old degree of freedom #Inf
v_com=n-k #degree of freedom of parameter estimate (CLcrrt) in the hypothetically complete data #166
v_obs_CLcrrt=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLcrrt) #observed data degrees of freedom that accounts for the missing information
v_CLcrrt<-(v_old_CLcrrt*v_obs_CLcrrt)/(v_old_CLcrrt+v_obs_CLcrrt) #equals 164 (its lim approximates 164)
t_crit_CLcrrt <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLcrrt<-CLcrrt-t_crit_CLcrrt*sqrt(T_CLcrrt) #1.42
upper_bound_CLcrrt<-CLcrrt+t_crit_CLcrrt*sqrt(T_CLcrrt) #1.96
lower_bound_CLcrrt
upper_bound_CLcrrt
```

#### Third of all, pooling CLr
```{r pooling CLr}
CLr <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLr"]) #0.634
W_CLr <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLr"])
B_CLr <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "CLr"]) 
T_CLr<-W_CLr+(1+1/10)*B_CLr #.001129 #m always equals 10
SE_CLr<-sqrt(T_CLr) 
RSE_CLr<-SE_CLr/CLr*100 #5.3
CLr
T_CLr
RSE_CLr
```
##### For CLr, the parameter estimate is 0.634 (5.3%)

```{r confidence interval CLr - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLr<-(B_CLr+B_CLr/m)/T_CLr #proportion of variation attributable to the missing data
r_CLr<-(lambda_CLr)/(1-lambda_CLr) #relative increase in variance due to nonresponse
v_old_CLr<-(m-1)*(1+1/r_CLr^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CLr) in the hypothetically complete data
v_obs_CLr=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLr) #observed data degrees of freedom that accounts for the missing information
v_CLr<-(v_old_CLr*v_obs_CLr)/(v_old_CLr+v_obs_CLr) #equals 164
t_crit_CLr <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLr<-CLr-t_crit_CLr*sqrt(T_CLr) #0.568
upper_bound_CLr<-CLr+t_crit_CLr*sqrt(T_CLr) #0.700
lower_bound_CLr
upper_bound_CLr
```

#### Fourth of all, pooling V1
```{r pooling V1}
V1 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V1"]) #37.9
W_V1 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V1"])
B_V1 <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V1"]) 
T_V1<-W_V1+(1+1/10)*B_V1 #13.51 #m always equals 10
SE_V1<-sqrt(T_V1) 
RSE_V1<-SE_V1/V1*100 #9.71
V1
T_V1
RSE_V1
```
##### For V1, the parameter estimate is 37.9 (9.7%)

```{r confidence interval V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V1<-(B_V1+B_V1/m)/T_V1 #proportion of variation attributable to the missing data
r_V1<-(lambda_V1)/(1-lambda_V1) #relative increase in variance due to nonresponse
v_old_V1<-(m-1)*(1+1/r_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V1) in the hypothetically complete data
v_obs_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_V1) #observed data degrees of freedom that accounts for the missing information
v_V1<-(v_old_V1*v_obs_V1)/(v_old_V1+v_obs_V1) #equals 164
t_crit_V1 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V1<-V1-t_crit_V1*sqrt(T_V1) #30.6
upper_bound_V1<-V1+t_crit_V1*sqrt(T_V1) #45.1
lower_bound_V1
upper_bound_V1
```

#### Fourth of all, pooling Q
```{r pooling Q}
Q <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Q"]) #13.8
W_Q <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Q"])
B_Q <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Q"]) 
T_Q<-W_Q+(1+1/10)*B_Q #35.20 #m always equals 10
SE_Q<-sqrt(T_Q) 
RSE_Q<-SE_Q/Q*100 #43.0
Q
T_Q
RSE_Q
```
##### For Q, the parameter estimate is 13.8 (43.0%)

```{r confidence interval Q - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Q<-(B_Q+B_Q/m)/T_Q #proportion of variation attributable to the missing data
r_Q<-(lambda_Q)/(1-lambda_Q) #relative increase in variance due to nonresponse
v_old_Q<-(m-1)*(1+1/r_Q^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Q) in the hypothetically complete data
v_obs_Q=((v_com+1)/(v_com+3))*v_com*(1-lambda_Q) #observed data degrees of freedom that accounts for the missing information
v_Q<-(v_old_Q*v_obs_Q)/(v_old_Q+v_obs_Q) #equals 164
t_crit_Q <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Q<-Q-t_crit_Q*sqrt(T_Q) #2.1
upper_bound_Q<-Q+t_crit_Q*sqrt(T_Q) #25.5
lower_bound_Q
upper_bound_Q
```

#### Fifth of all, pooling V2
```{r pooling V2}
V2 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V2"]) #8.79
W_V2 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V2"])
B_V2 <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "V2"]) 
T_V2<-W_V2+(1+1/10)*B_V2 #12.13 #m always equals 10
SE_V2<-sqrt(T_V2) 
RSE_V2<-SE_V2/V2*100 #39.62
V2
T_V2
RSE_V2
```
##### For V2, the parameter estimate is 8.79 (39.62%)

```{r confidence interval V2 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V2<-(B_V2+B_V2/m)/T_V2 #proportion of variation attributable to the missing data
r_V2<-(lambda_V2)/(1-lambda_V2) #relative increase in variance due to nonresponse
v_old_V2<-(m-1)*(1+1/r_V2^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V2) in the hypothetically complete data
v_obs_V2=((v_com+1)/(v_com+3))*v_com*(1-lambda_V2) #observed data degrees of freedom that accounts for the missing information
v_V2<-(v_old_V2*v_obs_V2)/(v_old_V2+v_obs_V2) #equals 164
t_crit_V2 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V2<-V2-t_crit_V2*sqrt(T_V2) #1.91
upper_bound_V2<-V2+t_crit_V2*sqrt(T_V2) #15.67
lower_bound_V2 
upper_bound_V2
```

#### Sixth of all, pooling BW
```{r pooling BW}
BW <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW"]) #0.989
W_BW <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW"])
B_BW <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW"]) 
T_BW<-W_BW+(1+1/10)*B_BW #0.03885 #m always equals 10
SE_BW<-sqrt(T_BW) 
RSE_BW<-SE_BW/BW*100 #19.9
BW
T_BW
RSE_BW
```
##### For BW, the parameter estimate is 0.989 (19.9%)

```{r confidence interval BW - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_BW<-(B_BW+B_BW/m)/T_BW #proportion of variation attributable to the missing data
r_BW<-(lambda_BW)/(1-lambda_BW) #relative increase in variance due to nonresponse
v_old_BW<-(m-1)*(1+1/r_BW^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (BW) in the hypothetically complete data
v_obs_BW=((v_com+1)/(v_com+3))*v_com*(1-lambda_BW) #observed data degrees of freedom that accounts for the missing information
v_BW<-(v_old_BW*v_obs_BW)/(v_old_BW+v_obs_BW) #equals 164
t_crit_BW <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_BW<-BW-t_crit_BW*sqrt(T_BW) #0.600 
upper_bound_BW<-BW+t_crit_BW*sqrt(T_BW) #1.378
lower_bound_BW
upper_bound_BW
```

#### Seventh of all, pooling Cov_CLr_V1
```{r pooling Cov_CLr_V1}
Cov_CLr_V1 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Cov_CLr_V1"]) #0.103
W_Cov_CLr_V1 <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Cov_CLr_V1"])
B_Cov_CLr_V1 <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "Cov_CLr_V1"]) 
T_Cov_CLr_V1<-W_Cov_CLr_V1+(1+1/10)*B_Cov_CLr_V1 #0.002128381 #m always equals 10
SE_Cov_CLr_V1<-sqrt(T_Cov_CLr_V1) 
RSE_Cov_CLr_V1<-SE_Cov_CLr_V1/Cov_CLr_V1*100 #44.747
Cov_CLr_V1
T_Cov_CLr_V1
RSE_Cov_CLr_V1
```
##### For Cov_CLr_V1, the parameter estimate is 0.103 (44.747%)

```{r confidence interval Cov_CLr_V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Cov_CLr_V1<-(B_Cov_CLr_V1+B_Cov_CLr_V1/m)/T_Cov_CLr_V1 #proportion of variation attributable to the missing data
r_Cov_CLr_V1<-(lambda_Cov_CLr_V1)/(1-lambda_Cov_CLr_V1) #relative increase in variance due to nonresponse
v_old_Cov_CLr_V1<-(m-1)*(1+1/r_Cov_CLr_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Cov_CLr_V1) in the hypothetically complete data
v_obs_Cov_CLr_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_Cov_CLr_V1) #observed data degrees of freedom that accounts for the missing information
v_Cov_CLr_V1<-(v_old_Cov_CLr_V1*v_obs_Cov_CLr_V1)/(v_old_Cov_CLr_V1+v_obs_Cov_CLr_V1) #equals 164
t_crit_Cov_CLr_V1 <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Cov_CLr_V1<-Cov_CLr_V1-t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.0120
upper_bound_Cov_CLr_V1<-Cov_CLr_V1+t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.194
lower_bound_Cov_CLr_V1
upper_bound_Cov_CLr_V1
```

#### Thereafter, with IIVs and Prop.Err, they are variance terms, so I will log-transform them first, then use Rubin's Rule to pool the parameter estimates, then back-transform to get the actual esmates 

##### First of all, create a new column called Log (the log-tranformed parameter estimates)
```{r create a log-transformed Log column}
Pooledmodel_noCKDEPI_noadderr_BW$Log<-log(Pooledmodel_noCKDEPI_noadderr_BW$Estimates)
```

##### Then create a Var_Log variable, which is the variance of the log-transformed variable
```{r create a Var_Log variable}
Pooledmodel_noCKDEPI_noadderr_BW$Var_Log<-(1/(Pooledmodel_noCKDEPI_noadderr_BW$Estimates))^2*Pooledmodel_noCKDEPI_noadderr_BW$Var #Var(log(x))=[1/(mean(x))]^2*var(x) (log(x) in R is actually ln(x))
```

##### Then pooling the log-transformed estimates, firstly, IIV_CLcrrt_log
```{r pooloing log-transformed IIV_CLcrrt_log }
IIV_CLcrrt_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLcrrt"]) #-1.714798
W_IIV_CLcrrt_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var_Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLcrrt"])
B_IIV_CLcrrt_log <- var(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLcrrt"]) 
T_IIV_CLcrrt_log<-W_IIV_CLcrrt_log+(1+1/10)*B_IIV_CLcrrt_log #0.1413766 #m always equals 10
SE_IIV_CLcrrt_log<-sqrt(T_IIV_CLcrrt_log)  
RSE_IIV_CLcrrt_log<-SE_IIV_CLcrrt_log/IIV_CLcrrt_log*100 #21.92682%
IIV_CLcrrt_log
T_IIV_CLcrrt_log
RSE_IIV_CLcrrt_log
```
```{r confidence interval IIV_CLcrrt_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLcrrt_log<-(B_IIV_CLcrrt_log+B_IIV_CLcrrt_log/m)/T_IIV_CLcrrt_log #proportion of variation attributable to the missing data
r_IIV_CLcrrt_log<-(lambda_IIV_CLcrrt_log)/(1-lambda_IIV_CLcrrt_log) #relative increase in variance due to nonresponse
v_old_IIV_CLcrrt_log<-(m-1)*(1+1/r_IIV_CLcrrt_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLcrrt_log) in the hypothetically complete data
v_obs_IIV_CLcrrt_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLcrrt_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLcrrt_log<-(v_old_IIV_CLcrrt_log*v_obs_IIV_CLcrrt_log)/(v_old_IIV_CLcrrt_log+v_obs_IIV_CLcrrt_log) #equals 164
t_crit_IIV_CLcrrt_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log-t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-2.457225
upper_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log+t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-0.9723719
lower_bound_IIV_CLcrrt_log
upper_bound_IIV_CLcrrt_log
```

##### Then back transform to the original scale, IIV_CLcrrt
```{r back transform IIV_CLcrrt_log to IIV_CLcrrt}
IIV_CLcrrt<-exp(IIV_CLcrrt_log) #0.18
lower_bound_IIV_CLcrrt<-exp(lower_bound_IIV_CLcrrt_log) #0.086
upper_bound_IIV_CLcrrt<-exp(upper_bound_IIV_CLcrrt_log) #0.38
IIV_CLcrrt
lower_bound_IIV_CLcrrt
upper_bound_IIV_CLcrrt
```

##### Next step, pooling the log-transformed estimates for IIV_CLr_log
```{r pooloing log-transformed IIV_CLr_log }
IIV_CLr_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLr"]) #-1.264786
W_IIV_CLr_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var_Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLr"])
B_IIV_CLr_log <- var(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_CLr"]) 
T_IIV_CLr_log<-W_IIV_CLr_log+(1+1/10)*B_IIV_CLr_log #0.02745992 #m always equals 10
SE_IIV_CLr_log<-sqrt(T_IIV_CLr_log)  
RSE_IIV_CLr_log<-SE_IIV_CLr_log/IIV_CLr_log*100 #13.10185%
IIV_CLr_log
T_IIV_CLr_log
RSE_IIV_CLr_log
```
```{r confidence interval IIV_CLr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLr_log<-(B_IIV_CLr_log+B_IIV_CLr_log/m)/T_IIV_CLr_log #proportion of variation attributable to the missing data
r_IIV_CLr_log<-(lambda_IIV_CLr_log)/(1-lambda_IIV_CLr_log) #relative increase in variance due to nonresponse
v_old_IIV_CLr_log<-(m-1)*(1+1/r_IIV_CLr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLr_log) in the hypothetically complete data
v_obs_IIV_CLr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLr_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLr_log<-(v_old_IIV_CLr_log*v_obs_IIV_CLr_log)/(v_old_IIV_CLr_log+v_obs_IIV_CLr_log) #equals 164
t_crit_IIV_CLr_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLr_log<-IIV_CLr_log-t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-1.591987
upper_bound_IIV_CLr_log<-IIV_CLr_log+t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-0.9375855
lower_bound_IIV_CLr_log
upper_bound_IIV_CLr_log
```

##### Then back transform to the original scale, IIV_CLr
```{r back transform IIV_CLr_log to IIV_CLr}
IIV_CLr<-exp(IIV_CLr_log) #.282
lower_bound_IIV_CLr<-exp(lower_bound_IIV_CLr_log) #.204
upper_bound_IIV_CLr<-exp(upper_bound_IIV_CLr_log) #.392
IIV_CLr
lower_bound_IIV_CLr
upper_bound_IIV_CLr
```

##### After that, pooling the log-transformed estimates for IIV_V1_log
```{r pooloing log-transformed IIV_V1_log }
IIV_V1_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_V1"]) #-1.197039
W_IIV_V1_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var_Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_V1"])
B_IIV_V1_log <- var(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "IIV_V1"]) 
T_IIV_V1_log<-W_IIV_V1_log+(1+1/10)*B_IIV_V1_log #0.0486719 #m always equals 10
SE_IIV_V1_log<-sqrt(T_IIV_V1_log)  
RSE_IIV_V1_log<-SE_IIV_V1_log/IIV_V1_log*100 #18.43023%
IIV_V1_log
T_IIV_V1_log
RSE_IIV_V1_log
```
```{r confidence interval IIV_V1_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_V1_log<-(B_IIV_V1_log+B_IIV_V1_log/m)/T_IIV_V1_log #proportion of variation attributable to the missing data
r_IIV_V1_log<-(lambda_IIV_V1_log)/(1-lambda_IIV_V1_log) #relative increase in variance due to nonresponse
v_old_IIV_V1_log<-(m-1)*(1+1/r_IIV_V1_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_V1_log) in the hypothetically complete data
v_obs_IIV_V1_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_V1_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_V1_log<-(v_old_IIV_V1_log*v_obs_IIV_V1_log)/(v_old_IIV_V1_log+v_obs_IIV_V1_log) #equals 164
t_crit_IIV_V1_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_V1_log<-IIV_V1_log-t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-1.632655
upper_bound_IIV_V1_log<-IIV_V1_log+t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-0.7614233
v_IIV_V1_log
lower_bound_IIV_V1_log
upper_bound_IIV_V1_log
```

##### Then back transform to the original scale, IIV_V1
```{r back transform IIV_V1_log to IIV_V1}
IIV_V1<-exp(IIV_V1_log) #.302
lower_bound_IIV_V1<-exp(lower_bound_IIV_V1_log) #.195
upper_bound_IIV_V1<-exp(upper_bound_IIV_V1_log) #.467
IIV_V1
lower_bound_IIV_V1
upper_bound_IIV_V1
```

##### Finally, pooling the log-transformed estimates for PropErr_log
```{r pooloing log-transformed PropErr_log}
PropErr_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "PropErr"]) #-3.586323
W_PropErr_log <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var_Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "PropErr"])
B_PropErr_log <- var(Pooledmodel_noCKDEPI_noadderr_BW$Log[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "PropErr"]) 
T_PropErr_log<-W_PropErr_log+(1+1/10)*B_PropErr_log #0.017424 #m always equals 10
SE_PropErr_log<-sqrt(T_PropErr_log)  
RSE_PropErr_log<-SE_PropErr_log/PropErr_log*100 #3.68065%
PropErr_log
T_PropErr_log
RSE_PropErr_log
```
```{r confidence interval PropErr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-10 #number of imputations
k<-11 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_PropErr_log<-(B_PropErr_log+B_PropErr_log/m)/T_PropErr_log #proportion of variation attributable to the missing data
r_PropErr_log<-(lambda_PropErr_log)/(1-lambda_PropErr_log) #relative increase in variance due to nonresponse
v_old_PropErr_log<-(m-1)*(1+1/r_PropErr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (PropErr_log) in the hypothetically complete data
v_obs_PropErr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_PropErr_log) #observed data degrees of freedom that accounts for the missing information
v_PropErr_log<-(v_old_PropErr_log*v_obs_PropErr_log)/(v_old_PropErr_log+v_obs_PropErr_log) #equals 164
t_crit_PropErr_log <- qt(0.975, 164) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_PropErr_log<-PropErr_log-t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.846961
upper_bound_PropErr_log<-PropErr_log+t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.325684
v_PropErr_log
lower_bound_PropErr_log
upper_bound_PropErr_log
```

##### Then back transform to the original scale, PropErr
```{r back transform PropErr_log to PropErr}
PropErr<-exp(PropErr_log) #0.0277
lower_bound_PropErr<-exp(lower_bound_PropErr_log) #0.02134449
upper_bound_PropErr<-exp(upper_bound_PropErr_log) #0.03594791
PropErr
lower_bound_PropErr
upper_bound_PropErr
```

### Creat simulation datasets 260423, followed up on 090523

#### For uniformly-distributed simulations, only need to simulate Ctrough and Cmax. Because if we simulate the whole-profile, the dataset is gonna be too heavy to handle!!!
#### That's why I create new datasets used for simulations on 090523

#### For population level-simulations, Omar simulated 1000 patients 10 times, in stead of 1000 times!!!

#### Firstly, I test standard dosing regimen (This is for the old one)
```{r read standard_dosing dataset I creaeted by excel, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
standard_dosing<-read.csv("standard_dosing.csv")
```

```{r create full uniformly distributed dataset}
# Create a new data frame to hold the additional observations
new_obs <- data.frame(matrix(nrow = 0, ncol = ncol(standard_dosing)))
colnames(new_obs) <- colnames(standard_dosing)

# Loop through the new IDs (2 to 13)
for (i in 2:13) {
  # Create a temporary data frame for the current ID
  temp_df <- standard_dosing[standard_dosing$ID == 1, ]
  
  # Update the FFM column with the appropriate value for the current ID
  temp_df$FFM <- (i - 1) * 5 + 30
  
  # Add the updated data frame to the new_obs data frame
  new_obs <- rbind(new_obs, temp_df)
  
  # Increment the ID column for the temporary data frame
  temp_df$ID <- i
  
  # Add the temporary data frame to the standard_dosing data frame
  standard_dosing <- rbind(standard_dosing, temp_df)
}

# Sort the standard_dosing data frame by ID and reset the row names
standard_dosing <- standard_dosing[order(standard_dosing$ID), ]
rownames(standard_dosing) <- NULL
```

#### Export full 13 FFM uniformly distributed standard_dosing dataset
```{r first - atomic dataset}
write.csv(standard_dosing,"standard_dosing_atomic.csv",quote=F,row.names=FALSE)
```
```{r then - full dataset}
write.csv(standard_dosing_1,"standard_dosing.csv",quote=F,row.names=FALSE)
```

#### From here down is what I do on 090523
##### First of all, standard_dosing
```{r read in datafile}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
standard_dosing<-read.csv("standard_dosing.csv")
standard_dosing_noCRRT<-read.csv("standard_dosing_noCRRT.csv")
```

```{r select dosing events, trough and peak concentrations only}
standard_dosing<-subset(standard_dosing, TROUGH == 1 | PEAK == 1 | MDV == 1)
standard_dosing_noCRRT<-subset(standard_dosing_noCRRT, TROUGH == 1 | PEAK == 1 | MDV == 1)
```

```{r export standard dosing datasets}
write.csv(standard_dosing,"standard_dosing.csv",quote=F,row.names=FALSE)
write.csv(standard_dosing_noCRRT,"standard_dosing_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Second of all, dosing regimen 01
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_01<-read.csv("dosing_01.csv")
dosing_01_noCRRT<-read.csv("dosing_01_noCRRT.csv")
```

```{r select dosing events, trough and peak concentrations only}
dosing_01<-subset(dosing_01, TROUGH == 1 | PEAK == 1 | MDV == 1)
dosing_01_noCRRT<-subset(dosing_01_noCRRT, TROUGH == 1 | PEAK == 1 | MDV == 1)
```

```{r export dosing regimen 01 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_01,"dosing_01.csv",quote=F,row.names=FALSE)
write.csv(dosing_01_noCRRT,"dosing_01_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Third of all, dosing regimen 02
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_02<-read.csv("dosing_02.csv")
dosing_02_noCRRT<-read.csv("dosing_02_noCRRT.csv")
```

```{r select dosing events, trough and peak concentrations only}
dosing_02<-subset(dosing_02, TROUGH == 1 | PEAK == 1 | MDV == 1)
dosing_02_noCRRT<-subset(dosing_02_noCRRT, TROUGH == 1 | PEAK == 1 | MDV == 1)
```

```{r export dosing regimen 02 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_02,"dosing_02.csv",quote=F,row.names=FALSE)
write.csv(dosing_02_noCRRT,"dosing_02_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Fourth of all, dosing regimen 03
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_03<-read.csv("dosing_03.csv")
dosing_03_noCRRT<-read.csv("dosing_03_noCRRT.csv")
```

```{r select dosing events, trough and peak concentrations only}
dosing_03<-subset(dosing_03, TROUGH == 1 | PEAK == 1 | MDV == 1)
dosing_03_noCRRT<-subset(dosing_03_noCRRT, TROUGH == 1 | PEAK == 1 | MDV == 1)
```

```{r export dosing regimen 03 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_03,"dosing_03.csv",quote=F,row.names=FALSE)
write.csv(dosing_03_noCRRT,"dosing_03_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Fifth of all, dosing regimen 04
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_04<-read.csv("dosing_04.csv")
dosing_04_noCRRT<-read.csv("dosing_04_noCRRT.csv")
```

```{r select dosing events, trough and peak concentrations only}
dosing_04<-subset(dosing_04, TROUGH == 1 | PEAK == 1 | MDV == 1)
dosing_04_noCRRT<-subset(dosing_04_noCRRT, TROUGH == 1 | PEAK == 1 | MDV == 1)
```

```{r export dosing regimen 04 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_04,"dosing_04.csv",quote=F,row.names=FALSE)
write.csv(dosing_04_noCRRT,"dosing_04_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Sixth of all, dosing regimen 05
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_05<-read.csv("standard_dosing.csv")
dosing_05_noCRRT<-read.csv("standard_dosing_noCRRT.csv")
```

```{r change loading and maintenance dose}
# Subset dosing_05 dataset to rows where MDV == 1
dosing_05_mdv <- dosing_05[dosing_05$MDV == 1,]

# Change AMT based on the condition
dosing_05_mdv$AMT <- ifelse(dosing_05_mdv$TIME == 0, 12*dosing_05_mdv$FFM, 6*dosing_05_mdv$FFM)

# Replace the original AMT values in dosing_05 with the updated values for the subset
dosing_05[dosing_05$MDV == 1,]$AMT <- dosing_05_mdv$AMT

```

```{r do similarly for the non-CRRT dataset}
# Subset dosing_05_noCRRT dataset to rows where MDV == 1
dosing_05_noCRRT_mdv <- dosing_05_noCRRT[dosing_05_noCRRT$MDV == 1,]

# Change AMT based on the condition
dosing_05_noCRRT_mdv$AMT <- ifelse(dosing_05_noCRRT_mdv$TIME == 0, 12*dosing_05_noCRRT_mdv$FFM, 6*dosing_05_noCRRT_mdv$FFM)

# Replace the original AMT values in dosing_05 with the updated values for the subset
dosing_05_noCRRT[dosing_05_noCRRT$MDV == 1,]$AMT <- dosing_05_noCRRT_mdv$AMT

```

```{r update TAD peak events}
# Subset dosing_05 dataset for rows where MDV == 1
mdv_rows <- dosing_05[dosing_05$MDV == 1,]

# Calculate AMT/RATE ratio for MDV == 1 rows
mdv_rows$amt_rate_ratio <- mdv_rows$AMT/mdv_rows$RATE

# Get the row numbers for the rows with MDV == 1
mdv_row_nums <- which(dosing_05$MDV == 1)

# Assign the amt_rate_ratio values to the TAD of the subsequent row
for (i in 1:(length(mdv_row_nums) - 1)) {
  dosing_05$TAD[mdv_row_nums[i] + 1] <- mdv_rows$amt_rate_ratio[i]
}
for (i in 1:(length(mdv_row_nums) - 1)) {
  dosing_05_noCRRT$TAD[mdv_row_nums[i] + 1] <- mdv_rows$amt_rate_ratio[i]
}

```

```{r update TIME of peak events accordingly}
dosing_05$TIME<-24*(dosing_05$OCC-1)+dosing_05$TAD
dosing_05_noCRRT$TIME<-24*(dosing_05_noCRRT$OCC-1)+dosing_05_noCRRT$TAD

```

```{r export dosing regimen 05 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_05,"dosing_05.csv",quote=F,row.names=FALSE)
write.csv(dosing_05_noCRRT,"dosing_05_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Sixth of all, dosing regimen 06
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_06<-read.csv("standard_dosing.csv")
dosing_06_noCRRT<-read.csv("standard_dosing_noCRRT.csv")
```

```{r change loading and maintenance dose}
# Subset dosing_06 dataset to rows where MDV == 1
dosing_06_mdv <- dosing_06[dosing_06$MDV == 1,]

# Change AMT based on the condition
dosing_06_mdv$AMT <- ifelse(dosing_06_mdv$TIME == 0, 18*dosing_06_mdv$FFM, 12*dosing_06_mdv$FFM)

# Replace the original AMT values in dosing_06 with the updated values for the subset
dosing_06[dosing_06$MDV == 1,]$AMT <- dosing_06_mdv$AMT

```

```{r do similarly for the non-CRRT dataset}
# Subset dosing_06_noCRRT dataset to rows where MDV == 1
dosing_06_noCRRT_mdv <- dosing_06_noCRRT[dosing_06_noCRRT$MDV == 1,]

# Change AMT based on the condition
dosing_06_noCRRT_mdv$AMT <- ifelse(dosing_06_noCRRT_mdv$TIME == 0, 18*dosing_06_noCRRT_mdv$FFM, 12*dosing_06_noCRRT_mdv$FFM)

# Replace the original AMT values in dosing_06 with the updated values for the subset
dosing_06_noCRRT[dosing_06_noCRRT$MDV == 1,]$AMT <- dosing_06_noCRRT_mdv$AMT

```

```{r update TAD peak events}
# Subset dosing_06 dataset for rows where MDV == 1
mdv_rows <- dosing_06[dosing_06$MDV == 1,]

# Calculate AMT/RATE ratio for MDV == 1 rows
mdv_rows$amt_rate_ratio <- mdv_rows$AMT/mdv_rows$RATE

# Get the row numbers for the rows with MDV == 1
mdv_row_nums <- which(dosing_06$MDV == 1)

# Assign the amt_rate_ratio values to the TAD of the subsequent row
for (i in 1:(length(mdv_row_nums) - 1)) {
  dosing_06$TAD[mdv_row_nums[i] + 1] <- mdv_rows$amt_rate_ratio[i]
}
for (i in 1:(length(mdv_row_nums) - 1)) {
  dosing_06_noCRRT$TAD[mdv_row_nums[i] + 1] <- mdv_rows$amt_rate_ratio[i]
}

```

```{r update TIME of peak events accordingly}
dosing_06$TIME<-24*(dosing_06$OCC-1)+dosing_06$TAD
dosing_06_noCRRT$TIME<-24*(dosing_06_noCRRT$OCC-1)+dosing_06_noCRRT$TAD

```

```{r export dosing regimen 06 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
write.csv(dosing_06,"dosing_06.csv",quote=F,row.names=FALSE)
write.csv(dosing_06_noCRRT,"dosing_06_noCRRT.csv",quote=F,row.names=FALSE)
```

#### Hereafter I create datasets to do simulations with the effect of BW (120523)
```{r first of all, check the range of BW in my dataset}
summary(FlucTotIV_clean$BW2) #ranges from 34 to 142 
summary(FlucTotIV_clean$BW2[!is.na(FlucTotIV_clean$BW2)])
```

##### My BW ranges from 34 to 142, so I'll simulate BW from 30 to 150, with the increment of 5
##### That means I will have 25 patients, 12 patients more than the FFM-based simulations

##### First of all, standard_dosing
```{r read in datafile}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
standard_dosing<-read.csv("standard_dosing.csv")
standard_dosing_noCRRT<-read.csv("standard_dosing_noCRRT.csv")
```

```{r add 12 new patients to standard_dosing adataset}
# Create a new dataset with only patient 13
standard_dosing_13 <- standard_dosing[standard_dosing$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- standard_dosing_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
standard_dosing <- rbind(standard_dosing, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(standard_dosing)[names(standard_dosing) == "FFM"] <- "BW"

# Assign values of BW based on ID
standard_dosing$BW <- (standard_dosing$ID - 1) * 5 + 30

```

```{r do similarly for standard_dosing_noCRRT dataset}
# Create a new dataset with only patient 13
standard_dosing_noCRRT_13 <- standard_dosing_noCRRT[standard_dosing_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- standard_dosing_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
standard_dosing_noCRRT <- rbind(standard_dosing_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(standard_dosing_noCRRT)[names(standard_dosing_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
standard_dosing_noCRRT$BW <- (standard_dosing_noCRRT$ID - 1) * 5 + 30
```


```{r export standard dosing datasets}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(standard_dosing,"standard_dosing.csv",quote=F,row.names=FALSE)
write.csv(standard_dosing_noCRRT,"standard_dosing_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Second of all, dosing regimen 01
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_01<-read.csv("dosing_01.csv")
dosing_01_noCRRT<-read.csv("dosing_01_noCRRT.csv")
```

```{r add 12 new patients to dosing_01 adataset}
# Create a new dataset with only patient 13
dosing_01_13 <- dosing_01[dosing_01$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_01_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_01 <- rbind(dosing_01, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_01)[names(dosing_01) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_01$BW <- (dosing_01$ID - 1) * 5 + 30

```

```{r do similarly for dosing_01_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_01_noCRRT_13 <- dosing_01_noCRRT[dosing_01_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_01_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_01_noCRRT <- rbind(dosing_01_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_01_noCRRT)[names(dosing_01_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_01_noCRRT$BW <- (dosing_01_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 01 datasets}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_01,"dosing_01.csv",quote=F,row.names=FALSE)
write.csv(dosing_01_noCRRT,"dosing_01_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Third of all, dosing regimen 02
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_02<-read.csv("dosing_02.csv")
dosing_02_noCRRT<-read.csv("dosing_02_noCRRT.csv")
```

```{r add 12 new patients to dosing_02 adataset}
# Create a new dataset with only patient 13
dosing_02_13 <- dosing_02[dosing_02$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_02_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_02 <- rbind(dosing_02, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_02)[names(dosing_02) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_02$BW <- (dosing_02$ID - 1) * 5 + 30

```

```{r do similarly for dosing_02_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_02_noCRRT_13 <- dosing_02_noCRRT[dosing_02_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_02_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_02_noCRRT <- rbind(dosing_02_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_02_noCRRT)[names(dosing_02_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_02_noCRRT$BW <- (dosing_02_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 02 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_02,"dosing_02.csv",quote=F,row.names=FALSE)
write.csv(dosing_02_noCRRT,"dosing_02_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Fourth of all, dosing regimen 03
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_03<-read.csv("dosing_03.csv")
dosing_03_noCRRT<-read.csv("dosing_03_noCRRT.csv")
```

```{r add 12 new patients to dosing_03 adataset}
# Create a new dataset with only patient 13
dosing_03_13 <- dosing_03[dosing_03$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_03_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_03 <- rbind(dosing_03, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_03)[names(dosing_03) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_03$BW <- (dosing_03$ID - 1) * 5 + 30

```

```{r do similarly for dosing_03_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_03_noCRRT_13 <- dosing_03_noCRRT[dosing_03_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_03_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_03_noCRRT <- rbind(dosing_03_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_03_noCRRT)[names(dosing_03_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_03_noCRRT$BW <- (dosing_03_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 03 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_03,"dosing_03.csv",quote=F,row.names=FALSE)
write.csv(dosing_03_noCRRT,"dosing_03_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Fifth of all, dosing regimen 04
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_04<-read.csv("dosing_04.csv")
dosing_04_noCRRT<-read.csv("dosing_04_noCRRT.csv")
```

```{r add 12 new patients to dosing_04 adataset}
# Create a new dataset with only patient 13
dosing_04_13 <- dosing_04[dosing_04$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_04_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_04 <- rbind(dosing_04, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_04)[names(dosing_04) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_04$BW <- (dosing_04$ID - 1) * 5 + 30

```

```{r do similarly for dosing_04_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_04_noCRRT_13 <- dosing_04_noCRRT[dosing_04_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_04_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_04_noCRRT <- rbind(dosing_04_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_04_noCRRT)[names(dosing_04_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_04_noCRRT$BW <- (dosing_04_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 04 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_04,"dosing_04.csv",quote=F,row.names=FALSE)
write.csv(dosing_04_noCRRT,"dosing_04_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Six of all, dosing regimen 05
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_05<-read.csv("dosing_05.csv")
dosing_05_noCRRT<-read.csv("dosing_05_noCRRT.csv")
```

```{r add 12 new patients to dosing_05 adataset}
# Create a new dataset with only patient 13
dosing_05_13 <- dosing_05[dosing_05$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_05_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_05 <- rbind(dosing_05, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_05)[names(dosing_05) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_05$BW <- (dosing_05$ID - 1) * 5 + 30

# Update a weight-based dose for these patients
dosing_05$AMT <- with(dosing_05, ifelse(TIME == 0, 12 * BW, ifelse(TIME > 0 & TAD == 0, 6 * BW, AMT)))

# Eliminate rows where PEAK == 1
dosing_05 <- subset(dosing_05, PEAK != 1)

```

```{r do similarly for dosing_05_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_05_noCRRT_13 <- dosing_05_noCRRT[dosing_05_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_05_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_05_noCRRT <- rbind(dosing_05_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_05_noCRRT)[names(dosing_05_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_05_noCRRT$BW <- (dosing_05_noCRRT$ID - 1) * 5 + 30

# Update a weight-based dose for these patients
dosing_05_noCRRT$AMT <- with(dosing_05_noCRRT, ifelse(TIME == 0, 12 * BW, ifelse(TIME > 0 & TAD == 0, 6 * BW, AMT)))

# Eliminate rows where PEAK == 1
dosing_05_noCRRT <- subset(dosing_05_noCRRT, PEAK != 1)

```


```{r export dosing 05 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_05,"dosing_05.csv",quote=F,row.names=FALSE)
write.csv(dosing_05_noCRRT,"dosing_05_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Seventh of all, dosing regimen 06
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_06<-read.csv("dosing_06.csv")
dosing_06_noCRRT<-read.csv("dosing_06_noCRRT.csv")
```

```{r add 12 new patients to dosing_06 adataset}
# Create a new dataset with only patient 13
dosing_06_13 <- dosing_06[dosing_06$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_06_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_06 <- rbind(dosing_06, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_06)[names(dosing_06) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_06$BW <- (dosing_06$ID - 1) * 5 + 30

# Update a weight-based dose for these patients
dosing_06$AMT <- with(dosing_06, ifelse(TIME == 0, 18 * BW, ifelse(TIME > 0 & TAD == 0, 12 * BW, AMT)))

# Eliminate rows where PEAK == 1
dosing_06 <- subset(dosing_06, PEAK != 1)

```

```{r do similarly for dosing_06_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_06_noCRRT_13 <- dosing_06_noCRRT[dosing_06_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_06_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_06_noCRRT <- rbind(dosing_06_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_06_noCRRT)[names(dosing_06_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_06_noCRRT$BW <- (dosing_06_noCRRT$ID - 1) * 5 + 30

# Update a weight-based dose for these patients
dosing_06_noCRRT$AMT <- with(dosing_06_noCRRT, ifelse(TIME == 0, 18 * BW, ifelse(TIME > 0 & TAD == 0, 12 * BW, AMT)))

# Eliminate rows where PEAK == 1
dosing_06_noCRRT <- subset(dosing_06_noCRRT, PEAK != 1)

```


```{r export dosing 06 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_06,"dosing_06.csv",quote=F,row.names=FALSE)
write.csv(dosing_06_noCRRT,"dosing_06_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Eight of all, dosing regimen 07
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_07<-read.csv("dosing_03.csv")
dosing_07_noCRRT<-read.csv("dosing_03_noCRRT.csv")
# Replace AMT with 600 for MDV == 1 and AMT == 1000
dosing_07$AMT[dosing_07$MDV == 1 & dosing_07$AMT == 1000] <- 600
dosing_07_noCRRT$AMT[dosing_07_noCRRT$MDV == 1 & dosing_07_noCRRT$AMT == 1000] <- 600

# Replace TAD with 0.75 for MDV == 1 and TAD == 1.25
dosing_07$TAD[dosing_07$TAD == 1.25] <- 0.75
dosing_07_noCRRT$TAD[dosing_07_noCRRT$TAD == 1.25] <- 0.75

# Update TIME for rows with TAD == 0.75
dosing_07$TIME[dosing_07$TAD == 0.75] <- 24 * (dosing_07$OCC[dosing_07$TAD == 0.75] - 1) + 0.75
dosing_07_noCRRT$TIME[dosing_07_noCRRT$TAD == 0.75] <- 24 * (dosing_07_noCRRT$OCC[dosing_07_noCRRT$TAD == 0.75] - 1) + 0.75

```

```{r add 12 new patients to dosing_07 adataset}
# Create a new dataset with only patient 13
dosing_07_13 <- dosing_07[dosing_07$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_07_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_07 <- rbind(dosing_07, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_07)[names(dosing_07) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_07$BW <- (dosing_07$ID - 1) * 5 + 30

```

```{r do similarly for dosing_07_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_07_noCRRT_13 <- dosing_07_noCRRT[dosing_07_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_07_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_07_noCRRT <- rbind(dosing_07_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_07_noCRRT)[names(dosing_07_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_07_noCRRT$BW <- (dosing_07_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 07 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_07,"dosing_07.csv",quote=F,row.names=FALSE)
write.csv(dosing_07_noCRRT,"dosing_07_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Ninth of all, dosing regimen 08
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation")
dosing_08<-read.csv("dosing_03.csv")
dosing_08_noCRRT<-read.csv("dosing_03_noCRRT.csv")
# Replace AMT with 600 for MDV == 1 and AMT == 1000
dosing_08$AMT[dosing_08$MDV == 1 & dosing_08$AMT == 1000] <- 800
dosing_08_noCRRT$AMT[dosing_08_noCRRT$MDV == 1 & dosing_08_noCRRT$AMT == 1000] <- 800

# Replace TAD with 0.75 for MDV == 1 and TAD == 1.25
dosing_08$TAD[dosing_08$TAD == 1.25] <- 1
dosing_08_noCRRT$TAD[dosing_08_noCRRT$TAD == 1.25] <- 1

# Update TIME for rows with TAD == 0.75
dosing_08$TIME[dosing_08$TAD == 1] <- 24 * (dosing_08$OCC[dosing_08$TAD == 1] - 1) + 1
dosing_08_noCRRT$TIME[dosing_08_noCRRT$TAD == 1] <- 24 * (dosing_08_noCRRT$OCC[dosing_08_noCRRT$TAD == 1] - 1) + 1

```

```{r add 12 new patients to dosing_08 adataset}
# Create a new dataset with only patient 13
dosing_08_13 <- dosing_08[dosing_08$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_08_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_08 <- rbind(dosing_08, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_08)[names(dosing_08) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_08$BW <- (dosing_08$ID - 1) * 5 + 30

```

```{r do similarly for dosing_08_noCRRT dataset}
# Create a new dataset with only patient 13
dosing_08_noCRRT_13 <- dosing_08_noCRRT[dosing_08_noCRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:25, function(id){
  new_df <- dosing_08_noCRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_08_noCRRT <- rbind(dosing_08_noCRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_08_noCRRT)[names(dosing_08_noCRRT) == "FFM"] <- "BW"

# Assign values of BW based on ID
dosing_08_noCRRT$BW <- (dosing_08_noCRRT$ID - 1) * 5 + 30
```


```{r export dosing 08 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_08,"dosing_08.csv",quote=F,row.names=FALSE)
write.csv(dosing_08_noCRRT,"dosing_08_noCRRT.csv",quote=F,row.names=FALSE)
```

##### Tenth of all, dosing regimen 09 for CRRT patients - 140523

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_09<-read.csv("dosing_08.csv")

# Replace AMT with 2000 for AMT == 1200 and BW >90
dosing_09$AMT[dosing_09$AMT == 1200 & dosing_09$BW > 90] <- 2000

# Eliminate rows where PEAK == 1
dosing_09 <- subset(dosing_09, PEAK != 1)

```

```{r export dosing 09 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_09,"dosing_09.csv",quote=F,row.names=FALSE)

```

##### Eleventh of all, dosing regimen 10 for non-CRRT patients - 140523
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_10<-read.csv("dosing_08_noCRRT.csv")

library(dplyr)

# Replace AMT with 2000 for AMT == 1200 and BW >110
dosing_10$AMT[dosing_10$AMT == 1200 & dosing_10$BW > 110] <- 2000

# Replace AMT with 400 for AMT == 800 and BW <=110
dosing_10$AMT[dosing_10$AMT == 800 & dosing_10$BW <= 110] <- 400

# Replace AMT with 600 for AMT == 800 and BW >110
dosing_10$AMT[dosing_10$AMT == 800 & dosing_10$BW > 110] <- 600

# Eliminate rows where PEAK == 1
dosing_10 <- subset(dosing_10, PEAK != 1)


```

```{r export dosing 10 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_10,"dosing_10.csv",quote=F,row.names=FALSE)

```

##### Twelth of all, dosing regimen 11 for non-CRRT patients - 140523
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_11<-read.csv("dosing_10.csv")

library(dplyr)

# Replace AMT with 2000 for AMT == 1200 and BW >110
dosing_11$AMT[dosing_11$AMT == 1200 & dosing_11$BW > 105] <- 2000

# Replace AMT with 600 for AMT == 400 and BW >105
dosing_11$AMT[dosing_11$AMT == 400 & dosing_11$BW > 105] <- 600

```

```{r export dosing 11 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_11,"dosing_11.csv",quote=F,row.names=FALSE)

```

##### Thirteenth of all, dosing regimen 12 for non-CRRT patients - 170523
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_12<-read.csv("dosing_11.csv")

library(dplyr)

# Replace AMT with 2000 for AMT == 1200 and BW >90
dosing_12$AMT[dosing_12$AMT == 1200 & dosing_12$BW > 90] <- 2000

# Replace AMT with 400 for AMT == 600 and BW >90
dosing_12$AMT[dosing_12$AMT == 600] <- 400


```

```{r export dosing 12 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_12,"dosing_12.csv",quote=F,row.names=FALSE)

```

##### Fourteenth of all, dosing regimen 13 for non-CRRT patients - 170523
```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_13<-read.csv("dosing_12.csv")

library(dplyr)

# Replace AMT with 600 for AMT == 400 and BW >90
dosing_13$AMT[dosing_13$AMT == 400 & dosing_12$BW > 90] <- 600


```

```{r export dosing 13 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_13,"dosing_13.csv",quote=F,row.names=FALSE)

```

##### Fifteenth of all, dosing regimen 14, Loading dose of 1400

```{r read in datafile - non CRRT dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_14_noCRRT<-read.csv("dosing_08_noCRRT.csv")

library(dplyr)

# Extract day 1 only
dosing_14_noCRRT <- dosing_14_noCRRT[dosing_14_noCRRT$DAY == 1, ] # Here I only care about PTA on day 1

# Replace AMT with 1400 for AMT == 1200
dosing_14_noCRRT$AMT[dosing_14_noCRRT$AMT == 1200] <- 1400

# Eliminate rows where PEAK == 1
dosing_14_noCRRT <- subset(dosing_14_noCRRT, PEAK != 1)

```

```{r do similarly for CRRT dataset, warning=FALSE}
dosing_14<- dosing_14_noCRRT

dosing_14$CRRT<-1

```

```{r export dosing 14 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_14_noCRRT,"dosing_14_noCRRT.csv",quote=F,row.names=FALSE)
write.csv(dosing_14,"dosing_14.csv",quote=F,row.names=FALSE)

```

##### Sixteenth of all, dosing regimen 15, Loading dose of 1600

```{r read in datafile - non CRRT dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_15_noCRRT<-read.csv("dosing_14_noCRRT.csv")

library(dplyr)

# Replace AMT with 1600 for AMT == 1400
dosing_15_noCRRT$AMT[dosing_15_noCRRT$AMT == 1400] <- 1600

```

```{r do similarly for CRRT dataset, warning=FALSE}
dosing_15<- dosing_15_noCRRT

dosing_15$CRRT<-1

```

```{r export dosing 15 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_15_noCRRT,"dosing_15_noCRRT.csv",quote=F,row.names=FALSE)
write.csv(dosing_15,"dosing_15.csv",quote=F,row.names=FALSE)

```

##### Seventeenth of all, dosing regimen 16, Loading dose of 1800, MD of 600, for CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_16<-read.csv("dosing_08.csv")

library(dplyr)

# Replace AMT with 1800 for AMT == 1200
dosing_16$AMT[dosing_16$AMT == 1200] <- 1800

# Replace AMT with 600 for AMT == 800
dosing_16$AMT[dosing_16$AMT == 800] <- 600

# Eliminate rows where PEAK == 1
dosing_16 <- subset(dosing_16, PEAK != 1)

```

```{r export dosing 16 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_16,"dosing_16.csv",quote=F,row.names=FALSE)

```

##### Eighteenth of all, dosing regimen 17, Loading dose of 1800, MD of 200, for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_17<-read.csv("dosing_08_noCRRT.csv")

library(dplyr)

# Replace AMT with 1800 for AMT == 1200
dosing_17$AMT[dosing_17$AMT == 1200] <- 1800

# Replace AMT with 200 for AMT == 800
dosing_17$AMT[dosing_17$AMT == 800] <- 200

# Eliminate rows where PEAK == 1
dosing_17 <- subset(dosing_17, PEAK != 1)

```

```{r export dosing 17 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_17,"dosing_17.csv",quote=F,row.names=FALSE)

```

##### Nineteenth of all, dosing regimen 18, Loading dose of 1800, MD of 800, for CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_18<-read.csv("dosing_08.csv")

library(dplyr)

# Replace AMT with 1800 for AMT == 1200
dosing_18$AMT[dosing_18$AMT == 1200] <- 1800

# Eliminate rows where PEAK == 1
dosing_18 <- subset(dosing_18, PEAK != 1)

```

```{r export dosing 18 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_18,"dosing_18.csv",quote=F,row.names=FALSE)

```

##### Twentieth of all, dosing regimen 19, Loading dose of 1800, MD of 400, for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_19<-read.csv("dosing_08_noCRRT.csv")

library(dplyr)

# Replace AMT with 1800 for AMT == 1200
dosing_19$AMT[dosing_19$AMT == 1200] <- 1800

# Replace AMT with 400 for AMT == 800
dosing_19$AMT[dosing_19$AMT == 800] <- 400

# Eliminate rows where PEAK == 1
dosing_19 <- subset(dosing_19, PEAK != 1)

```

```{r export dosing 19 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_19,"dosing_19.csv",quote=F,row.names=FALSE)

```

##### Twenty-first of all, dosing regimen 20, an optimised dosing for CRRT patients, Loading dose of 1800 BW>80 kg, 1200 BW<=80kg, and MD of 800

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_20<-read.csv("dosing_18.csv")

library(dplyr)

# Replace AMT with 1200 for AMT == 1800 and BW <=80 kg
dosing_20$AMT[dosing_20$AMT == 1800 & dosing_20$BW<=80] <- 1200

# Eliminate rows where PEAK == 1
dosing_20 <- subset(dosing_20, PEAK != 1)

```

```{r export dosing 20 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_20,"dosing_20.csv",quote=F,row.names=FALSE)

```

##### Twenty-second of all, dosing regimen 21, an optimised dosing for non-CRRT patients, Loading dose of 1800 BW>80 kg, 1200 BW<=80kg, and MD of 400

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_21<-read.csv("dosing_19.csv")

library(dplyr)

# Replace AMT with 1200 for AMT == 1800 and BW <=80 kg
dosing_21$AMT[dosing_21$AMT == 1800 & dosing_21$BW<=80] <- 1200

# Eliminate rows where PEAK == 1
dosing_21 <- subset(dosing_21, PEAK != 1)

```

```{r export dosing 21 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_21,"dosing_21.csv",quote=F,row.names=FALSE)

```

#### Creating datasets for population-level simulations 200523

##### For optimised dosing

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
dosing_CRRT<-read.csv("dosing_03.csv")

library(dplyr)

```

```{r create a dataset of 1000 patients from dosing_CRRT dataset}
# Create a new dataset with only patient 13
dosing_CRRT_13 <- dosing_CRRT[dosing_CRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-25
new_patients <- lapply(14:1000, function(id){
  new_df <- dosing_CRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_CRRT <- rbind(dosing_CRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_CRRT)[names(dosing_CRRT) == "FFM"] <- "BW"

```

```{r sample BW from the normal distribution}
library(dplyr)
test <- FlucTotIV_clean %>% ungroup() %>% select(ID, BW2,CRRT) %>% unique() %>% mutate(BW = log10(BW2/80))
library(ggplot2)

test<-na.omit(test)

# Create a QQ plot using ggplot2
ggplot(test, aes(sample = BW2)) +
  stat_qq() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

# Plotting test$BW2 against a theoretical normal distribution
qqplot(test$BW2, y = rnorm(length(test$BW2)))

# Another way of making a qqplot
qqnorm(test$BW2, pch = 1, frame = FALSE)
qqline(test$BW2, col = "steelblue", lwd = 2)

shapiro.test(test$BW2)

# For the log-transformed BW
qqnorm(test$BW, pch = 1, frame = FALSE)
qqline(test$BW, col = "steelblue", lwd = 2)

shapiro.test(test$BW)

# Histograms
hist(test$BW)
hist(test$BW2)

# Assuming your test dataset is named "test"
sampled_BW <- sample(test$BW2, size = 1000, replace = TRUE)

# normal distribution doesn't work

```

```{r sample BW from an empirical distribution}

#sampling from the empirical distribution

# Create the empirical cumulative distribution function (ECDF)
ecdf_func <- ecdf(test$BW2)

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_BW <- round(quantile(test$BW2, random_values), 1)

# Create a histogram of the sampled values
hist(sampled_BW)

sampled_BW <- as.data.frame(sampled_BW)

```

```{r sample CRRT from an empirical distribution}
# Create the empirical cumulative distribution function (ECDF)
ecdf_func <- ecdf(test$CRRT)

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_CRRT <- round(quantile(test$CRRT, random_values), 1) #does not work

# Create a histogram of the sampled values
hist(sampled_CRRT)
```

```{r assign BW of dosing_CRRT from the empirical distribution above}
# Create the empirical cumulative distribution function (ECDF)
ecdf_func <- ecdf(test$BW2)

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_BW <- round(quantile(test$BW2, random_values), 1)

# Assign the sampled BW values to dosing_CRRT dataset
dosing_CRRT$BW <- sampled_BW[match(dosing_CRRT$ID, 1:1000)]

```

```{r comparing BW2 of CRRT vs non-CRRT}
# comparing if CRRT vs non-CRRT patients have a different distribution

# Perform Mann-Whitney U test
non_parametric_test <- wilcox.test(BW2 ~ ifelse(ID %in% c(crrt_1_ids, miscel_IDs), "CRRT", "Non-CRRT"), data = test)

# Print the test results
print(non_parametric_test) 

#CRRT and non-CRRT patients have a similar BW2 distribution
```

```{r examine the CRRT characteristic of FlucTotIV_clean dataset}
library(dplyr)

miscel_IDs <- FlucTotIV_clean %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16 # CRRT on and off

crrt_1_ids <- unique(FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 1 & !FlucTotIV_clean$ID %in% FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 0]]) #ids of those who have CRRT all the time #16

# IDs of those miscel
Fluc_CRRT <- FlucTotIV_clean[FlucTotIV_clean$ID %in% miscel_IDs, ]

# Create the DAY variable based on TIME
Fluc_CRRT$DAY <- cut(Fluc_CRRT$TIME, breaks = seq(0, max(Fluc_CRRT$TIME), by = 24), labels = FALSE, right = FALSE)

library(tidyr)

# Fill NA values in DAY with 25
Fluc_CRRT <- Fluc_CRRT %>%
  replace_na(list(DAY = 25))

# Convert DAY variable to factor and add 1 to align with the desired values
Fluc_CRRT$DAY <- as.numeric(Fluc_CRRT$DAY)

library(dplyr)

# Move DAY between TAD and AMT
Fluc_CRRT <- Fluc_CRRT %>%
  relocate(DAY, .after = TAD)

```

```{r calculate how many days a patient has CRRT}
library(dplyr)

# Calculate the number of unique days with CRRT == 1 for each patient ID
CRRT_days <- Fluc_CRRT %>%
  filter(CRRT == 1) %>%
  distinct(ID, DAY) %>%
  group_by(ID) %>%
  summarise(CRRT_days = n())

# Calculate the total number of days per patient ID
total_days <- Fluc_CRRT %>%
  group_by(ID) %>%
  summarise(total_days = max(DAY))

# Calculate the percentage of CRRT days
percentage_CRRT_days <- CRRT_days %>%
  left_join(total_days, by = "ID") %>%
  summarise(percentage = sum(CRRT_days) / sum(total_days) * 100)

# Print the result

total_days

percentage_CRRT_days

```

###### I will create my dosing_CRRT dataset with 9% full-time CRRT, and 9% part time CRRT (in which 51.5% DAYS on CRRT)

```{r mimic the aforementioned characterictics for my dosing_CRRT}

# Create a dummy dataset with 1000 patient IDs and 14 days:
dummy_data <- data.frame(
  ID = rep(1:1000, each = 14),
  DAY = rep(1:14, times = 1000)
)

# Add the CRRT variable to the dummy dataset and assign it temporarily to 0:
dummy_data$CRRT <- 0

# Randomly select 9% of the patient IDs and assign their CRRT to 1:
set.seed(42)  # Set seed for reproducibility
selected_ids <- sample(unique(dummy_data$ID), size = round(0.09 * 1000))
dummy_data$CRRT[dummy_data$ID %in% selected_ids] <- 1

# Randomly select another 9% of patient IDs that are not in selected_ids:
available_ids <- setdiff(unique(dummy_data$ID), selected_ids)
selected_ids_2 <- sample(available_ids, size = round(0.09 * 1000))
selected_days <- sample(unique(dummy_data$DAY), size = round(0.515 * 14))

# Assign 51.5% of the selected days to CRRT == 1, and the remaining to CRRT == 0
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & dummy_data$DAY %in% selected_days] <- 1
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & !dummy_data$DAY %in% selected_days] <- 0

# Assign CRRT == 0 to the remaining 82% of patient IDs:

dummy_data$CRRT[!(dummy_data$ID %in% c(selected_ids, selected_ids_2))] <- 0

# Assign the CRRT information from the dummy dataset to the dosing_CRRT dataset based on ID and DAY:

dosing_CRRT <- merge(dosing_CRRT, dummy_data[, c("ID", "DAY", "CRRT")], by = c("ID", "DAY"), all.x = TRUE)
dosing_CRRT$CRRT.x<-NULL
colnames(dosing_CRRT)[colnames(dosing_CRRT) == "CRRT.y"] <- "CRRT"

```

```{r make sure it relects FlucTotIV_clean dataset}
library(dplyr)

miscel_IDs <- dosing_CRRT %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 90 # CRRT on and off
length(miscel_IDs)

crrt_1_ids <- unique(dosing_CRRT$ID[dosing_CRRT$CRRT == 1 & !dosing_CRRT$ID %in% dosing_CRRT$ID[dosing_CRRT$CRRT == 0]]) #ids of those who have CRRT all the time #16
length(crrt_1_ids)

# IDs of those miscel
Fluc_CRRT <- dosing_CRRT[dosing_CRRT$ID %in% miscel_IDs, ]

library(dplyr)

# Calculate the number of unique days with CRRT == 1 for each patient ID
CRRT_days <- Fluc_CRRT %>%
  filter(CRRT == 1) %>%
  distinct(ID, DAY) %>%
  group_by(ID) %>%
  summarise(CRRT_days = n())

# Calculate the total number of days per patient ID
total_days <- Fluc_CRRT %>%
  group_by(ID) %>%
  summarise(total_days = max(DAY))

# Calculate the percentage of CRRT days
percentage_CRRT_days <- CRRT_days %>%
  left_join(total_days, by = "ID") %>%
  summarise(percentage = sum(CRRT_days) / sum(total_days) * 100)

# Print the result

CRRT_days

percentage_CRRT_days

```

```{r updating AMT for dosing_CRRT}
dosing_CRRT <- dosing_CRRT %>%
  mutate(
    AMT = ifelse(TIME == 0 & BW > 80, 2000,
           ifelse(TIME == 0 & BW <= 80, 1200,
           ifelse(TIME > 0 & MDV == 1 & CRRT == 1, 800,
           ifelse(TIME > 0 & MDV == 1 & CRRT == 0, 400, AMT))))
  )


```

```{r extract AMT 2000 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 2000
selected_groups <- grouped_data %>% filter(any(AMT == 2000))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.25, 2.5, 4, 6,8, 12, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,489)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 1200 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1200
selected_groups <- grouped_data %>% filter(any(AMT == 1200))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.25, 2, 4, 6,8, 12, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,511)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 800 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 800
selected_groups <- grouped_data %>% filter(any(AMT == 800))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Eliminate all TAD == 24 rows

# Filter out rows with TAD == 24
dosing_CRRT <- dosing_CRRT %>%
  filter(TAD != 24)

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.5, 1, 2, 4, 6,12, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,1800)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r extract AMT 400 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 400
selected_groups <- grouped_data %>% filter(any(AMT == 400))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.25, 0.5, 1, 2,6,12, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,11200)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r update TIME}
dosing_CRRT$TIME<-24*(dosing_CRRT$OCC-1)+dosing_CRRT$TAD
dosing_CRRT$PEAK<-NULL

# Rearrange dosing_CRRT according to ID, DAY, and TIME
dosing_CRRT <- dosing_CRRT %>%
  arrange(ID, DAY, TIME)

```

```{r export dosing_CRRT dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
#write.csv(dosing_CRRT,"pop_dosing.csv",quote=F,row.names=FALSE)
write.csv(pop_dosing,"pop_dosing.csv",quote=F,row.names=FALSE)

```

```{r read pop_dosing dataset}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
pop_dosing<-read.csv("pop_dosing.csv")

# Move DAY after OCC
library(dplyr)
pop_dosing <- pop_dosing %>%
  relocate(DAY, .after = OCC)

```

##### For standard dosing

```{r change into standard dosing}
# Replace rows with AMT == 2000 or AMT == 1200 with 800
# Replace rows with AMT == 800 with 400
pop_dosing<- dosing_CRRT
dosing_CRRT$AMT <- ifelse(dosing_CRRT$AMT == 2000 | dosing_CRRT$AMT == 1200, 800,
                         ifelse(dosing_CRRT$AMT == 800, 400, dosing_CRRT$AMT))

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r extract AMT 800 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 800
selected_groups <- grouped_data %>% filter(any(AMT == 800))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.5, 1, 2, 4, 6,12,15, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,1000)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r extract AMT 400 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 400
selected_groups <- grouped_data %>% filter(any(AMT == 400))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.25, 0.5, 1, 2,6,12, 18, 21, 22, 23, 23.9)

selected_rows$TAD<-rep(desired_tad,13000)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r update TIME}
dosing_CRRT$TIME<-24*(dosing_CRRT$OCC-1)+dosing_CRRT$TAD

```

```{r export dosing_CRRT dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
#write.csv(dosing_CRRT,"pop_dosing_std.csv",quote=F,row.names=FALSE)
write.csv(pop_dosing_std,"pop_dosing_std.csv",quote=F,row.names=FALSE)

```

```{r read pop_dosing_std dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
pop_dosing_std<-read.csv("pop_dosing_std.csv")

# Move DAY after OCC
library(dplyr)
pop_dosing_std <- pop_dosing_std %>%
  relocate(DAY, .after = OCC)

```

### Manuscript Result section 030523
#### Table 1

```{r read in dataset}
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")
```

```{r change variables into correct data types}
FlucTotIV_clean$DV <- as.numeric(as.character(FlucTotIV_clean$DV))
FlucTotIV_clean$AMT <- as.numeric(as.character(FlucTotIV_clean$AMT))
FlucTotIV_clean$BW2 <- as.numeric(as.character(FlucTotIV_clean$BW2))
FlucTotIV_clean$BMI <- as.numeric(as.character(FlucTotIV_clean$BMI))
FlucTotIV_clean$LENGTH <- as.numeric(as.character(FlucTotIV_clean$LENGTH))
FlucTotIV_clean$CREAT <- as.numeric(as.character(FlucTotIV_clean$CREAT))
FlucTotIV_clean$CKDEPI <- as.numeric(as.character(FlucTotIV_clean$CKDEPI))
FlucTotIV_clean$BILI <- as.numeric(as.character(FlucTotIV_clean$BILI))
FlucTotIV_clean$AST <- as.numeric(as.character(FlucTotIV_clean$AST))
FlucTotIV_clean$ALT <- as.numeric(as.character(FlucTotIV_clean$ALT))
FlucTotIV_clean$ALB <- as.numeric(as.character(FlucTotIV_clean$ALB))
FlucTotIV_clean$GGT <- as.numeric(as.character(FlucTotIV_clean$GGT))
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$IHD <- as.factor(FlucTotIV_clean$IHD)
FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
```


```{r create FFM variable for reporting}
for (i in 1:length(FlucTotIV_clean$SEX)) {
        if (FlucTotIV_clean$SEX[i]==1) {
                FlucTotIV_clean$FFM[i] <- 0.407*FlucTotIV_clean$BW2[i]+0.267*FlucTotIV_clean$LENGTH[i]*100-19.2
        } else {
                FlucTotIV_clean$FFM[i] <- 0.252*FlucTotIV_clean$BW2[i]+0.473*FlucTotIV_clean$LENGTH[i]*100-48.3
        } 
}
```

```{r report AMT & DV}
library(table1)
library(dplyr)
datasum <- FlucTotIV_clean %>% select(AMT,DV,HOSPITAL)
label(datasum$AMT) <- "Dose"
label(datasum$DV) <- "Concentration"

table1(~ AMT + DV |HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))
table1(~ AMT |HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))
table1(~ DV |HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))
```

```{r report Ctrough}
library(table1)
library(dplyr)
datasum <- FlucTotIV_clean %>% filter (TAD>=23 & TAD <=25) %>% select(DV,DV15, HOSPITAL)
label(datasum$DV) <- "Concentration"
datasum$DV15<-as.factor(datasum$DV15)

table1(~ DV + DV15 |HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))
```

```{r report the percentage of patiens who has conc greater or equal 15}
FlucTotIV_clean$DV15<-ifelse(FlucTotIV_clean$DV>=15, 1,0)
library(table1)
library(dplyr)
datasum <- FlucTotIV_clean %>% filter(!is.na(FlucTotIV_clean$DV)) %>% select(DV15,HOSPITAL)
datasum$DV15<-as.factor(datasum$DV15)
table1(~ DV15 |HOSPITAL, data=datasum)
```

```{r report the number of samples per patient per HOSPITAL}
library(dplyr)

datasum %>%
  group_by(HOSPITAL, ID) %>%
  summarise(n_samples = sum(!is.na(DV))) %>%
  group_by(HOSPITAL) %>%
  summarise(total_samples = sum(n_samples), n_patients = n()) 

# Calculate the number of samples per patient ID
samples_per_patient <- aggregate(DV ~ ID + HOSPITAL, data = FlucTotIV_clean, FUN = function(x) sum(!is.na(x)))

# Calculate the median (IQR) of the number of samples per patient ID in each HOSPITAL
median_samples_per_patient <- aggregate(samples_per_patient["DV"], by = samples_per_patient["HOSPITAL"], FUN = function(x) quantile(x, probs = c(0.25, 0.5, 0.75), na.rm = TRUE))

# Print the results
median_samples_per_patient

```

```{r number of samples per patient overall}
library(dplyr)

# calculate the number of samples per patient ID
samples_per_patient <- FlucTotIV_clean %>% 
  group_by(ID) %>% 
  summarize(samples = sum(!is.na(DV))) %>% 
  ungroup()

# calculate median and IQR of samples per patient ID across all hospitals
overall_samples_summary <- samples_per_patient %>% 
  summarize(median_samples = median(samples), 
            lower_quartile = quantile(samples, 0.25), 
            upper_quartile = quantile(samples, 0.75))
```


```{r report the common characteristics: APACHE, AGE, SEX, CRRT, IHD}
### CRRT2 variable, indicating which patient has CRRT
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"]) 
FlucTotIV_clean$CRRT2 <- ifelse(FlucTotIV_clean$ID %in% crrt_patients, 1, 0)
FlucTotIV_clean$CRRT2 <- as.factor(FlucTotIV_clean$CRRT2)

### IHD2 variable, indicating which patient has IHD
ihd_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$IHD == 1, "ID"]) 
FlucTotIV_clean$IHD2 <- ifelse(FlucTotIV_clean$ID %in% ihd_patients, 1, 0)
FlucTotIV_clean$IHD2 <- as.factor(FlucTotIV_clean$IHD2)

library(table1)

datasum <- unique(FlucTotIV_clean %>% select(ID,APACHE,AGE,SEX,HOSPITAL,CRRT2,IHD2, BW2, LENGTH))

### Here I eliminate the duplicated missing APACHE rows

# Check for duplicated IDs
dup_ids <- duplicated(datasum$ID)

# Identify duplicated IDs where APACHE is missing
dup_ids_apache_missing <- duplicated(datasum$ID, incomparables = NA)

# Keep the row with non-missing APACHE values for each duplicated ID
datasum <- datasum[!(dup_ids & dup_ids_apache_missing), ]


### assign label to sex, CRRT, IHD
datasum$SEX <- 
        factor(datasum$SEX, levels=c(1,2),
               labels=c("Male", 
                        "Female"))
datasum$CRRT2 <- 
        factor(datasum$CRRT2, levels=c(0,1),
               labels=c("No", 
                        "Yes"))

datasum$IHD2 <- 
        factor(datasum$IHD2, levels=c(0,1),
               labels=c("No", 
                        "Yes"))

table1(~ APACHE + AGE + SEX + CRRT2 + IHD2 + BW2 + LENGTH|HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))

```

```{r report the covariates: BW, BMI, FFM, CKDEPI, LENGTH}
### Create CKDEPI2 & BMI2 variables
FlucTotIV_clean$BMI2 <- FlucTotIV_clean$BW2/(FlucTotIV_clean$LENGTH)^2
FlucTotIV_clean$CKDEPI2 <- ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT2 < 0.9,(142) * ((FlucTotIV_clean$CREAT2/0.9)^-0.302) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT2 >= 0.9,(142) * ((FlucTotIV_clean$CREAT2/0.9)^-1.200) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 2 & FlucTotIV_clean$CREAT2 < 0.7, (142) * ((FlucTotIV_clean$CREAT2/0.7)^-0.241) * (0.9938^FlucTotIV_clean$AGE)*1.012, (142) * ((FlucTotIV_clean$CREAT2/0.7)^-1.200) * (0.9938^FlucTotIV_clean$AGE)*1.012)))

library(table1)

datasum <- FlucTotIV_clean %>% select(BW2,BMI2,FFM,CKDEPI2,LENGTH,HOSPITAL)

table1(~ BW2 + BMI2 + FFM + CKDEPI2 + LENGTH|HOSPITAL, data=datasum,render.continuous=
               c(.="Median [Q1-Q3]"))

#050623
summary(FlucTotIV_clean$BW2)
summary(FlucTotIV_clean$CKDEPI2)

# Assuming your dataset is named FlucTotIV_clean
# Replace 'ID' with the actual column name for IDs in your dataset
# Replace 'CKDEPI2' with the actual column name for CKDEPI2 in your dataset

# Count the number of unique IDs with CKDEPI2 > 96.5
count <- length(unique(FlucTotIV_clean$ID[FlucTotIV_clean$CKDEPI2 > 96.5]))

# Print the result
count


```

#### Table 2
##### Reporting 10 bootstraps

```{r read pooled 10 bootstraps dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooled_Bootstrap<-read.csv("Pooled_Bootstrap.csv")
```

```{r reporting the median of the median (95% CI) of 10 bootstraps}
library(dplyr)

Pooled_Bootstrap %>%
  group_by(Parameters) %>%
  summarise(median_median = median(Median_Mean),
            median_lower_bound = median(Lower_bound),
            median_upper_bound = median(Upper_bound))

```

```{r create 3 new columns for %CV of IIV/PropErr}
Pooled_Bootstrap$CV_mean<-sqrt(exp(Pooled_Bootstrap$Median_Mean)-1)*100
Pooled_Bootstrap$CV_lower<-sqrt(exp(Pooled_Bootstrap$Lower_bound)-1)*100
Pooled_Bootstrap$CV_upper<-sqrt(exp(Pooled_Bootstrap$Upper_bound)-1)*100
```

```{r calculate the median of these %CV of the 10 model and the final model}
library(dplyr)

Pooled_Bootstrap %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%
  group_by(Parameters) %>%
  summarise(median_CV_mean = median(CV_mean),
            median_CV_lower = median(CV_lower),
            median_CV_upper = median(CV_upper))

Pooled_Bootstrap %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%filter(Model==100) %>%select(CV_mean,CV_lower,CV_upper,Model,Parameters) %>%
  print()
```

```{r number of successful run}
successful_run<-182+183+189+191+185+187+192+192+192+187
percentage<- successful_run/2000
successful_run
percentage
```

```{r number of significantly reduced OFV by CKDEPI}
sig_OFV_CKDEPI<-(8+10+8+6+7+10+8+8+9+9)/10 #per each imputation
sig_OFV_CKDEPI #equals 8.3
```

##### Table 2, Reporting 10 bootstraps for models with BW - 170523

```{r read pooled 10 bootstraps dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooled_Bootstrap_BW<-read.csv("Pooled_Bootstrap_BW.csv")

```

```{r reporting the median of the median (95% CI) of 10 bootstraps}

library(dplyr)

Pooled_Bootstrap_BW %>%
  group_by(Parameters) %>%
  summarise(median_median = median(Median_Mean),
            median_lower_bound = median(Lower_bound),
            median_upper_bound = median(Upper_bound))

Pooled_Bootstrap_BW %>%
        group_by(Model) %>%
select(Median_Mean,Lower_bound,Upper_bound,Model,Parameters) %>%
  print()

```

```{r create 3 new columns for %CV of IIV/PropErr}

Pooled_Bootstrap_BW$CV_mean<-sqrt(exp(Pooled_Bootstrap_BW$Median_Mean)-1)*100
Pooled_Bootstrap_BW$CV_lower<-sqrt(exp(Pooled_Bootstrap_BW$Lower_bound)-1)*100
Pooled_Bootstrap_BW$CV_upper<-sqrt(exp(Pooled_Bootstrap_BW$Upper_bound)-1)*100

```

```{r calculate the median of these %CV of the 10 model and the final model}

library(dplyr)

Pooled_Bootstrap_BW %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%
  group_by(Parameters) %>%
  summarise(median_CV_mean = median(CV_mean),
            median_CV_lower = median(CV_lower),
            median_CV_upper = median(CV_upper))

Pooled_Bootstrap_BW %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%filter(Model==100) %>%select(CV_mean,CV_lower,CV_upper,Model,Parameters) %>%
  print()

Pooled_Bootstrap_BW %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%
        group_by(Model) %>%
select(CV_mean,CV_lower,CV_upper,Model,Parameters) %>%
  print()

```

```{r number of successful run}

successful_run<-c(190,191,195,195,193,193,195,191,189,190)
percentage<- successful_run/200
summary(percentage)

```

#### Model diagnostic - GOF plots - appendix

##### First of all, base model

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat <- read.csv("sdtab000.csv")
dat <- subset (dat, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Base model", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_modbase.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Second of all, mod 01
```{r setwd and read datafile}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat01 <- read.csv("sdtab011.csv")
dat01 <- subset (dat01, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat01, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat01, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat01, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat01, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 01", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod01.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Third of all, mod 02
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat02 <- read.csv("sdtab012.csv")
dat02 <- subset (dat02, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat02, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat02, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat02, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat02, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 02", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod02.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Fourth of all, mod 03
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat03 <- read.csv("sdtab013.csv")
dat03 <- subset (dat03, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat03, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat03, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat03, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat03, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 03", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod03.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Fifth of all, mod 04
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat04 <- read.csv("sdtab014.csv")
dat04 <- subset (dat04, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat04, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat04, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat04, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat04, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 04", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod04.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Sixth of all, mod 05
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat05 <- read.csv("sdtab015.csv")
dat05 <- subset (dat05, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat05, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat05, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat05, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat05, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 05", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod05.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Seventh of all, mod 06
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat06 <- read.csv("sdtab016.csv")
dat06 <- subset (dat06, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat06, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat06, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat06, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat06, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 06", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod06.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Eight of all, mod 07
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat07 <- read.csv("sdtab017.csv")
dat07 <- subset (dat07, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat07, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat07, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat07, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat07, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 07", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod07.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Ninth of all, mod 08
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat08 <- read.csv("sdtab018.csv")
dat08 <- subset (dat08, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat08, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat08, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat08, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat08, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 08", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod08.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Tenth of all, mod 09
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat09 <- read.csv("sdtab019.csv")
dat09 <- subset (dat09, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat09, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat09, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat09, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat09, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 09", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod09.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Eleventh of all, mod 10
```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model diagnostics")
dat10 <- read.csv("sdtab020.csv")
dat10 <- subset (dat10, EVID==0)
```
```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat10, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat10, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat10, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat10, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 10", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod10.png", combined_plot, dpi = 300, width = 12, height = 7)


```

#### Model with BW - diagnostic - appendix

##### I already had the one for base model above

##### First of all, mod 01

```{r setwd and read datafile}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat01 <- read.csv("sdtab211.csv",skip=1,sep="")
dat01 <- subset (dat01, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat01, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat01, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat01, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat01, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 01", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod01.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Second of all, mod 02

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat02 <- read.csv("sdtab212.csv",skip=1,sep="")
dat02 <- subset (dat02, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat02, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat02, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat02, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat02, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 02", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod02.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Third of all, mod 03

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat03 <- read.csv("sdtab213.csv",skip=1,sep="")
dat03 <- subset (dat03, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat03, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat03, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat03, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat03, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 03", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod03.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Fourth of all, mod 04

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat04 <- read.csv("sdtab214.csv",skip=1,sep="")
dat04 <- subset (dat04, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat04, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat04, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat04, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat04, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 04", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod04.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Fifth of all, mod 05

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat05 <- read.csv("sdtab215.csv",skip=1,sep="")
dat05 <- subset (dat05, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat05, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat05, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat05, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat05, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 05", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod05.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Sixth of all, mod 06

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat06 <- read.csv("sdtab216.csv",skip=1,sep="")
dat06 <- subset (dat06, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat06, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat06, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat06, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat06, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 06", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod06.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Seventh of all, mod 07

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat07 <- read.csv("sdtab217.csv",skip=1,sep="")
dat07 <- subset (dat07, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat07, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat07, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat07, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat07, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 07", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod07.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Eighth of all, mod 08

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat08 <- read.csv("sdtab218.csv",skip=1,sep="")
dat08 <- subset (dat08, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat08, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat08, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat08, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat08, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 08", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod08.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Tenth of all, mod 09

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat09 <- read.csv("sdtab219.csv",skip=1,sep="")
dat09 <- subset (dat09, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat09, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat09, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat09, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat09, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 09", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod09.png", combined_plot, dpi = 300, width = 12, height = 7)


```

##### Tenth of all, mod 10

```{r setwd and read datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")
dat10 <- read.csv("sdtab220.csv",skip=1,sep="")
dat10 <- subset (dat10, EVID==0)
```

```{r PRED vs CWRES plot, warning=FALSE}
plot1<-ggplot (data = dat10, aes(x=PRED, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot2<-ggplot (data = dat10, aes(x=TAD, y=CWRES)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -2, linetype = "dashed") +  
  geom_hline(yintercept = 2, linetype = "dashed") +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot3<-ggplot (data = dat10, aes(x=PRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

plot4<-ggplot (data = dat10, aes(x=IPRED, y=DV)) +
  #choose:
  # geom_point(colour='dodgerblue', shape=1, size=3) +
  geom_point(colour="dodgerblue", shape=1, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10)) +
  geom_smooth(se = F, aes(colour = "red"), method = "loess") +
  theme(legend.position="none") +
  theme(text = element_text(size = 12))

library(cowplot)

# Combine the plots using plot_grid()
grid <- plot_grid(plot1, plot2, plot3, plot4, nrow = 2, align = "h")

# Add a title to the grid
title <- ggdraw() + 
  draw_label("Final model 10", fontface = "bold", size = 14)

# Arrange the title and grid using plot_grid()
combined_plot <- plot_grid(title, grid, ncol = 1, rel_heights = c(0.1, 1))

# Set wd to store plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Model_Rx_BW")

# Save the plot as a high-resolution png file
ggsave("combined_plot_mod10.png", combined_plot, dpi = 300, width = 12, height = 7)


```

