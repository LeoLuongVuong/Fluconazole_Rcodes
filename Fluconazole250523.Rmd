---
title: "New file - better life"
author: "Leo"
date: "2023-05-25"
output: pdf_document
---

#### Population level simulations dataset for optimised dosing

```{r for optimised dosing, warning=FALSE}

library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")

# Read in sdtab_stand.txt file
sdtab_pop_10 <- read.table("sdtab_pop_10.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_pop_10[] <- lapply(sdtab_pop_10, as.numeric)

#eliminate all NAs
sdtab_pop_10 <- na.omit(sdtab_pop_10)

# Extract only the trough events
sdtab_pop_10_trough <- sdtab_pop_10[sdtab_pop_10$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_pop_10_trough <- sdtab_pop_10_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_pop_10_trough<- sdtab_pop_10_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_pop_10_trough$fAUC<- sdtab_pop_10_trough$AUC24*0.89

#Eliminate peak column
sdtab_pop_10_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY columns
PTA_pop_10 <- subset(sdtab_pop_10_trough, select = c("ID", "DV", "fAUC", "DAY"))

# Calculate percentage of DV >= 7.5 per DAY (PTA_Cmin_75)
PTA_pop_10$PTA_Cmin_75 <- 100 * ave(PTA_pop_10$DV >= 7.5, PTA_pop_10$DAY, FUN = mean)

# Calculate percentage of DV >= 80 per DAY (PTA_Cmin_80)
PTA_pop_10$PTA_Cmin_80 <- 100 * ave(PTA_pop_10$DV >= 80, PTA_pop_10$DAY, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY (PTA_fAUC_200)
PTA_pop_10$PTA_fAUC_200 <- 100 * ave(PTA_pop_10$fAUC >= 200, PTA_pop_10$DAY, FUN = mean)

# Create PTA_pop_10_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY
PTA_pop_10_overall <- unique(PTA_pop_10[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_pop_10_trough, "sdtab_pop_10_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_pop_10_overall, "PTA_pop_10_overall.csv",quote=F,row.names = FALSE)

```

#### Plot fAUC over DAY (draft code)

```{r read those exported datasets again when R aborted, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
sdtab_pop_10_trough<-read.csv("sdtab_pop_10_trough.csv")
library(dplyr)
pop_10_trough <-sdtab_pop_10_trough%>%select(ID, DAY, fAUC)

```

```{r modify the sdtab_pop_10_trough dataset}
# Extract only the first row
pop_10_trough_01 <- pop_10_trough[1,]

# Change DAY to 0
pop_10_trough_01$DAY<-0
pop_10_trough_01$fAUC<-0

# Create 1000 copies of pop_10_trough and assign IDs 1-1000
new_rows <- lapply(1:1000, function(id){
  new_df <- pop_10_trough_01
  new_df$ID <- id
  return(new_df)
})

new_rows<-rep(new_rows,10)

# Combine the new datasets with the original dataset
pop_10_trough <- rbind(pop_10_trough, do.call(rbind, new_rows))

```

```{r fAUC over DAY}

library(ggplot2)

# Calculate median and quantiles for fAUC by DAY
summary_stats <- pop_10_trough %>%
  group_by(DAY) %>%
  summarize(median_fAUC = median(fAUC),
            q1_fAUC = quantile(fAUC, 0.005),
            q99_fAUC = quantile(fAUC, 0.995))

# Change summary_stats into data.frame
summary_stats<-as.data.frame(summary_stats)

# Plot fAUC over DAY with median line and population interval ribbon
ggplot(pop_10_trough, aes(x = DAY, y = fAUC)) +
  geom_ribbon(data = summary_stats, aes(ymin = q1_fAUC, ymax = q99_fAUC),
              fill = "gray70", alpha = 0.5) +
  geom_line(data = summary_stats, aes(y = median_fAUC), color = "gray40", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50") +
  labs(x = "DAY", y = "fAUC") +
  theme_minimal()

library(ggplot2)
library(dplyr)

# Assuming your dataset is named "pop_10_trough"
# Make sure DAY and fAUC are numeric variables

# Check if 'fAUC' variable exists in the dataset
if (!"fAUC" %in% colnames(pop_10_trough)) {
  stop("Variable 'fAUC' not found in the dataset.")
}

# Calculate median and quantiles for fAUC by DAY
summary_stats <- pop_10_trough %>%
  group_by(DAY) %>%
  summarize(median_fAUC = median(fAUC),
            q1_fAUC = quantile(fAUC, 0.005),
            q99_fAUC = quantile(fAUC, 0.995))

# Plot fAUC over DAY with median line and population interval ribbon
ggplot() +
  geom_ribbon(data = summary_stats, aes(x = factor(DAY),ymin = q1_fAUC, ymax = q99_fAUC),
              fill = "gray70", alpha = 0.5) +
  geom_line(data = summary_stats, aes(x = factor(DAY),y = median_fAUC), color = "gray40", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50") +
  labs(x = "DAY", y = "fAUC") +
  theme_minimal()

ggplot (data = summary_stats, aes(x=factor(DAY), y=median_fAUC)) +
   geom_ribbon(aes(ymin = q1_fAUC, ymax = q99_fAUC), fill = "gray70", alpha = 0.5)+ geom_line(color = "gray40", size = 1)+
  xlab('DAY') +
  ylab('Fluconazole fAUC (mgxh/L)') +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50") +
  #scale_x_discrete(limits = c(0, 14), breaks = seq(0,14, by =1)) +
  #scale_y_continuous(limits = c(0, 3300), breaks = seq(0,3300, by =100)) 
  theme(text = element_text(size = 18))+  theme(
  #Remove panel border
  panel.border = element_blank(),  
  # Remove panel grid lines
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
  # Add axis line
  axis.line = element_line(colour = "grey"),
  plot.title = element_text(hjust = 0.5),
  legend.position = "none",
  axis.title = element_text(size = 18),
   axis.text = element_text(size = 14), strip.text= element_text(size=14),legend.title=element_text(size=14),legend.text=element_text(size=12)) 

ggplot(summary_stats, aes(x = factor(DAY))) +
  geom_ribbon(aes(ymin = q1_fAUC, ymax = q99_fAUC), fill = "gray70", alpha = 0.5) +
  geom_line(aes(y = median_fAUC), color = "gray40", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50") +
  labs(x = "DAY", y = "fAUC") +
  theme_minimal()


```

##### Trying the code of Omar, ribbon + line plot of optimised dosing

```{r create a data_summary_opt dataset}
data_summary_opt <- pop_10_trough %>%
  group_by(DAY) %>%
  summarize(median= median(fAUC),
            min= quantile(fAUC, 0.05),
            max= quantile(fAUC, 0.95),
            .groups = 'drop')

# Round the values to 2 decimal places
data_summary_opt <- data_summary_opt %>%
  mutate(across(everything(), ~ round(., 2)))

```

```{r plot simple ribbon}
ggplot (data = data_summary_opt, aes(x=DAY, y=median)) +
   geom_ribbon(aes(ymin = min, ymax = max), fill = "gray70", alpha = 0.5)+ geom_line(color = "gray40", size = 1) #geom_line requires two observations per group to create a line
```

```{r more complicated ribbon plot}
ggplot (data = data_summary_opt, aes(x=DAY, y=median)) +
   geom_ribbon(aes(ymin = min, ymax = max), fill = "gray70", alpha = 0.5)+ geom_line(color = "gray40", size = 1)+
  xlab('DAY') +
  ylab('Fluconazole fAUC (mgxh/L)') +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50") +
  scale_x_continuous(limits = c(0, 14), breaks = seq(0,14, by =1)) +
  scale_y_continuous(limits = c(0, 1200), breaks = seq(0,1200, by =100)) 
  theme(text = element_text(size = 18))+  theme(
  #Remove panel border
  panel.border = element_blank(),  
  # Remove panel grid lines
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
  # Add axis line
  axis.line = element_line(colour = "grey"),
  plot.title = element_text(hjust = 0.5),
  legend.position = "none",
  axis.title = element_text(size = 18),
   axis.text = element_text(size = 14), strip.text= element_text(size=14),legend.title=element_text(size=14),legend.text=element_text(size=12)) 
```

```{r refined version of the code above,warning=FALSE}
pop_sim_opt<-ggplot(data = data_summary_opt, aes(x = DAY, y = median)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "gray70", alpha = 0.5) +
  geom_line(color = "gray40", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50",size=0.8) +
  xlab("DAY") +
  ylab("Fluconazole fAUC (mgxh/L)") +
  scale_x_continuous(limits = c(0, 14), breaks = seq(0, 14, by = 1)) +
  scale_y_continuous(limits = c(0, 1200), breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),  # Add panel borders
    panel.grid.major = element_line(color = "gray80"),  # Use a minimal grid color
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("pop_sim_opt.png",pop_sim_opt, dpi = 300, width = 12, height = 7)
```

##### Ribbon + line plot of standard dosing

```{r modify the sdtab_pop_std_10_trough dataset}
library(dplyr)
pop_std_10_trough <-sdtab_pop_std_10_trough%>%select(ID, DAY, fAUC)
# Extract only the first row
pop_std_10_trough_01 <- pop_std_10_trough[1,]

# Change DAY to 0
pop_std_10_trough_01$DAY<-0
pop_std_10_trough_01$fAUC<-0

# Create 1000 copies of pop_std_10_trough and assign IDs 1-1000
new_rows <- lapply(1:1000, function(id){
  new_df <- pop_std_10_trough_01
  new_df$ID <- id
  return(new_df)
})

new_rows<-rep(new_rows,10)

# Combine the new datasets with the original dataset
pop_std_10_trough <- rbind(pop_std_10_trough, do.call(rbind, new_rows))

```

```{r create a data_summary_std dataset}
data_summary_std <- pop_std_10_trough %>%
  group_by(DAY) %>%
  summarize(median= median(fAUC),
            min= quantile(fAUC, 0.05),
            max= quantile(fAUC, 0.95),
            .groups = 'drop')

# Round the values to 2 decimal places
data_summary_std <- data_summary_std %>%
  mutate(across(everything(), ~ round(., 2)))

```

```{r ribbon plot std dosing}

pop_sim_std<-ggplot(data = data_summary_std, aes(x = DAY, y = median)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "gray70", alpha = 0.5) +
  geom_line(color = "gray40", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50",size=0.8) +
  xlab("DAY") +
  ylab("Fluconazole fAUC (mgxh/L)") +
  scale_x_continuous(limits = c(0, 14), breaks = seq(0, 14, by = 1)) +
  scale_y_continuous(limits = c(0, 1200), breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),  # Add panel borders
    panel.grid.major = element_line(color = "gray80"),  # Use a minimal grid color
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("pop_sim_std.png",pop_sim_std, dpi = 300, width = 12, height = 7)
```

#### Analyse population level simulations dataset for standard dosing

```{r for optimised dosing, warning=FALSE}

library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")

# Read in sdtab_stand.txt file
sdtab_pop_std_10 <- read.table("sdtab_pop_std_10.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_pop_std_10[] <- lapply(sdtab_pop_std_10, as.numeric)

#eliminate all NAs
sdtab_pop_std_10 <- na.omit(sdtab_pop_std_10)

# Extract only the trough events
sdtab_pop_std_10_trough <- sdtab_pop_std_10[sdtab_pop_std_10$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_pop_std_10_trough <- sdtab_pop_std_10_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_pop_std_10_trough<- sdtab_pop_std_10_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_pop_std_10_trough$fAUC<- sdtab_pop_std_10_trough$AUC24*0.89

#Eliminate peak column
sdtab_pop_std_10_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY columns
PTA_pop_std_10 <- subset(sdtab_pop_std_10_trough, select = c("ID", "DV", "fAUC", "DAY"))

# Calculate percentage of DV >= 7.5 per DAY (PTA_Cmin_75)
PTA_pop_std_10$PTA_Cmin_75 <- 100 * ave(PTA_pop_std_10$DV >= 7.5, PTA_pop_std_10$DAY, FUN = mean)

# Calculate percentage of DV >= 80 per DAY (PTA_Cmin_80)
PTA_pop_std_10$PTA_Cmin_80 <- 100 * ave(PTA_pop_std_10$DV >= 80, PTA_pop_std_10$DAY, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY (PTA_fAUC_200)
PTA_pop_std_10$PTA_fAUC_200 <- 100 * ave(PTA_pop_std_10$fAUC >= 200, PTA_pop_std_10$DAY, FUN = mean)

# Create PTA_pop_std_10_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY
PTA_pop_std_10_overall <- unique(PTA_pop_std_10[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY")])
# PTA of Cmin 80 mg/L is very low actually!

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_pop_std_10_trough, "sdtab_pop_std_10_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_pop_std_10_overall, "PTA_pop_std_10_overall.csv",quote=F,row.names = FALSE)

```

```{r read those exported datasets again when R aborted, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
sdtab_pop_std_10_trough<-read.csv("sdtab_pop_std_10_trough.csv")

```

#### Box plot AUC over DAY

##### For optimised dosing

```{r read those exported datasets again when R aborted, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
sdtab_pop_10_trough<-read.csv("sdtab_pop_10_trough.csv")
library(dplyr)
pop_10_trough <-sdtab_pop_10_trough%>%select(ID, DAY, fAUC)

```

```{r boxplot optimised dosing}
library(ggplot2)

# Calculate the percentile
percentiles_opt <- pop_10_trough %>%
group_by(DAY) %>%
summarize(p5 = quantile(fAUC, 0.05),
p25 = quantile(fAUC, 0.25),
p50 = median(fAUC),
p75 = quantile(fAUC, 0.75),
p95 = quantile(fAUC, 0.95))

# box plot
pop_auc_opt <- ggplot(pop_10_trough, aes(x = factor(DAY), y = fAUC)) +
  geom_boxplot(fill = "steelblue", color = "#4E84C4", outlier.shape = NA, alpha = 0.6, coef = 0) +
  geom_segment(data = percentiles_opt, aes(x = factor(DAY), xend = factor(DAY), y = p5, yend = p25), color = "#4E84C4", size = 1) +
  geom_segment(data = percentiles_opt, aes(x = factor(DAY), xend = factor(DAY), y = p75, yend = p95), color = "#4E84C4", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50", size = 0.8) +
  ylab(expression(atop("Fluconazole area under the", "unbound concentration time curve (mgxh/L)"))) +
  xlab("DAY") +
  coord_cartesian(ylim = c(0, 1200)) +
  scale_y_continuous(breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# Save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("pop_auc_opt.png", pop_auc_opt, dpi = 300, width = 12, height = 7)

```

##### For standard dosing

```{r read those exported datasets again when R aborted, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
sdtab_pop_std_10_trough<-read.csv("sdtab_pop_std_10_trough.csv")
library(dplyr)
pop_std_10_trough <-sdtab_pop_std_10_trough%>%select(ID, DAY, fAUC)

```

```{r boxplot standard dosing}
library(ggplot2)

# Calculate the percentile
percentiles_std <- pop_std_10_trough %>%
group_by(DAY) %>%
summarize(p5 = quantile(fAUC, 0.05),
p25 = quantile(fAUC, 0.25),
p50 = median(fAUC),
p75 = quantile(fAUC, 0.75),
p95 = quantile(fAUC, 0.95))

# box plot
pop_auc_std <- ggplot(pop_std_10_trough, aes(x = factor(DAY), y = fAUC)) +
  geom_boxplot(fill = "steelblue", color = "#4E84C4", outlier.shape = NA, alpha = 0.6, coef = 0) +
  geom_segment(data = percentiles_std, aes(x = factor(DAY), xend = factor(DAY), y = p5, yend = p25), color = "#4E84C4", size = 1) +
  geom_segment(data = percentiles_std, aes(x = factor(DAY), xend = factor(DAY), y = p75, yend = p95), color = "#4E84C4", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50", size = 0.8) +
  ylab(expression(atop("Fluconazole area under the", "unbound concentration time curve (mgxh/L)"))) +
  xlab("DAY") +
  coord_cartesian(ylim = c(0, 1200)) +
  scale_y_continuous(breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

# Save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("pop_auc_std.png", pop_auc_std, dpi = 300, width = 12, height = 7)

```

#### Ribbon of optimised dosing - DV over TIME

```{r create a optimised dataset}

pop_10 <- sdtab_pop_10 %>% select(TIME,DV)

pop_10 <- pop_10[pop_10$DV != 0 | pop_10$TIME == 0, ]
        
data_summary_opt <- pop_10 %>%
  group_by(TIME) %>%
  summarize(median= median(DV),
            min= quantile(DV, 0.05),
            max= quantile(DV, 0.95),
            .groups = 'drop')

# Round the values to 2 decimal places
data_summary_opt <- data_summary_opt %>%
  mutate(across(everything(), ~ round(., 2)))

```

```{r ribbon plot opt dosing}

pop_sim_opt<-ggplot(data = data_summary_opt, aes(x = TIME/24, y = median)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "steelblue", alpha = 0.5) +
  geom_line(color = "#4E84C4", size = 1.2) +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray50",size=0.8) +
  xlab("DAY") +
  ylab("Fluconazole concentration (mg/L)") +
  scale_x_continuous(limits = c(0, 14), breaks = seq(0, 14, by = 1)) +
  #scale_y_continuous(limits = c(0, 1200), breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),  # Add panel borders
    panel.grid.major = element_line(color = "gray80"),  # Use a minimal grid color
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )
pop_sim_opt

# save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("DV_pop_opt.png",pop_sim_opt, dpi = 300, width = 12, height = 7)
```

#### Ribbon of standard dosing - DV over TIME

```{r create a standard dataset}

pop_std_10 <- sdtab_pop_std_10 %>% select(TIME,DV)

pop_std_10 <- pop_std_10[pop_std_10$DV != 0 | pop_std_10$TIME == 0, ]

        
data_summary_std <- pop_std_10 %>%
  group_by(TIME) %>%
  summarize(median= median(DV),
            min= quantile(DV, 0.05),
            max= quantile(DV, 0.95),
            .groups = 'drop')

# Round the values to 2 decimal places
data_summary_std <- data_summary_std %>%
  mutate(across(everything(), ~ round(., 2)))

```

```{r ribbon plot std dosing}

pop_sim_std<-ggplot(data = data_summary_std, aes(x = TIME/24, y = median)) +
  geom_ribbon(aes(ymin = min, ymax = max), fill = "steelblue", alpha = 0.5) +
  geom_line(color = "#4E84C4", size = 1.2) +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray50",size=0.8) +
  xlab("DAY") +
  ylab("Fluconazole concentration (mg/L)") +
  scale_x_continuous(limits = c(0, 14), breaks = seq(0, 14, by = 1)) +
  #scale_y_continuous(limits = c(0, 1200), breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    text = element_text(size = 18),
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),  # Add panel borders
    panel.grid.major = element_line(color = "gray80"),  # Use a minimal grid color
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )
pop_sim_std

# save the plot
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("DV_pop_std.png",pop_sim_std, dpi = 300, width = 12, height = 7)
```

#### Combining box plots & DV plots of standard and optimised dosing

```{r combining box plots & DV plots}
library(grid)
library(gridExtra)

# Combine pop_sim_opt and pop_auc_opt horizontally
combined_opt <- grid.arrange(pop_sim_opt, pop_auc_std, ncol = 2, top=textGrob("Optimised dosing regimen", gp = gpar(fontsize = 14, fontface = "bold")))

# Add annotation "(b)" on the top left corner
combined_opt <- grid.arrange(textGrob("(b)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 14)), combined_opt, ncol = 1, heights = c(0.05, 0.95))

# Combine pop_sim_std and pop_auc_std horizontally
combined_std <- grid.arrange(pop_sim_std, pop_auc_std, ncol = 2, top = textGrob("Standard dosing regimen", gp = gpar(fontsize = 14, fontface = "bold")))

# Add annotation "(a)" on the top left corner
combined_std <- grid.arrange(textGrob("(a)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 14)), combined_std, ncol = 1, heights = c(0.05, 0.95))

# Combine the two combined plots vertically
combined_plots <- grid.arrange(combined_std, combined_opt, ncol = 1)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
#ggsave("combined_auc&dv_plots.png", combined_plots, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)
ggsave("auc&dv_1406.png", combined_plots, dpi = 300, width = 22, height = 22, units = "cm", limitsize = FALSE)

# For my PAGE poster 100623
#setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/working documents/PAGE 2023/Poster/Plots")
#ggsave("combined_auc&dv_plots.png", combined_plots, dpi = 300, width = 26, height = 26.14, units = "cm", limitsize = FALSE)

#Adjust plot for defence slides 170623
left_title <- textGrob("Fluconazole area under the unbound concentration time curve (mgxh/L)",
                       gp = gpar(fontsize = 8))
left_title_rotated <- grobTree(left_title, vp = viewport(angle = 90))
library(grid)
library(gridExtra)
combined_plots <- grid.arrange(pop_auc_std, pop_auc_opt, ncol = 1,top=textGrob("Standard vs Optimised dosing regimen", gp = gpar(fontsize = 12, fontface = "bold")),left=left_title_rotated,bottom=textGrob("DAY", gp = gpar(fontsize = 9))) #reducing the top font size from 14 (as in manuscript) to 12 #170623
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("auc&dv_1706.png", combined_plots, dpi = 300, width = 11.22, height = 11.22, units = "cm", limitsize = FALSE)

# box plot std
pop_auc_std <- ggplot(pop_std_10_trough, aes(x = factor(DAY), y = fAUC)) +
  geom_boxplot(fill = "steelblue", color = "#4E84C4", outlier.shape = NA, alpha = 0.6, coef = 0) +
  geom_segment(data = percentiles, aes(x = factor(DAY), xend = factor(DAY), y = p5, yend = p25), color = "#4E84C4", size = 1) +
  geom_segment(data = percentiles, aes(x = factor(DAY), xend = factor(DAY), y = p75, yend = p95), color = "#4E84C4", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50", size = 0.8) +
  coord_cartesian(ylim = c(0, 1200)) +
  scale_y_continuous(breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "left",
    axis.title = element_blank(),
    axis.text = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7)
  )

# box plot opt
pop_auc_opt <- ggplot(pop_10_trough, aes(x = factor(DAY), y = fAUC)) +
  geom_boxplot(fill = "steelblue", color = "#4E84C4", outlier.shape = NA, alpha = 0.6, coef = 0) +
  geom_segment(data = percentiles_opt, aes(x = factor(DAY), xend = factor(DAY), y = p5, yend = p25), color = "#4E84C4", size = 1) +
  geom_segment(data = percentiles_opt, aes(x = factor(DAY), xend = factor(DAY), y = p75, yend = p95), color = "#4E84C4", size = 1) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "gray50", size = 0.8) +
  coord_cartesian(ylim = c(0, 1200)) +
  scale_y_continuous(breaks = seq(0, 1200, by = 100)) +
  theme_minimal() +
  theme(
    panel.border = element_rect(color = "gray80", fill = NA, size = 1),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "grey"),
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom",
    axis.title = element_blank(),
    axis.text = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7)
  )

```

#### ROC curves in sdtab_pop_10_trough and sdtab_pop_std_10_trough 

```{r for sdtab_pop_10_trough dataset}
### Nada's way


#####For recommended dosing

analysis <- sdtab_pop_10_trough %>% filter(DAY==1) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW <- pROC::roc(analysis$TA,
                           analysis$BW,
                           auc.polygon=F, max.auc.polygon=F,grid=F,
                           ci=T, boot.n=1000, ci.alpha=0.95, stratified=T,
                           plot=T, print.auc=T,print.auc.x=0.2,print.auc.y=0.3,
                           show.thres=T)

AUC_AUC_BW <-  pROC::auc(ROC_AUC_BW,conf.level=0.95, ci.alpha=0.95, method="bootstrap", boot.n=1000,stratified = T)
AUC_firstpart_AUC_BW  <- round(as.numeric(sub(".*(: *)","\\1",AUC_AUC_BW)),3)
CI_AUC_AUC_BW          <-  pROC::ci.auc(ROC_AUC_BW,conf.level=0.95, ci.alpha=0.95, method="bootstrap",boot.n=1000,stratified = T)
AUC_anotherpart_AUC_BW <- sub(".*(: *)","\\1",CI_AUC_AUC_BW)
AUC_secondpart_AUC_BW   <- as.numeric(substr(AUC_anotherpart_AUC_BW[1],1,5))
AUC_thirdpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[3],1,5))
AUC_label_AUC_BW <- paste0("AUC:",AUC_firstpart_AUC_BW,"(",AUC_secondpart_AUC_BW, "-",AUC_thirdpart_AUC_BW,")",sep="")

```

```{r for sdtab_pop_std_10_trough dataset}
### Nada's way

#####For standard  dosing

analysis1 <- sdtab_pop_std_10_trough %>% filter(DAY==1) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW1 <- pROC::roc(analysis1$TA,
                           analysis1$BW,
                           auc.polygon=F, max.auc.polygon=F,grid=F,
                           ci=T, boot.n=1000, ci.alpha=0.95, stratified=T,
                           plot=T, print.auc=T,print.auc.x=0.2,print.auc.y=0.3,
                           show.thres=T)

AUC_AUC_BW1 <-  pROC::auc(ROC_AUC_BW1,conf.level=0.95, ci.alpha=0.95, method="bootstrap", boot.n=1000,stratified = T)
AUC_firstpart_AUC_BW1  <- round(as.numeric(sub(".*(: *)","\\1",AUC_AUC_BW1)),3)
CI_AUC_AUC_BW1          <-  pROC::ci.auc(ROC_AUC_BW1,conf.level=0.95, ci.alpha=0.95, method="bootstrap",boot.n=1000,stratified = T)
AUC_anotherpart_AUC_BW1 <- sub(".*(: *)","\\1",CI_AUC_AUC_BW1)
AUC_secondpart_AUC_BW1   <- as.numeric(substr(AUC_anotherpart_AUC_BW1[1],1,5))
AUC_thirdpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[3],1,5))
AUC_label_AUC_BW1 <- paste0("AUC:",AUC_firstpart_AUC_BW1,"(",AUC_secondpart_AUC_BW1, "-",AUC_thirdpart_AUC_BW1,")",sep="")

```

##### Combining ROC curves

```{r combining 2 roc curves of DAY1}

library(ggplot2)

# For standard dosing
analysis1_DAY1 <- sdtab_pop_std_10_trough %>% filter(DAY == 1) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW1_DAY1 <- pROC::roc(analysis1_DAY1$TA,
                        analysis1_DAY1$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW1 <- pROC::auc(ROC_AUC_BW1_DAY1, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW1 <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW1)), 3)
CI_AUC_AUC_BW1 <- pROC::ci.auc(ROC_AUC_BW1_DAY1, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW1 <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW1)
AUC_secondpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[1], 1, 5))
AUC_thirdpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[3], 1, 5))
AUC_label_AUC_BW1_DAY1 <- paste0("AUC:", AUC_firstpart_AUC_BW1, "(", AUC_secondpart_AUC_BW1, "-", AUC_thirdpart_AUC_BW1, ")", sep = "")

# For recommended dosing
analysis_DAY1 <- sdtab_pop_10_trough %>% filter(DAY == 1) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW_DAY1 <- pROC::roc(analysis_DAY1$TA,
                        analysis_DAY1$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW <- pROC::auc(ROC_AUC_BW_DAY1, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW)), 3)
CI_AUC_AUC_BW <- pROC::ci.auc(ROC_AUC_BW_DAY1, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW)
AUC_secondpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[1], 1, 5))
AUC_thirdpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[3], 1, 5))
AUC_label_AUC_BW_DAY1 <- paste0("AUC:", AUC_firstpart_AUC_BW, "(", AUC_secondpart_AUC_BW, "-", AUC_thirdpart_AUC_BW, ")", sep = "")

# Convert roc objects to data frames
roc1_DAY1 <- pROC::coords(ROC_AUC_BW1_DAY1)
roc_DAY1 <- pROC::coords(ROC_AUC_BW_DAY1)

library(gridExtra)

# Create the plot with DAY 1 title
Plot_ROC_AUC_BW_DAY1 <- ggplot() +
  geom_line(data = roc1_DAY1, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY1, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1 - Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "right",
    legend.title = element_blank(),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY1, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY1, color = "steelblue") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))), linetype = "none") +
  ggtitle("DAY 1") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 1 title

# Create the annotation grob
annotation <- textGrob("(a)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))

# Combine the annotation and plot using grid.arrange
combined_plot_DAY1 <- grid.arrange(annotation, Plot_ROC_AUC_BW_DAY1, ncol = 1, heights = c(0.02, 0.98)) 

# Draw the combined plot
grid.draw(combined_plot_DAY1)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("roc_day1.png", combined_plot_DAY1, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)

```

```{r combining two ROC curves of DAY2}

library(ggplot2)

# For standard dosing - DAY 2
analysis1_DAY2 <- sdtab_pop_std_10_trough %>% filter(DAY == 2) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW1_DAY2 <- pROC::roc(analysis1_DAY2$TA,
                        analysis1_DAY2$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW1 <- pROC::auc(ROC_AUC_BW1_DAY2, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW1 <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW1)), 3)
CI_AUC_AUC_BW1 <- pROC::ci.auc(ROC_AUC_BW1_DAY2, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW1 <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW1)
AUC_secondpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[1], 1, 5))
AUC_thirdpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[3], 1, 5))
AUC_label_AUC_BW1_DAY2 <- paste0("AUC:", AUC_firstpart_AUC_BW1, "(", AUC_secondpart_AUC_BW1, "-", AUC_thirdpart_AUC_BW1, ")", sep = "")

# For recommended dosing - DAY 2
analysis_DAY2 <- sdtab_pop_10_trough %>% filter(DAY == 2) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW_DAY2 <- pROC::roc(analysis_DAY2$TA,
                        analysis_DAY2$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW <- pROC::auc(ROC_AUC_BW_DAY2, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW)), 3)
CI_AUC_AUC_BW <- pROC::ci.auc(ROC_AUC_BW_DAY2, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW)
AUC_secondpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[1], 1, 5))
AUC_thirdpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[3], 1, 5))
AUC_label_AUC_BW_DAY2 <- paste0("AUC:", AUC_firstpart_AUC_BW, "(", AUC_secondpart_AUC_BW, "-", AUC_thirdpart_AUC_BW, ")", sep = "")

# Convert roc objects to data frames
roc1_DAY2 <- pROC::coords(ROC_AUC_BW1_DAY2)
roc_DAY2 <- pROC::coords(ROC_AUC_BW_DAY2)

# Plot ROC curves - DAY 2
Plot_ROC_AUC_BW_DAY2 <- ggplot() +
  geom_line(data = roc1_DAY2, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY2, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1- Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "right",
    legend.title = element_blank(),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY2, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY2, color = "steelblue") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))), linetype = "none") +
ggtitle("DAY 2") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 2 title

# Create the annotation grob
annotation <- textGrob("(b)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))

# Combine the annotation and plot using grid.arrange
combined_plot_DAY2 <- grid.arrange(annotation, Plot_ROC_AUC_BW_DAY2, ncol = 1, heights = c(0.02, 0.98))

# Draw the combined plot
grid.draw(combined_plot_DAY2)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("roc_day2.png", combined_plot_DAY2, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)

```

```{r combining two ROC curves of DAY7}

library(ggplot2)

# For standard dosing - DAY 7
analysis1_DAY7 <- sdtab_pop_std_10_trough %>% filter(DAY == 7) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW1_DAY7 <- pROC::roc(analysis1_DAY7$TA,
                        analysis1_DAY7$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW1 <- pROC::auc(ROC_AUC_BW1_DAY7, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW1 <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW1)), 3)
CI_AUC_AUC_BW1 <- pROC::ci.auc(ROC_AUC_BW1_DAY7, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW1 <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW1)
AUC_secondpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[1], 1, 5))
AUC_thirdpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[3], 1, 5))
AUC_label_AUC_BW1_DAY7 <- paste0("AUC:", AUC_firstpart_AUC_BW1, "(", AUC_secondpart_AUC_BW1, "-", AUC_thirdpart_AUC_BW1, ")", sep = "")

# For recommended dosing - DAY 7
analysis_DAY7 <- sdtab_pop_10_trough %>% filter(DAY == 2) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW_DAY7 <- pROC::roc(analysis_DAY7$TA,
                        analysis_DAY7$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW <- pROC::auc(ROC_AUC_BW_DAY7, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW)), 3)
CI_AUC_AUC_BW <- pROC::ci.auc(ROC_AUC_BW_DAY7, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW)
AUC_secondpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[1], 1, 5))
AUC_thirdpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[3], 1, 5))
AUC_label_AUC_BW_DAY7 <- paste0("AUC:", AUC_firstpart_AUC_BW, "(", AUC_secondpart_AUC_BW, "-", AUC_thirdpart_AUC_BW, ")", sep = "")

# Convert roc objects to data frames
roc1_DAY7 <- pROC::coords(ROC_AUC_BW1_DAY7)
roc_DAY7 <- pROC::coords(ROC_AUC_BW_DAY7)

# Plot ROC curves - DAY 7
Plot_ROC_AUC_BW_DAY7 <- ggplot() +
  geom_line(data = roc1_DAY7, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY7, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1- Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "right",
    legend.title = element_blank(),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY7, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY7, color = "steelblue") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))), linetype = "none") +
        ggtitle("DAY 7") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 7 title

# Create the annotation grob
annotation <- textGrob("(c)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))

# Combine the annotation and plot using grid.arrange
combined_plot_DAY7 <- grid.arrange(annotation, Plot_ROC_AUC_BW_DAY7, ncol = 1, heights = c(0.02, 0.98))

# Draw the combined plot
grid.draw(combined_plot_DAY7)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("roc_day7.png", combined_plot_DAY7, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)


```

```{r combining two ROC curves of DAY14}

library(ggplot2)

# For standard dosing - DAY 14
analysis1_DAY14 <- sdtab_pop_std_10_trough %>% filter(DAY == 14) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW1_DAY14 <- pROC::roc(analysis1_DAY14$TA,
                        analysis1_DAY14$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW1 <- pROC::auc(ROC_AUC_BW1_DAY14, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW1 <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW1)), 3)
CI_AUC_AUC_BW1 <- pROC::ci.auc(ROC_AUC_BW1_DAY14, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW1 <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW1)
AUC_secondpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[1], 1, 5))
AUC_thirdpart_AUC_BW1 <- as.numeric(substr(AUC_anotherpart_AUC_BW1[3], 1, 5))
AUC_label_AUC_BW1_DAY14 <- paste0("AUC:", AUC_firstpart_AUC_BW1, "(", AUC_secondpart_AUC_BW1, "-", AUC_thirdpart_AUC_BW1, ")", sep = "")

# For recommended dosing - DAY 14
analysis_DAY14 <- sdtab_pop_10_trough %>% filter(DAY == 2) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))

ROC_AUC_BW_DAY14 <- pROC::roc(analysis_DAY14$TA,
                        analysis_DAY14$BW,
                        auc.polygon = FALSE, max.auc.polygon = FALSE, grid = FALSE,
                        ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE,
                        plot = FALSE, print.auc = TRUE, print.auc.x = 0.2, print.auc.y = 0.3,
                        show.thres = TRUE)

AUC_AUC_BW <- pROC::auc(ROC_AUC_BW_DAY14, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_firstpart_AUC_BW <- round(as.numeric(sub(".*(: *)", "\\1", AUC_AUC_BW)), 3)
CI_AUC_AUC_BW <- pROC::ci.auc(ROC_AUC_BW_DAY14, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
AUC_anotherpart_AUC_BW <- sub(".*(: *)", "\\1", CI_AUC_AUC_BW)
AUC_secondpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[1], 1, 5))
AUC_thirdpart_AUC_BW <- as.numeric(substr(AUC_anotherpart_AUC_BW[3], 1, 5))
AUC_label_AUC_BW_DAY14 <- paste0("AUC:", AUC_firstpart_AUC_BW, "(", AUC_secondpart_AUC_BW, "-", AUC_thirdpart_AUC_BW, ")", sep = "")

# Convert roc objects to data frames
roc1_DAY14 <- pROC::coords(ROC_AUC_BW1_DAY14)
roc_DAY14 <- pROC::coords(ROC_AUC_BW_DAY14)

# Plot ROC curves - DAY 14
Plot_ROC_AUC_BW_DAY14 <- ggplot() +
  geom_line(data = roc1_DAY14, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY14, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1- Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "right",
    legend.title = element_blank(),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY14, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY14, color = "steelblue") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))), linetype = "none") +
        ggtitle("DAY 14") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 14 title

# Create the annotation grob
annotation <- textGrob("(d)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))

# Combine the annotation and plot using grid.arrange
combined_plot_DAY14 <- grid.arrange(annotation, Plot_ROC_AUC_BW_DAY14, ncol = 1, heights = c(0.02, 0.98))

# Draw the combined plot
grid.draw(combined_plot_DAY14)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("roc_day14.png", combined_plot_DAY14, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)


```

```{r combining ROC curves day 1 2 7 14}
combined_plot_roc <- grid.arrange(combined_plot_DAY1, combined_plot_DAY2,combined_plot_DAY7,combined_plot_DAY14, ncol = 1)
# Draw the combined plot
grid.draw(combined_plot_roc)

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("combined_roc_plot.png", combined_plot_roc, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)

```

```{r draft code trying out suggestions by chatgpt}
library(gridExtra)
library(ggplot2)
library(grid)

# Create the plot with DAY 1 title
Plot_ROC_AUC_BW_DAY1 <- ggplot() +
  geom_line(data = roc1_DAY1, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY1, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1 - Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none",  # Hide legend initially
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY1, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY1, color = "steelblue") +
  ggtitle("DAY 1") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 1 title

# Create the plot with DAY 2 title
Plot_ROC_AUC_BW_DAY2 <- ggplot() +
  geom_line(data = roc1_DAY2, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY2, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1- Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none",  # Hide legend initially
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY2, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY2, color = "steelblue") +
  ggtitle("DAY 2") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 2 title

# Create the plot with DAY 7 title
Plot_ROC_AUC_BW_DAY7 <- ggplot() +
  geom_line(data = roc1_DAY7, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY7, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1 - Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none",  # Hide legend initially
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY7, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY7, color = "steelblue") +
  ggtitle("DAY 7") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 7 title

# Create the plot with DAY 14 title
Plot_ROC_AUC_BW_DAY14 <- ggplot() +
  geom_line(data = roc1_DAY14, aes(x = 1 - specificity, y = sensitivity, color = "Standard dosing regimen", linetype = "Standard dosing regimen"), size = 1) +
  geom_line(data = roc_DAY14, aes(x = 1 - specificity, y = sensitivity, color = "Optimised dosing regimen", linetype = "Optimised dosing regimen"), size = 1) +
  scale_color_manual(values = c("steelblue", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_minimal() +
  labs(y = "Sensitivity", x = "1 - Specificity") +
  theme(
    plot.title = element_text(hjust = 0.01, size = 12),
    text = element_text(size = 12),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none",  # Hide legend initially
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12)
  ) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color = "black", linetype = "solid") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.30, size = 4, label = AUC_label_AUC_BW1_DAY14, color = "orange") +
  annotate(geom = "text", x = 0.60, parse = TRUE, y = 0.10, size = 4, label = AUC_label_AUC_BW_DAY14, color = "steelblue") +
  ggtitle("DAY 14") + 
  theme(plot.title = element_text(hjust = 0.5, size = 14))  # Centered DAY 14 title

library(gridExtra)
library(grid)
library(ggplot2)

# Assuming you have defined the plots and annotations before this step

# Define the theme settings
custom_theme <- theme(
  plot.title = element_text(hjust = 0.01, size = 12),
  text = element_text(size = 12),
  panel.border = element_rect(color = "black", fill = NA, size = 1),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black"),
  legend.position = "none",  # Hide legend initially
  axis.title = element_text(size = 12),
  axis.text = element_text(size = 12),
  strip.text = element_text(size = 12)
)

# Combine the plots and annotations using grid.arrange
annotation_day1 <- textGrob("(a)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))
combined_plot_DAY1 <- grid.arrange(annotation_day1, Plot_ROC_AUC_BW_DAY1 + custom_theme, ncol = 1, heights = c(0.02, 0.98))

annotation_day2 <- textGrob("(b)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))
combined_plot_DAY2 <- grid.arrange(annotation_day2, Plot_ROC_AUC_BW_DAY2 + custom_theme, ncol = 1, heights = c(0.02, 0.98))

annotation_day7 <- textGrob("(c)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))
combined_plot_DAY7 <- grid.arrange(annotation_day7, Plot_ROC_AUC_BW_DAY7 + custom_theme, ncol = 1, heights = c(0.02, 0.98))

annotation_day14 <- textGrob("(d)", x = 0, y = 0.2, just = c("left", "top"), gp = gpar(fontsize = 14))
combined_plot_DAY14 <- grid.arrange(annotation_day14, Plot_ROC_AUC_BW_DAY14 + custom_theme, ncol = 1, heights = c(0.02, 0.98))

# Combine all plots using grid.arrange
combined_plot_roc <- grid.arrange(combined_plot_DAY1, combined_plot_DAY2, combined_plot_DAY7, combined_plot_DAY14, ncol = 1)

# Add the legend and adjust theme settings
combined_plot_roc <- combined_plot_roc +
  theme(legend.position = "right") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))), linetype = "none")

# Draw the combined plot
grid.draw(combined_plot_roc)

```

```{r combine 4 ROC plots}
library(patchwork)

# Create titles and annotations
title_day1 <- ggtitle("DAY 1") + theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
annotation_day1 <- annotate("text", x = 0.05, y = 0.95, label = "(a)", size = 12, hjust = 0, vjust = 1)

title_day2 <- ggtitle("DAY 2") + theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
annotation_day2 <- annotate("text", x = 0.05, y = 0.95, label = "(b)", size = 12, hjust = 0, vjust = 1)

title_day7 <- ggtitle("DAY 7") + theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
annotation_day7 <- annotate("text", x = 0.05, y = 0.95, label = "(c)", size = 12, hjust = 0, vjust = 1)

title_day14 <- ggtitle("DAY 14") + theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
annotation_day14 <- annotate("text", x = 0.05, y = 0.95, label = "(d)", size = 12, hjust = 0, vjust = 1)

# Add titles and annotations to each plot
Plot_ROC_AUC_BW_DAY1 <- Plot_ROC_AUC_BW_DAY1 + title_day1 + annotation_day1
Plot_ROC_AUC_BW_DAY2 <- Plot_ROC_AUC_BW_DAY2 + title_day2 + annotation_day2
Plot_ROC_AUC_BW_DAY7 <- Plot_ROC_AUC_BW_DAY7 + title_day7 + annotation_day7
Plot_ROC_AUC_BW_DAY14 <- Plot_ROC_AUC_BW_DAY14 + title_day14 + annotation_day14

# Combine the plots vertically
combined_roc_plot <- Plot_ROC_AUC_BW_DAY1 / Plot_ROC_AUC_BW_DAY2 / Plot_ROC_AUC_BW_DAY7 / Plot_ROC_AUC_BW_DAY14

# Save the combined plot
ggsave("combined_roc_plot.png", combined_roc_plot, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)


```


```{r shorter code by chatGPT}
library(pROC)
library(ggplot2)

# Function to calculate AUC and create AUC label
calculate_auc <- function(data) {
  roc_obj <- roc(data$TA, data$BW, ci = TRUE, boot.n = 1000, ci.alpha = 0.95, stratified = TRUE)
  auc <- auc(roc_obj)
  ci_auc <- ci.auc(roc_obj, conf.level = 0.95, ci.alpha = 0.95, method = "bootstrap", boot.n = 1000, stratified = TRUE)
  
  auc_label <- paste0("AUC:", round(auc, 3), " (", round(ci_auc[1], 3), "-", round(ci_auc[3], 3), ")")
  
  return(list(auc_obj = roc_obj, auc_label = auc_label))
}

# Function to plot ROC curve
plot_roc <- function(roc_obj, auc_label) {
  roc_plot <- ggroc(roc_obj, alpha = 0.5, colour = "red", linetype = "solid", size = 1) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.01, size = 15),
      text = element_text(size = 15),
      panel.border = element_rect(color = "black", fill = NA, size = 1),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      legend.position = "none",
      legend.title = element_blank(),
      legend.text = element_text(size = 15)
    ) +
    labs(y = "Sensitivity", x = "Specificity") +
    geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color = "grey", linetype = "solid") +
    annotate(geom = "text", x = 0.4, parse = TRUE, y = 0.2, size = 5.5, label = auc_label)
  
  return(roc_plot)
}

# Filter data for DAY 1 and calculate AUC
analysis1 <- sdtab_pop_std_10_trough %>% filter(DAY == 1) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))
auc_results1 <- calculate_auc(analysis1)

# Plot ROC curve for DAY 1
plt_roc1 <- plot_roc(auc_results1$auc_obj, auc_results1$auc_label)
print(plt_roc1)

# Repeat for DAY 2, 7, and 14
analysis2 <- sdtab_pop_std_10_trough %>% filter(DAY == 2) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))
auc_results2 <- calculate_auc(analysis2)
plt_roc2 <- plot_roc(auc_results2$auc_obj, auc_results2$auc_label)
print(plt_roc2)

analysis7 <- sdtab_pop_std_10_trough %>% filter(DAY == 7) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))
auc_results7 <- calculate_auc(analysis7)
plt_roc7 <- plot_roc(auc_results7$auc_obj, auc_results7$auc_label)
print(plt_roc7)

analysis14 <- sdtab_pop_std_10_trough %>% filter(DAY == 14) %>% mutate(TA = ifelse(fAUC >= 200, 1, 0))
auc_results14 <- calculate_auc(analysis14)
plt_roc14 <- plot_roc(auc_results14$auc_obj, auc_results14$auc_label)
print(plt_roc14)

```

#### PTA fAUC200 of two optimized dosing 28 and 29 - 020623

```{r read in PTA_overall dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
PTA_overall<-read.csv("PTA_overall.csv")

```

```{r PTA fAUC 200 mgxh/L day 1 CRRT patients optimised regimen}

library(ggplot2)
library(dplyr)
PTA_OPT200_DAY1<- PTA_overall %>%
  filter(DAY == 1, BW<150,Regimen %in% c(29,30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29,30))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("blue","orange"),name = "Dosing regimen",
                     labels = c("CRRT patients:\n- Loading dose (day 1): 1000 mg q24h if BW<=55kg - 1200 mg q24h if 55kg<BW<=80kg - 1400 mg q24h if 80kg<BW<=100kg - 1600 mg q24h if 100kg<BW<=120kg - 1800 mg if 120<BW<=145kg\n- Maintenance dose: 800 mg q24h",
      "Non-CRRT patients:\n- Loading dose (day 1): 800 mg q24h if BW<=50kg - 1000 mg q24h if 55kg<BW<=75kg - 1200 mg q24h if 75kg<BW<=95kg - 1400 mg q24h if 95kg<BW<=115kg - 1600 mg if 115<BW<=145kg\n- Maintenance dose: 400 mg q24h")) +
                scale_shape_manual(values = c(17, 5),name = "Dosing regimen",
                     labels = c("CRRT patients:\n- Loading dose (day 1): 1000 mg q24h if BW<=55kg - 1200 mg q24h if 55kg<BW<=80kg - 1400 mg q24h if 80kg<BW<=100kg - 1600 mg q24h if 100kg<BW<=120kg - 1800 mg if 120<BW<=145kg\n- Maintenance dose: 800 mg q24h",
      "Non-CRRT patients:\n- Loading dose (day 1): 800 mg q24h if BW<=50kg - 1000 mg q24h if 55kg<BW<=75kg - 1200 mg q24h if 75kg<BW<=95kg - 1400 mg q24h if 95kg<BW<=115kg - 1600 mg if 115<BW<=145kg\n- Maintenance dose: 400 mg q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "bottom") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_OPT200_DAY1 

library(ggplot2)
library(dplyr)

PTA_OPT200_day1 <- PTA_overall %>%
  filter(DAY == 1, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(
    values = c("blue", "orange"),
    name = "Dosing regimen",
    labels = c(
      "CRRT patients:\nLoading dose (day 1): 1000 mg q24h if BW<=55kg - 1200 mg q24h if 55kg<BW<=80kg - \n1400 mg q24h if 80kg<BW<=100kg - 1600 mg q24h if 100kg<BW<=120kg - 1800 mg if 120<BW<=145kg\nMaintenance dose: 800 mg q24h",
      "Non-CRRT patients:\nLoading dose (day 1): 800 mg q24h if BW<=50kg - 1000 mg q24h if 55kg<BW<=75kg - \n1200 mg q24h if 75kg<BW<=95kg - 1400 mg q24h if 95kg<BW<=115kg - 1600 mg if 115<BW<=145kg\nMaintenance dose: 400 mg q24h"
    )
  ) +
  scale_shape_manual(
    values = c(17, 5),
    name = "Dosing regimen",
    labels = c(
      "CRRT patients:\nLoading dose (day 1): 1000 mg q24h if BW<=55kg - 1200 mg q24h if 55kg<BW<=80kg - \n1400 mg q24h if 80kg<BW<=100kg - 1600 mg q24h if 100kg<BW<=120kg - 1800 mg if 120<BW<=145kg\nMaintenance dose: 800 mg q24h",
      "Non-CRRT patients:\nLoading dose (day 1): 800 mg q24h if BW<=50kg - 1000 mg q24h if 55kg<BW<=75kg - \n1200 mg q24h if 75kg<BW<=95kg - 1400 mg q24h if 95kg<BW<=115kg - 1600 mg if 115<BW<=145kg\nMaintenance dose: 400 mg q24h"
    )
  ) +
  scale_x_continuous(
    limits = c(30, 145),
    breaks = seq(30, 145, by = 5),
    name = "Body Weight (kg)",
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, by = 5),
    name = "Probability (%)",
    expand = c(0, 0)
  ) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 1") +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    legend.title = element_text(size = 8),
    axis.text = element_text(size = 9),
    legend.text = element_text(size = 7),  # Adjust the font size
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    legend.key.width = unit(1.5, "cm")  # Adjust the legend width
  ) +
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1) +
  guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))

PTA_OPT200_day1






```

##### ChatGPT generated code

```{r for fAUC200}
# PTA_OPT200_DAY1
PTA_OPT200_DAY1 <- PTA_overall %>%
  filter(DAY == 1, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 1") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT200_DAY2
PTA_OPT200_DAY2 <- PTA_overall %>%
  filter(DAY == 2, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 2") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT200_DAY7
PTA_OPT200_DAY7 <- PTA_overall %>%
  filter(DAY == 7, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 7") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT200_DAY14
PTA_OPT200_DAY14 <- PTA_overall %>%
  filter(DAY == 14, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 14") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

```

```{r for Cmin80}
library(dplyr)
library(ggplot2)
# PTA_OPT80_DAY1
PTA_OPT80_DAY1 <- PTA_overall %>%
  filter(DAY == 1, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 1") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT80_DAY2
PTA_OPT80_DAY2 <- PTA_overall %>%
  filter(DAY == 2, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 2") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT80_DAY7
PTA_OPT80_DAY7 <- PTA_overall %>%
  filter(DAY == 7, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 7") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) + 
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#theme(axis.title.x = element_blank(),axis.title.y = element_blank()) +

# PTA_OPT80_DAY14
PTA_OPT80_DAY14 <- PTA_overall %>%
  filter(DAY == 14, BW < 150, Regimen %in% c(29, 30)) %>%
  mutate(Regimen = factor(Regimen, levels = c(29, 30))) %>%
  ggplot() +
  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)), size = 1) +
  geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) +
  scale_color_manual(values = c("blue", "orange")) +
  scale_shape_manual(values = c(17, 5)) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  ggtitle("Day 14") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 9),
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank()
  ) +
  geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 1)
#+ theme(axis.title.x = element_blank(),axis.title.y = element_blank()) 

```

```{r combining fAUC200}

# Combine PTA_OPT200_DAY1, PTA_OPT200_DAY2, PTA_OPT200_DAY7, and PTA_OPT200_DAY14
combined_PTA_OPT200 <- grid.arrange(
  PTA_OPT200_DAY1, PTA_OPT200_DAY2,
  PTA_OPT200_DAY7, PTA_OPT200_DAY14,
  nrow = 2, ncol = 2,
  top = textGrob("Probability of target Attainment of fAUC 200 mgxh/L", gp = gpar(fontsize = 12, fontface = "bold")),
  left = textGrob("(a)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 12)),
  bottom = get_legend(PTA_OPT200_day1)
)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("combined_PTA_OPT200.png", combined_PTA_OPT200, dpi = 300, width = 29.7, height = 19, units = "cm", limitsize = FALSE)

```

```{r combining Cmin80, warning=FALSE}
# Loading the gridExtra package
library(gridExtra)

# Combine PTA_OPT80_DAY1, PTA_OPT80_DAY2, PTA_OPT80_DAY7, and PTA_OPT80_DAY14
combined_PTA_OPT80 <- grid.arrange(
  PTA_OPT80_DAY1, PTA_OPT80_DAY2,
  PTA_OPT80_DAY7, PTA_OPT80_DAY14,
  nrow = 2, ncol = 2,
  top = textGrob("Probability of reaching toxicity threshold of Cmin 80 mg/L", gp = gpar(fontsize = 12, fontface = "bold")),
  left = textGrob("(b)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 12)),
  bottom = get_legend(PTA_OPT200_day1)
)

grid.draw(combined_PTA_OPT80)

# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("combined_PTA_OPT80.png", combined_PTA_OPT80, dpi = 300, width = 29.7, height = 17.5, units = "cm", limitsize = FALSE)


```

```{r combining these combined Cmin & fAUC plots, warning=FALSE}
# Combine the two plots vertically
final_combined <- grid.arrange(
  combined_PTA_OPT200,
  combined_PTA_OPT80,
  nrow = 2,
  heights = c(0.5, 0.5),
  bottom = get_legend(PTA_OPT200_day1)  # Include the legend from PTA_OPT200_day1
)
# Save the combined plots
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("final_combined.png", final_combined, dpi = 300, width = 21, height = 27, units = "cm", limitsize = FALSE)

```


###### End of chat gpt generated code

#### Plots for optimised dosing regimens 250523

##### Firstly, for PTA 200

```{r adjust 12 plots of PTA fAUC200 optimised dosing}
PTA_CRRT200_DAY1_optimised_nolegend<-PTA_CRRT200_DAY1_optimised+guides(color = "none")+ theme(axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 1") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT200_DAY1_optimised_nolegend<-PTA_NOCRRT200_DAY1_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 1") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT200_DAY2_optimised_nolegend<-PTA_CRRT200_DAY2_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 2") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT200_DAY2_optimised_nolegend<-PTA_NOCRRT200_DAY2_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 2") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT200_DAY7_optimised_nolegend<-PTA_CRRT200_DAY7_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 7") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT200_DAY7_optimised_nolegend<-PTA_NOCRRT200_DAY7_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 7") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT200_DAY14_optimised_nolegend<-PTA_CRRT200_DAY14_optimised+ theme(
        axis.text = element_text(size = 7),legend.text = element_text(size = 7), legend.title = element_text(size = 9)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 14") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT200_DAY14_optimised_nolegend<-PTA_NOCRRT200_DAY14_optimised+ theme(
        axis.text = element_text(size = 7),legend.text = element_text(size = 7), legend.title = element_text(size = 9)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 14") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))
          
```

```{r save 12 PTA plots of optimised dosing,warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
# Create a list of plot objects
plot_fAUC200_01 <- list(PTA_CRRT200_DAY1_optimised_nolegend, PTA_NOCRRT200_DAY1_optimised_nolegend,PTA_CRRT200_DAY2_optimised_nolegend, PTA_NOCRRT200_DAY2_optimised_nolegend,PTA_CRRT200_DAY7_optimised_nolegend, PTA_NOCRRT200_DAY7_optimised_nolegend)

# Define the file names
file_fAUC200_01 <- c("PTA_CRRT200_DAY1_optimised_nolegend.png","PTA_NOCRRT200_DAY1_optimised_nolegend.png","PTA_CRRT200_DAY2_optimised_nolegend.png","PTA_NOCRRT200_DAY2_optimised_nolegend.png","PTA_CRRT200_DAY7_optimised_nolegend.png","PTA_NOCRRT200_DAY7_optimised_nolegend.png")


plot_fAUC200_02 <- list(PTA_CRRT200_DAY14_optimised_nolegend,PTA_NOCRRT200_DAY14_optimised_nolegend)

file_fAUC200_02 <- c("PTA_CRRT200_DAY14_optimised_nolegend.png","PTA_NOCRRT200_DAY14_optimised_nolegend.png")

# Loop through the plot objects and save them as separate files
for (i in seq_along(plot_fAUC200_01)) {
  ggsave(file_fAUC200_01[i], plot = plot_fAUC200_01[[i]], dpi = 300, width = 2.7, height = 6)
}

for (i in seq_along(plot_fAUC200_02)) {
  ggsave(file_fAUC200_02[i], plot = plot_fAUC200_02[[i]], dpi = 300, width = 5.2, height = 6)
}

```

##### Secondly, for Cmin 80

```{r adjust 12 plots of PTA Cmin80 optimised dosing}
PTA_CRRT80_DAY1_optimised_nolegend<-PTA_CRRT80_DAY1_optimised+guides(color = "none")+ theme(axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 1") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT80_DAY1_optimised_nolegend<-PTA_NOCRRT80_DAY1_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 1") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT80_DAY2_optimised_nolegend<-PTA_CRRT80_DAY2_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 2") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT80_DAY2_optimised_nolegend<-PTA_NOCRRT80_DAY2_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 2") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT80_DAY7_optimised_nolegend<-PTA_CRRT80_DAY7_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 7") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT80_DAY7_optimised_nolegend<-PTA_NOCRRT80_DAY7_optimised+guides(color = "none")+ theme(
        axis.text = element_text(size = 7)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 7") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_CRRT80_DAY14_optimised_nolegend<-PTA_CRRT80_DAY14_optimised+ theme(
        axis.text = element_text(size = 7),legend.text = element_text(size = 7), legend.title = element_text(size = 9)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 14") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))

PTA_NOCRRT80_DAY14_optimised_nolegend<-PTA_NOCRRT80_DAY14_optimised + theme(
        axis.text = element_text(size = 7),legend.text = element_text(size = 7), legend.title = element_text(size = 9)) + theme(axis.title.x = element_blank(), 
                                                           axis.title.y = element_blank()) + ggtitle("DAY 14") +
    theme(plot.title = element_text(hjust = 0.5, size = 12,face="bold")) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))
          
```

```{r save 12 PTA plots of optimised dosing,warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
# Create a list of plot objects
plot_Cmin80_01 <- list(PTA_CRRT80_DAY1_optimised_nolegend, PTA_NOCRRT80_DAY1_optimised_nolegend,
                   PTA_CRRT80_DAY2_optimised_nolegend, PTA_NOCRRT80_DAY2_optimised_nolegend,PTA_CRRT80_DAY7_optimised_nolegend, PTA_NOCRRT80_DAY7_optimised_nolegend)

# Define the file names
file_Cmin80_01 <- c("PTA_CRRT80_DAY1_optimised_nolegend.png","PTA_NOCRRT80_DAY1_optimised_nolegend.png","PTA_CRRT80_DAY2_optimised_nolegend.png","PTA_NOCRRT80_DAY2_optimised_nolegend.png","PTA_CRRT80_DAY7_optimised_nolegend.png","PTA_NOCRRT80_DAY7_optimised_nolegend.png")


plot_Cmin80_02 <- list(PTA_CRRT80_DAY14_optimised_nolegend,PTA_NOCRRT80_DAY14_optimised_nolegend)

file_Cmin80_02 <- c("PTA_CRRT80_DAY14_optimised_nolegend.png","PTA_NOCRRT80_DAY14_optimised_nolegend.png")

# Loop through the plot objects and save them as separate files
for (i in seq_along(plot_Cmin80_01)) {
  ggsave(file_Cmin80_01[i], plot = plot_Cmin80_01[[i]], dpi = 300, width = 2.7, height = 6)
}

for (i in seq_along(plot_Cmin80_02)) {
  ggsave(file_Cmin80_02[i], plot = plot_Cmin80_02[[i]], dpi = 300, width = 5.5, height = 6)
}
```

#### Draft code (shorten version of the above code)

```{r}
# Function to adjust the plot
adjust_plot <- function(plot, title) {
  adjusted_plot <- plot + guides(color = "none") +
    theme(axis.text = element_text(size = 7),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
    ggtitle(title) +
    scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))
  
  return(adjusted_plot)
}

# Function to save the plots
save_plots <- function(plot_list, file_list) {
  for (i in seq_along(plot_list)) {
    ggsave(file_list[i], plot = plot_list[[i]], dpi = 300, width = 2.7, height = 6)
  }
}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")

# PTA fAUC200 plots
PTA_CRRT200_DAY1_optimised_nolegend <- adjust_plot(PTA_CRRT200_DAY1_optimised, "DAY 1")
PTA_NOCRRT200_DAY1_optimised_nolegend <- adjust_plot(PTA_NOCRRT200_DAY1_optimised, "DAY 1")
PTA_CRRT200_DAY2_optimised_nolegend <- adjust_plot(PTA_CRRT200_DAY2_optimised, "DAY 2")
PTA_NOCRRT200_DAY2_optimised_nolegend <- adjust_plot(PTA_NOCRRT200_DAY2_optimised, "DAY 2")
PTA_CRRT200_DAY7_optimised_nolegend <- adjust_plot(PTA_CRRT200_DAY7_optimised, "DAY 7")
PTA_NOCRRT200_DAY

```

```{r}
library(ggplot2)

# Function to create the plot objects
create_plot <- function(data, title) {
  plot <- data + guides(color = "none") + theme(
    axis.text = element_text(size = 7),
    axis.title = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) + ggtitle(title) + scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10))
  return(plot)
}

# Function to save the plots
save_plots <- function(plot_list, file_names) {
  for (i in seq_along(plot_list)) {
    ggsave(file_names[i], plot = plot_list[[i]], dpi = 300, width = 2.7, height = 6)
  }
}

# Set the working directory
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")

# PTA fAUC200 plots
plot_fAUC200_01 <- list(
  create_plot(PTA_CRRT200_DAY1_optimised, "DAY 1"),
  create_plot(PTA_NOCRRT200_DAY1_optimised, "DAY 1"),
  create_plot(PTA_CRRT200_DAY2_optimised, "DAY 2"),
  create_plot(PTA_NOCRRT200_DAY2_optimised, "DAY 2"),
  create_plot(PTA_CRRT200_DAY7_optimised, "DAY 7"),
  create_plot(PTA_NOCRRT200_DAY7_optimised, "DAY 7")
)

file_fAUC200_01 <- c(
  "PTA_CRRT200_DAY1_optimised_nolegend.png",
  "PTA_NOCRRT200_DAY1_optimised_nolegend.png",
  "PTA_CRRT200_DAY2_optimised_nolegend.png",
  "PTA_NOCRRT200_DAY2_optimised_nolegend.png",
  "PTA_CRRT200_DAY7_optimised_nolegend.png",
  "PTA_NOCRRT200_DAY7_optimised_nolegend.png"
)

plot_fAUC200_02 <- list(
  create_plot(PTA_CRRT200_DAY14_optimised, "DAY 14"),
  create_plot(PTA_NOCRRT200_DAY14_optimised, "DAY 14")
)

file_fAUC200_02 <- c(
  "PTA_CRRT200_DAY14_optimised_nolegend.png",
  "PTA_NOCRRT200_DAY14_optimised_nolegend.png"
)

# Save PTA fAUC200 plots
save_plots(plot_fAUC200_01, file_fAUC200_01)
save_plots(plot_fAUC200_02, file_fAUC200_02)

# PTA Cmin80 plots


```

#### Box plot containing 5th & 95th percentile

```{r}
library(ggplot2)

# Calculate the 5th and 95th percentiles
percentiles <- quantile(PTA_overall$PTA_fAUC_200, probs = c(0.05, 0.95))

# Plot boxplots
ggplot(PTA_overall, aes(x = factor(DAY), y = PTA_fAUC_200)) +
  geom_boxplot(outlier.shape = NA) +
  geom_errorbar(aes(ymin = percentiles[1], ymax = percentiles[2]), width = 0.5) +
  scale_y_continuous(name = "PTA_fAUC_200", limits = c(0, 100),breaks = seq(0, 100, by = 5)) +
  labs(x = "DAY") +
  theme_minimal()

```

#### Check BW distribution of my original dataset to see the value of the optimised dosing

```{r read in the original source dataset,warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean<-read.csv("FlucTotIV_clean.csv")

```

```{r creat CRRT2 variable}
# CRRT2 indicates whether a patient has at least one time on CRRT
library(dplyr)
crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"]) #IDs of the patients who have CRRT
FlucTotIV_clean$CRRT2 <- ifelse(FlucTotIV_clean$ID %in% crrt_patients, 1, 0)
FlucTotIV_clean$CRRT2 <- as.factor(FlucTotIV_clean$CRRT2)

```

```{r extract unique BW}
library(dplyr)
test <- FlucTotIV_clean %>% ungroup() %>% select(ID, BW2,CRRT2) %>% unique()
test<-na.omit(test)

```

```{r calculate the percentage of BW2 within certain range}
# Subset the test dataset based on BW2 ranges
subset_bw2_55 <- test[test$BW2 <= 55, ]
subset_bw2_55_80 <- test[test$BW2 > 55 & test$BW2 <= 80, ]
subset_bw2_80_100 <- test[test$BW2 > 80 & test$BW2 <= 100, ]
subset_bw2_100_120 <- test[test$BW2 > 100 & test$BW2 <= 120, ]
subset_bw2_120 <- test[test$BW2 > 120, ]

# Calculate the counts of patient IDs in each BW2 range
count_bw2_55 <- length(unique(subset_bw2_55$ID))
count_bw2_55_80 <- length(unique(subset_bw2_55_80$ID))
count_bw2_80_100 <- length(unique(subset_bw2_80_100$ID))
count_bw2_100_120 <- length(unique(subset_bw2_100_120$ID))
count_bw2_120 <- length(unique(subset_bw2_120$ID))

# Calculate the percentages for each BW2 range
total_patients <- length(unique(test$ID))
percentage_bw2_55 <- count_bw2_55 / total_patients * 100
percentage_bw2_55_80 <- count_bw2_55_80 / total_patients * 100
percentage_bw2_80_100 <- count_bw2_80_100 / total_patients * 100
percentage_bw2_100_120 <- count_bw2_100_120 / total_patients * 100
percentage_bw2_120 <- count_bw2_120 / total_patients * 100 #only 5 patients weight more than 120kg

# Print the results
cat("Percentage of patient IDs with BW2 <= 55:", percentage_bw2_55, "%\n")
cat("Percentage of patient IDs with 55 < BW2 <= 80:", percentage_bw2_55_80, "%\n")
cat("Percentage of patient IDs with 80 < BW2 <= 100:", percentage_bw2_80_100, "%\n")
cat("Percentage of patient IDs with 100 < BW2 <= 120:", percentage_bw2_100_120, "%\n")
cat("Percentage of patient IDs with BW2 > 120:", percentage_bw2_120, "%\n")

```

```{r % of CRRT patients within a BW range}
# Subset the "test" dataset based on CRRT == 1
subset_crrt_1 <- test[test$CRRT2 == 1, ]

# Subset the resulting dataset based on BW2 ranges
subset_bw2_55 <- subset_crrt_1[subset_crrt_1$BW2 <= 55, ]
subset_bw2_55_80 <- subset_crrt_1[subset_crrt_1$BW2 > 55 & subset_crrt_1$BW2 <= 80, ]
subset_bw2_80_100 <- subset_crrt_1[subset_crrt_1$BW2 > 80 & subset_crrt_1$BW2 <= 100, ]
subset_bw2_100_120 <- subset_crrt_1[subset_crrt_1$BW2 > 100 & subset_crrt_1$BW2 <= 120, ]
subset_bw2_120 <- subset_crrt_1[subset_crrt_1$BW2 > 120, ]

# Calculate the counts of patient IDs in each BW2 range
count_bw2_55 <- length(unique(subset_bw2_55$ID))
count_bw2_55_80 <- length(unique(subset_bw2_55_80$ID))
count_bw2_80_100 <- length(unique(subset_bw2_80_100$ID))
count_bw2_100_120 <- length(unique(subset_bw2_100_120$ID))
count_bw2_120 <- length(unique(subset_bw2_120$ID))

# Calculate the percentages for each BW2 range
total_patients_crrt_1 <- length(unique(subset_crrt_1$ID))
percentage_bw2_55 <- count_bw2_55 / total_patients_crrt_1 * 100
percentage_bw2_55_80 <- count_bw2_55_80 / total_patients_crrt_1 * 100
percentage_bw2_80_100 <- count_bw2_80_100 / total_patients_crrt_1 * 100
percentage_bw2_100_120 <- count_bw2_100_120 / total_patients_crrt_1 * 100
percentage_bw2_120 <- count_bw2_120 / total_patients_crrt_1 * 100

# Print the results
cat("Percentage of patient IDs with CRRT == 1 and BW2 <= 55:", percentage_bw2_55, "%\n")
cat("Percentage of patient IDs with CRRT == 1 and 55 < BW2 <= 80:", percentage_bw2_55_80, "%\n")
cat("Percentage of patient IDs with CRRT == 1 and 80 < BW2 <= 100:", percentage_bw2_80_100, "%\n")
cat("Percentage of patient IDs with CRRT == 1 and 100 < BW2 <= 120:", percentage_bw2_100_120, "%\n")
cat("Percentage of patient IDs with CRRT == 1 and BW2 > 120:", percentage_bw2_120, "%\n")

```

```{r % of non-CRRT patients within a BW range}

# Subset the "test" dataset based on CRRT == 0
subset_crrt_0 <- test[test$CRRT2 == 0, ]

# Subset the resulting dataset based on BW2 ranges
subset_bw2_55 <- subset_crrt_0[subset_crrt_0$BW2 <= 55, ]
subset_bw2_55_75 <- subset_crrt_0[subset_crrt_0$BW2 > 55 & subset_crrt_0$BW2 <= 75, ]
subset_bw2_75_100 <- subset_crrt_0[subset_crrt_0$BW2 > 75 & subset_crrt_0$BW2 <= 100, ]
subset_bw2_100_115 <- subset_crrt_0[subset_crrt_0$BW2 > 100 & subset_crrt_0$BW2 <= 115, ]
subset_bw2_115 <- subset_crrt_0[subset_crrt_0$BW2 > 115, ]

# Calculate the counts of patient IDs in each BW2 range
count_bw2_55 <- length(unique(subset_bw2_55$ID))
count_bw2_55_75 <- length(unique(subset_bw2_55_75$ID))
count_bw2_75_100 <- length(unique(subset_bw2_75_100$ID))
count_bw2_100_115 <- length(unique(subset_bw2_100_115$ID))
count_bw2_115 <- length(unique(subset_bw2_115$ID))

# Calculate the percentages for each BW2 range
total_patients_crrt_0 <- length(unique(subset_crrt_0$ID))
percentage_bw2_55 <- count_bw2_55 / total_patients_crrt_0 * 100
percentage_bw2_55_75 <- count_bw2_55_75 / total_patients_crrt_0 * 100
percentage_bw2_75_100 <- count_bw2_75_100 / total_patients_crrt_0 * 100
percentage_bw2_100_115 <- count_bw2_100_115 / total_patients_crrt_0 * 100
percentage_bw2_115 <- count_bw2_115 / total_patients_crrt_0 * 100

# Print the results
cat("Percentage of patient IDs with CRRT == 0 and BW2 <= 55:", percentage_bw2_55, "%\n")
cat("Percentage of patient IDs with CRRT == 0 and 55 < BW2 <= 75:", percentage_bw2_55_75, "%\n")
cat("Percentage of patient IDs with CRRT == 0 and 75 < BW2 <= 100:", percentage_bw2_75_100, "%\n")
cat("Percentage of patient IDs with CRRT == 0 and 100 < BW2 <= 115:", percentage_bw2_100_115, "%\n")
cat("Percentage of patient IDs with CRRT == 0 and BW2 > 115:", percentage_bw2_115, "%\n")

```

#### Creating more dataset used for simulations (continue from Flucconazole120423.Rmd file)

##### Dosing 22, 1400 mg loading dose, 800 mg maitenance dose for CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_22<-read.csv("dosing_08.csv")

library(dplyr)

# Replace AMT with 1400 for AMT == 1200
dosing_22$AMT[dosing_22$AMT == 1200] <- 1400

# Eliminate rows where PEAK == 1
dosing_22 <- subset(dosing_22, PEAK != 1)

```

```{r export dosing 22 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_22,"dosing_22.csv",quote=F,row.names=FALSE)

```

##### Dosing 23, 1600 mg loading dose, 800 mg maitenance dose for CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_23<-read.csv("dosing_08.csv")

library(dplyr)

# Replace AMT with 1600 for AMT == 1200
dosing_23$AMT[dosing_23$AMT == 1200] <- 1600

# Eliminate rows where PEAK == 1
dosing_23 <- subset(dosing_23, PEAK != 1)

```

```{r export dosing 23 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_23,"dosing_23.csv",quote=F,row.names=FALSE)

```

##### Dosing 24, 1000 mg loading dose, 400 mg maitenance dose for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_24<-read.csv("standard_dosing_noCRRT.csv")

library(dplyr)

# Replace AMT with 1000 for AMT == 800
dosing_24$AMT[dosing_24$AMT == 800] <- 1000

# Eliminate rows where PEAK == 1
dosing_24 <- subset(dosing_24, PEAK != 1)

```

```{r export dosing 24 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_24,"dosing_24.csv",quote=F,row.names=FALSE)

```

##### Dosing 25, 1200 mg loading dose, 400 mg maitenance dose for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_25<-read.csv("standard_dosing_noCRRT.csv")

library(dplyr)

# Replace AMT with 1200 for AMT == 800
dosing_25$AMT[dosing_25$AMT == 800] <- 1200

# Eliminate rows where PEAK == 1
dosing_25 <- subset(dosing_25, PEAK != 1)

```

```{r export dosing 25 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_25,"dosing_25.csv",quote=F,row.names=FALSE)

```

##### Dosing 26, 1400 mg loading dose, 400 mg maitenance dose for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_26<-read.csv("standard_dosing_noCRRT.csv")

library(dplyr)

# Replace AMT with 1400 for AMT == 800
dosing_26$AMT[dosing_26$AMT == 800] <- 1400

# Eliminate rows where PEAK == 1
dosing_26 <- subset(dosing_26, PEAK != 1)

```

```{r export dosing 26 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_26,"dosing_26.csv",quote=F,row.names=FALSE)

```

##### Dosing 27, 1600 mg loading dose, 400 mg maitenance dose for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_27<-read.csv("standard_dosing_noCRRT.csv")

library(dplyr)

# Replace AMT with 1600 for AMT == 800
dosing_27$AMT[dosing_27$AMT == 800] <- 1600

# Eliminate rows where PEAK == 1
dosing_27 <- subset(dosing_27, PEAK != 1)

```

```{r export dosing 27 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_27,"dosing_27.csv",quote=F,row.names=FALSE)

```

##### Dosing 28, 1000mg <= 55kg - 1200mg <=80kg - 1400mg <=100kg - 1600mg <=120kg - 1800 rest (loading dose), 800 mg (maitenance dose) for CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_28<-read.csv("dosing_08.csv")

library(dplyr)

# Replace AMT with 1000 for AMT == 1200 & BW<=55
dosing_28$AMT[dosing_28$AMT == 1200 & dosing_28$BW<=55] <- 1000
# Replace AMT with 1400 for AMT == 1200 & 80<BW<=100
dosing_28$AMT[dosing_28$AMT == 1200 & dosing_28$BW<=100 & dosing_28$BW>80] <- 1400
# Replace AMT with 1600 for AMT == 1200 & 100<BW<=120
dosing_28$AMT[dosing_28$AMT == 1200 & dosing_28$BW<=120 & dosing_28$BW>100] <- 1600
# Replace AMT with 1800 for AMT == 1200 & 120<BW
dosing_28$AMT[dosing_28$AMT == 1200 & dosing_28$BW>120] <- 1800

# Eliminate rows where PEAK == 1
dosing_28 <- subset(dosing_28, PEAK != 1)

```

```{r export dosing 28 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_28,"dosing_28.csv",quote=F,row.names=FALSE)

```

##### Dosing 29, 800mg <= 50kg - 1000mg <=75kg - 1200mg <=95kg - 1400mg <=115kg - 1600 rest (loading dose), 400 mg (maitenance dose) for non-CRRT patients

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
dosing_29<-read.csv("standard_dosing_noCRRT.csv")

library(dplyr)

# Replace AMT with 1000 for AMT == 800 & 50<BW<=75
dosing_29$AMT[dosing_29$AMT == 800 & dosing_29$BW<=75 & dosing_29$BW>50] <- 1000
# Replace AMT with 1200 for AMT == 800 & 75<BW<=95
dosing_29$AMT[dosing_29$AMT == 800 & dosing_29$BW<=95 & dosing_29$BW>75] <- 1200
# Replace AMT with 1400 for AMT == 800 & 95<BW<=115
dosing_29$AMT[dosing_29$AMT == 800 & dosing_29$BW<=115 & dosing_29$BW>95] <- 1400
# Replace AMT with 1600 for AMT == 800 & 115<BW
dosing_29$AMT[dosing_29$AMT == 800 & dosing_29$BW>115] <- 1600

# Eliminate rows where PEAK == 1
dosing_29 <- subset(dosing_29, PEAK != 1)

```

```{r export dosing 29 datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")
write.csv(dosing_29,"dosing_29.csv",quote=F,row.names=FALSE)

```

#### Analysing simulations output files

##### For dosing regimen 22

```{r dosing regimen 22 CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_22.txt file
sdtab_22 <- read.table("sdtab_22.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_22[] <- lapply(sdtab_22, as.numeric)

#eliminate all NAs
sdtab_22 <- na.omit(sdtab_22)

# Extract only the trough events
sdtab_22_trough <- sdtab_22[sdtab_22$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_22_trough <- sdtab_22_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_22_trough<- sdtab_22_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_22_trough$fAUC<- sdtab_22_trough$AUC24*0.89

#Eliminate peak column
sdtab_22_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_22 <- subset(sdtab_22_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_22$PTA_Cmin_75 <- 100 * ave(PTA_22$DV >= 7.5, PTA_22$DAY, PTA_22$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_22$PTA_Cmin_80 <- 100 * ave(PTA_22$DV >= 80, PTA_22$DAY, PTA_22$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_22$PTA_fAUC_200 <- 100 * ave(PTA_22$fAUC >= 200, PTA_22$DAY, PTA_22$BW, FUN = mean)

# Create PTA_22_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_22_overall <- unique(PTA_22[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_22_trough, "sdtab_22_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_22_overall, "PTA_22_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 23

```{r dosing regimen 23 CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_23.txt file
sdtab_23 <- read.table("sdtab_23.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_23[] <- lapply(sdtab_23, as.numeric)

#eliminate all NAs
sdtab_23 <- na.omit(sdtab_23)

# Extract only the trough events
sdtab_23_trough <- sdtab_23[sdtab_23$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_23_trough <- sdtab_23_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_23_trough<- sdtab_23_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_23_trough$fAUC<- sdtab_23_trough$AUC24*0.89

#Eliminate peak column
sdtab_23_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_23 <- subset(sdtab_23_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_23$PTA_Cmin_75 <- 100 * ave(PTA_23$DV >= 7.5, PTA_23$DAY, PTA_23$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_23$PTA_Cmin_80 <- 100 * ave(PTA_23$DV >= 80, PTA_23$DAY, PTA_23$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_23$PTA_fAUC_200 <- 100 * ave(PTA_23$fAUC >= 200, PTA_23$DAY, PTA_23$BW, FUN = mean)

# Create PTA_23_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_23_overall <- unique(PTA_23[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_23_trough, "sdtab_23_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_23_overall, "PTA_23_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 24

```{r dosing regimen 24 non-CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_24.txt file
sdtab_24 <- read.table("sdtab_24.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_24[] <- lapply(sdtab_24, as.numeric)

#eliminate all NAs
sdtab_24 <- na.omit(sdtab_24)

# Extract only the trough events
sdtab_24_trough <- sdtab_24[sdtab_24$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_24_trough <- sdtab_24_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_24_trough<- sdtab_24_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_24_trough$fAUC<- sdtab_24_trough$AUC24*0.89

#Eliminate peak column
sdtab_24_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_24 <- subset(sdtab_24_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_24$PTA_Cmin_75 <- 100 * ave(PTA_24$DV >= 7.5, PTA_24$DAY, PTA_24$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_24$PTA_Cmin_80 <- 100 * ave(PTA_24$DV >= 80, PTA_24$DAY, PTA_24$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_24$PTA_fAUC_200 <- 100 * ave(PTA_24$fAUC >= 200, PTA_24$DAY, PTA_24$BW, FUN = mean)

# Create PTA_24_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_24_overall <- unique(PTA_24[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_24_trough, "sdtab_24_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_24_overall, "PTA_24_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 25

```{r dosing regimen 25 non-CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_25.txt file
sdtab_25 <- read.table("sdtab_25.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_25[] <- lapply(sdtab_25, as.numeric)

#eliminate all NAs
sdtab_25 <- na.omit(sdtab_25)

# Extract only the trough events
sdtab_25_trough <- sdtab_25[sdtab_25$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_25_trough <- sdtab_25_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_25_trough<- sdtab_25_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_25_trough$fAUC<- sdtab_25_trough$AUC24*0.89

#Eliminate peak column
sdtab_25_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_25 <- subset(sdtab_25_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_25$PTA_Cmin_75 <- 100 * ave(PTA_25$DV >= 7.5, PTA_25$DAY, PTA_25$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_25$PTA_Cmin_80 <- 100 * ave(PTA_25$DV >= 80, PTA_25$DAY, PTA_25$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_25$PTA_fAUC_200 <- 100 * ave(PTA_25$fAUC >= 200, PTA_25$DAY, PTA_25$BW, FUN = mean)

# Create PTA_25_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_25_overall <- unique(PTA_25[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_25_trough, "sdtab_25_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_25_overall, "PTA_25_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 26

```{r dosing regimen 26 non-CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_26.txt file
sdtab_26 <- read.table("sdtab_26.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_26[] <- lapply(sdtab_26, as.numeric)

#eliminate all NAs
sdtab_26 <- na.omit(sdtab_26)

# Extract only the trough events
sdtab_26_trough <- sdtab_26[sdtab_26$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_26_trough <- sdtab_26_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_26_trough<- sdtab_26_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_26_trough$fAUC<- sdtab_26_trough$AUC24*0.89

#Eliminate peak column
sdtab_26_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_26 <- subset(sdtab_26_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_26$PTA_Cmin_75 <- 100 * ave(PTA_26$DV >= 7.5, PTA_26$DAY, PTA_26$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_26$PTA_Cmin_80 <- 100 * ave(PTA_26$DV >= 80, PTA_26$DAY, PTA_26$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_26$PTA_fAUC_200 <- 100 * ave(PTA_26$fAUC >= 200, PTA_26$DAY, PTA_26$BW, FUN = mean)

# Create PTA_26_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_26_overall <- unique(PTA_26[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_26_trough, "sdtab_26_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_26_overall, "PTA_26_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 27

```{r dosing regimen 27 non-CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_27.txt file
sdtab_27 <- read.table("sdtab_27.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_27[] <- lapply(sdtab_27, as.numeric)

#eliminate all NAs
sdtab_27 <- na.omit(sdtab_27)

# Extract only the trough events
sdtab_27_trough <- sdtab_27[sdtab_27$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_27_trough <- sdtab_27_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_27_trough<- sdtab_27_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_27_trough$fAUC<- sdtab_27_trough$AUC24*0.89

#Eliminate peak column
sdtab_27_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_27 <- subset(sdtab_27_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_27$PTA_Cmin_75 <- 100 * ave(PTA_27$DV >= 7.5, PTA_27$DAY, PTA_27$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_27$PTA_Cmin_80 <- 100 * ave(PTA_27$DV >= 80, PTA_27$DAY, PTA_27$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_27$PTA_fAUC_200 <- 100 * ave(PTA_27$fAUC >= 200, PTA_27$DAY, PTA_27$BW, FUN = mean)

# Create PTA_27_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_27_overall <- unique(PTA_27[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_27_trough, "sdtab_27_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_27_overall, "PTA_27_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 28

```{r dosing regimen 28 CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_stand.txt file
sdtab_28 <- read.table("sdtab_28.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_28[] <- lapply(sdtab_28, as.numeric)

#eliminate all NAs
sdtab_28 <- na.omit(sdtab_28)

# Extract only the trough events
sdtab_28_trough <- sdtab_28[sdtab_28$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_28_trough <- sdtab_28_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_28_trough<- sdtab_28_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_28_trough$fAUC<- sdtab_28_trough$AUC24*0.89

#Eliminate peak column
sdtab_28_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_28 <- subset(sdtab_28_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_28$PTA_Cmin_75 <- 100 * ave(PTA_28$DV >= 7.5, PTA_28$DAY, PTA_28$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_28$PTA_Cmin_80 <- 100 * ave(PTA_28$DV >= 80, PTA_28$DAY, PTA_28$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_28$PTA_fAUC_200 <- 100 * ave(PTA_28$fAUC >= 200, PTA_28$DAY, PTA_28$BW, FUN = mean)

# Create PTA_28_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_28_overall <- unique(PTA_28[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_28_trough, "sdtab_28_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_28_overall, "PTA_28_overall.csv",quote=F,row.names = FALSE)

```

##### For dosing regimen 29

```{r dosing regimen 29 non-CRRT, warning=FALSE}
library(dplyr)
# Setwd for this chunk
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations")

# Read in sdtab_stand.txt file
sdtab_29 <- read.table("sdtab_29.txt", header=TRUE, skip=1, sep="", na.strings="", strip.white=TRUE)

#change all the variables to numeric
sdtab_29[] <- lapply(sdtab_29, as.numeric)

#eliminate all NAs
sdtab_29 <- na.omit(sdtab_29)

# Extract only the trough events
sdtab_29_trough <- sdtab_29[sdtab_29$TROUGH == 1,]

# Create a new variable AUC24 for each ID
sdtab_29_trough <- sdtab_29_trough %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()
sdtab_29_trough<- sdtab_29_trough %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
sdtab_29_trough$fAUC<- sdtab_29_trough$AUC24*0.89

#Eliminate peak column
sdtab_29_trough$PEAK<-NULL

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_29 <- subset(sdtab_29_trough, select = c("ID", "DV", "fAUC","CRRT", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_29$PTA_Cmin_75 <- 100 * ave(PTA_29$DV >= 7.5, PTA_29$DAY, PTA_29$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_29$PTA_Cmin_80 <- 100 * ave(PTA_29$DV >= 80, PTA_29$DAY, PTA_29$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_29$PTA_fAUC_200 <- 100 * ave(PTA_29$fAUC >= 200, PTA_29$DAY, PTA_29$BW, FUN = mean)

# Create PTA_29_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_29_overall <- unique(PTA_29[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW","CRRT")])

# Export trough and PTA dataset
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(sdtab_29_trough, "sdtab_29_trough.csv",quote=F,row.names = FALSE)
write.csv(PTA_29_overall, "PTA_29_overall.csv",quote=F,row.names = FALSE)

```

#### Combine into PTA_overall dataset (continue from Fluc_Simulation.Rmd file)

```{r read all newly created PTA_x_overall datasets, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
PTA_overall<-read.csv("PTA_overall.csv")
PTA_22_overall<-read.csv("PTA_22_overall.csv")
PTA_23_overall<-read.csv("PTA_23_overall.csv")
PTA_24_overall<-read.csv("PTA_24_overall.csv")
PTA_25_overall<-read.csv("PTA_25_overall.csv")
PTA_26_overall<-read.csv("PTA_26_overall.csv")
PTA_27_overall<-read.csv("PTA_27_overall.csv")
PTA_28_overall<-read.csv("PTA_28_overall.csv")
PTA_29_overall<-read.csv("PTA_29_overall.csv")

```

```{r assign regimen number}
PTA_22_overall$Regimen<-23
PTA_23_overall$Regimen<-24
PTA_24_overall$Regimen<-25
PTA_25_overall$Regimen<-26
PTA_26_overall$Regimen<-27
PTA_27_overall$Regimen<-28
PTA_28_overall$Regimen<-29
PTA_29_overall$Regimen<-30

```

```{r combine these new datasets into 1 single PTA_overall}
PTA_overall<-rbind(PTA_overall,PTA_22_overall,PTA_23_overall,PTA_24_overall,PTA_25_overall,PTA_26_overall,PTA_27_overall,PTA_28_overall,PTA_29_overall)
PTA_overall$Regimen<-as.factor(PTA_overall$Regimen)
PTA_overall$CRRT<-as.factor(PTA_overall$CRRT)

```

```{r export PTA_overall again,warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
write.csv(PTA_overall, "PTA_overall.csv",quote=F,row.names = FALSE)

```

#### PTA fAUC of 200 mgxh/L paper appendix 010623 

##### Day 1 to evaluate the adequacy of loading dose

```{r PTA fAUC 200 mgxh/L day 1 CRRT patients, warning=FALSE}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY1<- PTA_overall %>%
  filter(CRRT == 1, DAY == 1, BW<150,Regimen %in% c(1, 3, 5, 9, 23, 24, 19, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 3, 5, 9, 23, 24, 19, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 55, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 80, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 100, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 120, linetype = "dashed", color = "gray50",size=1) #+
        scale_shape_manual(values = c(16, 17, 15, 5, 25, 22, 8, 2, 11),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
                geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT200_DAY1 #1000 55kg - 1200 80kg - 1400 100kg - 1600 120kg - 1800 rest
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

```{r PTA fAUC 200 mgxh/L day 1 non-CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY1<- PTA_overall %>%
  filter(CRRT == 0, DAY == 1,BW<150, Regimen %in% c(1, 25, 5, 26, 27, 28, 18, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 5, 26, 27, 28, 18, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 50, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 75, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 95, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 115, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
        scale_shape_manual(values = c(16, 17, 15, 5, 25, 22, 8, 2, 11),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +        
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT200_DAY1 #800 50kg - 1000 75kg - 1200 95kg - 1400 115kg - 1600 rest
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

##### Day 7 to evaluate the adequacy of maintenance dose

```{r PTA fAUC 200 mgxh/L day 7 CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY7<- PTA_overall %>%
  filter(CRRT == 1, DAY == 7,BW<150, Regimen %in% c(1, 2, 3, 5, 8, 9, 17, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 17, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "green", "blue", "brown", "purple", "orange", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 600 mg  q24h", "1800 mg q24h (day 1) / 800 mg q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
            scale_shape_manual(values = c(16, 15, 17, 25, 22, 5, 2, 8),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 600 mg  q24h", "1800 mg q24h (day 1) / 800 mg q24h")) +    
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT200_DAY7
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

```{r PTA fAUC 200 mgxh/L day 7 non-CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY7<- PTA_overall %>%
  filter(CRRT == 0, DAY == 7,BW<150, Regimen %in% c(1, 2, 3, 5, 8, 9, 18, 20)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 18, 20))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 200 mg  q24h", "1800 mg q24h (day 1) / 400 mg q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
        scale_shape_manual(values = c(16, 17, 15, 25, 22, 5, 2, 8),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 200 mg  q24h", "1800 mg q24h (day 1) / 400 mg q24h")) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT200_DAY7
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

##### Day 2 to evaluate the adequacy of loading + maintenance dose

```{r PTA fAUC 200 mgxh/L day 2 CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY2<- PTA_overall %>%
  filter(CRRT == 1, DAY == 2,BW<150, Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 55, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 80, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 100, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 120, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
                scale_shape_manual(values = c(17, 5, 25, 22, 8),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT200_DAY2
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

```{r PTA fAUC 200 mgxh/L day 2 non-CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY2<- PTA_overall %>%
  filter(CRRT == 0, DAY == 2, BW<150, Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 50, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 75, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 95, linetype = "dashed", color = "gray50",size=1) +
        geom_vline(xintercept = 115, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
        scale_shape_manual(values = c(16, 17, 5, 25, 22),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +       
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT200_DAY2
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

##### Day 14 to evaluate the adequacy of maintenance dose

```{r PTA fAUC 200 mgxh/L day 14 CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY14<- PTA_overall %>%
  filter(CRRT == 1, DAY == 14,BW<150, Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) + 
                scale_shape_manual(values = c(17, 5, 25, 22, 8),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT200_DAY14
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

```{r PTA fAUC 200 mgxh/L day 14 non-CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY14<- PTA_overall %>%
  filter(CRRT == 0, DAY == 14, BW<150, Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 7),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) #+
        geom_point(aes(x = BW, y = PTA_fAUC_200, shape = factor(Regimen)), size = 2) +
                scale_shape_manual(values = c(16, 17, 5, 25, 22),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT200_DAY14
#on 140623 I eliminated the shape and point to have the plot in my thesis defence presentation

```

##### Panels PTA over time of CRRT and non-CRRT patients

```{r PTA day 1 7 2 14 fAUC200 CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
library(cowplot)

CRRT_pooled <- plot_grid(PTA_CRRT200_DAY1, PTA_CRRT200_DAY7, PTA_CRRT200_DAY2, PTA_CRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of target attainment of fAUC 200 mgxh/L", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
CRRT_pooled <- plot_grid(title, CRRT_pooled, ncol = 1, rel_heights = c(0.02, 1))

#This plot is in the presentation 140623
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots/Thesis_defence_plot")
#ggsave("CRRT_pooled.png", CRRT_pooled, dpi = 300, width = 17.15, height = 8.86, unit = "cm",limitsize=FALSE)
ggsave("CRRT_pooled.png", CRRT_pooled, dpi = 300, width = 16, height = 8.27)

```

```{r PTA day 1 7 2 14 fAUC200 non-CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
library(cowplot)

noCRRT_pooled <- plot_grid(PTA_NOCRRT200_DAY1, PTA_NOCRRT200_DAY7, PTA_NOCRRT200_DAY2, PTA_NOCRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of target attainment of fAUC 200 mgxh/L", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
noCRRT_pooled <- plot_grid(title, noCRRT_pooled, ncol = 1, rel_heights = c(0.02, 1))

#This plot is in the presentation 140623
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots/Thesis_defence_plot")
ggsave("noCRRT_pooled.png", noCRRT_pooled, dpi = 300, width = 16, height = 8.27)

```

#### Preparing plots for thesis defence presentation 150623. I need to modify the code for appendix plots a little.
##### Adjusting the code of PTA for each day

```{r reducing legend text size}
#Day 1
PTA_CRRT200_DAY1<-PTA_CRRT200_DAY1+
        theme(plot.title = element_text(hjust = 0.5, size = 8,face="bold"),
        axis.title = element_text(size = 6),legend.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.text = element_text(size = 4))
#Day 2
PTA_CRRT200_DAY2<-PTA_CRRT200_DAY2 +
        theme(plot.title = element_text(hjust = 0.5, size = 8,face="bold"),
        axis.title = element_text(size = 6),legend.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.text = element_text(size = 4))
#Day 7
PTA_CRRT200_DAY7<-PTA_CRRT200_DAY7 +
        theme(plot.title = element_text(hjust = 0.5, size = 8,face="bold"),
        axis.title = element_text(size = 6),legend.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.text = element_text(size = 4))
#Day 14
PTA_CRRT200_DAY14<-PTA_CRRT200_DAY14 +
        theme(plot.title = element_text(hjust = 0.5, size = 8,face="bold"),
        axis.title = element_text(size = 6),legend.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.text = element_text(size = 4))

```

##### Adjusting the code for combining these plots

```{r reducing title text size}
library(cowplot)

CRRT_pooled <- plot_grid(PTA_CRRT200_DAY1, PTA_CRRT200_DAY7, PTA_CRRT200_DAY2, PTA_CRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of target attainment of fAUC 200 mgxh/L", fontface = "bold", size = 10)

# Arrange the title and grid using plot_grid()
CRRT_pooled <- plot_grid(title, CRRT_pooled, ncol = 1, rel_heights = c(0.05, 1))

#This plot is in the presentation 150623
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots/Thesis_defence_plot")
ggsave("CRRT_pooled.png", CRRT_pooled, dpi = 300, width = 17.15, height = 8.86, unit = "cm",limitsize=FALSE)

```

#### PTA Cmin of 80 mgxh/L paper appendix 010623

```{r read in PTA_overall dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
PTA_overall<-read.csv("PTA_overall.csv")
```

##### Day 1 to evaluate the toxicity of loading dose

```{r PTA Cmin 80 mg/L day 1 CRRT patients, warning=FALSE}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT80_DAY1<- PTA_overall %>%
  filter(CRRT == 1, DAY == 1, BW<150,Regimen %in% c(1, 3, 5, 9, 23, 24, 19, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 3, 5, 9, 23, 24, 19, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
                scale_shape_manual(values = c(16, 17, 15, 5, 25, 22, 8, 2, 11),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT80_DAY1 #1000 55kg - 1200 80kg - 1400 100kg - 1600 120kg - 1800 rest


```

```{r PTA Cmin 80 mg/L day 1 non-CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT80_DAY1<- PTA_overall %>%
  filter(CRRT == 0, DAY == 1,BW<150, Regimen %in% c(1, 25, 5, 26, 27, 28, 18, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 5, 26, 27, 28, 18, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
                scale_shape_manual(values = c(16, 17, 15, 5, 25, 22, 8, 2, 11),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT80_DAY1 #800 50kg - 1000 75kg - 1200 95kg - 1400 115kg - 1600 rest

```

##### Day 7 to evaluate the toxicity of maintenance dose

```{r PTA Cmin 80 mg/L day 7 CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT80_DAY7<- PTA_overall %>%
  filter(CRRT == 1, DAY == 7,BW<150, Regimen %in% c(1, 2, 3, 5, 8, 9, 17, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 17, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red", "green", "blue", "brown", "purple", "orange", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 600 mg  q24h", "1800 mg q24h (day 1) / 800 mg q24h")) +
                scale_shape_manual(values = c(16, 15, 17, 25, 22, 5, 2, 8),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 600 mg  q24h", "1800 mg q24h (day 1) / 800 mg q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT80_DAY7

```

```{r PTA Cmin 80 mg/L day 7 non-CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT80_DAY7<- PTA_overall %>%
  filter(CRRT == 0, DAY == 7,BW<150, Regimen %in% c(1, 2, 3, 5, 8, 9, 18, 20)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 18, 20))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 200 mg  q24h", "1800 mg q24h (day 1) / 400 mg q24h")) +
                scale_shape_manual(values = c(16, 17, 15, 25, 22, 5, 2, 8),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 200 mg  q24h", "1800 mg q24h (day 1) / 400 mg q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT80_DAY7

```

##### Day 2 to evaluate the toxicity of loading + maintenance dose

```{r PTA Cmin 80 mg/L day 2 CRRT patients}

# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT80_DAY2<- PTA_overall %>%
  filter(CRRT == 1, DAY == 2,BW<150, Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
                scale_shape_manual(values = c(17, 5, 25, 22, 8),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT80_DAY2

```

```{r PTA Cmin 80 mg/L day 2 non-CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT80_DAY2<- PTA_overall %>%
  filter(CRRT == 0, DAY == 2, BW<150, Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
                scale_shape_manual(values = c(16, 17, 5, 25, 22),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT80_DAY2

```

##### Day 14 to evaluate the toxicity of maintenance dose

```{r PTA Cmin 80 mg/L day 14 CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_CRRT80_DAY14<- PTA_overall %>%
  filter(CRRT == 1, DAY == 14,BW<150, Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
                scale_shape_manual(values = c(17, 5, 25, 22, 8),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_CRRT80_DAY14

```

```{r PTA Cmin 80 mg/L day 14 non-CRRT patients}
# This version is better for black&white printing
library(ggplot2)
library(dplyr)
PTA_NOCRRT80_DAY14<- PTA_overall %>%
  filter(CRRT == 0, DAY == 14, BW<150, Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_Cmin_80, color = factor(Regimen)),size = 1) + 
        geom_point(aes(x = BW, y = PTA_Cmin_80, shape = factor(Regimen)), size = 2) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
                scale_shape_manual(values = c(16, 17, 5, 25, 22),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 145), breaks = seq(30, 145, by = 5), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 10,face="bold"),
        axis.title = element_text(size = 9),legend.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        guides(shape = guide_legend(title = "Dosing regimen"), color = guide_legend(title = "Dosing regimen"))
PTA_NOCRRT80_DAY14

```

##### Panels toixcity over time of CRRT and non-CRRT patients

```{r PTA day 1 7 2 14 Cmin80 CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
library(cowplot)

grid_tox_CRRT <- plot_grid(PTA_CRRT80_DAY1, PTA_CRRT80_DAY7, PTA_CRRT80_DAY2, PTA_CRRT80_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of reaching toxicity threshold of Cmin 80 mg/L", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_tox_CRRT <- plot_grid(title, grid_tox_CRRT, ncol = 1, rel_heights = c(0.02, 1))

ggsave("grid_tox_CRRT.png", grid_tox_CRRT, dpi = 300, width = 16, height = 8.27)

```

```{r PTA day 1 7 2 14 Cmin80 non-CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
library(cowplot)

grid_tox_noCRRT <- plot_grid(PTA_NOCRRT80_DAY1, PTA_NOCRRT80_DAY7, PTA_NOCRRT80_DAY2, PTA_NOCRRT80_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of reaching toxicity threshold of Cmin 80 mg/L", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_tox_noCRRT <- plot_grid(title, grid_tox_noCRRT, ncol = 1, rel_heights = c(0.02, 1))

ggsave("grid_tox_noCRRT.png", grid_tox_noCRRT, dpi = 300, width = 16, height = 8.27)

```

#### Making plots for PAGE poster 100623

##### Making individual plots

###### DAY 1 CRRT

```{r PTA fAUC 200 mgxh/L day 1 CRRT patients, warning=FALSE}

### For the POSTER, I change the followings compared to the plot in the appendix
# Firstly, reducing the size of legend text and legend title (6 and 7 compared to 8 and 9)
# Secondly, eliminating points for enhancing visibility
# Third, reducing the size of vertical and horizontal dashed lines
# Fourth, reducing the size and the breaks of axis text

library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY1<- PTA_overall %>%
  filter(CRRT == 1, DAY == 1, BW<150,Regimen %in% c(1, 3, 5, 9, 23, 24, 19, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 3, 5, 9, 23, 24, 19, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) +
        geom_vline(xintercept = c(55, 80, 100, 120), linetype = "dashed", color = "gray50", size = 0.6) 
PTA_CRRT200_DAY1 #1000 55kg - 1200 80kg - 1400 100kg - 1600 120kg - 1800 rest

```

###### DAY 1 non-CRRT

```{r PTA fAUC 200 mgxh/L day 1 non-CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY1<- PTA_overall %>%
  filter(CRRT == 0, DAY == 1, BW<150,Regimen %in% c(1, 25, 5, 26, 27, 28, 18, 6, 7)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 5, 26, 27, 28, 18, 6, 7))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "gray","pink","black"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1)", "1000 mg q24h (day 1)",
                                "800 mg + 400 mg q12h (day 1)", "1200 mg q24h (day 1)","1400 mg q24h (day 1)","1600 mg q24h (day 1)",
                                "1800 mg q24h (day 1)","12 mg/kg q24h (day 1)","18 mg/kg q24h (day 1)")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) +
        geom_vline(xintercept = c(50, 75, 95, 115), linetype = "dashed", color = "gray50", size = 0.6) 
PTA_NOCRRT200_DAY1 #1000 55kg - 1200 80kg - 1400 100kg - 1600 120kg - 1800 rest

```

###### DAY 7 CRRT

```{r PTA fAUC 200 mgxh/L day 7 CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY7<- PTA_overall %>%
  filter(CRRT == 1, DAY == 7, BW<150,Regimen %in% c(1, 2, 3, 5, 8, 9, 17, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 17, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "green", "blue", "brown", "purple", "orange", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 600 mg  q24h", "1800 mg q24h (day 1) / 800 mg q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) 
PTA_CRRT200_DAY7 

```

###### DAY 7 non-CRRT

```{r PTA fAUC 200 mgxh/L day 7 non-CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY7<- PTA_overall %>%
  filter(CRRT == 0, DAY == 7, BW<150,Regimen %in% c(1, 2, 3, 5, 8, 9, 18, 20)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 2, 3, 5, 8, 9, 18, 20))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red", "blue", "green", "orange", "purple", "brown", "pink","gray"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 600 mg q24h", "1000 mg q24h (day 1) / 800 mg q24h",
                                "800 mg first 12h / 400 mg q12h", "1200 mg q24h (day 1) / 600 mg q24h","1200 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 200 mg  q24h", "1800 mg q24h (day 1) / 400 mg q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) 
PTA_NOCRRT200_DAY7 

```

###### DAY 2 CRRT

```{r PTA fAUC 200 mgxh/L day 2 CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY2<- PTA_overall %>%
  filter(CRRT == 1, DAY == 2, BW<150,Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) +
        geom_vline(xintercept = c(55, 80, 100, 120), linetype = "dashed", color = "gray50", size = 0.6) 
PTA_CRRT200_DAY2 

```

###### DAY 2 non-CRRT

```{r PTA fAUC 200 mgxh/L day 2 non-CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY2<- PTA_overall %>%
  filter(CRRT == 0, DAY == 2, BW<150,Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"),name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) +
        geom_vline(xintercept = c(50, 75, 95, 115), linetype = "dashed", color = "gray50", size = 0.6)
PTA_NOCRRT200_DAY2 

```

###### DAY 14 CRRT

```{r PTA fAUC 200 mgxh/L day 14 CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_CRRT200_DAY14<- PTA_overall %>%
  filter(CRRT == 1, DAY == 14, BW<150,Regimen %in% c(3, 9, 23, 24, 19)) %>%
  mutate(Regimen = factor(Regimen, levels = c(3, 9, 23, 24, 19))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("blue", "orange", "purple", "brown", "gray"),name = "Dosing regimen",
                     labels = c("1000 mg q24h (day 1) / 800 mg q24h", "1200 mg q24h (day 1) / 800 mg q24h", "1400 mg q24h (day 1) / 800 mg q24h",
                                "1600 mg q24h (day 1) / 800 mg q24h",
                                "1800 mg q24h (day 1) / 800 mg  q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6)  
PTA_CRRT200_DAY14 

```

###### DAY 14 non-CRRT

```{r PTA fAUC 200 mgxh/L day 14 non-CRRT patients, warning=FALSE}

library(ggplot2)
library(dplyr)
PTA_NOCRRT200_DAY14<- PTA_overall %>%
  filter(CRRT == 0, DAY == 14, BW<150,Regimen %in% c(1, 25, 26, 27, 28)) %>%
  mutate(Regimen = factor(Regimen, levels = c(1, 25, 26, 27, 28))) %>%
  ggplot() +  geom_line(aes(x = BW, y = PTA_fAUC_200, color = factor(Regimen)),size = 1) + 
        scale_color_manual(values = c("red","blue", "orange", "purple", "brown"), name = "Dosing regimen",
                     labels = c("800 mg q24h (day 1) / 400 mg q24h", "1000 mg q24h (day 1) / 400 mg q24h", "1200 mg q24h (day 1) / 400 mg q24h",
                                "1400 mg q24h (day 1) / 400 mg q24h",
                                "1600 mg q24h (day 1) / 400 mg  q24h")) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 10), name = "Body Weight (kg)", 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10), name = "Probability (%)", 
                     expand = c(0,0)) +
  theme_minimal(base_size = 12) +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 9.5),legend.title = element_text(size = 7.5),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 6.5),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
        geom_hline(yintercept = 90, linetype = "dashed", color = "gray50", size = 0.6) 
PTA_NOCRRT200_DAY14 

```

##### Combining individual plots

```{r PTA day 1 7 2 14 fAUC200 CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/working documents/PAGE 2023/Poster/Plots")
library(cowplot)

CRRT_pooled <- plot_grid(PTA_CRRT200_DAY1, PTA_CRRT200_DAY7, PTA_CRRT200_DAY2, PTA_CRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of target attainment of fAUC 200 mgxh/L", fontface = "bold", size = 13)

# Arrange the title and grid using plot_grid()
CRRT_pooled <- plot_grid(title, CRRT_pooled, ncol = 1, rel_heights = c(0.05, 0.95))

ggsave("CRRT_pooled.png", CRRT_pooled, dpi = 300, width = 27, height = 16,units = "cm", limitsize = FALSE)

```

```{r PTA day 1 7 2 14 fAUC200 non-CRRT patients, warning=FALSE}
#This plot is in the appendix
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/working documents/PAGE 2023/Poster/Plots")
library(cowplot)

noCRRT_pooled <- plot_grid(PTA_NOCRRT200_DAY1, PTA_NOCRRT200_DAY7, PTA_NOCRRT200_DAY2, PTA_NOCRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of target attainment of fAUC 200 mgxh/L", fontface = "bold", size = 13)

# Arrange the title and grid using plot_grid()
noCRRT_pooled <- plot_grid(title, noCRRT_pooled, ncol = 1, rel_heights = c(0.05, 0.95))

ggsave("noCRRT_pooled.png", noCRRT_pooled, dpi = 300, width = 27, height = 16,units = "cm", limitsize = FALSE)

```

#### Creating datasets for population simulation 270623 - increase the percentage of CRRT to 50%

##### Updating CRRT status

```{r update CRRT status for pop_dosing}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
pop_dosing<-read.csv("pop_dosing.csv")

# Set the seed for reproducibility
set.seed(123)

# Randomly select 500 IDs
selected_ids <- sample(unique(pop_dosing$ID), 500)

# Assign CRRT = 1 to selected IDs and CRRT = 0 to the rest
pop_dosing$CRRT <- ifelse(pop_dosing$ID %in% selected_ids, 1, 0)

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
pop_dosing_std<-read.csv("pop_dosing_std.csv")

# Set the seed for reproducibility
set.seed(123)

# Randomly select 500 IDs
selected_ids_std <- sample(unique(pop_dosing_std$ID), 500)

# Assign CRRT = 1 to selected IDs std and CRRT = 0 to the rest
pop_dosing_std$CRRT <- ifelse(pop_dosing_std$ID %in% selected_ids_std, 1, 0)

```

##### Updating the dose for new CRRT status

```{r update dose for new CRRT status}
library(dplyr)
pop_dosing <- pop_dosing %>%
  mutate(
    AMT = ifelse(TIME == 0 & BW > 120 & CRRT == 1, 1800,
           ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 1, 1600,
           ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 1, 1400,
           ifelse(TIME == 0 & BW <= 80 & BW > 55 & CRRT == 1, 1200, 
                  ifelse(TIME == 0 & BW <= 55 & CRRT == 1, 1000,
                         ifelse(TIME == 0 & BW > 115 & CRRT == 0, 1600,
                                ifelse(TIME == 0 & BW <= 115 & BW > 95 & CRRT == 0, 1400,
                                       ifelse(TIME == 0 & BW <= 95 & BW > 75 & CRRT == 0, 1200,
                                              ifelse(TIME == 0 & BW <= 75 & BW > 50 & CRRT == 0, 1000,
                                                     ifelse(TIME == 0 & BW <= 50 & CRRT == 0, 800,
                                                            ifelse(TIME > 0 & MDV==1 & CRRT == 1, 800,
                                                                   ifelse(TIME > 0 & MDV==1 & CRRT == 0, 400,0
                                                            
                  ))))
  )))
))))))

```

##### Exporting datasets

```{r exporting pop_dosing_upd & pop_dosing_std_upd}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
write.csv(pop_dosing,"pop_dosing_2706.csv",quote=F,row.names=FALSE)
write.csv(pop_dosing_std,"pop_dosing_std_2706.csv",quote=F,row.names=FALSE)

```


##### I create from scratch here (follow Fluconazole120423.Rmd file)

##### For optimised dosing

```{r read in datafile, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
dosing_CRRT<-read.csv("dosing_03.csv")

library(dplyr)

```

```{r extract AMT 1200 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1200
selected_groups <- grouped_data %>% filter(any(AMT == 1200))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

#0  0.1  0.5   1.5    2    3    6   12   18   21   22   23 23.9 
#13   13   13  13   13   13   13   13   13   13   13   13   13 

# Eliminate TAD == 1 rows
dosing_CRRT <- dosing_CRRT[dosing_CRRT$TAD != 1, ]

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.5, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,13)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 1000 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1000
selected_groups <- grouped_data %>% filter(any(AMT == 1000))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

#0  0.1  0.6 1.25    2    3    6   12   18   21   22   23 23.9    
#169  169  169  169  169  169  169  169  169  169  169  169  169   

# Eliminate TAD == 24 rows
dosing_CRRT <- dosing_CRRT[dosing_CRRT$TAD != 24, ]

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.25, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,169)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r create a dataset of 1000 patients from dosing_CRRT dataset}
# Create a new dataset with only patient 13
dosing_CRRT_13 <- dosing_CRRT[dosing_CRRT$ID == 13,]

# Create 987 copies of the patient 13 dataset and assign IDs 14-1000
new_patients <- lapply(14:1000, function(id){
  new_df <- dosing_CRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_CRRT <- rbind(dosing_CRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_CRRT)[names(dosing_CRRT) == "FFM"] <- "BW"

```

```{r read in FlucTotIV_clean dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
FlucTotIV_clean<-read.csv("FlucTotIV_clean.csv")

```

```{r extract IDs of those who were on CRRT}
library(dplyr)

miscel_IDs <- FlucTotIV_clean %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16 # CRRT on and off

crrt_1_ids <- unique(FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 1 & !FlucTotIV_clean$ID %in% FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 0]]) #ids of those who have CRRT all the time #16

```

```{r comparing BW2 of CRRT vs non-CRRT}
library(dplyr)
# Unique value of BW in my original dataset
test <- FlucTotIV_clean %>% ungroup() %>% select(ID, BW2) %>% unique()

test<-na.omit(test)

# comparing if CRRT vs non-CRRT patients have a different distribution

# Perform Mann-Whitney U test
non_parametric_test <- wilcox.test(BW2 ~ ifelse(ID %in% c(crrt_1_ids, miscel_IDs), "CRRT", "Non-CRRT"), data = test)

# Print the test results
print(non_parametric_test) 

#CRRT and non-CRRT patients have a similar BW2 distribution
```

```{r sample BW of dosing_CRRT from the empirical distribution of BW in the original dataset}

# Create the empirical cumulative distribution function (ECDF)
ecdf_func <- ecdf(test$BW2)

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_BW <- round(quantile(test$BW2, random_values), 1)

# Assign the sampled BW values to dosing_CRRT dataset
dosing_CRRT$BW <- sampled_BW[match(dosing_CRRT$ID, 1:1000)]

```

###### Creating my dosing_CRRT dataset with 9% full-time CRRT, and 9% part time CRRT (in which 51.5% DAYS on CRRT)

```{r mimic the aforementioned characterictics for my dosing_CRRT}

# Create a dummy dataset with 1000 patient IDs and 14 days:
dummy_data <- data.frame(
  ID = rep(1:1000, each = 14),
  DAY = rep(1:14, times = 1000)
)

# Add the CRRT variable to the dummy dataset and assign it temporarily to 0:
dummy_data$CRRT <- 0

# Randomly select 9% of the patient IDs and assign their CRRT to 1:
set.seed(42)  # Set seed for reproducibility
selected_ids <- sample(unique(dummy_data$ID), size = round(0.09 * 1000))
dummy_data$CRRT[dummy_data$ID %in% selected_ids] <- 1

# Randomly select another 9% of patient IDs that are not in selected_ids:
available_ids <- setdiff(unique(dummy_data$ID), selected_ids)
selected_ids_2 <- sample(available_ids, size = round(0.09 * 1000))
selected_days <- sample(unique(dummy_data$DAY), size = round(0.515 * 14))

# Assign 51.5% of the selected days to CRRT == 1, and the remaining to CRRT == 0
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & dummy_data$DAY %in% selected_days] <- 1
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & !dummy_data$DAY %in% selected_days] <- 0

# Assign CRRT == 0 to the remaining 82% of patient IDs:

dummy_data$CRRT[!(dummy_data$ID %in% c(selected_ids, selected_ids_2))] <- 0

# Assign the CRRT information from the dummy dataset to the dosing_CRRT dataset based on ID and DAY:

dosing_CRRT <- merge(dosing_CRRT, dummy_data[, c("ID", "DAY", "CRRT")], by = c("ID", "DAY"), all.x = TRUE)
dosing_CRRT$CRRT.x<-NULL
colnames(dosing_CRRT)[colnames(dosing_CRRT) == "CRRT.y"] <- "CRRT"

```

###### Updating dosing information

```{r updating loading and maintenance dose for dosing_CRRT}
dosing_CRRT <- dosing_CRRT %>%
  mutate(
    AMT = ifelse(TIME == 0 & BW > 120 & CRRT == 1, 1800,
           ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 1, 1600,
           ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 1, 1400,
           ifelse(TIME == 0 & BW <= 80 & BW > 55 & CRRT == 1, 1200, 
                  ifelse(TIME == 0 & BW <= 55 & CRRT == 1, 1000,
                         ifelse(TIME == 0 & BW > 115 & CRRT == 0, 1600,
                                ifelse(TIME == 0 & BW <= 115 & BW > 95 & CRRT == 0, 1400,
                                       ifelse(TIME == 0 & BW <= 95 & BW > 75 & CRRT == 0, 1200,
                                              ifelse(TIME == 0 & BW <= 75 & BW > 50 & CRRT == 0, 1000,
                                                     ifelse(TIME == 0 & BW <= 50 & CRRT == 0, 800,
                                                            ifelse(TIME > 0 & MDV==1 & CRRT == 1, 800,
                                                                   ifelse(TIME > 0 & MDV==1 & CRRT == 0, 400,0
                                                            
                  ))))
  )))
))))))

```

###### Updating TIME and TAD

```{r extract AMT 1600 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1600
selected_groups <- grouped_data %>% filter(any(AMT == 1600))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 1, 2, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,79)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 1400 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1400
selected_groups <- grouped_data %>% filter(any(AMT == 1400))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 1, 1.75, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,188)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 1200 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1200
selected_groups <- grouped_data %>% filter(any(AMT == 1200))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.5, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,392)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 1000 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 1000
selected_groups <- grouped_data %>% filter(any(AMT == 1000))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1.25, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,316)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 800 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 800
selected_groups <- grouped_data %>% filter(any(AMT == 800))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,1825)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r extract AMT 400 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 400
selected_groups <- grouped_data %>% filter(any(AMT == 400))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.25, 0.5, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,11200)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# View the updated dosing_CRRT
View(dosing_CRRT)

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

```

```{r update TIME}
dosing_CRRT$TIME<-24*(dosing_CRRT$OCC-1)+dosing_CRRT$TAD

```

```{r check TAD of dosing_CRRT}
summary(as.factor(dosing_CRRT$TAD))
dosing_CRRT$PEAK<-NULL

# Rearrange dosing_CRRT according to ID, DAY, and TIME
dosing_CRRT <- dosing_CRRT %>%
  arrange(ID, DAY, TIME)

# Move DAY after OCC
library(dplyr)
dosing_CRRT <- dosing_CRRT %>%
  relocate(DAY, .after = OCC)

```

```{r export dosing_CRRT dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
write.csv(dosing_CRRT,"pop_dosing.csv",quote=F,row.names=FALSE)

```

##### For standard dosing

```{r change into standard dosing}
pop_dosing<-dosing_CRRT

dosing_CRRT <- dosing_CRRT %>%
  mutate(
    AMT = ifelse(TIME == 0, 800,
           ifelse(TIME >0 & TAD==0, 400,0
           )
    )
  )

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r extract AMT 800 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 800
selected_groups <- grouped_data %>% filter(any(AMT == 800))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.6, 1, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,1000)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r extract AMT 400 data}
library(dplyr)

# Group the dataset by ID and DAY
grouped_data <- dosing_CRRT %>% group_by(ID, DAY)

# Filter the groups that have at least one row with AMT == 400
selected_groups <- grouped_data %>% filter(any(AMT == 400))

# Extract all rows from the selected groups
selected_rows <- ungroup(selected_groups)

# View the extracted rows
summary(as.factor(selected_rows$TAD))

# Define the desired TAD values
desired_tad <- c(0,0.1, 0.25, 0.5, 3, 4, 6,8, 12, 18, 21, 22.5, 23.9)

selected_rows$TAD<-rep(desired_tad,13000)

# Update the TAD values in dosing_CRRT with selected_rows
dosing_CRRT <- dosing_CRRT %>%
  left_join(selected_rows[, c("ID", "TIME", "TAD")], by = c("ID", "TIME")) %>%
  mutate(TAD = coalesce(TAD.y, TAD.x)) %>%
  select(-c(TAD.x, TAD.y))

# Move TAD after TIME
dosing_CRRT <- dosing_CRRT %>%
  relocate(TAD, .after = TIME)

# View the updated dosing_CRRT
View(dosing_CRRT)

```

```{r update TIME}
dosing_CRRT$TIME<-24*(dosing_CRRT$OCC-1)+dosing_CRRT$TAD

```

```{r export dosing_CRRT dataset, warning=FALSE}

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
write.csv(dosing_CRRT,"pop_dosing_std.csv",quote=F,row.names=FALSE)

```

#### Scatter plot DV vs fAUC 030623

```{r DV vs fAUC with trendline day 1, warning=FALSE}

library(ggplot2)
library(dplyr)

# Filter the dataset for DAY 1
sdtab_pop_day1 <- sdtab_pop_10_trough %>%
  filter(DAY == 1)

# Create the scatter plot
scatter_plot_day1 <- ggplot(sdtab_pop_day1, aes(y = fAUC, x = DV)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(y = "Fluconazole area under the unbound concentration time curve (mgxh/L)",
       x = "Fluconazole trough concentration (mg/L)") +
  theme_bw() +
  scale_y_continuous(breaks = seq(0, 1700, by = 100), limits = c(0, 1700)) +
  scale_x_continuous(breaks = seq(0, 70, by = 5), limits = c(0, 70)) +
  ggtitle("Day 1") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 

# Add linear regression equation
lm_eq_day1 <- lm(fAUC ~ DV, data = sdtab_pop_day1)
intercept <- coef(lm_eq_day1)[1]
slope <- coef(lm_eq_day1)[2]
r_squared <- summary(lm_eq_day1)$r.squared
equation_day1 <- sprintf("y = %.2f + %.2fx", intercept, slope)
r_squared_label <- sprintf("R² = %.2f", r_squared)
scatter_plot_with_eq_day1 <- scatter_plot_day1 +
  annotate("text", x = max(sdtab_pop_day1$DV), y = max(sdtab_pop_day1$fAUC), label = equation_day1, hjust = 3, vjust = -0.2, size = 6) +
  annotate("text", x = max(sdtab_pop_day1$DV), y = max(sdtab_pop_day1$fAUC), label = r_squared_label, hjust = 6.4, vjust = 1.2, size = 6)

# Display the scatter plot with equation
scatter_plot_with_eq_day1

# Save the scatter plot with equation
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("fAUCvsDV_day1.png", scatter_plot_with_eq_day1, dpi = 300, width = 8.27, height = 11.7, units = "in", limitsize = FALSE)

```

```{r DV vs fAUC with trendline day 2, warning=FALSE}

library(ggplot2)
library(dplyr)

# Filter the dataset for DAY 2
sdtab_pop_day2 <- sdtab_pop_10_trough %>%
  filter(DAY == 2)

# Create the scatter plot
scatter_plot_day2 <- ggplot(sdtab_pop_day2, aes(y = fAUC, x = DV)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(y = "Fluconazole area under the unbound concentration time curve (mgxh/L)",
       x = "Fluconazole trough concentration (mg/L)") +
  theme_bw() +
  scale_y_continuous(breaks = seq(0, 1700, by = 100), limits = c(0, 1700)) +
  scale_x_continuous(breaks = seq(0, 75, by = 5), limits = c(0, 75)) +
  ggtitle("Day 2") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 

# Add linear regression equation
lm_eq_day2 <- lm(fAUC ~ DV, data = sdtab_pop_day2)
intercept <- coef(lm_eq_day2)[1]
slope <- coef(lm_eq_day2)[2]
r_squared <- summary(lm_eq_day2)$r.squared
equation_day2 <- sprintf("y = %.2f + %.2fx", intercept, slope)
r_squared_label <- sprintf("R² = %.2f", r_squared)
scatter_plot_with_eq_day2 <- scatter_plot_day2 +
  annotate("text", x = max(sdtab_pop_day2$DV), y = max(sdtab_pop_day2$fAUC), label = equation_day2, hjust = 3, vjust = -0.2, size = 6) +
  annotate("text", x = max(sdtab_pop_day2$DV), y = max(sdtab_pop_day2$fAUC), label = r_squared_label, hjust = 6.4, vjust = 1.2, size = 6)

# Display the scatter plot with equation
scatter_plot_with_eq_day2

# Save the scatter plot with equation
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("fAUCvsDV_day2.png", scatter_plot_with_eq_day2, dpi = 300, width = 8.27, height = 11.7, units = "in", limitsize = FALSE)


```

```{r DV vs fAUC with trendline day 7, warning=FALSE}

library(ggplot2)
library(dplyr)

# Filter the dataset for DAY 7
sdtab_pop_day7 <- sdtab_pop_10_trough %>%
  filter(DAY == 7)

# Create the scatter plot
scatter_plot_day7 <- ggplot(sdtab_pop_day7, aes(y = fAUC, x = DV)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(y = "Fluconazole area under the unbound concentration time curve (mgxh/L)",
       x = "Fluconazole trough concentration (mg/L)") +
  theme_bw() +
  scale_y_continuous(breaks = seq(0, 2400, by = 200), limits = c(0, 2400)) +
  scale_x_continuous(breaks = seq(0, 130, by = 10), limits = c(0, 130)) +
  ggtitle("Day 7") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 

# Add linear regression equation
lm_eq_day7 <- lm(fAUC ~ DV, data = sdtab_pop_day7)
intercept <- coef(lm_eq_day7)[1]
slope <- coef(lm_eq_day7)[2]
r_squared <- summary(lm_eq_day7)$r.squared
equation_day7 <- sprintf("y = %.2f + %.2fx", intercept, slope)
r_squared_label <- sprintf("R² = %.2f", r_squared)
scatter_plot_with_eq_day7 <- scatter_plot_day7 +
  annotate("text", x = max(sdtab_pop_day7$DV), y = max(sdtab_pop_day7$fAUC), label = equation_day7, hjust = 3, vjust = -0.2, size = 6) +
  annotate("text", x = max(sdtab_pop_day7$DV), y = max(sdtab_pop_day7$fAUC), label = r_squared_label, hjust = 6.4, vjust = 1.2, size = 6)

# Display the scatter plot with equation
scatter_plot_with_eq_day7

# Save the scatter plot with equation
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("fAUCvsDV_day7.png", scatter_plot_with_eq_day7, dpi = 300, width = 8.27, height = 11.7, units = "in", limitsize = FALSE)

```

```{r DV vs fAUC with trendline day 14, warning=FALSE}

library(ggplot2)
library(dplyr)

# Filter the dataset for DAY 14
sdtab_pop_day14 <- sdtab_pop_10_trough %>%
  filter(DAY == 14)

# Create the scatter plot
scatter_plot_day14 <- ggplot(sdtab_pop_day14, aes(y = fAUC, x = DV)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(y = "Fluconazole area under the unbound concentration time curve (mgxh/L)",
       x = "Fluconazole trough concentration (mg/L)") +
  theme_bw() +
  scale_y_continuous(breaks = seq(0, 3400, by = 200), limits = c(0, 3400)) +
  scale_x_continuous(breaks = seq(0, 160, by = 10), limits = c(0, 160)) +
  ggtitle("Day 14") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 

# Add linear regression equation
lm_eq_day14 <- lm(fAUC ~ DV, data = sdtab_pop_day14)
intercept <- coef(lm_eq_day14)[1]
slope <- coef(lm_eq_day14)[2]
r_squared <- summary(lm_eq_day14)$r.squared
equation_day14 <- sprintf("y = %.2f + %.2fx", intercept, slope)
r_squared_label <- sprintf("R² = %.2f", r_squared)
scatter_plot_with_eq_day14 <- scatter_plot_day14 +
  annotate("text", x = max(sdtab_pop_day14$DV), y = max(sdtab_pop_day14$fAUC), label = equation_day14, hjust = 3, vjust = -0.2, size = 6) +
  annotate("text", x = max(sdtab_pop_day14$DV), y = max(sdtab_pop_day14$fAUC), label = r_squared_label, hjust = 6.4, vjust = 1.2, size = 6)

# Display the scatter plot with equation
scatter_plot_with_eq_day14

# Save the scatter plot with equation
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("fAUCvsDV_day14.png", scatter_plot_with_eq_day14, dpi = 300, width = 8.27, height = 10.3, units = "in", limitsize = FALSE)

```

#### Table 4 manuscript 03062023

```{r PTA optimised and standard dosing, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Trough and PTA datasets")
PTA_pop_10_overall<-read.csv("PTA_pop_10_overall.csv")
PTA_pop_std_10_overall<-read.csv("PTA_pop_std_10_overall.csv")
#day1
(200-108.5)/19.43
#day2
(200-142.44)/18.71
#day3
(200-131.08)/19.37
#day4
(200-128.83)/19.81

```

#### Figure S2 and S3 appendix 040623

```{r read my new dataframe, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noCKDEPI_noadderr_BW<-read.csv("Pooling_Parameters_noCKDEPI_noadderr_BW.csv")
```

```{r create a new variable}
Pooledmodel_noCKDEPI_noadderr_BW$Var<-(Pooledmodel_noCKDEPI_noadderr_BW$RSE*Pooledmodel_noCKDEPI_noadderr_BW$Estimates/100)^2
```


```{r calculate variance Theta Within and Between Subject variability for first 10 imputations}
# Create empty vectors
m <- Theta <- W <- B <- Total_Var <- numeric(10)

# Assign values to vectors using for loop
for (i in 1:10) {
  m[i] <- i
  Theta[i] <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  W[i] <- mean(Pooledmodel_noCKDEPI_noadderr_BW$Var[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  B[i] <- var(Pooledmodel_noCKDEPI_noadderr_BW$Estimates[Pooledmodel_noCKDEPI_noadderr_BW$Parameters == "BW" & Pooledmodel_noCKDEPI_noadderr_BW$Model <= i])
  Total_Var[i] <- W[i] + (1 + 1 / m[i]) * B[i]
}

# Combine vectors into a data frame
imputation_number <- data.frame(m, Theta, Total_Var)
```

```{r plot Theta over m, warning=FALSE}
library(ggplot2)
Theta_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Theta, color = "Parameter Estimate"), size = 1.0) +
  geom_point(aes(y = Theta, color = "Parameter Estimate"), size = 2.5) + # Add points for Parameter Estimate
  scale_color_manual(values = c("blue")) +
  scale_x_continuous(breaks = seq(1, 10, 1), limits = c(1, 10)) +
        scale_y_continuous(breaks = seq(0.95, 1.01, 0.005), limits = c(0.95, 1.01)) +
  labs(x = "Number of imputations", y = "BW effect Estimate", color = "Variables") +
  theme_bw() + theme(legend.position = "none")
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("theta_over_m_figs2.png", plot = Theta_over_m, dpi = 300, width = 8.27, height = 10.3)
```

```{r plot variance over m, warning=FALSE}
var_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Total_Var, color = "Total Variance"), size = 1.0) +
  geom_point(aes(y = Total_Var, color = "Total Variance"), size = 2.5) + # Add points for Total Variance
  scale_color_manual(values = c("orange")) +
  scale_x_continuous(breaks = seq(2, 10, 1), limits = c(2, 10)) +
        scale_y_continuous(breaks = seq(0.035, 0.0405, 0.0005), limits = c(0.035, 0.0405)) +
  labs(x = "Number of imputations", y = "Total variance of BW effect estimate", color = "Variables") +
  theme_bw() + theme(legend.position = "none")
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Manuscript_plots")
ggsave("var_over_m_figs3.png", plot = var_over_m, dpi = 300, width = 8.27, height = 10.3)
```

#### Table S3 appendix 040623
##### First of all, read in dataset

```{r read Pooledmodel_noCKDEPI_noadderr dataset, warning=FALSE}
setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooledmodel_noadderr_BW<-read.csv("Pooling_Parameters_noadderr_BW.csv")
```

```{r create a new variable}
Pooledmodel_noadderr_BW$Var<-(Pooledmodel_noadderr_BW$RSE*Pooledmodel_noadderr_BW$Estimates/100)^2
```

##### Second of all, pooling CLcrrt
```{r pooling CLcrrt}
CLcrrt <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CLcrrt"]) #1.69
W_CLcrrt <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "CLcrrt"])
B_CLcrrt <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CLcrrt"]) 
T_CLcrrt<-W_CLcrrt+(1+1/100)*B_CLcrrt #.01823 #m always equals 100
SE_CLcrrt<-sqrt(T_CLcrrt) 
RSE_CLcrrt<-SE_CLcrrt/CLcrrt*100 #8
CLcrrt
RSE_CLcrrt
```
###### For CLcrrt, the parameter estimate is 1.69 (8%)

```{r confidence interval CLcrrt - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 7 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLcrrt<-(B_CLcrrt+B_CLcrrt/m)/T_CLcrrt #proportion of variation attributable to the missing data #0
r_CLcrrt<-(lambda_CLcrrt)/(1-lambda_CLcrrt) #relative increase in variance due to nonresponse #0
v_old_CLcrrt<-(m-1)*(1+1/r_CLcrrt^2) #old degree of freedom #Inf
v_com=n-k #degree of freedom of parameter estimate (CLcrrt) in the hypothetically complete data #166
v_obs_CLcrrt=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLcrrt) #observed data degrees of freedom that accounts for the missing information
v_CLcrrt<-(v_old_CLcrrt*v_obs_CLcrrt)/(v_old_CLcrrt+v_obs_CLcrrt) #equals 164 (its lim approximates 164)
t_crit_CLcrrt <- qt(0.975, v_CLcrrt) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLcrrt<-CLcrrt-t_crit_CLcrrt*sqrt(T_CLcrrt) #1.43
upper_bound_CLcrrt<-CLcrrt+t_crit_CLcrrt*sqrt(T_CLcrrt) #1.96
lower_bound_CLcrrt
upper_bound_CLcrrt
```

##### Third of all, pooling CLr

```{r pooling CLr}
CLr <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CLr"]) #0.647
W_CLr <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "CLr"])
B_CLr <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CLr"]) 
T_CLr<-W_CLr+(1+1/100)*B_CLr #.001129 #m always equals 10
SE_CLr<-sqrt(T_CLr) 
RSE_CLr<-SE_CLr/CLr*100 #5.3
CLr
T_CLr
RSE_CLr

```
###### For CLr, the parameter estimate is 0.634 (5.3%)

```{r confidence interval CLr - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CLr<-(B_CLr+B_CLr/m)/T_CLr #proportion of variation attributable to the missing data
r_CLr<-(lambda_CLr)/(1-lambda_CLr) #relative increase in variance due to nonresponse
v_old_CLr<-(m-1)*(1+1/r_CLr^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CLr) in the hypothetically complete data
v_obs_CLr=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLr) #observed data degrees of freedom that accounts for the missing information
v_CLr<-(v_old_CLr*v_obs_CLr)/(v_old_CLr+v_obs_CLr) #equals 164
t_crit_CLr <- qt(0.975, v_CLr) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CLr<-CLr-t_crit_CLr*sqrt(T_CLr) #0.579
upper_bound_CLr<-CLr+t_crit_CLr*sqrt(T_CLr) #0.715
lower_bound_CLr
upper_bound_CLr

```

##### Fourth of all, pooling V1

```{r pooling V1}
V1 <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "V1"]) #38.4
W_V1 <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "V1"])
B_V1 <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "V1"]) 
T_V1<-W_V1+(1+1/100)*B_V1 #13.51 #m always equals 10
SE_V1<-sqrt(T_V1) 
RSE_V1<-SE_V1/V1*100 #9.71
V1
T_V1
RSE_V1

```
###### For V1, the parameter estimate is 37.9 (9.7%)

```{r confidence interval V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V1<-(B_V1+B_V1/m)/T_V1 #proportion of variation attributable to the missing data
r_V1<-(lambda_V1)/(1-lambda_V1) #relative increase in variance due to nonresponse
v_old_V1<-(m-1)*(1+1/r_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V1) in the hypothetically complete data
v_obs_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_V1) #observed data degrees of freedom that accounts for the missing information
v_V1<-(v_old_V1*v_obs_V1)/(v_old_V1+v_obs_V1) #equals 164
t_crit_V1 <- qt(0.975, v_V1) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V1<-V1-t_crit_V1*sqrt(T_V1) #31.7
upper_bound_V1<-V1+t_crit_V1*sqrt(T_V1) #45.1
lower_bound_V1
upper_bound_V1

```

##### Fourth of all, pooling Q
```{r pooling Q}
Q <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "Q"]) #13.5
W_Q <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "Q"])
B_Q <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "Q"]) 
T_Q<-W_Q+(1+1/100)*B_Q #35.20 #m always equals 10
SE_Q<-sqrt(T_Q) 
RSE_Q<-SE_Q/Q*100 #43.0
Q
T_Q
RSE_Q

```
###### For Q, the parameter estimate is 13.8 (43.0%)

```{r confidence interval Q - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Q<-(B_Q+B_Q/m)/T_Q #proportion of variation attributable to the missing data
r_Q<-(lambda_Q)/(1-lambda_Q) #relative increase in variance due to nonresponse
v_old_Q<-(m-1)*(1+1/r_Q^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Q) in the hypothetically complete data
v_obs_Q=((v_com+1)/(v_com+3))*v_com*(1-lambda_Q) #observed data degrees of freedom that accounts for the missing information
v_Q<-(v_old_Q*v_obs_Q)/(v_old_Q+v_obs_Q) #equals 164
t_crit_Q <- qt(0.975, v_Q) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Q<-Q-t_crit_Q*sqrt(T_Q) #3.2
upper_bound_Q<-Q+t_crit_Q*sqrt(T_Q) #23.9
lower_bound_Q
upper_bound_Q

```

##### Fifth of all, pooling V2

```{r pooling V2}
V2 <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "V2"]) #8.74
W_V2 <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "V2"])
B_V2 <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "V2"]) 
T_V2<-W_V2+(1+1/100)*B_V2 #12.13 #m always equals 10
SE_V2<-sqrt(T_V2) 
RSE_V2<-SE_V2/V2*100 #39.62
V2
T_V2
RSE_V2

```

###### For V2, the parameter estimate is 8.79 (39.62%)

```{r confidence interval V2 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_V2<-(B_V2+B_V2/m)/T_V2 #proportion of variation attributable to the missing data
r_V2<-(lambda_V2)/(1-lambda_V2) #relative increase in variance due to nonresponse
v_old_V2<-(m-1)*(1+1/r_V2^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (V2) in the hypothetically complete data
v_obs_V2=((v_com+1)/(v_com+3))*v_com*(1-lambda_V2) #observed data degrees of freedom that accounts for the missing information
v_V2<-(v_old_V2*v_obs_V2)/(v_old_V2+v_obs_V2) #equals 164
t_crit_V2 <- qt(0.975, v_V2) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_V2<-V2-t_crit_V2*sqrt(T_V2) #2.50
upper_bound_V2<-V2+t_crit_V2*sqrt(T_V2) #14.99
lower_bound_V2 
upper_bound_V2

```

##### Sixth of all, pooling BW

```{r pooling BW}
BW <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "BW"]) #0.969
W_BW <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "BW"])
B_BW <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "BW"]) 
T_BW<-W_BW+(1+1/100)*B_BW #0.03885 #m always equals 10
SE_BW<-sqrt(T_BW) 
RSE_BW<-SE_BW/BW*100 #19.9
BW
T_BW
RSE_BW

```

##### For BW, the parameter estimate is 0.989 (19.9%)

```{r confidence interval BW - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_BW<-(B_BW+B_BW/m)/T_BW #proportion of variation attributable to the missing data
r_BW<-(lambda_BW)/(1-lambda_BW) #relative increase in variance due to nonresponse
v_old_BW<-(m-1)*(1+1/r_BW^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (BW) in the hypothetically complete data
v_obs_BW=((v_com+1)/(v_com+3))*v_com*(1-lambda_BW) #observed data degrees of freedom that accounts for the missing information
v_BW<-(v_old_BW*v_obs_BW)/(v_old_BW+v_obs_BW) #equals 164
t_crit_BW <- qt(0.975, v_BW) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_BW<-BW-t_crit_BW*sqrt(T_BW) #0.589 
upper_bound_BW<-BW+t_crit_BW*sqrt(T_BW) #1.349
lower_bound_BW
upper_bound_BW

```

##### Sixth of all, pooling CKDEPI

```{r pooling BW}
CKDEPI <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CKDEPI"]) #0.273
W_CKDEPI <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "CKDEPI"])
B_CKDEPI <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "CKDEPI"]) 
T_CKDEPI<-W_CKDEPI+(1+1/100)*B_CKDEPI #0.03885 #m always equals 10
SE_CKDEPI<-sqrt(T_CKDEPI) 
RSE_CKDEPI<-SE_CKDEPI/CKDEPI*100 #73.6
CKDEPI
T_CKDEPI
RSE_CKDEPI

```

##### For CKDEPI, the parameter estimate is 0.989 (19.9%)

```{r confidence interval CKDEPI - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_CKDEPI<-(B_CKDEPI+B_CKDEPI/m)/T_CKDEPI #proportion of variation attributable to the missing data
r_CKDEPI<-(lambda_CKDEPI)/(1-lambda_CKDEPI) #relative increase in variance due to nonresponse
v_old_CKDEPI<-(m-1)*(1+1/r_CKDEPI^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CKDEPI) in the hypothetically complete data
v_obs_CKDEPI=((v_com+1)/(v_com+3))*v_com*(1-lambda_CKDEPI) #observed data degrees of freedom that accounts for the missing information
v_CKDEPI<-(v_old_CKDEPI*v_obs_CKDEPI)/(v_old_CKDEPI+v_obs_CKDEPI) #equals 164
t_crit_CKDEPI <- qt(0.975, v_CKDEPI) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_CKDEPI<-CKDEPI-t_crit_CKDEPI*sqrt(T_CKDEPI) #0.589 
upper_bound_CKDEPI<-CKDEPI+t_crit_CKDEPI*sqrt(T_CKDEPI) #1.349
lower_bound_CKDEPI #-0.127
upper_bound_CKDEPI #0.672

```

##### Seventh of all, pooling Cov_CLr_V1

```{r pooling Cov_CLr_V1}
Cov_CLr_V1 <- mean(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "Cov_CLr_V1"]) #0.0962
W_Cov_CLr_V1 <- mean(Pooledmodel_noadderr_BW$Var[Pooledmodel_noadderr_BW$Parameters == "Cov_CLr_V1"])
B_Cov_CLr_V1 <- var(Pooledmodel_noadderr_BW$Estimates[Pooledmodel_noadderr_BW$Parameters == "Cov_CLr_V1"]) 
T_Cov_CLr_V1<-W_Cov_CLr_V1+(1+1/100)*B_Cov_CLr_V1 #0.002128381 #m always equals 10
SE_Cov_CLr_V1<-sqrt(T_Cov_CLr_V1) 
RSE_Cov_CLr_V1<-SE_Cov_CLr_V1/Cov_CLr_V1*100 #44.747
Cov_CLr_V1
T_Cov_CLr_V1
RSE_Cov_CLr_V1

```

###### For Cov_CLr_V1, the parameter estimate is 0.103 (44.747%)

```{r confidence interval Cov_CLr_V1 - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_Cov_CLr_V1<-(B_Cov_CLr_V1+B_Cov_CLr_V1/m)/T_Cov_CLr_V1 #proportion of variation attributable to the missing data
r_Cov_CLr_V1<-(lambda_Cov_CLr_V1)/(1-lambda_Cov_CLr_V1) #relative increase in variance due to nonresponse
v_old_Cov_CLr_V1<-(m-1)*(1+1/r_Cov_CLr_V1^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (Cov_CLr_V1) in the hypothetically complete data
v_obs_Cov_CLr_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_Cov_CLr_V1) #observed data degrees of freedom that accounts for the missing information
v_Cov_CLr_V1<-(v_old_Cov_CLr_V1*v_obs_Cov_CLr_V1)/(v_old_Cov_CLr_V1+v_obs_Cov_CLr_V1) #equals 164
t_crit_Cov_CLr_V1 <- qt(0.975, v_Cov_CLr_V1) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_Cov_CLr_V1<-Cov_CLr_V1-t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.00882
upper_bound_Cov_CLr_V1<-Cov_CLr_V1+t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.184
lower_bound_Cov_CLr_V1
upper_bound_Cov_CLr_V1

```

##### Thereafter, with IIVs and Prop.Err, they are variance terms, so I will log-transform them first, then use Rubin's Rule to pool the parameter estimates, then back-transform to get the actual esmates 

###### First of all, create a new column called Log (the log-tranformed parameter estimates)
```{r create a log-transformed Log column}
Pooledmodel_noadderr_BW$Log<-log(Pooledmodel_noadderr_BW$Estimates)

```

###### Then create a Var_Log variable, which is the variance of the log-transformed variable
```{r create a Var_Log variable}
Pooledmodel_noadderr_BW$Var_Log<-(1/(Pooledmodel_noadderr_BW$Estimates))^2*Pooledmodel_noadderr_BW$Var #Var(log(x))=[1/(mean(x))]^2*var(x) (log(x) in R is actually ln(x))
```

###### Then pooling the log-transformed estimates, firstly, IIV_CLcrrt_log

```{r pooloing log-transformed IIV_CLcrrt_log }
IIV_CLcrrt_log <- mean(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLcrrt"]) #-1.714798
W_IIV_CLcrrt_log <- mean(Pooledmodel_noadderr_BW$Var_Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLcrrt"])
B_IIV_CLcrrt_log <- var(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLcrrt"]) 
T_IIV_CLcrrt_log<-W_IIV_CLcrrt_log+(1+1/100)*B_IIV_CLcrrt_log #0.1413766 #m always equals 10
SE_IIV_CLcrrt_log<-sqrt(T_IIV_CLcrrt_log)  
RSE_IIV_CLcrrt_log<-SE_IIV_CLcrrt_log/IIV_CLcrrt_log*100 #21.92682%
IIV_CLcrrt_log
T_IIV_CLcrrt_log
RSE_IIV_CLcrrt_log
```

```{r confidence interval IIV_CLcrrt_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLcrrt_log<-(B_IIV_CLcrrt_log+B_IIV_CLcrrt_log/m)/T_IIV_CLcrrt_log #proportion of variation attributable to the missing data
r_IIV_CLcrrt_log<-(lambda_IIV_CLcrrt_log)/(1-lambda_IIV_CLcrrt_log) #relative increase in variance due to nonresponse
v_old_IIV_CLcrrt_log<-(m-1)*(1+1/r_IIV_CLcrrt_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLcrrt_log) in the hypothetically complete data
v_obs_IIV_CLcrrt_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLcrrt_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLcrrt_log<-(v_old_IIV_CLcrrt_log*v_obs_IIV_CLcrrt_log)/(v_old_IIV_CLcrrt_log+v_obs_IIV_CLcrrt_log) #equals 164
t_crit_IIV_CLcrrt_log <- qt(0.975, v_IIV_CLcrrt_log) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log-t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-2.457225
upper_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log+t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-0.9723719
lower_bound_IIV_CLcrrt_log
upper_bound_IIV_CLcrrt_log

```

###### Then back transform to the original scale, IIV_CLcrrt

```{r back transform IIV_CLcrrt_log to IIV_CLcrrt}
IIV_CLcrrt<-exp(IIV_CLcrrt_log) #0.18
lower_bound_IIV_CLcrrt<-exp(lower_bound_IIV_CLcrrt_log) #0.083
upper_bound_IIV_CLcrrt<-exp(upper_bound_IIV_CLcrrt_log) #0.38
IIV_CLcrrt
lower_bound_IIV_CLcrrt
upper_bound_IIV_CLcrrt
```

###### Next step, pooling the log-transformed estimates for IIV_CLr_log

```{r pooloing log-transformed IIV_CLr_log }
IIV_CLr_log <- mean(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLr"]) #-1.264786
W_IIV_CLr_log <- mean(Pooledmodel_noadderr_BW$Var_Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLr"])
B_IIV_CLr_log <- var(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_CLr"]) 
T_IIV_CLr_log<-W_IIV_CLr_log+(1+1/100)*B_IIV_CLr_log #0.02745992 #m always equals 10
SE_IIV_CLr_log<-sqrt(T_IIV_CLr_log)  
RSE_IIV_CLr_log<-SE_IIV_CLr_log/IIV_CLr_log*100 #13.10185%
IIV_CLr_log
T_IIV_CLr_log
RSE_IIV_CLr_log

```

```{r confidence interval IIV_CLr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_CLr_log<-(B_IIV_CLr_log+B_IIV_CLr_log/m)/T_IIV_CLr_log #proportion of variation attributable to the missing data
r_IIV_CLr_log<-(lambda_IIV_CLr_log)/(1-lambda_IIV_CLr_log) #relative increase in variance due to nonresponse
v_old_IIV_CLr_log<-(m-1)*(1+1/r_IIV_CLr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_CLr_log) in the hypothetically complete data
v_obs_IIV_CLr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLr_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_CLr_log<-(v_old_IIV_CLr_log*v_obs_IIV_CLr_log)/(v_old_IIV_CLr_log+v_obs_IIV_CLr_log) #equals 164
t_crit_IIV_CLr_log <- qt(0.975, v_IIV_CLr_log) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_CLr_log<-IIV_CLr_log-t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-1.591987
upper_bound_IIV_CLr_log<-IIV_CLr_log+t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-0.9375855
lower_bound_IIV_CLr_log
upper_bound_IIV_CLr_log

```

###### Then back transform to the original scale, IIV_CLr

```{r back transform IIV_CLr_log to IIV_CLr}
IIV_CLr<-exp(IIV_CLr_log) #.262
lower_bound_IIV_CLr<-exp(lower_bound_IIV_CLr_log) #.186
upper_bound_IIV_CLr<-exp(upper_bound_IIV_CLr_log) #.370
IIV_CLr
lower_bound_IIV_CLr
upper_bound_IIV_CLr

```

###### After that, pooling the log-transformed estimates for IIV_V1_log

```{r pooloing log-transformed IIV_V1_log }
IIV_V1_log <- mean(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_V1"]) #-1.197039
W_IIV_V1_log <- mean(Pooledmodel_noadderr_BW$Var_Log[Pooledmodel_noadderr_BW$Parameters == "IIV_V1"])
B_IIV_V1_log <- var(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "IIV_V1"]) 
T_IIV_V1_log<-W_IIV_V1_log+(1+1/100)*B_IIV_V1_log #0.0486719 #m always equals 10
SE_IIV_V1_log<-sqrt(T_IIV_V1_log)  
RSE_IIV_V1_log<-SE_IIV_V1_log/IIV_V1_log*100 #18.43023%
IIV_V1_log
T_IIV_V1_log
RSE_IIV_V1_log

```

```{r confidence interval IIV_V1_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_IIV_V1_log<-(B_IIV_V1_log+B_IIV_V1_log/m)/T_IIV_V1_log #proportion of variation attributable to the missing data
r_IIV_V1_log<-(lambda_IIV_V1_log)/(1-lambda_IIV_V1_log) #relative increase in variance due to nonresponse
v_old_IIV_V1_log<-(m-1)*(1+1/r_IIV_V1_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (IIV_V1_log) in the hypothetically complete data
v_obs_IIV_V1_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_V1_log) #observed data degrees of freedom that accounts for the missing information
v_IIV_V1_log<-(v_old_IIV_V1_log*v_obs_IIV_V1_log)/(v_old_IIV_V1_log+v_obs_IIV_V1_log) #equals 164
t_crit_IIV_V1_log <- qt(0.975, v_IIV_V1_log) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_IIV_V1_log<-IIV_V1_log-t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-1.632655
upper_bound_IIV_V1_log<-IIV_V1_log+t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-0.7614233
v_IIV_V1_log
lower_bound_IIV_V1_log
upper_bound_IIV_V1_log

```

###### Then back transform to the original scale, IIV_V1

```{r back transform IIV_V1_log to IIV_V1}
IIV_V1<-exp(IIV_V1_log) #.302
lower_bound_IIV_V1<-exp(lower_bound_IIV_V1_log) #.197
upper_bound_IIV_V1<-exp(upper_bound_IIV_V1_log) #.462
IIV_V1
lower_bound_IIV_V1
upper_bound_IIV_V1

```

###### Finally, pooling the log-transformed estimates for PropErr_log

```{r pooloing log-transformed PropErr_log}
PropErr_log <- mean(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "PropErr"]) #-3.586323
W_PropErr_log <- mean(Pooledmodel_noadderr_BW$Var_Log[Pooledmodel_noadderr_BW$Parameters == "PropErr"])
B_PropErr_log <- var(Pooledmodel_noadderr_BW$Log[Pooledmodel_noadderr_BW$Parameters == "PropErr"]) 
T_PropErr_log<-W_PropErr_log+(1+1/100)*B_PropErr_log #0.017424 #m always equals 100
SE_PropErr_log<-sqrt(T_PropErr_log)  
RSE_PropErr_log<-SE_PropErr_log/PropErr_log*100 #3.68065%
PropErr_log
T_PropErr_log
RSE_PropErr_log
```

```{r confidence interval PropErr_log - T distribution} 
### I apply equations 2.30 to 2.32 in chapter 2.3 - vanbuuren imputation book - https://stefvanbuuren.name/fimd/sec-whyandwhen.html#eq:newnu
m<-100 #number of imputations
k<-12 #my model has 11 parameters (including 6 fixed effects parameters and 5 random effect parameters where covariance is one of them)
n<-177 #sample size
lambda_PropErr_log<-(B_PropErr_log+B_PropErr_log/m)/T_PropErr_log #proportion of variation attributable to the missing data
r_PropErr_log<-(lambda_PropErr_log)/(1-lambda_PropErr_log) #relative increase in variance due to nonresponse
v_old_PropErr_log<-(m-1)*(1+1/r_PropErr_log^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (PropErr_log) in the hypothetically complete data
v_obs_PropErr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_PropErr_log) #observed data degrees of freedom that accounts for the missing information
v_PropErr_log<-(v_old_PropErr_log*v_obs_PropErr_log)/(v_old_PropErr_log+v_obs_PropErr_log) #equals 164
t_crit_PropErr_log <- qt(0.975, v_PropErr_log) #critical t-value with df 164 and alpha 0.05 (95%CI) #equals 1.9745
lower_bound_PropErr_log<-PropErr_log-t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.846961
upper_bound_PropErr_log<-PropErr_log+t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.325684
v_PropErr_log
lower_bound_PropErr_log
upper_bound_PropErr_log

```

###### Then back transform to the original scale, PropErr

```{r back transform PropErr_log to PropErr}
PropErr<-exp(PropErr_log) #0.0282
lower_bound_PropErr<-exp(lower_bound_PropErr_log) #0.0163
upper_bound_PropErr<-exp(upper_bound_PropErr_log) #0.0486
PropErr
lower_bound_PropErr
upper_bound_PropErr

```

#### Checking VPC 200623
##### Identify all patients IDs having trough concentration   

```{r sorting dataset}
library(dplyr)

sorted_data <- FlucTotIV_clean %>%
  arrange(ID, OCC, AMT, TIME)
View(sorted_data)
```

##### Check the summary of the dosing intervals

```{r FlucTotIV_clean_int dataset}
FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean_int <- FlucTotIV_clean[!is.na(FlucTotIV_clean$AMT), ]

```
##### Calculating dosing intervals per patient

```{r}
library(dplyr)

dosing_intervals <- FlucTotIV_clean_int %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(dosing_interval = TIME - lag(TIME)) 

summary(dosing_intervals$dosing_interval)

library(dplyr)

dosing_intervals<-ungroup(dosing_intervals)
dosing_intervals <- dosing_intervals[!is.na(dosing_intervals$dosing_interval), ]
percentage <- dosing_intervals %>%
  filter((dosing_interval < 13 & dosing_interval > 11) | (dosing_interval < 25 & dosing_interval > 23)) %>%
  summarize(percentage = (n() / nrow(dosing_intervals)) * 100)
percentage
# 86.34713% dosing interval are within 12 hours or 24 hours	

```
##### Identify patients with high concentration

```{r identifying high concentration patients}
library(dplyr)

FlucTotIV_clean$TAD<-as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$DV<-as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$HOSPITAL<-as.factor(FlucTotIV_clean$HOSPITAL)

high_rows <- FlucTotIV_clean %>% #identify patients with high trough concentration
  filter(TAD >= 23, TAD <= 25.5, DV > 50) %>% #regardless of 25 or 25.5, the results remain the same
  distinct(ID)
#5 patient IDs 117 122 126 139 144

long_rows <- FlucTotIV_clean %>% #identify patients with >25.5 TAD trough concentration
  filter(TAD > 25.5, DV>0) %>%
  distinct(ID)
#18 patient IDs, 9 from HOSPITAL 2, 1 from HOS 5, 1 from HOS 7 & 7 from HOS 8

FlucTotIV_clean$DV <- as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$TAD <- as.numeric(FlucTotIV_clean$TAD)

# Creating CKDEPI2 column
FlucTotIV_clean$CKDEPI2 <- ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT2 < 0.9,(142) * ((FlucTotIV_clean$CREAT2/0.9)^-0.302) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 1 & FlucTotIV_clean$CREAT2 >= 0.9,(142) * ((FlucTotIV_clean$CREAT2/0.9)^-1.200) * (0.9938^FlucTotIV_clean$AGE), ifelse(FlucTotIV_clean$SEX == 2 & FlucTotIV_clean$CREAT2 < 0.7, (142) * ((FlucTotIV_clean$CREAT2/0.7)^-0.241) * (0.9938^FlucTotIV_clean$AGE)*1.012, (142) * ((FlucTotIV_clean$CREAT2/0.7)^-1.200) * (0.9938^FlucTotIV_clean$AGE)*1.012)))

# Exporting FlucTotIV_clean_full, which is FlucTotIV_clean with additional CKDEPI2 column - 230623

setwd("D:/Projects/Fluconazole PoPPK KU Leuven/Fluconazol_project/My datasets and R codes")
write.csv(FlucTotIV_clean,"FlucTotIV_clean_full.csv",quote=F,row.names=FALSE)

```

##### Plot high concentration patients

```{r plotting high concentration patients}
library(ggplot2)
library(tidyverse)

# Filter rows for the high concentration patients
high_patients <- c(117, 122, 126, 139, 144)
high_data <- FlucTotIV_clean %>%
  filter(ID %in% high_patients)

# Remove NAs from DV column
high_data <- high_data %>%
  drop_na(DV)
high_data$CRRT<-as.factor(high_data$CRRT)

# Create line plots with geom_points
plots <- lapply(high_patients, function(patient_id) {
  data <- high_data %>%
    filter(ID == patient_id)

  # Set different shape for CRRT values
  shape_mapping <- ifelse(data$CRRT == 1, 19, 17)

  ggplot(data, aes(x = TAD)) +
    geom_line(aes(y = DV), color = "blue") +
    geom_line(aes(y = AMT), color = "red") +
    geom_line(aes(y = CKDEPI2), color = "green") +
    geom_point(aes(y = DV, shape = factor(CRRT)), size = 3) +
    scale_shape_manual(values = shape_mapping) +
    labs(title = paste("Patient ID:", patient_id),
         x = "TAD", y = "Value") +
    theme_bw()
})

# Arrange the plots in a grid
gridExtra::grid.arrange(grobs = plots, nrow = 2, ncol = 3)


```

#### Identifying centers that have imputed CREAT before sending datasets to us - 230623

```{r identifying centers already imputed CREAT}
# Impute 09
# Get unique IDs with CRRT == 1 only
setwd("D:/Projects/Fluconazole PopPK KU Leuven/Fluconazol_project/My datasets and R codes/Plots/Creat_nonimpute_org")
library(dplyr)
FlucTotIV <- FlucTotIV %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV$ID[FlucTotIV$CRRT == 1 & !FlucTotIV$ID %in% FlucTotIV$ID[FlucTotIV$CRRT == 0]]) #ids of those who have CRRT all the time 

library(ggplot2)

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
creat_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_01.png", plot = creat_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
creat_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CREAT over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_crrt_02.png", plot = creat_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off
library(dplyr)
miscel_IDs <- FlucTotIV %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

#library(ggplot2)
# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
creat_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_01.png", plot = creat_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
creat_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_02.png", plot = creat_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
creat_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CREAT over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CREAT (mg/dL)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("creat_time_miscel_03.png", plot = creat_time_miscel_03, dpi = 300, width = 10, height = 5)

## After that, select IDs of those who don't have CRRT
nonCRRT_IDs<-setdiff(unique(FlucTotIV$ID),c(crrt_1_ids,miscel_IDs))

## I will plot per hospital because there might be similar patterns in the way they deal with missing CREAT
## First of all, hospital 1
library(dplyr)

hospital_1 <- FlucTotIV %>% 
        filter(HOSPITAL == 1) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_1_groups <- split(hospital_1, ceiling(seq_along(hospital_1)/4))

# Here I try to plot it in a different fashion for better illustration (discriminate between NAs and non_NAs also between CRRT and non-CRRT)
for (i in seq_along(hospital_1_groups)) {
        nonCRRT_IDs_1 <- hospital_1_groups[[i]]
        CRRT_non_1 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_1)
        creat_time_nonCRRT_01 <- ggplot() +
                geom_line(data = CRRT_non_1, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_1, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 01 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_1[CRRT_non_1$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos1_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_01, dpi = 300, width = 10, height = 5)
}

## Second of all, hospital 2
library(dplyr)

hospital_2 <- FlucTotIV %>% 
        filter(HOSPITAL == 2) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_2_groups <- split(hospital_2, ceiling(seq_along(hospital_2)/5))
for (i in seq_along(hospital_2_groups)) {
        nonCRRT_IDs_2 <- hospital_2_groups[[i]]
        CRRT_non_2 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_2)
        creat_time_nonCRRT_02 <- ggplot() +
                geom_line(data = CRRT_non_2, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_2, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 02 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_2[CRRT_non_2$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos2_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_02, dpi = 300, width = 10, height = 5)
}

## Third of all, hospital 5
library(dplyr)

hospital_5 <- FlucTotIV %>% 
        filter(HOSPITAL == 5) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_5_groups <- split(hospital_5, ceiling(seq_along(hospital_5)/5))
for (i in seq_along(hospital_5_groups)) {
        nonCRRT_IDs_5 <- hospital_5_groups[[i]]
        CRRT_non_5 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_5)
        creat_time_nonCRRT_05 <- ggplot() +
                geom_line(data = CRRT_non_5, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_5, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 5 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_5[CRRT_non_5$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos5_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_05, dpi = 300, width = 10, height = 5)
}

## Fourth of all, hospital 6
hospital_6 <- FlucTotIV %>% 
        filter(HOSPITAL == 6) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_6_groups <- split(hospital_6, ceiling(seq_along(hospital_6)/6))
for (i in seq_along(hospital_6_groups)) {
        nonCRRT_IDs_6 <- hospital_6_groups[[i]]
        CRRT_non_6 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_6)
        creat_time_nonCRRT_06 <- ggplot() +
                geom_line(data = CRRT_non_6, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_6, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 6 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_6[CRRT_non_6$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos6_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_06, dpi = 300, width = 10, height = 5)
}

## Fifth of all, hospital 7
hospital_7 <- FlucTotIV %>% 
        filter(HOSPITAL == 7) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_7_groups <- split(hospital_7, ceiling(seq_along(hospital_7)/6))
for (i in seq_along(hospital_7_groups)) {
        nonCRRT_IDs_7 <- hospital_7_groups[[i]]
        CRRT_non_7 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_7)
        creat_time_nonCRRT_07 <- ggplot() +
                geom_line(data = CRRT_non_7, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_7, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 7 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_7[CRRT_non_7$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos7_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_07, dpi = 300, width = 10, height = 5)
}

## Sixth of all, hospital 8
hospital_8 <- FlucTotIV %>% 
        filter(HOSPITAL == 8) %>% 
        select(ID) %>% 
        distinct() %>% 
        filter(ID %in% nonCRRT_IDs) %>% 
        pull(ID)

hospital_8_groups <- split(hospital_8, ceiling(seq_along(hospital_8)/6))
for (i in seq_along(hospital_8_groups)) {
        nonCRRT_IDs_8 <- hospital_8_groups[[i]]
        CRRT_non_8 <- FlucTotIV %>% 
                filter(ID %in% nonCRRT_IDs_8)
        creat_time_nonCRRT_08 <- ggplot() +
                geom_line(data = CRRT_non_8, aes(x = TIME, y = CREAT, group = ID, color = factor(CRRT)), size = 1) +
                geom_point(data = CRRT_non_8, aes(x = TIME, y = CREAT, shape = factor(CRRT)), size = 2) +
                scale_shape_manual(values = c(16)) +
                scale_color_manual(values = c("black")) +
                labs(title = paste0("CREAT over Time for Patients with no CRRT of hospital 8 ", sprintf("%02d", i)), 
                     x = "Time (hours)", y = "CREAT (mg/dL)") +
                theme_bw() +
                geom_rect(data = CRRT_non_8[CRRT_non_8$CRRT == 0, ], 
                          aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                          fill = "grey", alpha = 0.2) +
                facet_wrap(~ ID, scales = "free") +
                guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT"))
        ggsave(paste0("creat_time_nonCRRT_hos8_", sprintf("%02d", i), ".png"), 
               plot = creat_time_nonCRRT_08, dpi = 300, width = 10, height = 5)
}

```

##### The already imputed centers are: 2, 5, 6, 7 - 230623
